# 주식 백업 데이터베이스 구조
`stock_min_back.db`, `stock_tick_back.db`

STOM 주식 백테스트/연속 분석에는 실시간 DB 외에 `_database` 폴더에 위치한 백업용 SQLite DB를 사용합니다.
이 문서는 그중 `stock_min_back.db`(분봉), `stock_tick_back.db`(틱)의 구조와 컬럼 정보를 정리합니다.

**📌 문서 최종 업데이트**: 실제 DB 구조 검증 완료 (2025-01-15)

---

## 1. 공통 개요

- **경로**
  - 분봉 백업 DB: `_database/stock_min_back.db`
  - 틱 백업 DB  : `_database/stock_tick_back.db`

- **테이블 구조**
  - 각 DB는 **종목코드(6자리)를 이름으로 갖는 테이블**들의 집합입니다.
  - 예) `000020`, `000040`, `000050`, …, 일부 특수 코드는 `0008Z0`처럼 알파벳이 포함될 수 있음.
  - 분봉 DB: **1,195개 테이블** (2025-01 기준)
  - 틱 DB: **2,366개 테이블** (2025-01 기준)

- **시간 축**
  - 분봉(min) DB: 한 행(row)이 **1분 단위 시각 `yyyymmddhhmm`**을 나타냅니다.
    - 예) `202507230900` ~ `202507231518` 사이 값이 당일 분봉으로 누적.
  - 틱(tick) DB: 한 행(row)이 **초 단위 시각 `yyyymmddhhmmss`**를 나타냅니다.
    - 예) `20230906090225` ~ `20230906092959` 사이 값이 장 시작 직후 틱 데이터로 누적.

- **수집 일자**
  - 두 DB 모두 **데이터가 수집된 날만** 누적됩니다.
  - 따라서 캘린더 상의 거래일이 연속이어도, 중간에 수집이 빠진 날은 테이블에 행이 존재하지 않을 수 있습니다.

---

## 2. 시간 정보 저장 방식

**⚠️ 중요**: `index` 컬럼이 **시간 정보**를 담고 있습니다.

- **"일시"라는 별도 컬럼은 존재하지 않습니다.**
- `index` 컬럼은 `INTEGER` 타입으로, 날짜와 시간을 연결한 숫자로 저장됩니다.
  - 분봉 DB: `yyyymmddhhmm` (예: `202507230900`)
  - 틱 DB: `yyyymmddhhmmss` (예: `20230906090225`)

**예시**:
```sql
-- 분봉 DB: 2025년 7월 23일 09시 00분
SELECT * FROM [000040] WHERE index = 202507230900;

-- 틱 DB: 2023년 9월 6일 09시 02분 25초
SELECT * FROM [000040] WHERE index = 20230906090225;

-- 특정 날짜 범위 조회 (2025년 7월 23일 전체)
SELECT * FROM [000040]
WHERE index >= 202507230900 AND index <= 202507231530
ORDER BY index;
```

---

## 3. 공통 컬럼 개요 (min / tick 공통)

두 DB의 각 테이블에는 아래와 같이 주가·수급·호가 정보를 표현하는 수치 컬럼이 **42개 공통**으로 존재합니다.

| 컬럼명              | 타입      | 설명                                              |
|---------------------|-----------|---------------------------------------------------|
| `index`             | INTEGER   | **시각** (분봉: `yyyymmddhhmm`, 틱: `yyyymmddhhmmss`) |
| `현재가`            | REAL      | 해당 시점 체결가                                  |
| `시가`              | REAL      | 해당 일자 첫 체결가                               |
| `고가`              | REAL      | 해당 일자 최고가                                  |
| `저가`              | REAL      | 해당 일자 최저가                                  |
| `등락율`            | REAL      | 전일 종가 대비 등락률(%)                          |
| `당일거래대금`      | REAL      | 장 시작 이후 누적 거래대금 (백만 원)              |
| `체결강도`          | REAL      | 매수/매도 비율 기반 체결강도 지표                 |
| `거래대금증감`      | REAL      | 전일 동시간 대비 거래대금 증감                    |
| `전일비`            | REAL      | 전일 종가 대비 등락률(%)                          |
| `회전율`            | REAL      | 거래량 / 유통주식수 × 100 (%)                     |
| `전일동시간비`      | REAL      | 전일 동시간 대비 현재 거래량 비율(%)              |
| `시가총액`          | REAL      | 시가총액 (억 원)                                  |
| `라운드피겨위5호가이내` | REAL   | 라운드 피겨 근처 5호가 이내 여부 (0 or 1)         |
| `VI해제시간`        | REAL      | 직전 VI(변동성 완화장치) 해제 시각                |
| `VI가격`            | REAL      | VI 발동 기준 가격                                 |
| `VI호가단위`        | REAL      | VI 발동 시 호가 단위                              |
| `고저평균대비등락율` | REAL     | (현재가 - (고가+저가)/2) / (고가+저가)/2 × 100   |
| `매도총잔량`        | REAL      | 매도호가 1~5 잔량의 합                            |
| `매수총잔량`        | REAL      | 매수호가 1~5 잔량의 합                            |
| `매도호가5`         | REAL      | 5단계 매도 호가                                   |
| `매도호가4`         | REAL      | 4단계 매도 호가                                   |
| `매도호가3`         | REAL      | 3단계 매도 호가                                   |
| `매도호가2`         | REAL      | 2단계 매도 호가                                   |
| `매도호가1`         | REAL      | 1단계 매도 호가 (최우선 매도 호가)                |
| `매수호가1`         | REAL      | 1단계 매수 호가 (최우선 매수 호가)                |
| `매수호가2`         | REAL      | 2단계 매수 호가                                   |
| `매수호가3`         | REAL      | 3단계 매수 호가                                   |
| `매수호가4`         | REAL      | 4단계 매수 호가                                   |
| `매수호가5`         | REAL      | 5단계 매수 호가                                   |
| `매도잔량5`         | REAL      | 5단계 매도 잔량                                   |
| `매도잔량4`         | REAL      | 4단계 매도 잔량                                   |
| `매도잔량3`         | REAL      | 3단계 매도 잔량                                   |
| `매도잔량2`         | REAL      | 2단계 매도 잔량                                   |
| `매도잔량1`         | REAL      | 1단계 매도 잔량 (최우선 매도 잔량)                |
| `매수잔량1`         | REAL      | 1단계 매수 잔량 (최우선 매수 잔량)                |
| `매수잔량2`         | REAL      | 2단계 매수 잔량                                   |
| `매수잔량3`         | REAL      | 3단계 매수 잔량                                   |
| `매수잔량4`         | REAL      | 4단계 매수 잔량                                   |
| `매수잔량5`         | REAL      | 5단계 매수 잔량                                   |
| `매도수5호가잔량합` | REAL      | 매도 5호가 잔량 총합 (매도총잔량과 동일)          |
| `관심종목`          | REAL/INTEGER | 관심종목 플래그 (분봉: REAL, 틱: INTEGER)      |

---

## 4. 분봉 백업 DB 상세 (stock_min_back.db)

### 4.1 기본 정보

- **컬럼 개수**: 총 **48개**
  - `index` 1개 (INTEGER)
  - 공통 컬럼 41개 (REAL)
  - **분봉 전용 컬럼 6개** (REAL)
  - `관심종목` 1개 (REAL)

- **시간 컬럼**: `index` (INTEGER, `yyyymmddhhmm` 형식)
- **데이터 예시**: `202507230900` = 2025년 7월 23일 09시 00분

### 4.2 분봉 전용 컬럼 (6개)

분봉 DB에는 틱 DB에 없는, "**1분 구간 집계값**"을 위한 컬럼이 추가로 존재합니다.

| 컬럼명              | 타입   | 설명                                              |
|---------------------|--------|---------------------------------------------------|
| `분봉시가`          | REAL   | 해당 1분 구간의 처음 체결가                       |
| `분봉고가`          | REAL   | 해당 1분 구간 동안의 최고가                       |
| `분봉저가`          | REAL   | 해당 1분 구간 동안의 최저가                       |
| `분당매수수량`      | REAL   | 해당 1분 동안 매수 체결 수량                      |
| `분당매도수량`      | REAL   | 해당 1분 동안 매도 체결 수량                      |
| `분당거래대금`      | REAL   | 해당 1분 동안의 거래대금 합 (백만 원)             |

**참고**:
- "분봉종가"는 별도 컬럼으로 존재하지 않습니다. → `현재가`가 해당 분의 마지막 체결가입니다.
- "분당순매수체결수량"은 별도 컬럼으로 존재하지 않습니다. → `분당매수수량 - 분당매도수량`으로 계산 가능합니다.

### 4.3 전체 컬럼 목록 (순서대로)

```
0.  index (INTEGER)
1.  현재가
2.  시가
3.  고가
4.  저가
5.  등락율
6.  당일거래대금
7.  체결강도
8.  거래대금증감
9.  전일비
10. 회전율
11. 전일동시간비
12. 시가총액
13. 라운드피겨위5호가이내
14. 분당매수수량 ⭐
15. 분당매도수량 ⭐
16. VI해제시간
17. VI가격
18. VI호가단위
19. 분봉시가 ⭐
20. 분봉고가 ⭐
21. 분봉저가 ⭐
22. 분당거래대금 ⭐
23. 고저평균대비등락율
24. 매도총잔량
25. 매수총잔량
26. 매도호가5
27. 매도호가4
28. 매도호가3
29. 매도호가2
30. 매도호가1
31. 매수호가1
32. 매수호가2
33. 매수호가3
34. 매수호가4
35. 매수호가5
36. 매도잔량5
37. 매도잔량4
38. 매도잔량3
39. 매도잔량2
40. 매도잔량1
41. 매수잔량1
42. 매수잔량2
43. 매수잔량3
44. 매수잔량4
45. 매수잔량5
46. 매도수5호가잔량합
47. 관심종목
```

⭐ = 분봉 전용 컬럼 (틱 DB에 없음)

---

## 5. 틱 백업 DB 상세 (stock_tick_back.db)

### 5.1 기본 정보

- **컬럼 개수**: 총 **45개**
  - `index` 1개 (INTEGER)
  - 공통 컬럼 41개 (REAL)
  - **틱 전용 컬럼 3개** (REAL)
  - `관심종목` 1개 (INTEGER) ⚠️ 분봉과 타입 다름!

- **시간 컬럼**: `index` (INTEGER, `yyyymmddhhmmss` 형식)
- **데이터 예시**: `20230906090225` = 2023년 9월 6일 09시 02분 25초

### 5.2 틱 전용 컬럼 (3개)

틱 DB에는 분봉 DB에 없는, "**초 단위 체결 수량**"을 위한 컬럼이 존재합니다.

| 컬럼명              | 타입   | 설명                                              |
|---------------------|--------|---------------------------------------------------|
| `초당매수수량`      | REAL   | 해당 틱(초)에서 매수로 체결된 수량                |
| `초당매도수량`      | REAL   | 해당 틱(초)에서 매도로 체결된 수량                |
| `초당거래대금`      | REAL   | 해당 틱(초)에서의 거래대금                        |

**참고**:
- "틱순매수체결수량"은 별도 컬럼으로 존재하지 않습니다. → `초당매수수량 - 초당매도수량`으로 계산 가능합니다.

### 5.3 전체 컬럼 목록 (순서대로)

```
0.  index (INTEGER)
1.  현재가
2.  시가
3.  고가
4.  저가
5.  등락율
6.  당일거래대금
7.  체결강도
8.  거래대금증감
9.  전일비
10. 회전율
11. 전일동시간비
12. 시가총액
13. 라운드피겨위5호가이내
14. 초당매수수량 ⭐
15. 초당매도수량 ⭐
16. VI해제시간
17. VI가격
18. VI호가단위
19. 초당거래대금 ⭐
20. 고저평균대비등락율
21. 매도총잔량
22. 매수총잔량
23. 매도호가5
24. 매도호가4
25. 매도호가3
26. 매도호가2
27. 매도호가1
28. 매수호가1
29. 매수호가2
30. 매수호가3
31. 매수호가4
32. 매수호가5
33. 매도잔량5
34. 매도잔량4
35. 매도잔량3
36. 매도잔량2
37. 매도잔량1
38. 매수잔량1
39. 매수잔량2
40. 매수잔량3
41. 매수잔량4
42. 매수잔량5
43. 매도수5호가잔량합
44. 관심종목 (INTEGER) ⚠️
```

⭐ = 틱 전용 컬럼 (분봉 DB에 없음)

---

## 6. min / tick 스키마 비교 요약

### 6.1 공통점

- 테이블 이름: 모두 **종목코드(6자리 문자열)**
- 첫 컬럼: 항상 `index` (INTEGER, 시간 정보 저장)
- 가격/거래량/호가 관련 컬럼은 대부분 `REAL` 타입
- 상·하한가, VI 관련 필드, 5단계 호가/잔량, 총매수·총매도 잔량 등 핵심 정보 구조는 동일
- **공통 컬럼 42개**

### 6.2 차이점

| 항목                | stock_min_back.db (분봉)       | stock_tick_back.db (틱)        |
|---------------------|-------------------------------|-------------------------------|
| **컬럼 개수**       | 48개                          | 45개                          |
| **시간 형식**       | `yyyymmddhhmm` (분 단위)      | `yyyymmddhhmmss` (초 단위)    |
| **전용 컬럼 개수**  | 6개                           | 3개                           |
| **전용 컬럼**       | 분봉시가, 분봉고가, 분봉저가<br>분당매수수량, 분당매도수량<br>분당거래대금 | 초당매수수량, 초당매도수량<br>초당거래대금 |
| **관심종목 타입**   | REAL                          | INTEGER                       |

### 6.3 설계 의도

min/tick은 **동일한 종류의 정보를 서로 다른 시간 스케일**로 표현합니다.

- **분봉 DB**: 1분 단위 OHLC(시고저종) 및 체결 집계
- **틱 DB**: 초 단위 실시간 체결 정보

공통 로직을 설계할 때는 위 차이를 고려해 캐스팅 또는 별도 분기 처리가 필요합니다.

---

## 7. SQL 쿼리 작성 시 주의사항

### 7.1 테이블 이름 처리

⚠️ **중요**: 테이블 이름이 **숫자로 시작**하므로, SQL 쿼리 시 **대괄호 `[ ]`로 감싸야** 합니다.

**올바른 예시**:
```sql
SELECT * FROM [000040] WHERE index >= 202507230900;
SELECT 현재가, 시가, 고가, 저가 FROM [000050] ORDER BY index DESC LIMIT 10;
```

**잘못된 예시** (오류 발생):
```sql
SELECT * FROM 000040;  -- ❌ Syntax Error
```

### 7.2 시간 범위 조회

```sql
-- 특정 날짜의 모든 분봉 데이터 (2025-07-23)
SELECT * FROM [000040]
WHERE index >= 202507230900 AND index <= 202507231530;

-- 특정 시간대 (09:00 ~ 10:00)
SELECT * FROM [000040]
WHERE index >= 202507230900 AND index < 202507231000;

-- 특정 날짜의 모든 틱 데이터
SELECT * FROM [000040]
WHERE index >= 20230906090000 AND index < 20230906160000;
```

### 7.3 계산 컬럼 예시

```sql
-- 분봉 DB: 분당 순매수 수량 계산
SELECT
  index,
  현재가,
  분당매수수량,
  분당매도수량,
  (분당매수수량 - 분당매도수량) AS 분당순매수수량
FROM [000040]
WHERE index >= 202507230900;

-- 틱 DB: 초당 순매수 수량 계산
SELECT
  index,
  현재가,
  초당매수수량,
  초당매도수량,
  (초당매수수량 - 초당매도수량) AS 초당순매수수량
FROM [000040]
WHERE index >= 20230906090000;

-- 매수/매도 호가 스프레드 분석
SELECT
  index,
  현재가,
  매수호가1,
  매도호가1,
  (매도호가1 - 매수호가1) AS 호가스프레드,
  ROUND((매도호가1 - 매수호가1) * 100.0 / 현재가, 2) AS 스프레드비율
FROM [000040]
WHERE index >= 202507230900
ORDER BY index;
```

### 7.4 테이블 목록 조회

```sql
-- 모든 종목 테이블 목록 조회
SELECT name FROM sqlite_master
WHERE type='table'
ORDER BY name;

-- 특정 패턴의 종목만 조회 (00으로 시작)
SELECT name FROM sqlite_master
WHERE type='table' AND name LIKE '00%'
ORDER BY name;
```

---

## 8. Python에서 활용 예시

### 8.1 기본 연결 및 조회

```python
import sqlite3
import pandas as pd

# DB 연결
conn = sqlite3.connect('_database/stock_min_back.db')

# 특정 종목의 특정 날짜 데이터 조회
query = """
SELECT * FROM [000040]
WHERE index >= 202507230900 AND index <= 202507231530
ORDER BY index
"""
df = pd.read_sql_query(query, conn)

print(f"조회된 데이터: {len(df)}건")
print(df.head())

conn.close()
```

### 8.2 분당 순매수 수량 계산

```python
import sqlite3
import pandas as pd

conn = sqlite3.connect('_database/stock_min_back.db')

# 분당 순매수 수량 포함 조회
query = """
SELECT
  index,
  현재가,
  분봉시가,
  분봉고가,
  분봉저가,
  분당매수수량,
  분당매도수량,
  분당거래대금,
  (분당매수수량 - 분당매도수량) AS 분당순매수수량,
  CASE
    WHEN 분당매수수량 + 분당매도수량 > 0
    THEN ROUND((분당매수수량 - 분당매도수량) * 100.0 / (분당매수수량 + 분당매도수량), 2)
    ELSE 0
  END AS 순매수비율
FROM [000040]
WHERE index >= 202507230900
ORDER BY index
"""

df = pd.read_sql_query(query, conn)
print(df.head(10))

conn.close()
```

### 8.3 여러 종목 동시 조회

```python
import sqlite3
import pandas as pd

def get_stock_data(stock_code, start_time, end_time, db_path='_database/stock_min_back.db'):
    """특정 종목의 특정 시간 범위 데이터 조회"""
    conn = sqlite3.connect(db_path)

    query = f"""
    SELECT * FROM [{stock_code}]
    WHERE index >= {start_time} AND index <= {end_time}
    ORDER BY index
    """

    df = pd.read_sql_query(query, conn)
    conn.close()

    return df

# 사용 예시
stocks = ['000040', '000050', '000070']
data_dict = {}

for stock in stocks:
    data_dict[stock] = get_stock_data(
        stock,
        start_time=202507230900,
        end_time=202507231530
    )
    print(f"{stock}: {len(data_dict[stock])}건")
```

### 8.4 조건식 백테스팅 예시

```python
import sqlite3
import pandas as pd

def backtest_condition(stock_code, date_prefix):
    """
    조건식 예시: 분당순매수수량이 양수이고, 체결강도가 150 이상인 경우
    """
    conn = sqlite3.connect('_database/stock_min_back.db')

    query = f"""
    SELECT
      index,
      현재가,
      분당매수수량,
      분당매도수량,
      (분당매수수량 - 분당매도수량) AS 분당순매수수량,
      체결강도,
      분당거래대금
    FROM [{stock_code}]
    WHERE index >= {date_prefix}0900
      AND index <= {date_prefix}1530
      AND (분당매수수량 - 분당매도수량) > 0
      AND 체결강도 >= 150
    ORDER BY index
    """

    df = pd.read_sql_query(query, conn)
    conn.close()

    return df

# 사용 예시
result = backtest_condition('000040', 20250723)
print(f"조건 만족 시점: {len(result)}개")
print(result)
```

---

## 9. 데이터 검증 스크립트

프로젝트 루트에 아래 스크립트를 활용하여 DB 구조를 확인할 수 있습니다:

```bash
# 기본 DB 구조 확인
python _database/inspect_stock_back_db.py --db _database/stock_min_back.db --sample-tables 10

# 특정 테이블 스키마 조회 (Markdown 형식)
python _database/inspect_stock_back_db.py --db _database/stock_tick_back.db --table 000040 --markdown-schema

# 특정 테이블 샘플 데이터 조회
python _database/inspect_stock_back_db.py --db _database/stock_tick_back.db --table 000040 --rows 5
```

---

## 10. 참고 사항

### 10.1 컬럼명 인코딩

- 실제 DB의 컬럼 이름은 **한글**로 되어 있습니다.
- Python에서 컬럼명을 사용할 때는 UTF-8 인코딩을 사용합니다.
- Windows 환경에서는 콘솔 출력 시 인코딩 문제가 발생할 수 있으니 주의하세요.

### 10.2 데이터 타입 주의사항

- `index`는 `INTEGER`이지만, 날짜/시간을 숫자로 저장하므로 비교 연산이 가능합니다.
- 대부분의 수치 컬럼은 `REAL` 타입입니다.
- `관심종목` 컬럼만 분봉 DB에서는 `REAL`, 틱 DB에서는 `INTEGER`입니다.

### 10.3 성능 최적화

- 대량 데이터 조회 시 `index` 컬럼에 범위 조건을 사용하세요.
- 필요한 컬럼만 SELECT하여 메모리 사용량을 줄이세요.
- 여러 종목을 조회할 때는 병렬 처리를 고려하세요.

### 10.4 데이터 무결성

- 장 마감 후 또는 주말에는 데이터가 없을 수 있습니다.
- VI 발동, 거래 정지 등의 특수 상황에서는 일부 컬럼 값이 0이거나 NULL일 수 있습니다.
- 데이터 수집 오류로 인해 일부 시간대의 데이터가 누락될 수 있습니다.

---

## 11. 버전 히스토리

- **v1.0** (초기 작성): 기본 DB 구조 문서화
- **v2.0** (2025-01-15): 실제 DB 검증 완료
  - `index` 컬럼이 시간 정보를 담고 있음 명시
  - "일시" 컬럼이 존재하지 않음 확인
  - 분봉 전용 컬럼 6개 확정 (분봉종가, 분당순매수체결수량 제외)
  - 틱 전용 컬럼 3개 확정 (초당 기준)
  - 전체 컬럼 순서 및 타입 검증
  - SQL 쿼리 예시 및 Python 활용 예시 추가
  - 테이블 이름 대괄호 처리 필수 사항 추가
