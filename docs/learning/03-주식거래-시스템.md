# 03. 주식거래 시스템

> 키움증권 OpenAPI를 활용한 주식 자동매매 시스템 상세

## 목차

- [시스템 개요](#시스템-개요)
- [Kiwoom Receiver](#kiwoom-receiver)
- [Kiwoom Strategy](#kiwoom-strategy)
- [Kiwoom Trader](#kiwoom-trader)
- [데이터 흐름](#데이터-흐름)

---

## 시스템 개요

### 주식 거래 프로세스 구조

```
[키움 OpenAPI]
    ↓
[Kiwoom Receiver] - 실시간 데이터 수집
    ↓ (ZMQ)
[Kiwoom Strategy 0-4] - 전략 연산 (5개 병렬)
    ↓ (Queue)
[Kiwoom Trader] - 주문 실행
```

### 주요 파일

- `stock/kiwoom.py`: 키움 API 래퍼
- `stock/kiwoom_receiver_tick.py`: 틱 데이터 리시버
- `stock/kiwoom_receiver_min.py`: 분봉 데이터 리시버
- `stock/kiwoom_strategy_tick.py`: 틱 전략 엔진
- `stock/kiwoom_strategy_min.py`: 분봉 전략 엔진
- `stock/kiwoom_trader.py`: 주문 실행 엔진

---

## Kiwoom Receiver

**파일:** `stock/kiwoom_receiver_tick.py`, `stock/kiwoom_receiver_min.py`

### 주요 기능

1. **실시간 데이터 수신**: 키움 API에서 체결/호가 데이터 수신
2. **데이터 정규화**: 체결강도, VI 가격 등 계산
3. **ZMQ 브로드캐스트**: 5개 전략 프로세스에 데이터 전송
4. **거래대금 순위**: 상위 30종목 자동 갱신

### 코드 구조

```python
class KiwoomReceiverTick:
    def __init__(self, qlist):
        self.windowQ = qlist[0]
        self.soundQ = qlist[1]
        self.queryQ = qlist[2]
        # ...
        
        self.kiwoom = Kiwoom()  # 키움 API
        self.zmq_sock = ZmqServ()  # ZMQ 서버
        
    def run(self):
        # 실시간 TR 구독
        self.kiwoom.SetRealReg('체결')
        self.kiwoom.SetRealReg('호가')
        
        while True:
            # 체결 데이터 수신
            data = self.kiwoom.GetChegeol()
            
            # 정규화
            data = self.NormalizeData(data)
            
            # ZMQ 전송
            self.zmq_sock.send(data)
```

---

## Kiwoom Strategy

**파일:** `stock/kiwoom_strategy_tick.py`, `stock/kiwoom_strategy_min.py`

### 전략 연산 흐름

```python
class KiwoomStrategyTick:
    def run(self):
        while True:
            # 1. 데이터 수신 (ZMQ)
            data = self.zmqQ.recv()
            
            # 2. 지표 계산
            self.calculate_indicator(data)
            
            # 3. 매수 전략 실행
            exec(self.buystrategy)
            
            # 4. 매도 전략 실행
            exec(self.sellstrategy)
            
            # 5. 신호 전송
            if buy_signal:
                self.traderQ.put(['매수', code, qty, price])
            if sell_signal:
                self.traderQ.put(['매도', code, qty, price])
```

---

## Kiwoom Trader

**파일:** `stock/kiwoom_trader.py`

### 주문 실행

```python
class KiwoomTrader:
    def SendOrder(self, code, qty, price):
        # 주문 전송
        self.kiwoom.SendOrder(
            '매수',
            code,
            qty,
            price,
            '00'  # 지정가
        )
        
        # 체결 확인
        while not self.IsChegeol(code):
            time.sleep(0.1)
            
        # 잔고 업데이트
        self.UpdateJango()
```

---

**다음:** [04-암호화폐-시스템](./04-암호화폐-시스템.md)
