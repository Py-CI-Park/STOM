# 10. 전략 개발 가이드

> 나만의 매매 전략 개발 및 구현 완벽 가이드

## 목차

- [전략 개발 기초](#전략-개발-기초)
- [전략 코드 작성법](#전략-코드-작성법)
- [기술적 지표 활용](#기술적-지표-활용)
- [전략 템플릿](#전략-템플릿)
- [리스크 관리](#리스크-관리)
- [전략 테스트](#전략-테스트)

---

## 전략 개발 기초

### 전략이란?

**매매 전략 = 매수 조건 + 매도 조건**

```python
# 매수 전략 예시
if 현재가 > 5일이동평균 and RSI < 30:
    매수()

# 매도 전략 예시
if 수익률 > 2% or 수익률 < -1%:
    매도()
```

### 전략의 구성 요소

1. **매수 조건 (Buy Condition)**
   - 진입 시점 결정
   - 기술적 지표 기반
   - 복수 조건 조합 가능

2. **매도 조건 (Sell Condition)**
   - 청산 시점 결정
   - 익절/손절 조건
   - 추세 반전 감지

3. **변수 (Variables)**
   - 전략 파라미터
   - 최적화 대상
   - 예: 이동평균 기간, RSI 임계값 등

---

## 전략 코드 작성법

### 사용 가능한 변수

#### 주식 (Tick/Min 공통)

**가격 데이터:**
```python
c = 현재가
o = 시가
h = 고가
low = 저가
c0, c1, c2, ... = 이전 현재가 (0틱/분 전, 1틱/분 전, ...)
```

**거래량/금액:**
```python
v = 거래량
value = 거래대금
vs = 초당 거래대금
```

**체결 데이터:**
```python
ch = 체결강도 (매수체결량/매도체결량)
ch5 = 5틱/분 평균 체결강도
```

**호가 데이터:**
```python
ho1 = 매도호가1
hg1 = 매수호가1
hoz1 = 매도호가잔량1
hgz1 = 매수호가잔량1
# ho2~ho10, hg2~hg10, hoz2~hoz10, hgz2~hgz10
```

**등락 데이터:**
```python
d = 등락율 (%)
dm = 등락폭 (원)
per = 전일 대비 등락율
```

**기타:**
```python
vidp = 상한 VI 발동가
vidm = 하한 VI 발동가
viuphogajump = VI 호가 단위
```

#### 주식 (Tick 전용)

```python
ctime = 체결시간 (int, HHMMSS 형식)
wtime = 호가 수신 시간
```

#### 주식 (Min 전용)

```python
index = 시간 인덱스 (int, YYYYMMDDHHmmss)
```

#### 코인 (Upbit/Binance)

주식과 유사하나 코인 특화 변수:

```python
c = 현재가
o = 시가
h = 고가
low = 저가
v = 거래량
value = 거래대금
per = 등락율
# ... (기타 유사)
```

### 사용 가능한 함수 및 모듈

#### 기본 Python

```python
# 수학 함수
abs(), min(), max(), round()
sum(), len()

# 조건문
if, elif, else
and, or, not

# 반복문
for, while

# 리스트
arry = [c0, c1, c2, ...]
max(arry), min(arry)
```

#### Numpy

```python
import numpy as np

# 배열 연산
arr = np.array([c0, c1, c2, ...])
np.mean(arr)  # 평균
np.std(arr)   # 표준편차
np.max(arr)   # 최댓값
np.min(arr)   # 최솟값
```

#### 기술적 지표 (TA-Lib)

지표는 **지표 코드**에서 미리 계산됩니다.

```python
# 이동평균
ma5, ma10, ma20, ma60, ma120

# RSI
rsi = RSI 값 (0-100)

# 볼린저 밴드
bb_upper = 상단 밴드
bb_middle = 중간 밴드 (이동평균)
bb_lower = 하단 밴드

# MACD
macd = MACD 선
macd_signal = 시그널 선
macd_hist = 히스토그램

# 스토캐스틱
slowk = Slow %K
slowd = Slow %D

# CCI
cci = CCI 값

# ADX
adx = ADX 값
```

지표는 `지표 코드` 영역에서 다음과 같이 계산됩니다:

```python
# 지표 코드 (Indicator Code)
df['ma5'] = self.indicator('SMA', 5, c)
df['ma20'] = self.indicator('SMA', 20, c)
df['rsi'] = self.indicator('RSI', 14, c)
```

### 전략 코드 구조

전략은 **3개 영역**으로 구성됩니다:

#### 1. 변수 선언

```python
# 변수 선언
ma_short = 5
ma_long = 20
rsi_low = 30
rsi_high = 70
```

#### 2. 지표 계산

```python
# 지표 계산 (self.indicator 사용)
df['ma_short'] = self.indicator('SMA', ma_short, c)
df['ma_long'] = self.indicator('SMA', ma_long, c)
df['rsi'] = self.indicator('RSI', 14, c)
```

#### 3. 매수/매도 조건

```python
# 매수 조건
if (
    c > df['ma_short'].iloc[-1] and
    c > df['ma_long'].iloc[-1] and
    df['rsi'].iloc[-1] < rsi_low
):
    buy_signal = True

# 매도 조건
if (
    c < df['ma_short'].iloc[-1] or
    df['rsi'].iloc[-1] > rsi_high
):
    sell_signal = True
```

---

## 기술적 지표 활용

### TA-Lib 지표 목록

STOM에서 사용 가능한 `self.indicator()` 함수:

```python
self.indicator(지표명, 기간/파라미터, 데이터)
```

#### 이동평균 (Moving Average)

```python
# 단순 이동평균
ma20 = self.indicator('SMA', 20, c)

# 지수 이동평균
ema12 = self.indicator('EMA', 12, c)

# 가중 이동평균
wma10 = self.indicator('WMA', 10, c)

# 삼중 지수 이동평균
tema9 = self.indicator('TEMA', 9, c)
```

#### 모멘텀 지표

```python
# RSI (Relative Strength Index)
rsi = self.indicator('RSI', 14, c)

# CCI (Commodity Channel Index)
cci = self.indicator('CCI', 20, h, low, c)

# Williams %R
willr = self.indicator('WILLR', 14, h, low, c)

# ROC (Rate of Change)
roc = self.indicator('ROC', 10, c)

# MFI (Money Flow Index)
mfi = self.indicator('MFI', 14, h, low, c, v)
```

#### 추세 지표

```python
# ADX (Average Directional Index)
adx = self.indicator('ADX', 14, h, low, c)

# MACD
macd, signal, hist = self.indicator('MACD', 12, 26, 9, c)

# Parabolic SAR
sar = self.indicator('SAR', 0.02, 0.2, h, low)

# Aroon
aroon_up, aroon_down = self.indicator('AROON', 14, h, low)
```

#### 변동성 지표

```python
# Bollinger Bands
upper, middle, lower = self.indicator('BBANDS', 20, 2, 2, c)

# ATR (Average True Range)
atr = self.indicator('ATR', 14, h, low, c)

# Standard Deviation
stddev = self.indicator('STDDEV', 20, c)
```

#### 거래량 지표

```python
# OBV (On Balance Volume)
obv = self.indicator('OBV', c, v)

# AD (Accumulation/Distribution)
ad = self.indicator('AD', h, low, c, v)

# ADOSC (Chaikin A/D Oscillator)
adosc = self.indicator('ADOSC', 3, 10, h, low, c, v)
```

---

## 전략 템플릿

### 템플릿 1: 이동평균 교차 전략

#### 매수 전략

```python
# 변수
ma_short = 5
ma_long = 20

# 지표
df['ma_short'] = self.indicator('SMA', ma_short, c)
df['ma_long'] = self.indicator('SMA', ma_long, c)

# 매수 조건: 골든크로스
if (
    df['ma_short'].iloc[-1] > df['ma_long'].iloc[-1] and
    df['ma_short'].iloc[-2] <= df['ma_long'].iloc[-2]  # 교차 확인
):
    buy_signal = True
```

#### 매도 전략

```python
# 변수
profit_target = 2.0  # 익절 2%
stop_loss = -1.0     # 손절 -1%

# 매도 조건
if (
    수익률 > profit_target or
    수익률 < stop_loss or
    (df['ma_short'].iloc[-1] < df['ma_long'].iloc[-1] and  # 데드크로스
     df['ma_short'].iloc[-2] >= df['ma_long'].iloc[-2])
):
    sell_signal = True
```

---

### 템플릿 2: RSI 과매도/과매수 전략

#### 매수 전략

```python
# 변수
rsi_period = 14
rsi_oversold = 30

# 지표
df['rsi'] = self.indicator('RSI', rsi_period, c)

# 매수 조건: RSI 과매도 구간
if (
    df['rsi'].iloc[-1] < rsi_oversold and
    df['rsi'].iloc[-1] > df['rsi'].iloc[-2]  # 반등 시작
):
    buy_signal = True
```

#### 매도 전략

```python
# 변수
rsi_overbought = 70

# 매도 조건: RSI 과매수 구간 또는 손익
if (
    df['rsi'].iloc[-1] > rsi_overbought or
    수익률 > 3.0 or
    수익률 < -2.0
):
    sell_signal = True
```

---

### 템플릿 3: 볼린저 밴드 전략

#### 매수 전략

```python
# 변수
bb_period = 20
bb_std = 2

# 지표
df['bb_upper'], df['bb_middle'], df['bb_lower'] = self.indicator('BBANDS', bb_period, bb_std, bb_std, c)

# 매수 조건: 하단 밴드 터치 후 반등
if (
    c <= df['bb_lower'].iloc[-1] * 1.005 and  # 하단 근처
    c > c0  # 반등 시작
):
    buy_signal = True
```

#### 매도 전략

```python
# 매도 조건: 상단 밴드 도달 또는 중간선 하회
if (
    c >= df['bb_upper'].iloc[-1] * 0.995 or
    c < df['bb_middle'].iloc[-1] or
    수익률 < -1.5
):
    sell_signal = True
```

---

### 템플릿 4: 체결강도 + 이동평균 복합 전략

#### 매수 전략

```python
# 변수
ma_period = 20
ch_threshold = 150  # 체결강도 150% 이상

# 지표
df['ma'] = self.indicator('SMA', ma_period, c)

# 매수 조건: 이동평균 돌파 + 강한 체결강도
if (
    c > df['ma'].iloc[-1] and
    ch > ch_threshold and
    v > v0  # 거래량 증가
):
    buy_signal = True
```

#### 매도 전략

```python
# 매도 조건
if (
    c < df['ma'].iloc[-1] or
    ch < 100 or  # 체결강도 약화
    수익률 > 3.0 or
    수익률 < -2.0
):
    sell_signal = True
```

---

### 템플릿 5: 다중 시간프레임 전략 (Min 전용)

#### 매수 전략

```python
# 변수
ma_fast = 5
ma_slow = 20

# 지표
df['ma_fast'] = self.indicator('SMA', ma_fast, c)
df['ma_slow'] = self.indicator('SMA', ma_slow, c)
df['rsi'] = self.indicator('RSI', 14, c)

# 매수 조건: 추세 + 모멘텀
if (
    df['ma_fast'].iloc[-1] > df['ma_slow'].iloc[-1] and  # 상승 추세
    df['rsi'].iloc[-1] > 50 and df['rsi'].iloc[-1] < 70 and  # 건강한 모멘텀
    c > c0 and v > v0  # 상승 + 거래량 증가
):
    buy_signal = True
```

---

## 리스크 관리

### 1. 손절/익절 설정

```python
# 고정 손익률
profit_target = 2.0  # 2% 익절
stop_loss = -1.0     # 1% 손절

if 수익률 > profit_target:
    sell_signal = True  # 익절
if 수익률 < stop_loss:
    sell_signal = True  # 손절
```

### 2. 추적 손절 (Trailing Stop)

```python
# 최고 수익률 기록
max_profit = max(수익률, getattr(self, 'max_profit', 수익률))
self.max_profit = max_profit

# 추적 손절: 최고점 대비 1% 하락 시
trailing_stop = -1.0
if max_profit - 수익률 > abs(trailing_stop):
    sell_signal = True
```

### 3. 시간 손절

```python
# 보유 시간 (분봉 전략)
holding_bars = index - 매수시간
if holding_bars > 30:  # 30분 경과
    sell_signal = True
```

### 4. 분할 매수/매도

STOM은 설정에서 분할 매수/매도를 지원합니다.

**설정 방법:**
1. GUI → 설정 탭
2. `분할매수횟수`: 2 (2번 분할)
3. `분할매수방법`: 1 (균등 분할)

**분할 비율:**
- 2회 분할: 50%, 50%
- 3회 분할: 33%, 33%, 34%
- 4회 분할: 25%, 25%, 25%, 25%

---

## 전략 테스트

### 1. 전략 저장

GUI에서 전략 코드를 작성한 후:

1. `전략 관리` 탭
2. 전략 이름 입력
3. 매수 전략 코드 입력
4. 매도 전략 코드 입력
5. `저장` 버튼 클릭

전략이 `strategy.db`에 저장됩니다.

### 2. 백테스트

```python
# 백테스트 실행
1. `백테스트` 탭
2. 전략 선택
3. 기간 설정 (예: 최근 3개월)
4. `백테스트 시작` 버튼 클릭
```

결과 확인:
- 승률
- 평균 수익률
- MDD (최대 낙폭률)
- 매매 내역

### 3. 최적화

Optuna를 사용한 파라미터 최적화:

```python
# 최적화 변수 설정
1. `최적화` 탭
2. 변수 범위 설정
   - ma_short: 3 ~ 10
   - ma_long: 15 ~ 30
   - rsi_low: 20 ~ 40
3. 목표: 수익률 최대화
4. `최적화 시작`
```

자세한 내용은 **[11-최적화-가이드](./11-최적화-가이드.md)** 참고

### 4. 실전 테스트

모의투자 계좌로 실전 테스트:

```python
1. 설정 → 모의투자 체크
2. 전략 시작
3. 실시간 모니터링
4. 로그 확인
```

---

## 전략 개발 Best Practices

### 1. 단순함 유지

- 조건은 3-5개 이내
- 복잡한 전략 ≠ 좋은 전략
- 과최적화 주의

### 2. 백테스트 필수

- 최소 3개월 이상 데이터
- 다양한 시장 상황 테스트
- Walk-Forward Test 수행

### 3. 리스크 관리 필수

- 항상 손절 설정
- 최대 손실 제한
- 포지션 사이징

### 4. 실전 검증

- 소액으로 시작
- 점진적 투자금 증가
- 지속적 모니터링

### 5. 기록 및 분석

- 매매 일지 작성
- 실패 원인 분석
- 전략 개선 반복

---

## 예제: 완전한 전략

### 전략명: "골든크로스 + RSI 필터"

#### 변수 선언

```python
ma_short = 5
ma_long = 20
rsi_period = 14
rsi_min = 40
rsi_max = 70
profit_target = 2.5
stop_loss = -1.5
```

#### 지표 계산

```python
df['ma_short'] = self.indicator('SMA', ma_short, c)
df['ma_long'] = self.indicator('SMA', ma_long, c)
df['rsi'] = self.indicator('RSI', rsi_period, c)
```

#### 매수 조건

```python
if (
    # 골든크로스
    df['ma_short'].iloc[-1] > df['ma_long'].iloc[-1] and
    df['ma_short'].iloc[-2] <= df['ma_long'].iloc[-2] and

    # RSI 필터 (과매수 제외)
    df['rsi'].iloc[-1] > rsi_min and
    df['rsi'].iloc[-1] < rsi_max and

    # 거래량 확인
    v > v0
):
    buy_signal = True
```

#### 매도 조건

```python
if (
    # 손익 조건
    수익률 > profit_target or
    수익률 < stop_loss or

    # 데드크로스
    (df['ma_short'].iloc[-1] < df['ma_long'].iloc[-1] and
     df['ma_short'].iloc[-2] >= df['ma_long'].iloc[-2]) or

    # RSI 과매수
    df['rsi'].iloc[-1] > 75
):
    sell_signal = True
```

---

## 다음 단계

전략 개발을 마스터했다면:

1. **[11-최적화-가이드](./11-최적화-가이드.md)**: 전략 파라미터 최적화
2. **[05-백테스팅-시스템](./05-백테스팅-시스템.md)**: 백테스트 심화
3. **[09-커스터마이징-가이드](./09-커스터마이징-가이드.md)**: 커스텀 지표 추가

---

**다음:** [11-최적화-가이드](./11-최적화-가이드.md)
