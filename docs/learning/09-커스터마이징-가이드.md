# 09. 커스터마이징 가이드

> STOM 시스템을 자신의 트레이딩 스타일에 맞게 커스터마이징하기

## 목차

- [설정 변경](#설정-변경)
- [새로운 지표 추가](#새로운-지표-추가)
- [UI 커스터마이징](#ui-커스터마이징)
- [새로운 거래소 추가](#새로운-거래소-추가)
- [알림 시스템 커스터마이징](#알림-시스템-커스터마이징)
- [데이터베이스 확장](#데이터베이스-확장)

---

## 설정 변경

### 1. 기본 설정 변경

#### 경로 설정

**파일:** `utility/setting.py`

```python
# Python 경로
PYTHON_64BIT = 'python'  # 64비트 Python
PYTHON_32BIT = 'C:/Python39-32/python.exe'  # 32비트 Python

# 키움 OpenAPI 경로
OPENAPI_PATH = 'C:/OpenAPI/'

# 데이터베이스 경로
DB_PATH = '_database/'
DB_SETTING = f'{DB_PATH}setting.db'
DB_STOCK_TICK = f'{DB_PATH}stock_tick.db'
# ...
```

#### 투자금 및 리스크 설정

**방법 1: GUI에서 변경**

1. STOM 실행
2. `설정` 탭
3. 주식/코인 설정에서 수정:
   - 투자금
   - 최대 종목수
   - 손절 수익률
   - 익절 수익률
4. `저장` 버튼 클릭

**방법 2: 데이터베이스 직접 수정**

```python
import sqlite3

conn = sqlite3.connect('_database/setting.db')
cursor = conn.cursor()

# 주식 투자금 변경
cursor.execute("UPDATE stock SET 증권사 = 5000000")  # 500만원

# 최대 종목수 변경
cursor.execute("UPDATE stock SET 최대매수종목수 = 10")

conn.commit()
conn.close()
```

### 2. 전략 프로세스 개수 변경

**파일:** `ui/ui_mainwindow.py`

```python
# 기본: 5개 전략 프로세스
STRATEGY_PROCESS_COUNT = 5

# 변경 예시: 10개로 증가 (고성능 PC)
STRATEGY_PROCESS_COUNT = 10
```

**변경 위치:**

```python
# stock/kiwoom_receiver_tick.py
for i in range(STRATEGY_PROCESS_COUNT):  # 5 → 10
    p = Process(target=KiwoomStrategyTick, args=(qlist,))
    p.start()
```

### 3. 로그 레벨 변경

**파일:** `utility/setting.py`

```python
# 로그 레벨 설정
LOG_LEVEL = 'INFO'  # 'DEBUG', 'INFO', 'WARNING', 'ERROR'

# 디버그 모드
DEBUG_MODE = False  # True로 변경 시 상세 로그
```

---

## 새로운 지표 추가

### 방법 1: TA-Lib 지표 추가

**파일:** `utility/static.py` (또는 전략 파일)

#### 예시: Ichimoku (일목균형표) 추가

```python
def calculate_ichimoku(high, low, close, conversion=9, base=26, span_b=52):
    """
    일목균형표 계산

    Returns:
        tenkan_sen: 전환선
        kijun_sen: 기준선
        senkou_span_a: 선행스팬 A
        senkou_span_b: 선행스팬 B
        chikou_span: 후행스팬
    """
    # 전환선 (Conversion Line)
    conv_high = high.rolling(window=conversion).max()
    conv_low = low.rolling(window=conversion).min()
    tenkan_sen = (conv_high + conv_low) / 2

    # 기준선 (Base Line)
    base_high = high.rolling(window=base).max()
    base_low = low.rolling(window=base).min()
    kijun_sen = (base_high + base_low) / 2

    # 선행스팬 A (Leading Span A)
    senkou_span_a = ((tenkan_sen + kijun_sen) / 2).shift(base)

    # 선행스팬 B (Leading Span B)
    span_b_high = high.rolling(window=span_b).max()
    span_b_low = low.rolling(window=span_b).min()
    senkou_span_b = ((span_b_high + span_b_low) / 2).shift(base)

    # 후행스팬 (Lagging Span)
    chikou_span = close.shift(-base)

    return tenkan_sen, kijun_sen, senkou_span_a, senkou_span_b, chikou_span
```

#### 전략에서 사용

```python
# 지표 계산
high_series = pd.Series([h0, h1, h2, ...])
low_series = pd.Series([low0, low1, low2, ...])
close_series = pd.Series([c0, c1, c2, ...])

tenkan, kijun, span_a, span_b, chikou = calculate_ichimoku(
    high_series, low_series, close_series
)

# 매수 조건: 전환선이 기준선 상향 돌파
if tenkan.iloc[-1] > kijun.iloc[-1] and tenkan.iloc[-2] <= kijun.iloc[-2]:
    buy_signal = True
```

### 방법 2: 커스텀 지표 추가

#### 예시: 거래대금 회전율

**파일:** `utility/static.py`

```python
@jit(nopython=True, cache=True)
def calculate_turnover_ratio(price, volume, market_cap):
    """
    거래대금 회전율 계산

    Args:
        price: 현재가
        volume: 거래량
        market_cap: 시가총액

    Returns:
        turnover_ratio: 회전율 (%)
    """
    trading_value = price * volume
    turnover_ratio = (trading_value / market_cap) * 100
    return turnover_ratio
```

#### 전략에서 사용

```python
# 시가총액 (예: DB에서 조회)
market_cap = 1000000000000  # 1조원

# 회전율 계산
turnover = calculate_turnover_ratio(c, v, market_cap)

# 매수 조건: 회전율 5% 이상
if turnover > 5.0:
    buy_signal = True
```

### 방법 3: 머신러닝 지표 추가

#### 예시: Scikit-learn 활용

```python
from sklearn.ensemble import RandomForestClassifier
import numpy as np

def ml_signal(features):
    """
    머신러닝 기반 매수 신호

    Args:
        features: [ma5, ma20, rsi, volume, ...]

    Returns:
        prediction: 1 (매수), 0 (대기)
    """
    # 사전 학습된 모델 로드 (pickle 등)
    model = load_model('model.pkl')

    # 예측
    prediction = model.predict([features])[0]

    return prediction

# 전략에서 사용
features = [ma5, ma20, rsi, v, ch]
signal = ml_signal(features)

if signal == 1:
    buy_signal = True
```

---

## UI 커스터마이징

### 1. 색상 테마 변경

**파일:** `ui/set_style.py`

```python
# 다크 테마 (기본)
style_bc_dk = 'background-color: #2b2b2b'  # 배경색
style_fc_bt = 'color: #ccc'                # 글자색

# 밝은 테마로 변경
style_bc_dk = 'background-color: #ffffff'
style_fc_bt = 'color: #000000'

# 차트 배경색
pg.setConfigOption('background', '#2b2b2b')  # 다크
pg.setConfigOption('background', '#ffffff')  # 밝게
```

### 2. 테이블 컬럼 추가

**파일:** `utility/setting.py`

```python
# 체결목록 컬럼
columns_cj = [
    '체결시간', '종목명', '매수가', '매수금액', '수익률', '수익금', '체결강도평균'
]

# 새 컬럼 추가: 보유시간
columns_cj = [
    '체결시간', '종목명', '매수가', '매수금액', '수익률', '수익금', '체결강도평균', '보유시간'
]
```

**테이블 업데이트 로직:**

**파일:** `ui/ui_update_tablewidget.py`

```python
def UpdateTableWidget(self, utext):
    # ... (기존 코드)

    # 보유시간 계산 추가
    if '보유시간' in columns:
        매수시간 = row['체결시간']
        현재시간 = now()
        보유시간 = (현재시간 - 매수시간).seconds // 60  # 분 단위
        row_data.append(f'{보유시간}분')
```

### 3. 차트 인디케이터 추가

**파일:** `ui/ui_draw_realchart.py`

```python
class DrawRealChart:
    def DrawChart(self, code, data):
        # ... (기존 차트 코드)

        # 볼린저 밴드 추가
        upper = data['bb_upper']
        middle = data['bb_middle']
        lower = data['bb_lower']

        self.plot.plot(upper, pen=pg.mkPen('r', width=1))
        self.plot.plot(middle, pen=pg.mkPen('y', width=1))
        self.plot.plot(lower, pen=pg.mkPen('r', width=1))
```

### 4. 새로운 탭 추가

**파일:** `ui/set_logtap.py` (또는 새 파일)

```python
def create_custom_tab(self):
    """커스텀 탭 생성"""
    tab = QWidget()
    layout = QVBoxLayout()

    # 위젯 추가
    label = QLabel('커스텀 기능')
    button = QPushButton('실행')
    button.clicked.connect(self.custom_function)

    layout.addWidget(label)
    layout.addWidget(button)
    tab.setLayout(layout)

    return tab

# 메인 윈도우에 탭 추가
custom_tab = create_custom_tab()
self.tabWidget.addTab(custom_tab, '커스텀')
```

---

## 새로운 거래소 추가

### 예시: Coinone 추가

#### Step 1: API 래퍼 작성

**파일:** `coin/coinone_api.py` (새 파일)

```python
import requests
import hashlib
import time

class CoinoneAPI:
    def __init__(self, access_key, secret_key):
        self.access_key = access_key
        self.secret_key = secret_key
        self.base_url = 'https://api.coinone.co.kr/v2/'

    def get_ticker(self, currency='BTC'):
        """티커 정보 조회"""
        url = f'{self.base_url}ticker?currency={currency}'
        response = requests.get(url)
        return response.json()

    def get_balance(self):
        """잔고 조회"""
        # ... (API 문서 참고)
        pass

    def buy_order(self, currency, price, qty):
        """매수 주문"""
        # ... (API 문서 참고)
        pass
```

#### Step 2: Receiver 작성

**파일:** `coin/coinone_receiver_tick.py` (새 파일)

```python
from multiprocessing import Process, Queue
from coinone_api import CoinoneAPI

class CoinoneReceiverTick:
    def __init__(self, qlist):
        self.windowQ = qlist[0]
        self.queryQ = qlist[1]
        # ...

        self.api = CoinoneAPI(access_key, secret_key)

    def run(self):
        while True:
            # 티커 정보 수신
            tickers = self.api.get_ticker('ALL')

            # 데이터 가공
            for ticker in tickers:
                data = self.process_ticker(ticker)

                # Strategy에 전송
                self.stgQ.put(data)
```

#### Step 3: Strategy & Trader 작성

Upbit/Binance 코드를 참고하여 작성합니다.

#### Step 4: 메인 윈도우에 통합

**파일:** `ui/ui_mainwindow.py`

```python
# Coinone 추가
from coin.coinone_receiver_tick import CoinoneReceiverTick
from coin.coinone_trader import CoinoneTrader

# 프로세스 시작
if 거래소 == 'Coinone':
    p_receiver = Process(target=CoinoneReceiverTick, args=(qlist,))
    p_receiver.start()
```

---

## 알림 시스템 커스터마이징

### 1. 디스코드 알림 추가

**파일:** `utility/discord_msg.py` (새 파일)

```python
import requests

class DiscordMsg:
    def __init__(self, webhook_url):
        self.webhook_url = webhook_url

    def send(self, message):
        """디스코드 메시지 전송"""
        data = {'content': message}
        response = requests.post(self.webhook_url, json=data)
        return response.status_code == 204

# 사용 예시
discord = DiscordMsg('https://discord.com/api/webhooks/...')
discord.send('매수 체결: 삼성전자 80,000원')
```

#### 트레이더에 통합

**파일:** `stock/kiwoom_trader.py`

```python
from utility.discord_msg import DiscordMsg

class KiwoomTrader:
    def __init__(self, qlist):
        # ...
        self.discord = DiscordMsg(webhook_url)

    def 체결처리(self, 종목명, 매수가):
        # ... (기존 코드)

        # 디스코드 알림
        self.discord.send(f'[매수] {종목명} {매수가:,}원')
```

### 2. 슬랙 알림 추가

```python
from slack_sdk import WebClient

class SlackMsg:
    def __init__(self, token):
        self.client = WebClient(token=token)
        self.channel = '#trading-alerts'

    def send(self, message):
        self.client.chat_postMessage(
            channel=self.channel,
            text=message
        )
```

### 3. 이메일 알림 추가

```python
import smtplib
from email.mime.text import MIMEText

class EmailMsg:
    def __init__(self, smtp_server, port, email, password):
        self.smtp_server = smtp_server
        self.port = port
        self.email = email
        self.password = password

    def send(self, to, subject, message):
        msg = MIMEText(message)
        msg['Subject'] = subject
        msg['From'] = self.email
        msg['To'] = to

        with smtplib.SMTP(self.smtp_server, self.port) as server:
            server.starttls()
            server.login(self.email, self.password)
            server.send_message(msg)
```

---

## 데이터베이스 확장

### 1. 새로운 테이블 추가

**예시: 매매 통계 테이블**

```python
import sqlite3

conn = sqlite3.connect('_database/tradelist.db')
cursor = conn.cursor()

# 테이블 생성
cursor.execute("""
CREATE TABLE IF NOT EXISTS trade_statistics (
    날짜 TEXT PRIMARY KEY,
    총거래수 INTEGER,
    승리수 INTEGER,
    패배수 INTEGER,
    승률 REAL,
    평균수익률 REAL,
    최대수익 REAL,
    최대손실 REAL,
    일수익금 INTEGER
)
""")

conn.commit()
conn.close()
```

#### Query 프로세스에 쿼리 추가

**파일:** `utility/query.py`

```python
class Query:
    def ProcessQuery(self, query):
        # ... (기존 코드)

        if query[0] == '통계저장':
            날짜, 데이터 = query[1], query[2]
            self.cursor.execute("""
                INSERT OR REPLACE INTO trade_statistics VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (날짜, *데이터))
            self.conn.commit()
```

### 2. 컬럼 추가

```python
# 기존 테이블에 컬럼 추가
cursor.execute("""
ALTER TABLE s_tradelist ADD COLUMN 체결강도평균 REAL
""")
```

---

## 추천 커스터마이징 예제

### 1. 거래대금 상위 종목 자동 갱신

**목적:** 거래 활발한 종목만 자동 선택

**파일:** `stock/kiwoom_receiver_tick.py`

```python
def update_money_top(self):
    """거래대금 상위 30종목 자동 갱신"""
    # 5분마다 갱신
    if now().minute % 5 == 0:
        # 거래대금 순위 정렬
        sorted_codes = sorted(
            self.dict_mtop.items(),
            key=lambda x: x[1],
            reverse=True
        )[:30]

        # 관심종목 업데이트
        self.interest_codes = [code for code, _ in sorted_codes]

        # DB 저장
        self.queryQ.put(['관심종목저장', self.interest_codes])
```

### 2. 변동성 돌파 자동 진입

**목적:** 레인지 돌파 시 자동 매수

```python
# 지표 계산
df['high_range'] = df['h'].rolling(20).max()  # 20봉 최고가
df['range_breakout'] = (c > df['high_range'].shift(1))  # 돌파

# 매수 조건
if df['range_breakout'].iloc[-1] and v > v0 * 2:
    buy_signal = True
```

### 3. 시장 상황별 전략 전환

**목적:** 상승장/하락장 자동 판별 및 전략 변경

```python
# 코스피 지수 추세 판별
kospi_ma20 = self.indicator('SMA', 20, kospi_close)

if kospi_close > kospi_ma20:
    # 상승장: 추세 추종 전략
    strategy_type = '추세추종'
else:
    # 하락장: 역추세 전략
    strategy_type = '역추세'

# 전략에 따라 다른 조건 적용
if strategy_type == '추세추종':
    if c > ma5 and c > ma20:
        buy_signal = True
else:
    if c < bb_lower and rsi < 30:
        buy_signal = True
```

---

## 성능 최적화 팁

### 1. Numba JIT 활용

```python
from numba import jit

@jit(nopython=True, cache=True)
def fast_calculation(arr):
    """빠른 계산 (10~100배 향상)"""
    result = 0
    for i in range(len(arr)):
        result += arr[i] * arr[i]
    return result
```

### 2. Pandas 대신 Numpy

```python
# 느림
df['ma5'] = df['c'].rolling(5).mean()

# 빠름
ma5 = np.mean(arr[-5:])
```

### 3. 데이터베이스 인덱스

```sql
CREATE INDEX idx_time ON stock_tick (체결시간);
CREATE INDEX idx_code ON stock_tick (종목코드);
```

---

## 다음 단계

커스터마이징을 완료했다면:

1. **[10-전략-개발-가이드](./10-전략-개발-가이드.md)**: 커스텀 전략 개발
2. **[12-문제해결-가이드](./12-문제해결-가이드.md)**: 디버깅 및 문제 해결

---

**다음:** [10-전략-개발-가이드](./10-전략-개발-가이드.md)
