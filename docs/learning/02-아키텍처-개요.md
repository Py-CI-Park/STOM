# 02. 아키텍처 개요

> STOM의 멀티프로세스 아키텍처와 전체 시스템 구조 이해

## 목차

- [시스템 아키텍처](#시스템-아키텍처)
- [멀티프로세스 구조](#멀티프로세스-구조)
- [데이터 흐름](#데이터-흐름)
- [주요 컴포넌트](#주요-컴포넌트)
- [디자인 패턴](#디자인-패턴)

---

## 시스템 아키텍처

### 전체 구조도

```
┌─────────────────────────────────────────────────────────────┐
│                     Main Process (PyQt5 GUI)                 │
│                      ui/ui_mainwindow.py                     │
├─────────────────────────────────────────────────────────────┤
│  15개 Queue를 통한 프로세스 간 통신                          │
│  windowQ, soundQ, queryQ, teleQ, chartQ, hogaQ, ...         │
└────────┬────────────────────────────────────────────────────┘
         │
         ├─[Query Process]──────────┐ 데이터베이스 관리
         ├─[Chart Process]──────────┤ 차트 생성
         ├─[Hoga Process]───────────┤ 호가 데이터 처리
         ├─[Telegram Process]───────┤ 알림 전송
         ├─[Sound Process]──────────┤ TTS 알림
         ├─[WebCrawling Process]────┤ 크롤링
         │
         ├─┌──────────────────────────────────────────┐
         │ │   Stock Trading System (주식)            │
         │ ├──────────────────────────────────────────┤
         │ │  [Kiwoom Receiver]                       │
         │ │       │ (ZMQ Pub/Sub)                    │
         │ │       ├─[Strategy 0]─┐                   │
         │ │       ├─[Strategy 1]─┤ 5개 프로세스 병렬 │
         │ │       ├─[Strategy 2]─┤                   │
         │ │       ├─[Strategy 3]─┤                   │
         │ │       └─[Strategy 4]─┘                   │
         │ │            │ (Queue)                      │
         │ │       [Kiwoom Trader]                    │
         │ └──────────────────────────────────────────┘
         │
         ├─┌──────────────────────────────────────────┐
         │ │   Coin Trading System (암호화폐)         │
         │ ├──────────────────────────────────────────┤
         │ │  [Upbit/Binance Receiver]                │
         │ │       │ (Queue)                          │
         │ │  [Coin Strategy]                         │
         │ │       │ (Queue)                          │
         │ │  [Coin Trader]                           │
         │ └──────────────────────────────────────────┘
         │
         └─┌──────────────────────────────────────────┐
           │   Backtest System (백테스팅)             │
           ├──────────────────────────────────────────┤
           │  [Total Process] - 백테스트 관리         │
           │       ├─[BackEngine 0]─┐                │
           │       ├─[BackEngine 1]─┤ 5개 엔진 병렬   │
           │       ├─[BackEngine 2]─┤                │
           │       ├─[BackEngine 3]─┤                │
           │       └─[BackEngine 4]─┘                │
           └──────────────────────────────────────────┘
```

### 핵심 개념

1. **멀티프로세스**: CPU 멀티코어 활용, GIL 우회
2. **비동기 통신**: Queue, ZMQ, WebSocket
3. **모듈화**: 시장별, 기능별 독립적 구성
4. **확장성**: 새로운 거래소/전략 추가 용이

---

## 멀티프로세스 구조

### 프로세스 계층

```python
# stom.py (메인 프로세스)
if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = MainWindow()  # PyQt5 GUI
    window.show()
    app.exec_()
```

```python
# ui/ui_mainwindow.py (MainWindow 클래스)
class MainWindow(QMainWindow):
    def __init__(self):
        # 15개 Queue 생성
        self.windowQ = Queue()
        self.queryQ = Queue()
        # ... (나머지 Queue)

        # 프로세스 시작
        self.ProcessStarter()
```

### Queue 목록 및 역할

| Index | Queue명 | 용도 | 방향 |
|-------|---------|------|------|
| 0 | windowQ | UI 업데이트 메시지 | 자식 → 메인 |
| 1 | soundQ | 음성 알림 요청 | 메인 → Sound |
| 2 | queryQ | DB 쿼리 요청 | 양방향 |
| 3 | teleQ | 텔레그램 메시지 | 메인 → Telegram |
| 4 | chartQ | 차트 데이터 요청 | 양방향 |
| 5 | hogaQ | 호가 데이터 | Receiver → Hoga |
| 6 | webcQ | 웹 크롤링 요청 | 메인 → WebCrawling |
| 7 | backQ | 백테스트 요청 | 메인 → Backtest |
| 8 | creceivQ | 코인 리시버 데이터 | Receiver → Trader |
| 9 | ctraderQ | 코인 전략 → 트레이더 | Strategy → Trader |
| 10 | cstgQ | 코인 리시버 → 전략 | Receiver → Strategy |
| 11 | liveQ | 라이브 서버 통신 | 메인 ↔ LiveClient |
| 12 | kimpQ | 김프 데이터 | Kimp → 메인 |
| 13 | wdzservQ | ZMQ 서버 | 메인 ↔ ZMQ |
| 14 | totalQ | 총괄 데이터 | 양방향 |

### 주식 전략 프로세스 (5개 병렬 처리)

```python
# stock/kiwoom_strategy_tick.py
class KiwoomStrategyTick:
    def __init__(self, qlist):
        # 각 전략 프로세스는 독립적으로 실행
        self.stgQ = qlist[0]  # Strategy → Trader
        self.zmqQ = qlist[1]  # Receiver → Strategy (ZMQ)

    def run(self):
        while True:
            data = self.zmqQ.get()  # Receiver에서 데이터 수신

            # 매수 전략 실행
            if self.BuyCondition(data):
                self.stgQ.put(['매수', 종목코드, 수량, 가격])

            # 매도 전략 실행
            if self.SellCondition(data):
                self.stgQ.put(['매도', 종목코드, 수량, 가격])
```

**병렬 처리 이점:**
- 전략 연산 속도 5배 향상
- CPU 멀티코어 활용
- 종목별 독립적 처리

---

## 데이터 흐름

### 실시간 거래 데이터 흐름 (주식)

```
1. [키움 API] 실시간 체결 데이터
    ↓
2. [KiwoomReceiver] 데이터 수신 및 정규화
    - 체결강도 계산
    - VI 가격 계산
    - 거래대금 순위 갱신
    ↓ (ZMQ Pub/Sub)
3. [KiwoomStrategy 0-4] 전략 연산 (5개 병렬)
    - 매수 조건 체크
    - 매도 조건 체크
    ↓ (straderQ)
4. [KiwoomTrader] 주문 실행
    - 주문 전송 → 키움 API
    - 체결 확인
    ↓
5. 체결 완료
    - DB 저장 (queryQ)
    - UI 업데이트 (windowQ)
    - 텔레그램 알림 (teleQ)
    - 음성 알림 (soundQ)
```

### 백테스트 데이터 흐름

```
1. [UI] 백테스트 설정
    - 전략 선택
    - 기간 설정
    - 변수 범위 설정
    ↓ (backQ)
2. [Total Process] 백테스트 관리
    - 데이터 분할 (5개 엔진)
    - 작업 분배
    ↓ (Queue)
3. [BackEngine 0-4] 백테스트 실행 (5개 병렬)
    - 과거 데이터 로드
    - 전략 시뮬레이션
    - 수익률 계산
    ↓ (Queue)
4. [Total Process] 결과 집계
    - 승률, 평균 수익률
    - MDD, Sharpe Ratio
    - 매매 내역
    ↓ (windowQ)
5. [UI] 결과 표시
    - 차트 렌더링
    - 테이블 업데이트
```

---

## 주요 컴포넌트

### 1. Main Process (메인 프로세스)

**파일:** `stom.py`, `ui/ui_mainwindow.py`
**역할:** PyQt5 GUI 관리, 프로세스 조율

**핵심 클래스:**
- `MainWindow`: 메인 윈도우
- `Writer`: UI 업데이트 스레드
- `ProcessStarter`: 프로세스 시작 관리

**주요 기능:**
- 15개 Queue 생성 및 관리
- 자식 프로세스 시작/종료
- 사용자 입력 처리
- 실시간 UI 업데이트

### 2. Query Process (쿼리 프로세스)

**파일:** `utility/query.py`
**역할:** 모든 데이터베이스 쿼리 전담

**장점:**
- 데이터베이스 Lock 방지
- 쿼리 큐잉 및 순차 처리
- 안전성 향상

**처리 DB:**
- setting.db: 설정 및 계정 정보
- tradelist.db: 거래 내역
- strategy.db: 전략 코드
- backtest.db: 백테스트 결과
- stock/coin tick/min DB: 시장 데이터

### 3. Receiver Process (리시버 프로세스)

**파일:** `stock/kiwoom_receiver_*.py`, `coin/*_receiver_*.py`
**역할:** 실시간 시장 데이터 수집 및 가공

**주식 (Kiwoom):**
- 키움 OpenAPI OCX 제어
- 실시간 TR 구독
- 체결, 호가 데이터 수신
- ZMQ로 전략 프로세스에 브로드캐스트

**코인 (Upbit/Binance):**
- WebSocket 연결 관리
- 티커 정보 수집
- 거래대금 순위 자동 갱신

### 4. Strategy Process (전략 프로세스)

**파일:** `stock/kiwoom_strategy_*.py`, `coin/*_strategy_*.py`
**역할:** 매매 신호 생성

**전략 실행 흐름:**
```python
# 1. 전략 로딩 (DB에서)
self.buystrategy = compile(buytxt, '<string>', 'exec')
self.sellstrategy = compile(selltxt, '<string>', 'exec')

# 2. 실시간 데이터 수신
data = self.zmqQ.get()

# 3. 지표 계산
self.indicator(data)  # TA-Lib 활용

# 4. 매수 조건 체크
exec(self.buystrategy)

# 5. 매도 조건 체크
exec(self.sellstrategy)
```

### 5. Trader Process (트레이더 프로세스)

**파일:** `stock/kiwoom_trader.py`, `coin/*_trader.py`
**역할:** 주문 실행 및 체결 관리

**주문 실행 흐름:**
```python
# 1. 전략에서 신호 수신
signal = self.stgQ.get()

# 2. 주문 검증
if self.ValidateOrder(signal):
    # 3. 주문 실행
    self.SendOrder(signal)

    # 4. 체결 확인
    while not 체결완료:
        체결내역 = self.GetChegeol()

    # 5. 잔고 업데이트
    self.UpdateJango()

    # 6. DB 저장 및 알림
    self.SaveToDB()
    self.Notify()
```

### 6. Backtest Process (백테스트 프로세스)

**파일:** `backtester/backtest.py`, `backtester/backengine_*.py`
**역할:** 과거 데이터로 전략 성능 테스트

**백테스트 엔진:**
- 멀티프로세스 (5개 엔진 병렬)
- 시장별, 타임프레임별 엔진 존재
- Numba JIT 최적화

---

## 디자인 패턴

### 1. Strategy Pattern (전략 패턴)

**적용:** 매매 전략 코드

```python
# 전략을 동적으로 컴파일 및 실행
self.buystrategy = compile(strategy_code, '<string>', 'exec')
exec(self.buystrategy)
```

**장점:**
- 전략 동적 변경
- DB에 저장된 전략 즉시 적용
- 코드 수정 없이 전략 추가

### 2. Observer Pattern (옵저버 패턴)

**적용:** 실시간 데이터 업데이트

```python
# ZMQ Pub/Sub
# Publisher (Receiver)
socket.send_pyobj(data)

# Subscriber (Strategy)
data = socket.recv_pyobj()
```

**장점:**
- 1:N 브로드캐스트
- 느슨한 결합
- 확장성

### 3. Factory Pattern (팩토리 패턴)

**적용:** 시장별 엔진 생성

```python
def GetBackEngine(market, timeframe):
    if market == 'stock':
        if timeframe == 'tick':
            return BackEngineKiwoomTick()
        else:
            return BackEngineKiwoomMin()
    elif market == 'upbit':
        # ...
```

**장점:**
- 객체 생성 로직 캡슐화
- 시장별 다형성

### 4. Singleton Pattern (싱글톤 패턴)

**적용:** 설정 관리

```python
# utility/setting.py
DICT_SET = {}  # 전역 설정 딕셔너리

def database_load():
    global DICT_SET
    # DB에서 설정 로드
    DICT_SET = {...}
```

**장점:**
- 설정 중앙 관리
- 메모리 효율

### 5. Multiprocessing Pattern

**적용:** 프로세스 풀

```python
# 5개 전략 프로세스 생성
for i in range(5):
    p = Process(target=KiwoomStrategyTick, args=(qlist,))
    p.start()
    process_list.append(p)
```

**장점:**
- CPU 멀티코어 활용
- GIL 우회
- 병렬 처리 성능 향상

---

## 성능 최적화 기법

### 1. Numba JIT 컴파일

```python
from numba import jit

@jit(nopython=True, cache=True)
def GetKiwoomPgSgSp(bg, cg):
    # 수익률 계산 (10~100배 빠름)
    texs = int(cg * 0.0018)
    # ...
    return pg, sg, sp
```

### 2. Numpy 벡터화

```python
# 배열 연산 (pandas 대비 빠름)
import numpy as np

arr = np.array(price_list)
ma5 = np.mean(arr[-5:])
ma20 = np.mean(arr[-20:])
```

### 3. ZMQ 브로드캐스트

```python
# 1:N 통신 (Queue 대비 효율적)
# Receiver에서 5개 Strategy에 동시 전송
socket.send_pyobj(data)  # 한 번만 전송
```

### 4. SQLite 최적화

```python
# 인덱스 생성
CREATE INDEX idx_time ON stock_tick (체결시간);

# 배치 삽입
cursor.executemany("INSERT INTO ...", data_list)
```

---

## 다음 단계

아키텍처를 이해했다면:

1. **[03-주식거래-시스템](./03-주식거래-시스템.md)**: 주식 거래 상세
2. **[04-암호화폐-시스템](./04-암호화폐-시스템.md)**: 코인 거래 상세
3. **[08-프로세스-통신](./08-프로세스-통신.md)**: Queue, ZMQ 통신 심화

---

**다음:** [03-주식거래-시스템](./03-주식거래-시스템.md)
