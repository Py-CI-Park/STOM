# ICOS 완전 통합 방식 설계 문서

**날짜**: 2026-01-19
**작성자**: Claude Code
**버전**: 설계 문서 v1.0

---

## 1. 배경 및 목적

### 1.1 사용자의 최종 목적
- 기존 백테스트 엔진(BackTest 클래스 + backQ 큐)을 **최대한 재활용**
- 기본 백테스트 실행 → 결과 분석 → 조건식 개선 → 반복
- 최적화 코드(optimiz.py)처럼 최종 조건으로 기존 백테스트 자동 실행
- 효율적인 프로세스로 조건식 탐색

### 1.2 현재 ICOS의 문제점
| 항목 | 최종 목적 | 현재 ICOS | Gap |
|------|----------|-----------|-----|
| 백테스트 엔진 | 기존 BackTest 클래스 재사용 | 별도 SyncBacktestRunner | 🔴 완전 다른 구현 |
| 통신 방식 | backQ 큐 기반 | 동기식 함수 호출 | 🔴 아키텍처 불일치 |
| 멀티코어 활용 | back_eques로 분산 처리 | 단일 코어 | 🟡 성능 저하 |
| 데이터 로딩 | 백엔진 프로세스에서 1회 로드 | 매 반복 DB 재로드 | 🔴 비효율 |
| 최종 백테스트 | 개선된 조건식으로 자동 실행 | 없음 | 🔴 미구현 |

### 1.3 선택된 접근법
**Option B: 완전 통합 방식** - 모든 ICOS 백테스트를 `backQ` 큐로 실행

---

## 2. 아키텍처 설계

### 2.1 현재 아키텍처 (변경 전)
```
┌─────────────────┐    ┌──────────────────┐    ┌────────────────────┐
│ sdbutton_       │───▶│ _run_icos_       │───▶│ _run_icos_process  │
│ clicked_02()    │    │ backtest()       │    │ (별도 Process)     │
└─────────────────┘    └──────────────────┘    └────────────────────┘
                                                         │
                                                         ▼
                                               ┌────────────────────┐
                                               │ SyncBacktestRunner │
                                               │ (동기식 실행)      │
                                               │ - 직접 DB 로드     │
                                               │ - 단일 코어        │
                                               └────────────────────┘
```

### 2.2 새 아키텍처 (완전 통합)
```
┌─────────────────┐    ┌──────────────────┐    ┌────────────────────┐
│ sdbutton_       │───▶│ _run_icos_       │───▶│ ICOSBackTest       │
│ clicked_02()    │    │ backtest()       │    │ (BackTest 상속)    │
└─────────────────┘    └──────────────────┘    └────────────────────┘
                                                         │
                                 ┌───────────────────────┼───────────────────────┐
                                 │                       │                       │
                                 ▼                       ▼                       ▼
                       ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
                       │ back_eques[0]   │     │ back_eques[1]   │     │ back_eques[N]   │
                       │ (백엔진 프로세스)│     │ (백엔진 프로세스)│     │ (백엔진 프로세스)│
                       └─────────────────┘     └─────────────────┘     └─────────────────┘
                                 │                       │                       │
                                 └───────────────────────┼───────────────────────┘
                                                         │
                                                         ▼
                                               ┌────────────────────┐
                                               │ ICOSTotal          │
                                               │ (결과 집계)        │
                                               └────────────────────┘
                                                         │
                                                         ▼
                                               ┌────────────────────┐
                                               │ ICOSAnalyzer       │
                                               │ (손실 패턴 분석)   │
                                               └────────────────────┘
                                                         │
                                                         ▼
                                               ┌────────────────────┐
                                               │ 다음 반복 또는     │
                                               │ 최종 백테스트 실행 │
                                               └────────────────────┘
```

### 2.3 새로운 ICOS 반복 루프
```
┌─────────────────────────────────────────────────────────────────────┐
│                        ICOS 반복 루프                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [반복 0] ICOSBackTest.Start()                                     │
│     │                                                               │
│     ├─→ back_eques에 전략 전달                                     │
│     ├─→ backQ.put(파라미터)                                        │
│     ├─→ 백엔진 프로세스들 병렬 실행                                 │
│     ├─→ ICOSTotal에서 결과 수집                                    │
│     │                                                               │
│     ▼                                                               │
│  [분석] ICOSAnalyzer.analyze(df_tsg)                               │
│     │                                                               │
│     ├─→ 손실 패턴 식별                                             │
│     ├─→ 필터 조건 생성                                             │
│     ├─→ 새 조건식 빌드                                             │
│     │                                                               │
│     ▼                                                               │
│  [수렴 체크] improvement_rate < threshold?                         │
│     │                                                               │
│     ├─ Yes ──▶ 최종 백테스트 실행 (기존 BackTest)                  │
│     │                                                               │
│     └─ No ───▶ [반복 1] 새 조건식으로 재실행                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 주요 구성요소 설계

### 3.1 ICOSBackTest 클래스 (backtest_icos.py)

**위치**: `backtester/backtest_icos.py`

**역할**: BackTest를 상속하여 ICOS 반복 루프 구현

```python
class ICOSBackTest(BackTest):
    """ICOS 전용 백테스트 클래스.

    기존 BackTest 클래스를 상속하여 반복적 조건식 최적화를 수행합니다.
    back_eques를 통한 멀티프로세스 백테스트 엔진을 재사용합니다.

    핵심 차이점:
    - Start() 대신 ICOSLoop() 사용
    - 반복마다 조건식 분석 및 개선
    - 수렴 시 최종 백테스트 자동 실행
    """

    def __init__(self, wq, bq, sq, tq, lq, teleQ, beq_list, bstq_list,
                 backname, ui_gubun, icos_config):
        # BackTest 초기화 (일부 파라미터만)
        self.wq = wq           # windowQ
        self.bq = bq           # backQ
        self.sq = sq           # soundQ
        self.tq = tq           # totalQ
        self.lq = lq           # liveQ
        self.teleQ = teleQ
        self.beq_list = beq_list   # back_eques (백엔진 큐)
        self.bstq_list = bstq_list # back_sques (집계 큐)
        self.backname = backname
        self.ui_gubun = ui_gubun

        # ICOS 전용 설정
        self.icos_config = icos_config
        self.max_iterations = icos_config.get('max_iterations', 5)
        self.convergence_threshold = icos_config.get('convergence_threshold', 5) / 100

        # 분석기, 필터 생성기, 조건 빌더
        self.analyzer = ResultAnalyzer(...)
        self.filter_gen = FilterGenerator(...)
        self.condition_builder = ConditionBuilder(...)

        # 반복 상태
        self.current_iteration = 0
        self.iteration_results = []
        self.converged = False

        self.ICOSLoop()

    def ICOSLoop(self):
        """ICOS 메인 반복 루프."""
        self.wq.put((ui_num[f'{self.ui_gubun}백테바'], 0, 100, 0))

        # backQ에서 초기 파라미터 수신
        data = self.bq.get()
        betting, avgtime, startday, endday, ... = self._parse_backq_data(data)
        current_buystg = buystg
        current_sellstg = sellstg

        while self.current_iteration < self.max_iterations and not self.converged:
            # === STEP 1: 백테스트 실행 (기존 BackTest 로직 재사용) ===
            self.wq.put((ui_num[f'{self.ui_gubun}백테스트'],
                f'[ICOS] 반복 {self.current_iteration + 1}/{self.max_iterations} 시작'))

            df_tsg, metrics = self._run_backtest_iteration(
                current_buystg, current_sellstg,
                betting, avgtime, startday, endday, ...
            )

            # === STEP 2: 결과 분석 ===
            analysis_result = self.analyzer.analyze(df_tsg, metrics)

            # === STEP 3: 필터 생성 ===
            filter_candidates = self.filter_gen.generate(analysis_result)

            # === STEP 4: 조건식 개선 ===
            new_buystg, applied_filters = self.condition_builder.build(
                current_buystg, filter_candidates
            )

            # === STEP 5: 수렴 체크 ===
            if self._check_convergence(metrics):
                self.converged = True
                break

            current_buystg = new_buystg
            self.current_iteration += 1

        # === 최종 백테스트 실행 (최적화 코드 패턴) ===
        self._run_final_backtest(current_buystg, current_sellstg, ...)

        self.SysExit(False)

    def _run_backtest_iteration(self, buystg, sellstg, ...):
        """단일 반복 백테스트 실행.

        기존 BackTest.Start() 로직을 재사용하되,
        결과를 직접 반환합니다.
        """
        # 전략 전달
        for q in self.beq_list:
            q.put(('전략', buystg, sellstg))

        # 백테스트 시작 명령
        for q in self.beq_list:
            q.put(('백테정보', betting, avgtime, ...))
        for q in self.bstq_list:
            q.put(('백테시작', 2))

        # ICOSTotal에서 결과 수집 (동기식 대기)
        result = self.icos_total_queue.get()  # 별도 결과 큐

        return result['df_tsg'], result['metrics']

    def _run_final_backtest(self, buystg, sellstg, ...):
        """최종 조건식으로 기존 BackTest 실행.

        optimiz.py:569-571 패턴 적용:
        self.wq.put((ui_num[f'{self.ui_gubun}백테스트'], '최적값 백테스트 시작'))
        """
        self.wq.put((ui_num[f'{self.ui_gubun}백테스트'],
            '[ICOS] 최적화된 조건식으로 최종 백테스트 실행'))

        # 일반 백테스트와 동일한 방식으로 실행
        # (UI에 결과 표시, DB 저장 등 모든 기능 포함)
        ...
```

### 3.2 ICOSTotal 클래스 (backtest_icos.py)

**역할**: 기존 Total 클래스를 확장하여 ICOS 반복에 결과 전달

```python
class ICOSTotal(Total):
    """ICOS 전용 집계 프로세스.

    기존 Total 클래스를 상속하되, 결과를 ICOSBackTest에 전달합니다.
    """

    def __init__(self, wq, sq, tq, teleQ, mq, lq, bstq_list,
                 icos_result_queue, backname, ui_gubun, gubun):
        # 추가 큐: ICOS 결과 전달용
        self.icos_result_queue = icos_result_queue
        super().__init__(...)

    def Report(self, list_tsg, arry_bct):
        """백테스트 결과 보고 (ICOS 확장)."""
        # 기존 Report 로직
        df_tsg, metrics = super().Report(list_tsg, arry_bct)

        # ICOS 결과 큐에 전달
        self.icos_result_queue.put({
            'df_tsg': df_tsg,
            'metrics': metrics,
            'arry_bct': arry_bct,
        })
```

### 3.3 UI 통합 (ui_button_clicked_sd.py 수정)

**수정 위치**: `_run_icos_backtest()` 함수

```python
def _run_icos_backtest(ui, bt_gubun, buystg, sellstg, ...):
    """ICOS 모드 백테스트 실행 (완전 통합 방식).

    기존 BackTest와 동일한 방식으로 프로세스를 생성합니다.
    """
    from backtester.backtest_icos import ICOSBackTest

    # 기존 백테스트와 동일하게 백테유형 설정
    for q in ui.back_eques:
        q.put(('백테유형', 'ICOS'))

    # backQ에 파라미터 전달 (기존 백테스트와 동일)
    ui.backQ.put((betting, avgtime, startday, endday, starttime, endtime,
                  buystg, sellstg, ui.dict_cn, ui.back_count, bl, True,
                  ui.df_kp, ui.df_kd, False))

    # ICOSBackTest 프로세스 시작
    gubun = 'S' if bt_gubun == '주식' else 'C'
    ui.proc_icos = Process(
        target=ICOSBackTest,
        args=(ui.windowQ, ui.backQ, ui.soundQ, ui.totalQ, ui.liveQ, ui.teleQ,
              ui.back_eques, ui.back_sques, 'ICOS', gubun, icos_config)
    )
    ui.proc_icos.start()

    # UI 상태 업데이트 (기존 백테스트와 동일)
    ui.svjButtonClicked_07() if bt_gubun == '주식' else ui.cvjButtonClicked_07()
    ui.ss_progressBar_01.setValue(0)
```

---

## 4. 데이터 흐름

### 4.1 ICOS 반복 1회의 데이터 흐름
```
ICOSBackTest                back_eques              백엔진 프로세스
    │                           │                        │
    │ ('전략', buystg, sellstg) │                        │
    │ ──────────────────────────▶│                        │
    │                           │──────────────────────▶ │
    │                           │                        │ 전략 로드
    │ ('백테정보', params...)   │                        │
    │ ──────────────────────────▶│                        │
    │                           │──────────────────────▶ │
    │                           │                        │ 백테스트 실행
    │                           │                        │ (병렬)
    │                           │                        │
    │                     totalQ│◀─────────────────────  │
    │                           │     ('백테완료', n)    │
    │                           │                        │
    └───────────────────────────┤                        │
              ICOSTotal         │                        │
                  │             │                        │
                  │ 결과 집계   │                        │
                  ▼             │                        │
           icos_result_queue    │                        │
                  │             │                        │
    ICOSBackTest◀─┘             │                        │
         │                      │                        │
         │ analyze(df_tsg)      │                        │
         │ generate_filters()   │                        │
         │ build_condition()    │                        │
         ▼                      │                        │
    다음 반복 또는 종료         │                        │
```

### 4.2 backQ 파라미터 형식 (기존과 동일)
```python
# ICOS도 기존 백테스트와 동일한 형식 사용
backQ.put((
    betting,      # 배팅금액
    avgtime,      # 평균값틱수
    startday,     # 시작일
    endday,       # 종료일
    starttime,    # 시작시간
    endtime,      # 종료시간
    buystg,       # 매수 조건식 (코드)
    sellstg,      # 매도 조건식 (코드)
    dict_cn,      # 종목코드-종목명
    back_count,   # 총 틱 수
    bl,           # 블랙리스트
    True,         # 주식=True
    df_kp,        # 코스피 지수
    df_kd,        # 코스닥 지수
    False         # 플래그
))
```

---

## 5. 구현 계획

### Phase 1: 기본 구조 (ICOSBackTest)
- [ ] `backtester/backtest_icos.py` 생성
- [ ] `ICOSBackTest` 클래스 구현 (BackTest 패턴 재사용)
- [ ] `ICOSTotal` 클래스 구현

### Phase 2: 분석 및 개선 모듈 통합
- [ ] 기존 `analyzer.py`, `filter_generator.py`, `condition_builder.py` 연결
- [ ] `_run_backtest_iteration()` 메서드 구현
- [ ] 결과 큐 통신 구현

### Phase 3: UI 통합
- [ ] `ui_button_clicked_sd.py` 수정
- [ ] `_run_icos_backtest()` 재구현
- [ ] 진행률 바 및 로그 통합

### Phase 4: 최종 백테스트 및 저장
- [ ] `_run_final_backtest()` 구현 (optimiz.py 패턴)
- [ ] 개선된 조건식 DB 저장 기능
- [ ] 결과 리포트 생성

### Phase 5: 테스트 및 최적화
- [ ] 단위 테스트
- [ ] 통합 테스트
- [ ] 성능 최적화

---

## 6. 장점

### 6.1 기존 백테스트 엔진 완전 재사용
- `back_eques`를 통한 멀티코어 분산 처리
- 데이터 로딩 1회 (백엔진 프로세스에서)
- 기존 UI 진행률 바 자연스럽게 작동

### 6.2 최적화 코드와 동일한 패턴
- `optimiz.py:569-571` 패턴 적용
- 최종 조건으로 기존 백테스트 자동 실행
- 결과 DB 저장 및 리포트 생성

### 6.3 코드 일관성
- STOM 전체 아키텍처와 통합
- 큐 기반 통신 패턴 준수
- 프로세스 관리 패턴 준수

---

## 7. 주의사항

### 7.1 동기화 복잡성
- 백엔진 프로세스들의 결과를 기다려야 함
- `totalQ`에서 `'백테완료'` 수신 후 분석 진행
- 반복 간 상태 관리 필요

### 7.2 에러 핸들링
- 백엔진 프로세스 실패 시 복구
- 분석 실패 시 기본 조건식 유지
- 수렴 실패 시 최대 반복 후 종료

### 7.3 메모리 관리
- 각 반복의 `df_tsg` 누적 주의
- 필요시 이전 반복 결과 정리

---

**작성 완료**: 2026-01-19
**다음 단계**: ICOSBackTest 클래스 구현
