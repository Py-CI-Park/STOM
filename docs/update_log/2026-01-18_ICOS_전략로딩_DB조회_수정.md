# ICOS 전략 로딩 SyntaxError 수정 - DB 조회 로직 추가

**날짜**: 2026-01-18
**작성자**: Claude Code
**Commit**: 93f5463

---

## 개요

ICOS (Iterative Condition Optimization System) 실행 시 발생하던 SyntaxError를 수정했습니다.
UI에서 전달받은 "조건식 이름"을 "전략 코드"로 변환하는 DB 조회 로직을 추가했습니다.

### 주요 변경사항

1. **DB 조회 로직 추가**: `_run_icos_process()`에서 strategy.db 조회
2. **일반 백테스트 패턴 적용**: `backtest.py:BackTest.Start()` 패턴과 동일
3. **에러 핸들링 강화**: 존재하지 않는 조건식 이름 처리

---

## 문제 분석

### 발견된 문제

#### SyntaxError: invalid syntax
```
File "<string>", line 1
  Min_B_Study_251227if 매수:
                       ^^
SyntaxError: invalid syntax
```

#### 근본 원인

**UI에서 전달받는 값의 정체:**
```python
# ui_button_clicked_svj.py Line 658-659
buystg = ui.svjb_comboBoxx_01.currentText()   # "Min_B_Study_251227" (이름!)
sellstg = ui.svjs_comboBoxx_01.currentText()  # "Min_S_Study_251227" (이름!)
```

**일반 백테스트의 처리 방식:**
```python
# backtest.py Line 328-333 (BackTest.Start)
con = sqlite3.connect(DB_STRATEGY)
dfb = pd.read_sql(f'SELECT * FROM {self.gubun}buy', con).set_index('index')
dfs = pd.read_sql(f'SELECT * FROM {self.gubun}sell', con).set_index('index')
con.close()
buystg  = dfb['전략코드'][buystg_name]   # 이름 → 코드 변환!
sellstg = dfs['전략코드'][sellstg_name]  # 이름 → 코드 변환!
```

**ICOS의 기존 처리 방식 (수정 전):**
```python
# ui_button_clicked_icos.py (수정 전)
def _run_icos_process(..., buystg: str, sellstg: str, ...):
    # buystg = "Min_B_Study_251227" (이름인데 코드로 착각!)
    result = optimizer.run(buystg, sellstg, backtest_params)
    # → SyncBacktestRunner.run(buystg, ...)
    # → GetBuyStg(buystg, ...)
    # → compile("Min_B_Study_251227" + "if 매수:\n    self.Buy(vturn, vkey)", ...)
    # → SyntaxError!
```

---

## 해결 방법

### 수정된 코드

**파일**: `ui/ui_button_clicked_icos.py`

```python
def _run_icos_process(windowQ, backQ, config_dict: dict, buystg: str,
                      sellstg: str, backtest_params: dict):
    """ICOS 백그라운드 프로세스 실행 함수.

    Note:
        buystg, sellstg는 UI에서 전달받은 **조건식 이름**입니다.
        일반 백테스트(backtest.py:BackTest.Start)와 동일하게
        DB에서 실제 전략 코드를 조회하여 사용합니다.
    """
    import sqlite3
    import traceback
    import pandas as pd
    from utility.setting import DB_STRATEGY

    # ... 기존 코드 ...

    # ===== DB에서 전략 코드 로드 (일반 백테스트와 동일한 방식) =====
    # 참조: backtest.py:BackTest.Start() Line 328-333
    buystg_name = buystg
    sellstg_name = sellstg
    gubun = 'stock' if bt_gubun == '주식' else 'coin'

    try:
        con = sqlite3.connect(DB_STRATEGY)
        dfb = pd.read_sql(f'SELECT * FROM {gubun}buy', con).set_index('index')
        dfs = pd.read_sql(f'SELECT * FROM {gubun}sell', con).set_index('index')
        con.close()

        # 조건식 이름 → 실제 전략 코드
        if buystg_name not in dfb.index:
            windowQ.put((log_target,
                f'<font color=#ff0000>[ICOS] 오류: 매수 조건식 "{buystg_name}"을 찾을 수 없습니다.</font>'))
            return
        if sellstg_name not in dfs.index:
            windowQ.put((log_target,
                f'<font color=#ff0000>[ICOS] 오류: 매도 조건식 "{sellstg_name}"을 찾을 수 없습니다.</font>'))
            return

        buystg_code = dfb['전략코드'][buystg_name]
        sellstg_code = dfs['전략코드'][sellstg_name]

        windowQ.put((log_target,
            f'<font color=#cccccc>[ICOS] 전략 로드 완료: {buystg_name} / {sellstg_name}</font>'))

    except Exception as e:
        windowQ.put((log_target,
            f'<font color=#ff0000>[ICOS] 전략 로드 오류: {type(e).__name__}: {e}</font>'))
        return
    # ===== DB 조회 끝 =====

    # 실제 전략 코드로 ICOS 실행
    result = optimizer.run(buystg_code, sellstg_code, backtest_params)
```

---

## 아키텍처 비교

### 수정 전 (문제)
```
메인 윈도우 / 스케줄러
  ↓
svj_button_clicked_11() / sdbutton_clicked_02()
  ↓
_run_icos_backtest(buystg="Min_B_Study_251227", ...)
  ↓
_run_icos_process(buystg="Min_B_Study_251227", ...)  ← 이름을 코드로 착각!
  ↓
optimizer.run("Min_B_Study_251227", ...)
  ↓
SyncBacktestRunner.run("Min_B_Study_251227", ...)
  ↓
GetBuyStg("Min_B_Study_251227", ...)
  ↓
compile("Min_B_Study_251227if 매수:\n    ...") ← SyntaxError!
```

### 수정 후 (정상)
```
메인 윈도우 / 스케줄러
  ↓
svj_button_clicked_11() / sdbutton_clicked_02()
  ↓
_run_icos_backtest(buystg="Min_B_Study_251227", ...)
  ↓
_run_icos_process(buystg="Min_B_Study_251227", ...)
  ↓
DB 조회: strategy.db → stockbuy 테이블 → 전략코드 컬럼  ← NEW!
  ↓
optimizer.run("if 매수:\n    등락율N(0) >= 2.0\n    ...", ...)  ← 실제 코드!
  ↓
SyncBacktestRunner.run("if 매수:\n    ...", ...)
  ↓
GetBuyStg("if 매수:\n    ...", ...)
  ↓
compile("if 매수:\n    self.Buy(vturn, vkey)") ← 정상 실행!
```

---

## 테스트 방법

### 1. ICOS 활성화 확인

`_database/icos_analysis_config.json`:
```json
{
  "icos": {
    "enabled": true,
    "max_iterations": 5
  }
}
```

### 2. 메인 윈도우에서 실행

1. STOM 실행: `stom_stock.bat`
2. 백테스트 탭 선택
3. 전략 선택 (예: Min_B_Study_251227 / Min_S_Study_251227)
4. 기간 설정
5. **"백테스트 시작" 버튼 클릭**
6. 로그 확인:
   ```
   [ICOS] ICOS 모드 활성화됨 - 반복적 조건식 개선이 실행됩니다.
   [ICOS] 전략 로드 완료: Min_B_Study_251227 / Min_S_Study_251227
   [ICOS] 반복 1/5 시작...
   ```

### 3. 에러 케이스

존재하지 않는 조건식 선택 시:
```
[ICOS] 오류: 매수 조건식 "NonExistent_Strategy"을 찾을 수 없습니다.
```

---

## 관련 파일

### 수정된 파일
1. `ui/ui_button_clicked_icos.py`
   - `_run_icos_process()` 함수에 DB 조회 로직 추가 (Lines 720-760)

### 참조 파일
- `backtester/backtest.py`: DB 조회 패턴 원본 (Lines 328-333)
- `backtester/iterative_optimizer/backtest_sync.py`: 향후 사용 가능한 DB 로드 메서드
- `ui/ui_button_clicked_svj.py`: UI에서 조건식 이름 획득 (Lines 658-659)
- `ui/ui_button_clicked_sd.py`: 스케줄러에서 ICOS 호출 (`_run_icos_backtest()`)

---

## 이전 커밋과의 관계

### commit 395f11f (2026-01-17)
- `backtest_sync.py`에 `_strip_condition_name()` 메서드 추가
- **용도**: DB에 저장된 전략 코드에서 조건식 이름 접두사 제거
- **상황**: DB 저장 형식이 `"조건식이름\nif 매수:..."` 또는 `"조건식이름if 매수:..."` 인 경우
- **현재 상태**: ICOS 파이프라인에서 직접 호출되지 않지만, 향후 다른 경로에서 활용 가능

### commit 93f5463 (2026-01-18) - 현재
- `_run_icos_process()`에 DB 조회 로직 추가
- **용도**: UI에서 전달받은 "조건식 이름"을 "전략 코드"로 변환
- **상황**: UI combobox가 이름만 반환하는 경우 (일반적인 경우)
- **결과**: SyntaxError 해결

---

## Commit 정보

**Commit Hash**: 93f5463
**Commit Message**:
```
fix(icos): ICOS 전략 로딩 SyntaxError 수정 - DB 조회 로직 추가

문제:
- ICOS 실행 시 SyntaxError 발생: "Min_B_Study_251227if 매수:" invalid syntax
- UI에서 전달받은 buystg/sellstg가 "조건식 이름"인데 "전략 코드"로 착각
- 일반 백테스트는 backtest.py:BackTest.Start()에서 DB 조회로 변환함
- ICOS는 이 단계가 누락되어 이름을 코드로 직접 컴파일 시도

해결:
- _run_icos_process()에 DB 조회 로직 추가
- 일반 백테스트(backtest.py:328-333)와 동일한 패턴 적용
- 조건식 이름 → strategy.db에서 실제 전략 코드 조회 → optimizer.run() 호출
```

---

## 향후 개선 사항

1. **통합 전략 로더**: 여러 곳에서 사용되는 DB 조회 로직을 유틸리티 함수로 통합
2. **캐싱**: 동일 전략 반복 조회 시 캐싱으로 성능 향상
3. **검증 강화**: 전략 코드 유효성 사전 검증 (compile 전 문법 체크)

---

**작성 완료**: 2026-01-18
**최종 검토**: Claude Code
