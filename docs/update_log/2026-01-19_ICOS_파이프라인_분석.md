# ICOS 파이프라인 상세 분석 및 문제 진단

**날짜**: 2026-01-19
**작성자**: Claude Code
**상태**: 문제 발견 및 해결 진행 중

---

## 1. ICOS 활성화 시 전체 프로세스 흐름

### 1.1 UI 레이어 (메인 윈도우)

```
사용자 → [백테스트 버튼 클릭]
         ↓
    sdbutton_clicked_02() (ui/ui_button_clicked_sd.py)
         ↓
    _check_icos_enabled(ui)  ← ICOS 활성화 여부 확인
         ↓
    [ICOS 활성화됨]
         ↓
    _run_icos_backtest()     ← ICOS 백테스트 시작
```

### 1.2 `_run_icos_backtest()` 함수 흐름

```python
def _run_icos_backtest(ui, bt_gubun, buystg, sellstg, ...):
    # 1. ICOS 설정 수집
    icos_config = _collect_icos_config(ui)
    analysis_config = _collect_analysis_config(ui)

    # 2. 백테엔진에 '백테유형' 전송  ★ 문제 지점
    for q in ui.back_eques:
        q.put(('백테유형', 'ICOS'))  # ← 백엔진이 'ICOS' 유형 처리 못함!

    # 3. backQ에 파라미터 전달
    ui.backQ.put((betting, avgtime, startday, endday, ...))

    # 4. ICOSBackTest 프로세스 시작
    ui.proc_icos = Process(
        target=ICOSBackTest,
        args=(ui.windowQ, ui.backQ, ui.soundQ, ui.totalQ, ...)
    )
    ui.proc_icos.start()
```

### 1.3 ICOSBackTest 클래스 실행 흐름

```
ICOSBackTest.__init__()
    ↓
ICOSLoop()
    ├── 1. backQ에서 파라미터 수신
    │       data = self.bq.get()
    │       _parse_backq_data(data)
    │
    ├── 2. 반복 루프 시작 (max_iterations 회)
    │       while current_iteration < max_iterations:
    │           │
    │           ├── _run_backtest_iteration()  ★ 여기서 멈춤
    │           │       │
    │           │       ├── ICOSTotal 프로세스 시작
    │           │       │       - totalQ 모니터링
    │           │       │
    │           │       ├── bstq_list에 '백테정보' 전송
    │           │       │
    │           │       ├── totalQ에 '백테정보' 전송
    │           │       │
    │           │       ├── bstq_list에 '백테시작' 전송
    │           │       │
    │           │       ├── beq_list에 '백테정보' 전송
    │           │       │       → 백엔진이 백테스트 수행
    │           │       │       → 백엔진 → totalQ로 '백테완료' 전송
    │           │       │       → ICOSTotal이 수신 및 결과 집계
    │           │       │
    │           │       └── mq.get()으로 결과 대기  ★ 무한 대기
    │           │
    │           ├── analyzer.analyze(df_tsg)
    │           ├── filter_gen.generate(analysis)
    │           ├── condition_builder.build(...)
    │           └── convergence_checker.check(...)
    │
    └── 3. 최종 백테스트 실행
            _run_final_backtest()
```

---

## 2. 발견된 문제점

### 2.1 핵심 문제: 백엔진에 'ICOS' 유형 처리 코드 없음

**파일**: `backtester/backengine_kiwoom_tick.py` (및 다른 백엔진들)

**현재 백엔진의 back_type 처리 분기:**
```python
# Line 93-192
if self.back_type == '최적화':
    if data[0] == '백테정보': ...
elif self.back_type == '전진분석':
    if data[0] == '백테정보': ...
elif self.back_type == 'GA최적화':
    if data[0] == '백테정보': ...
elif self.back_type == '조건최적화':
    if data[0] == '백테정보': ...
elif self.back_type == '백테스트':      # ← 기본 백테스트
    if data[0] == '백테정보': ...
elif self.back_type == '백파인더':
    if data[0] == '백테정보': ...
# 'ICOS' 분기가 없음!
```

**결과:**
1. UI에서 `('백테유형', 'ICOS')` 전송
2. 백엔진이 `self.back_type = 'ICOS'` 설정
3. ICOSBackTest가 `('백테정보', ...)` 전송
4. 백엔진의 어떤 분기에도 안 걸림 → 백테스트 실행 안 됨
5. ICOSTotal이 '백테완료' 메시지를 영원히 기다림
6. `mq.get(timeout=600)`에서 10분 타임아웃까지 대기

### 2.2 증상

```
[ICOS] 반복 1/5 시작
(이후 아무 진행 없음 - 10분 후 타임아웃 예상)
```

---

## 3. 프로세스 간 통신 구조

### 3.1 큐 구조

```
┌─────────────────────────────────────────────────────────────┐
│                     메인 윈도우 (UI)                          │
│                                                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │
│  │ windowQ │  │ backQ   │  │ totalQ  │  │soundQ   │         │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘         │
│       │            │            │            │               │
│  ┌────┴────────────┴────────────┴────────────┴────┐         │
│  │                  back_eques (beq_list)          │         │
│  │  [beq0] [beq1] [beq2] [beq3] [beq4] ... [beqN] │         │
│  └────┬─────┬─────┬─────┬─────┬─────────────┬────┘         │
│       │     │     │     │     │             │               │
│  ┌────┴────────────┴────────────┴────────────┴────┐         │
│  │                  back_sques (bstq_list)         │         │
│  │  [bstq0] [bstq1] [bstq2] [bstq3] [bstq4]       │         │
│  └─────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 프로세스 관계

```
┌─────────────────────────────────────────────────────────────┐
│                     메인 프로세스 (PyQt5)                     │
└───────┬─────────────────────────────────────────────────────┘
        │
        │ Process(target=ICOSBackTest, ...)
        ▼
┌───────────────────────────────────────────────────────────┐
│                   ICOSBackTest 프로세스                     │
│                                                            │
│  ICOSLoop() → _run_backtest_iteration()                   │
│                          │                                 │
│                          │ Process(target=ICOSTotal, ...)  │
│                          ▼                                 │
│              ┌───────────────────────┐                    │
│              │   ICOSTotal 프로세스    │                    │
│              │                       │                    │
│              │  MainLoop()           │                    │
│              │   - totalQ.get()      │ ← 백엔진 결과 대기  │
│              │   - mq.put(result)    │ → 결과 반환        │
│              └───────────────────────┘                    │
└───────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────┐
│                백테스트 엔진 프로세스들 (N개)                 │
│                                                            │
│  BackEngine.__init__()                                    │
│      │                                                     │
│      └── MainLoop()                                        │
│              │                                             │
│              ├── beq.get() ← 명령 대기                      │
│              │                                             │
│              ├── if back_type == '백테스트':               │
│              │       if data[0] == '백테정보':             │
│              │           BackTest() 실행                   │
│              │           tq.put(('백테완료', ...))         │
│              │                                             │
│              └── elif back_type == 'ICOS':  ← 이 분기 없음! │
│                      (처리 안 됨)                          │
└───────────────────────────────────────────────────────────┘
```

---

## 4. 해결 방안

### 4.1 방안 A: 백테유형을 '백테스트'로 변경 (권장)

ICOS의 백테스트 로직은 기본 백테스트와 동일합니다.
따라서 백엔진에 'ICOS' 분기를 추가하는 대신,
ICOS가 '백테스트' 유형을 사용하도록 변경합니다.

**수정 파일**: `ui/ui_button_clicked_sd.py`

```python
# 기존 (문제)
for q in ui.back_eques:
    q.put(('백테유형', 'ICOS'))

# 수정 후 (해결)
for q in ui.back_eques:
    q.put(('백테유형', '백테스트'))
```

**장점:**
- 최소한의 코드 변경
- 기존 백엔진 코드 수정 불필요
- 검증된 백테스트 로직 재사용

### 4.2 방안 B: 백엔진에 'ICOS' 분기 추가

모든 백엔진 파일에 'ICOS' 분기를 추가합니다.

**수정 파일**:
- `backengine_kiwoom_tick.py`
- `backengine_upbit_tick.py`
- `backengine_binance_tick.py`
- (및 tick2 버전들)

```python
elif self.back_type == 'ICOS':
    if data[0] == '백테정보':
        # '백테스트'와 동일한 처리
        ...
```

**단점:**
- 여러 파일 수정 필요
- 유지보수 복잡성 증가

---

## 5. 권장 해결 방안

**방안 A (백테유형을 '백테스트'로 변경)** 를 권장합니다.

ICOS의 핵심은 "반복적으로 백테스트를 실행하고 결과를 분석하여 조건식을 개선"하는 것입니다.
개별 백테스트 실행 자체는 기본 백테스트와 완전히 동일합니다.

따라서 백엔진에 별도 분기를 추가할 필요 없이,
기존 '백테스트' 유형을 그대로 사용하면 됩니다.

---

## 6. 구현 체크리스트

- [ ] `ui/ui_button_clicked_sd.py`에서 `('백테유형', 'ICOS')` → `('백테유형', '백테스트')` 변경
- [ ] 테스트: ICOS 백테스트 버튼 클릭 시 정상 진행 확인
- [ ] 테스트: 상태바 진행률 표시 확인
- [ ] 테스트: 반복 완료 및 결과 출력 확인

---

**작성 완료**: 2026-01-19
**최종 검토**: Claude Code
