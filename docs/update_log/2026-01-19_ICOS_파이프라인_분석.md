# ICOS 파이프라인 상세 분석 및 구현 완료 보고서

**날짜**: 2026-01-19
**작성자**: Claude Code
**상태**: ✅ 구현 완료 및 검증됨
**버전**: v1.2 (그래프 옵션 연동 및 단계별 로그 추가)

---

## 1. ICOS 개요

### 1.1 ICOS란?

**ICOS (Iterative Condition Optimization System)** 는 트레이딩 조건식을 반복적으로 개선하는 자동화 시스템입니다.

**핵심 특징:**
- 기존 백테스트 엔진(back_eques 멀티프로세스)을 완전히 재활용
- 손실 패턴 분석 → 필터 생성 → 조건식 개선의 반복 사이클
- 수렴 조건 달성 또는 최대 반복 횟수 도달 시 최종 백테스트 자동 실행
- 백테스트 옵션(그래프 표시/저장)과 완전히 연동

### 1.2 아키텍처 원칙

```
┌─────────────────────────────────────────────────────────────────┐
│  ICOS 설계 원칙: "기존 백테스트 엔진 100% 재활용"                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ✅ backQ 큐를 통한 파라미터 전달 (BackTest.Start()와 동일)        │
│  ✅ back_eques 멀티프로세스를 통한 분산 백테스트                    │
│  ✅ totalQ를 통한 결과 수집 (Total 클래스 재사용)                   │
│  ✅ '백테스트' 유형으로 백엔진 호출 (별도 분기 불필요)               │
│  ✅ dict_set['그래프띄우지않기'] 옵션 완전 연동                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. ICOS 실행 흐름 (상세)

### 2.1 UI 레이어 → ICOS 시작

```
사용자
  │
  ▼ [백테스트 버튼 클릭]
  │
sdbutton_clicked_02() (ui/ui_button_clicked_sd.py:354)
  │
  ├─ _check_icos_enabled(ui)  ← ICOS 활성화 여부 확인
  │   └─ icos_analysis_config.json 파일에서 설정 로드
  │
  ├─ [ICOS 활성화 확인됨]
  │
  └─ _run_icos_backtest() 호출 (line 499)
```

### 2.2 `_run_icos_backtest()` 함수 흐름

```python
# 파일: ui/ui_button_clicked_sd.py (line 121-291)

def _run_icos_backtest(ui, bt_gubun, buystg, sellstg, ...):
    """ICOS 모드 백테스트 실행 (완전 통합 방식)"""

    # 1. ICOS 설정 수집
    icos_config = _collect_icos_config(ui)
    analysis_config = _collect_analysis_config(ui)

    # 2. 백테 유형 설정 ─ '백테스트' 유형 사용 (해결됨!)
    for q in ui.back_eques:
        q.put(('백테유형', '백테스트'))  # ← ICOS가 아닌 '백테스트' 유형

    # 3. backQ에 파라미터 전달 (기존 백테스트와 동일한 형식)
    ui.backQ.put((
        betting, avgtime, startday, endday, starttime, endtime,
        buystg, sellstg, ui.dict_cn, ui.back_count, bl, True,
        ui.df_kp, ui.df_kd, False
    ))

    # 4. ICOSBackTest 프로세스 시작
    ui.proc_icos = Process(
        target=ICOSBackTest,
        args=(ui.windowQ, ui.backQ, ui.soundQ, ui.totalQ, ...)
    )
    ui.proc_icos.start()
```

### 2.3 ICOSBackTest 클래스 실행 흐름

```
ICOSBackTest.__init__() (backtester/backtest_icos.py:299)
    │
    └── ICOSLoop() 호출 (line 382)
         │
         ├── [ICOS 시작 안내 로그]
         │   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         │   🚀 ICOS (Iterative Condition Optimization System) 시작
         │   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         │   [ICOS 단계 안내]
         │     1️⃣ 초기화: 파라미터 수신 및 전략 로드
         │     2️⃣ 반복 최적화: 백테스트 → 분석 → 필터 생성 → 조건식 개선
         │     3️⃣ 수렴 검사: 개선율 기준 수렴 여부 판단
         │     4️⃣ 최종 백테스트: 최적화된 조건식으로 결과 생성
         │   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         │
         ├── 📥 1단계: backQ에서 파라미터 수신
         │   data = self.bq.get()
         │   _parse_backq_data(data)
         │   └── strategy.db에서 전략 코드 조회
         │
         ├── 🔄 2단계: 반복 최적화 루프
         │   while current_iteration < max_iterations:
         │       │
         │       ├── 진행률 업데이트 (0~80%)
         │       │
         │       ├── [2.1] 백테스트 실행
         │       │   _run_backtest_iteration()
         │       │       │
         │       │       ├── ICOSTotal 프로세스 시작
         │       │       │   └── totalQ 모니터링 & 결과 집계
         │       │       │
         │       │       ├── bstq_list에 '백테정보' 전송
         │       │       ├── totalQ에 '백테정보' 전송
         │       │       ├── bstq_list에 '백테시작' 전송
         │       │       ├── beq_list에 '백테정보' 전송
         │       │       │   └── 백엔진이 백테스트 수행
         │       │       │   └── 백엔진 → totalQ로 '백테완료' 전송
         │       │       │   └── ICOSTotal이 결과 집계
         │       │       │
         │       │       └── mq.get(timeout=600)으로 결과 수신
         │       │
         │       ├── [2.2] 결과 분석
         │       │   analyzer.analyze(df_tsg)
         │       │   └── 손실 패턴 추출
         │       │
         │       ├── [2.3] 필터 생성
         │       │   filter_gen.generate(analysis)
         │       │   └── 손실 방지 필터 후보 생성
         │       │
         │       ├── [2.4] 조건식 개선
         │       │   condition_builder.build(...)
         │       │   └── 필터를 조건식에 통합
         │       │
         │       └── [2.5] 수렴 검사
         │           convergence_checker.check(...)
         │           └── 개선율 < 임계값 → 수렴
         │
         ├── 🎯 4단계: 최종 백테스트 실행 (90%)
         │   _run_final_backtest()
         │       │
         │       ├── 그래프 옵션 로그 출력
         │       │   └── dict_set['그래프띄우지않기'] 확인
         │       │
         │       ├── Total 프로세스 시작 (기존 Total 클래스 재사용)
         │       │
         │       └── back_club=False로 설정
         │           └── 그래프 옵션이 적용됨!
         │
         └── 🏁 완료 (100%)
             ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
             🏁 ICOS 완료 - 총 N회 반복, 소요시간 HH:MM:SS
             ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 3. 프로세스 간 통신 구조

### 3.1 큐 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        메인 윈도우 (UI)                           │
│                                                                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐             │
│  │ windowQ │  │ backQ   │  │ totalQ  │  │ soundQ  │             │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘             │
│       │            │            │            │                   │
│       │            │            │            │                   │
│  ┌────┴────────────┴────────────┴────────────┴────────────────┐ │
│  │                    back_eques (beq_list)                    │ │
│  │  [beq0] [beq1] [beq2] [beq3] [beq4] ... [beqN]              │ │
│  │    │      │      │      │      │           │                │ │
│  │    ▼      ▼      ▼      ▼      ▼           ▼                │ │
│  │  BackEngine 프로세스들 (멀티코어 분산 처리)                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    back_sques (bstq_list)                   │ │
│  │  [bstq0] [bstq1] [bstq2] [bstq3] [bstq4]                    │ │
│  │    │       │       │       │       │                        │ │
│  │    ▼       ▼       ▼       ▼       ▼                        │ │
│  │  BackSum 프로세스들 (결과 집계)                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 프로세스 관계도

```
┌─────────────────────────────────────────────────────────────────┐
│                      메인 프로세스 (PyQt5 GUI)                    │
├─────────────────────────────────────────────────────────────────┤
│  windowQ ← 로그 수신 및 UI 업데이트                               │
│  backQ   → 백테스트 파라미터 전송                                 │
└───────┬─────────────────────────────────────────────────────────┘
        │
        │ Process(target=ICOSBackTest, ...)
        ▼
┌───────────────────────────────────────────────────────────────┐
│                     ICOSBackTest 프로세스                       │
│                                                                │
│  ICOSLoop()                                                    │
│    │                                                           │
│    ├── _parse_backq_data()  ← backQ에서 파라미터 수신           │
│    │                                                           │
│    ├── _run_backtest_iteration()                               │
│    │       │                                                   │
│    │       ├── Process(target=ICOSTotal, ...)                  │
│    │       │              ▼                                    │
│    │       │   ┌────────────────────────┐                     │
│    │       │   │    ICOSTotal 프로세스   │                     │
│    │       │   │                        │                     │
│    │       │   │  MainLoop()            │                     │
│    │       │   │   ├── totalQ.get()     │ ← 백엔진 결과 대기   │
│    │       │   │   ├── 결과 집계         │                     │
│    │       │   │   └── mq.put(result)   │ → 부모에게 결과 전달 │
│    │       │   └────────────────────────┘                     │
│    │       │                                                   │
│    │       └── mq.get() ← 결과 수신                            │
│    │                                                           │
│    ├── analyzer.analyze() → filter_gen.generate()              │
│    ├── condition_builder.build() → convergence_checker.check() │
│    │                                                           │
│    └── _run_final_backtest()                                   │
│            │                                                   │
│            └── Process(target=Total, ...)  ← 기존 Total 재사용 │
│                        ▼                                       │
│             ┌────────────────────────┐                        │
│             │     Total 프로세스      │                        │
│             │                        │                        │
│             │  Report()              │                        │
│             │   ├── 결과 DB 저장      │                        │
│             │   ├── 그래프 옵션 확인   │ ← back_club=False     │
│             │   │   └── 그래프띄우지않기 옵션 적용              │
│             │   └── PltShow() 호출    │                        │
│             └────────────────────────┘                        │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                  백테스트 엔진 프로세스들 (N개)                   │
│                                                                │
│  BackEngine.__init__()                                        │
│      │                                                        │
│      └── MainLoop()                                           │
│              │                                                │
│              ├── beq.get() ← 명령 대기                         │
│              │                                                │
│              ├── if back_type == '백테스트':  ← ICOS도 이 분기 사용 │
│              │       if data[0] == '백테정보':                 │
│              │           BackTest() 실행                      │
│              │           tq.put(('백테완료', ...))             │
│              │                                                │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. 해결된 문제점

### 4.1 백테유형 'ICOS' 문제 (해결됨 ✅)

**문제:**
- 초기 구현에서 `('백테유형', 'ICOS')`를 전송했으나
- 백엔진에는 'ICOS' 분기가 없어 백테스트가 실행되지 않음

**해결:**
- `('백테유형', '백테스트')`로 변경
- ICOS의 개별 백테스트는 기본 백테스트와 동일하므로 기존 분기 재사용

**수정 위치:** `ui/ui_button_clicked_sd.py:217-218`

### 4.2 그래프 옵션 미연동 문제 (해결됨 ✅)

**문제:**
- `_run_final_backtest()`에서 `back_club=True`로 설정하여
- `dict_set['그래프띄우지않기']` 옵션이 무시됨
- "그래프 띄우지 않기" 체크해도 그래프가 표시됨

**해결:**
- `back_club=False`로 변경하여 그래프 옵션 적용
- Total.Report()에서 `dict_set['그래프띄우지않기']` 확인

**수정 위치:** `backtester/backtest_icos.py:758`

### 4.3 단계별 로그 미흡 문제 (해결됨 ✅)

**문제:**
- ICOS 실행 시 진행 단계가 불명확
- 사용자가 현재 상태를 파악하기 어려움

**해결:**
- ICOS 시작 시 단계 안내 메시지 추가
- 각 단계별 상세 로그 (1단계: 초기화, 2단계: 반복 최적화, 등)
- 이모지 및 구분선으로 가시성 향상

**수정 위치:** `backtester/backtest_icos.py:392-427, 451-577`

### 4.4 진행바 미표시 문제 (해결됨 ✅)

**문제:**
- ICOS 실행 중 진행바가 업데이트되지 않음

**해결:**
- 반복 루프에서 진행률 계산 (0~80%)
- 최종 백테스트 시작 시 90%
- 완료 시 100%

**수정 위치:** `backtester/backtest_icos.py:460-461, 580-590`

---

## 5. 그래프 옵션 동작 방식

### 5.1 Total.Report() 내부 로직

```python
# backtester/backtest.py:218-253

def Report(self, list_tsg, arry_bct):
    # ... 결과 처리 ...

    if self.back_club:
        # back_club=True: 그래프 옵션 무시, 항상 표시
        PltShow(..., self.dict_set['그래프띄우지않기'], ...)
        # ↑ 실제로는 이 경우 항상 그래프 표시

    else:
        # back_club=False: 그래프 옵션 적용
        if not self.dict_set['그래프저장하지않기']:
            PltShow(..., self.dict_set['그래프띄우지않기'], ...)
            # ↑ 그래프띄우지않기=True면 표시 안 함
```

### 5.2 ICOS에서의 설정

```python
# backtester/backtest_icos.py:750-758

# back_club=False로 설정하여 dict_set['그래프띄우지않기'] 옵션 적용
# back_club=True면 그래프 옵션 무시하고 항상 표시됨
self.tq.put((
    '백테정보', self.betting, self.avgtime, ...,
    self.df_kp, self.df_kd, False  # back_club=False
))
```

---

## 6. 설정 파일

### 6.1 ICOS 설정 (`_database/icos_analysis_config.json`)

```json
{
  "icos": {
    "enabled": true,           // ICOS 활성화 여부
    "max_iterations": 5,       // 최대 반복 횟수
    "convergence_threshold": 5 // 수렴 임계값 (%)
  },
  "analysis": {
    // 분석 관련 설정
  }
}
```

### 6.2 백테스트 옵션 (DICT_SET)

```python
# utility/setting.py

DICT_SET = {
    '그래프띄우지않기': False,  # True면 그래프 표시 안 함
    '그래프저장하지않기': False,  # True면 그래프 저장 안 함
    # ...
}
```

---

## 7. 구현 체크리스트

- [x] `('백테유형', 'ICOS')` → `('백테유형', '백테스트')` 변경
- [x] `back_club=True` → `back_club=False` 변경 (그래프 옵션 적용)
- [x] ICOS 시작 시 단계별 안내 메시지 추가
- [x] 각 반복 단계별 상세 로그 추가
- [x] 진행바 업데이트 로직 추가 (0%→80%→90%→100%)
- [x] 그래프 옵션 상태 로그 출력

---

## 8. 관련 파일

### 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| `backtester/backtest_icos.py` | 그래프 옵션 연동, 단계별 로그, 진행바 |
| `ui/ui_button_clicked_sd.py` | 백테유형 '백테스트'로 변경 |

### 참조 파일

| 파일 | 용도 |
|------|------|
| `backtester/backtest.py` | Total.Report() 그래프 옵션 로직 |
| `backtester/backengine_*.py` | 백엔진 back_type 분기 처리 |
| `ui/ui_button_clicked_icos.py` | ICOS 설정 수집 함수 |

---

## 9. 커밋 히스토리

| 커밋 해시 | 날짜 | 내용 |
|----------|------|------|
| `e2f766d9` | 2026-01-19 | feat(icos): 기존 백테스트 엔진 완전 통합 - ICOSBackTest 클래스 구현 |
| `872feb0` | 2026-01-19 | fix(icos): ConditionBuilder, IterationStorage config 인자 누락 수정 |
| `feeeb77` | 2026-01-19 | fix(icos): 백테유형 'ICOS' → '백테스트' 변경 - 백엔진 호환성 해결 |
| (현재) | 2026-01-19 | fix(icos): 그래프 옵션 연동, 단계별 로그 추가, 진행바 업데이트 |

---

**작성 완료**: 2026-01-19
**최종 검토**: Claude Code
