# ICOS 버그 수정 및 메인 윈도우 통합

**날짜**: 2026-01-17
**작성자**: Claude Code
**Commit**: 395f11f

---

## 개요

ICOS (Iterative Condition Optimization System)가 실행되지 않던 문제를 해결하고, 메인 윈도우의 백테스트 버튼에서도 ICOS를 실행할 수 있도록 통합했습니다.

### 주요 변경사항

1. **SyntaxError 버그 수정**: 전략 코드 로딩 시 조건식 이름 제거
2. **메인 윈도우 통합**: 주식 백테스트 버튼(`svj_button_clicked_11`)에 ICOS 지원 추가
3. **코드 재사용**: 스케줄러와 메인 윈도우가 공통 함수 사용

---

## 문제 분석

### 1. 발견된 문제

#### 문제 1: 메인 윈도우에서 ICOS 미실행
- **증상**: 메인 윈도우 백테스트 버튼 클릭 시 일반 백테스트만 실행됨
- **원인**: `ui/ui_button_clicked_svj.py:svj_button_clicked_11()` 함수에 ICOS 체크 로직 부재
- **영향**: 사용자가 선호하는 실행 방법(메인 윈도우)에서 ICOS 사용 불가

#### 문제 2: 전략 코드 컴파일 시 SyntaxError
- **증상**:
  ```
  File "<string>", line 1
    Min_B_Study_251227if 매수:
                         ^^
  SyntaxError: invalid syntax
  ```
- **원인**: 데이터베이스에 저장된 전략 코드에 조건식 이름이 붙어있음
  - 저장 형식: `"Min_B_Study_251227if 매수:"` (인라인)
  - 저장 형식: `"Min_B_Study_251227\nif 매수:"` (개행)
- **영향**: ICOS 실행 시 Python 코드 컴파일 실패

#### 문제 3: 두 개의 실행 경로
- **스케줄러 경로** (`Alt+B`): `ui/ui_button_clicked_sd.py:sdbutton_clicked_02()`
  - ICOS 지원 O
- **메인 윈도우 경로**: `ui/ui_button_clicked_svj.py:svj_button_clicked_11()`
  - ICOS 지원 X (수정 전)

---

## 해결 방법

### 1. SyntaxError 버그 수정

**파일**: `backtester/iterative_optimizer/backtest_sync.py`

#### 추가된 메서드: `_strip_condition_name()`

```python
def _strip_condition_name(self, strategy_code: str, keyword: str) -> str:
    """전략 코드에서 조건식 이름 제거.

    DB 저장 형식:
        - "조건식이름if 매수:" (인라인)
        - "조건식이름\nif 매수:" (개행)

    변환 결과:
        - "if 매수:"

    Args:
        strategy_code: 원본 전략 코드
        keyword: 찾을 키워드 ("if 매수:", "if 매도:" 등)

    Returns:
        조건식 이름이 제거된 코드
    """
    if not strategy_code or keyword not in strategy_code:
        return strategy_code

    before_keyword = strategy_code.split(keyword)[0]

    # 인라인 형식: 개행 없이 바로 붙어있음
    if '\n' not in before_keyword:
        # 조건식 이름인지 확인 (if, def, class, import 등이 없으면 조건식 이름)
        if before_keyword.strip() and not any(kw in before_keyword for kw in ['if', 'def', 'class', 'import']):
            return strategy_code.replace(before_keyword, '', 1).lstrip()

    # 개행 형식: 첫 번째 라인이 조건식 이름
    else:
        lines = strategy_code.split('\n')
        first_line = lines[0].strip()
        # 첫 라인이 조건식 이름인지 확인
        if first_line and not any(kw in first_line for kw in ['if', 'def', 'class', 'import', '=']):
            return '\n'.join(lines[1:])

    return strategy_code
```

#### 수정된 메서드: `_load_strategy_from_db()`

전략 로딩 시 조건식 이름 제거 로직 추가:

```python
def _load_strategy_from_db(self, 전략명: str) -> tuple[str, str]:
    # ... 기존 DB 로딩 코드 ...

    # 조건식 이름 제거
    if 매수전략:
        매수전략 = self._strip_condition_name(매수전략, "if 매수:")

    if 매도전략:
        매도전략 = self._strip_condition_name(매도전략, "if 매도:")

    return 매수전략, 매도전략
```

**효과**:
- DB에서 로드한 전략 코드가 Python 컴파일러에서 정상 처리됨
- 인라인/개행 형식 모두 지원

---

### 2. 메인 윈도우 ICOS 통합

**파일**: `ui/ui_button_clicked_svj.py`

#### 추가된 import (Line 12)
```python
from utility.setting import ui_num
```

#### 수정된 함수: `svj_button_clicked_11()` (Lines 672-702)

스케줄러와 동일한 ICOS 체크 로직 추가:

```python
def svj_button_clicked_11(ui):
    # ... 기존 validation 코드 ...

    # ===== ICOS 체크 추가 =====
    from ui.ui_button_clicked_sd import _check_icos_enabled, _run_icos_backtest

    icos_enabled = _check_icos_enabled(ui)

    if icos_enabled:
        ui.windowQ.put((ui_num['S백테스트'],
            '<font color=#7cfc00>[ICOS] ICOS 모드 활성화됨 - 반복적 조건식 개선이 실행됩니다.</font>'))

        # back_schedul 플래그 임시 비활성화
        original_schedul = getattr(ui, 'back_schedul', False)
        ui.back_schedul = False

        # ICOS 백테스트 실행
        _run_icos_backtest(
            ui=ui,
            bt_gubun='주식',
            buystg=buystg,
            sellstg=sellstg,
            startday=startday,
            endday=endday,
            starttime=starttime,
            endtime=endtime,
            betting=betting,
            avgtime=avgtime
        )

        # 플래그 복원
        ui.back_schedul = original_schedul
        return  # ICOS 실행 후 조기 종료

    # ===== 일반 백테스트 계속 =====
    # ... 기존 백테스트 로직 ...
```

**주요 특징**:
1. **공통 함수 재사용**: 스케줄러와 동일한 `_check_icos_enabled()`, `_run_icos_backtest()` 사용
2. **조기 종료**: ICOS 실행 시 일반 백테스트 건너뜀
3. **플래그 관리**: `back_schedul` 플래그를 임시로 `False`로 설정하여 ICOS 실행 보장

---

### 3. 아키텍처 개선

#### 공통 함수 (ui/ui_button_clicked_sd.py)

**함수 1: `_check_icos_enabled(ui) -> bool`**
- ICOS 활성화 여부 확인
- 우선순위: 설정 파일 > 레거시 파일 > UI 속성 > 기본값(False)

**함수 2: `_run_icos_backtest(...)`**
- ICOS 백테스트 실행
- 멀티프로세스 큐를 통한 프로세스 실행

#### 실행 경로 통합

이제 두 경로 모두 ICOS 지원:

```
메인 윈도우 경로:
  svj_button_clicked_11()
    → _check_icos_enabled()
    → _run_icos_backtest()
    → backQ.put(...)

스케줄러 경로:
  sdbutton_clicked_02()
    → _check_icos_enabled()
    → _run_icos_backtest()
    → backQ.put(...)
```

---

## 테스트 방법

### 1. ICOS 활성화 확인

`_database/icos_analysis_config.json` 파일 확인:

```json
{
  "analysis": {
    "enabled": true,
    ...
  },
  "icos": {
    "enabled": true,
    "max_iterations": 5,
    "convergence_threshold": 5,
    "optimization_metric": "profit",
    "optimization_method": "grid_search"
  }
}
```

### 2. 메인 윈도우에서 실행

1. STOM 실행: `stom_stock.bat`
2. 백테스트 탭 선택
3. 전략 선택 및 기간 설정
4. **"백테스트 시작" 버튼 클릭**
5. 로그 확인:
   ```
   [ICOS] ICOS 모드 활성화됨 - 반복적 조건식 개선이 실행됩니다.
   [ICOS] 반복 1/5 시작...
   ```

### 3. 스케줄러에서 실행

1. STOM 실행: `stom_stock.bat`
2. **`Alt+B`** 키 입력 (스케줄러 대화상자)
3. 전략 선택 및 스케줄 설정
4. "실행" 버튼 클릭
5. 동일한 ICOS 로그 확인

### 4. 디버깅 파일 확인

ICOS 실행 시 자동 생성:
- `_database/icos_debug.txt`: ICOS 상세 로그
- 로그 예시:
  ```
  [2026-01-17 10:00:00] ICOS 시작
  [2026-01-17 10:00:01] 전략 로드: Min_B_Study_251227
  [2026-01-17 10:00:02] 반복 1/5: 수익률 +3.5%
  ```

---

## 사용 가이드

### 기본 사용법

1. **ICOS 설정 파일 생성** (최초 1회):
   ```json
   {
     "icos": {
       "enabled": true,
       "max_iterations": 5
     }
   }
   ```
   파일 위치: `_database/icos_analysis_config.json`

2. **메인 윈도우에서 실행**:
   - 백테스트 탭 → 전략 선택 → "백테스트 시작" 클릭
   - ICOS 활성화 메시지 확인

3. **스케줄러에서 실행**:
   - `Alt+B` → 전략 선택 → "실행" 클릭
   - 동일한 ICOS 실행

### 문제 해결

#### ICOS가 실행되지 않을 때
1. `_database/icos_analysis_config.json` 파일 존재 확인
2. `"icos.enabled": true` 설정 확인
3. 로그에서 ICOS 활성화 메시지 확인

#### SyntaxError 발생 시
- 이번 업데이트로 해결됨
- 여전히 발생 시: `_database/icos_debug.txt` 로그 확인

#### 일반 백테스트만 실행될 때
- ICOS 설정 파일 재확인
- UI에서 ICOS 옵션 활성화 여부 확인

---

## 기술 세부사항

### 조건식 이름 제거 알고리즘

**입력 패턴 1 (인라인)**:
```python
"Min_B_Study_251227if 매수:"
```

**입력 패턴 2 (개행)**:
```python
"""Min_B_Study_251227
if 매수:"""
```

**출력 (공통)**:
```python
"if 매수:"
```

**처리 로직**:
1. `keyword` 앞부분 추출 (`before_keyword`)
2. 개행 포함 여부 확인
3. 인라인: 조건식 이름 직접 제거
4. 개행: 첫 라인 제거

### 멀티프로세스 아키텍처

```
메인 프로세스 (PyQt5 GUI)
  ↓
windowQ.put(ICOS 활성화 메시지)
  ↓
backQ.put({
  '백테스트': '주식',
  '전략명': 'Min_B_Study_251227',
  'icos_enabled': True,
  ...
})
  ↓
백테스터 프로세스 실행
  ↓
BacktestSync 초기화
  ↓
_load_strategy_from_db()
  ↓
_strip_condition_name()  # 조건식 이름 제거
  ↓
전략 코드 컴파일
  ↓
ICOS 반복 실행 (최대 5회)
```

---

## 관련 파일

### 수정된 파일
1. `backtester/iterative_optimizer/backtest_sync.py`
   - `_strip_condition_name()` 메서드 추가 (Lines 168-199)
   - `_load_strategy_from_db()` 수정 (Lines 201-251)

2. `ui/ui_button_clicked_svj.py`
   - `svj_button_clicked_11()` ICOS 통합 (Lines 672-702)
   - `ui_num` import 추가 (Line 12)

### 참조 파일
- `ui/ui_button_clicked_sd.py`: 공통 함수 위치
- `_database/icos_analysis_config.json`: ICOS 설정 파일

---

## Commit 정보

**Commit Hash**: 395f11f
**Commit Message**:
```
feat(icos): 파일 무결성 검증 시스템 추가

- SyntaxError 버그 수정: 전략 코드에서 조건식 이름 제거
- 메인 윈도우 ICOS 통합: svj_button_clicked_11에 ICOS 지원 추가
- 공통 함수 재사용: _check_icos_enabled, _run_icos_backtest
- 인라인/개행 형식 모두 지원하는 _strip_condition_name 구현
```

**변경된 파일**:
- `backtester/iterative_optimizer/backtest_sync.py`
- `ui/ui_button_clicked_svj.py`

---

## 향후 개선 사항

1. **ICOS 설정 UI**: 설정 파일 수동 편집 대신 GUI 제공
2. **진행률 표시**: ICOS 반복 진행률 실시간 표시
3. **결과 비교**: 반복별 성능 비교 차트
4. **자동 저장**: 개선된 조건식 자동 저장 옵션

---

## 참고 자료

- ICOS 아키텍처: `docs/Manual/08_Backtesting/`
- 백테스팅 가이드라인: `docs/Guideline/Back_Testing_Guideline_Tick.md`
- 멀티프로세스 큐: `docs/Manual/02_Architecture/`

---

**작성 완료**: 2026-01-17
**최종 검토**: Claude Code
