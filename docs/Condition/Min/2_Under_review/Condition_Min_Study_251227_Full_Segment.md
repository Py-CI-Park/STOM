# 조건식(Condition) - Min_B_Study_251227 세그먼트 필터 통합

- STOM 주식 자동거래에 사용하기 위한 분봉 조건식 문서
- [[Back_Testing_Guideline_Min]] 을(를) 기반으로 작성
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조 적용

---

## 1. 개요

본 문서는 **Min_B_Study_251227 매수/매도 조건식**에
**세그먼트 필터 전역 조합(Global Best)**을 통합한 최종 조건식을 정리합니다.

- **전략 버전**: Min_B_Study_251227_Full_Segment
- **대상 백테스트**: `stock_bt_Min_B_Study_251227_20251229173431`
- **핵심 목표**: 세그먼트 필터 결과를 매수 조건식에 직접 반영하여
  성과 개선 및 재현 가능한 최종 조건식 확보

---

## 2. 참고/입력 파일

**백테스트 결과 폴더**:
- `backtester/backtesting_output/stock_bt_Min_B_Study_251227_20251229173431/`

**핵심 산출물**:
- `stock_bt_Min_B_Study_251227_20251229173431_segment_filtered.png`
- `stock_bt_Min_B_Study_251227_20251229173431_segment_combos.csv`
- `stock_bt_Min_B_Study_251227_20251229173431_segment_code.txt`
- `stock_bt_Min_B_Study_251227_20251229173431_segment_ranges.csv`
- `stock_bt_Min_B_Study_251227_20251229173431_segment_summary_full.txt`
- `stock_bt_Min_B_Study_251227_20251229173431_report.txt`
- `stock_bt_Min_B_Study_251227_20251229173431_condition_study.md`

**최종 통합 조건식(신규)**:
- `stock_bt_Min_B_Study_251227_20251229173431_segment_code_final.txt`
  - `analysis_enhanced/runner.py` 실행 시 자동 생성
  - `segment_summary_full.txt`에 경로 기록
  - 텔레그램 알림: `최종 작성 업데이트 된 조건식 파일: <path>`

---

## 3. 원본 매수 조건식 (Min_B_Study_251227)

```python
# 분봉 기반 변수 정의
전일종가 = 현재가 / (1 + (등락율 / 100))  # 단위: 원
시가등락율 = ((분봉시가 - 전일종가) / 전일종가) * 100  # 단위: 퍼센트
시가대비등락율 = ((현재가 - 분봉시가) / 분봉시가) * 100  # 단위: 퍼센트
분당순매수금액 = (분당매수수량 - 분당매도수량) * 현재가 / 1_000_000  # 단위: 백만원
누적거래대금비율 = 당일거래대금 / (시가총액 * 회전율 / 100) * 100 if (시가총액 * 회전율 / 100) != 0 else 0

매수 = True

# 공통 선결 조건
if not (관심종목 == 1):
    매수 = False
elif not (0 < 현재가 <= 50000):
    매수 = False
elif not (1.0 < 등락율 <= 20.0):
    매수 = False
elif not (고저평균대비등락율 > 0):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not (분당거래대금 > 분당거래대금N(1) * 0.0):
    매수 = False
elif 시분초 < 120000:
    if 시가총액 < 100000:
        if not (-1.0 <= 시가등락율 < 20.0):
            매수 = False
        elif not (0 <= 시가대비등락율 < 20.0):
            매수 = False
        elif not (5 < 분당순매수금액 < 10 * 100):
            매수 = False
        elif not (현재가 > (분봉고가 - (분봉고가 - 분봉저가) * 80 / 100)):
            매수 = False
        elif not (전일비 > 0):
            매수 = False
        elif not (전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 0):
            매수 = False
        elif not (당일거래대금 > 1 * 100):
            매수 = False
    else:
        매수 = False
else:
    매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

---

## 4. 원본 매도 조건식 (Min_S_Study_251227)

```python
# 분봉 기반 변수 정의
시가대비등락율 = ((현재가 - 분봉시가) / 분봉시가) * 100  # 단위: 퍼센트

매도 = False

if 등락율 > 29.5:
    매도 = True
elif 보유시간 > 10 and 현재가 < 최저현재가(30, 보유시간):
    매도 = True
elif 시가대비등락율 < 0 and 수익률 <= -2.0 and 현재가 < 최저현재가(30, 보유시간):
    매도 = True
elif 시분초 < 151500:
    if 10 <= 수익률:
        매도 = True
    elif 수익률 <= -5.0:
        매도 = True
    elif 최고수익률 > 7 and 최고수익률 * 0.7 >= 수익률:
        매도 = True
    elif 시가총액 < 10000:
        if 5 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
            매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

---

## 5. 최종 통합 조건식 (세그먼트 필터 반영)

아래 조건식은 `*_segment_code_final.txt`와 동일한 구성으로,
매수 조건식에 세그먼트 필터(`필터통과`)를 결합한 최종 형태입니다.

```python
# ==================================
# Min_B_Study_251227 + Segment Filter
# ==================================

# [기본 변수]
전일종가 = 현재가 / (1 + (등락율 / 100))
시가등락율 = ((분봉시가 - 전일종가) / 전일종가) * 100
시가대비등락율 = ((현재가 - 분봉시가) / 분봉시가) * 100
분당순매수금액 = (분당매수수량 - 분당매도수량) * 현재가 / 1_000_000
누적거래대금비율 = 당일거래대금 / (시가총액 * 회전율 / 100) * 100 if (시가총액 * 회전율 / 100) != 0 else 0

# [세그먼트 필터용 파생 변수]
초당매수수량 = 분당매수수량 / 60
초당매도수량 = 분당매도수량 / 60
초당매도_매수_비율 = 초당매도수량 / (초당매수수량 + 1e-6)
초당순매수금액 = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000
초당순매수수량 = 초당매수수량 - 초당매도수량
매수스프레드 = ((매도호가1 - 매수호가1) / 매수호가1) * 100 if 매수호가1 > 0 else 0
매수호가잔량비 = (매수총잔량 / (매도총잔량 + 1e-6)) * 100
매수변동폭 = 고가 - 저가
매수변동폭비율 = ((고가 - 저가) / 저가) * 100 if 저가 > 0 else 0
현재가_고저범위_위치 = (현재가 - 저가) / (고가 - 저가 + 1e-6) * 100
초당매수수량_매도총잔량_비율 = (초당매수수량 / (매도총잔량 + 1e-6)) * 100
당일거래대금_전틱분봉_비율 = 당일거래대금 / (당일거래대금N(1) + 1e-6)
매수초당거래대금 = 분당거래대금 / 60

# [매수 시점 스냅샷 변수 매핑]
매수매수호가1 = 매수호가1
매수매도호가1 = 매도호가1
매수매수총잔량 = 매수총잔량
매수매도총잔량 = 매도총잔량
매수전일비 = 전일비
매수전일동시간비 = 전일동시간비
매수체결강도 = 체결강도
매수등락율 = 등락율
매수시가등락율 = 시가등락율
매수회전율 = 회전율
매수당일거래대금 = 당일거래대금
매수가 = 현재가
매수금액 = 현재가 * 매수수량
매수시간 = 시분초  # 실전에서는 날짜까지 포함한 타임스탬프로 교체 필요

# [위험도 점수]
위험도점수 = 0
if 등락율 >= 20: 위험도점수 += 20
if 등락율 >= 25: 위험도점수 += 10
if 등락율 >= 30: 위험도점수 += 10
if 체결강도 < 80: 위험도점수 += 15
if 체결강도 < 60: 위험도점수 += 10
if 체결강도 >= 150: 위험도점수 += 10
if 체결강도 >= 200: 위험도점수 += 10
if 체결강도 >= 250: 위험도점수 += 10
if 당일거래대금 / 100 < 50: 위험도점수 += 15
if 당일거래대금 / 100 < 100: 위험도점수 += 10
if 시가총액 < 1000: 위험도점수 += 15
if 시가총액 < 5000: 위험도점수 += 10
if 매수호가잔량비 < 90: 위험도점수 += 10
if 매수호가잔량비 < 70: 위험도점수 += 15
if 매수스프레드 >= 0.5: 위험도점수 += 10
if 매수스프레드 >= 1.0: 위험도점수 += 10
if 회전율 < 10: 위험도점수 += 5
if 회전율 < 5: 위험도점수 += 10
if 매수변동폭비율 >= 7.5: 위험도점수 += 10
if 매수변동폭비율 >= 10: 위험도점수 += 10
if 매수변동폭비율 >= 15: 위험도점수 += 10
위험도점수 = min(100, 위험도점수)

# ================================
# 1) 원본 매수 조건식
# ================================
매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (0 < 현재가 <= 50000):
    매수 = False
elif not (1.0 < 등락율 <= 20.0):
    매수 = False
elif not (고저평균대비등락율 > 0):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not (분당거래대금 > 분당거래대금N(1) * 0.0):
    매수 = False
elif 시분초 < 120000:
    if 시가총액 < 100000:
        if not (-1.0 <= 시가등락율 < 20.0):
            매수 = False
        elif not (0 <= 시가대비등락율 < 20.0):
            매수 = False
        elif not (5 < 분당순매수금액 < 10 * 100):
            매수 = False
        elif not (현재가 > (분봉고가 - (분봉고가 - 분봉저가) * 80 / 100)):
            매수 = False
        elif not (전일비 > 0):
            매수 = False
        elif not (전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 0):
            매수 = False
        elif not (당일거래대금 > 1 * 100):
            매수 = False
    else:
        매수 = False
else:
    매수 = False

# ================================
# 2) 세그먼트 필터 (Global Best)
# ================================
필터통과 = False

# [대형주_T1_092900_095900]
if (시가총액 >= 10000 and 시분초 >= 92900 and 시분초 < 95900):
    if ((매수매수호가1 < 52025) and (매수매도호가1 >= 9902)):
        필터통과 = True

# [대형주_T2_095900_102900]
if (시가총액 >= 10000 and 시분초 >= 95900 and 시분초 < 102900):
    if ((매수시간 >= 202505122018.9) and (매수호가잔량비 >= 47840) and (매수초당거래대금 < 20251021080015)):
        필터통과 = True

# [대형주_T3_102900_105900]
if (시가총액 >= 10000 and 시분초 >= 102900 and 시분초 < 105900):
    if ((매수시가등락율 < 15.122) and (매수금액 < 20030820.8) and (현재가_고저범위_위치 >= 51.4885)):
        필터통과 = True

# [대형주_T4_105900_112900]
if (시가총액 >= 10000 and 시분초 >= 105900 and 시분초 < 112900):
    if ((매수시간 < 202511191109.5) and (현재가_고저범위_위치 < 93.2121) and (매수호가잔량비 < 88560)):
        필터통과 = True

# [대형주_T5_112900_115900]
if (시가총액 >= 10000 and 시분초 >= 112900 and 시분초 < 115900):
    if ((시가총액 >= 11318) and (초당매도_매수_비율 < 0.677717) and (매수등락율 < 12.122)):
        필터통과 = True

# [소형주_T1_092900_095900]
if (시가총액 >= 2500 and 시가총액 < 5000 and 시분초 >= 92900 and 시분초 < 95900):
    if ((초당매도_매수_비율 >= 0.145838) and (초당순매수금액 < 617.07) and (매수가 < 4702.2)):
        필터통과 = True

# [소형주_T2_095900_102900]
if (시가총액 >= 2500 and 시가총액 < 5000 and 시분초 >= 95900 and 시분초 < 102900):
    if ((매수매수호가1 >= 4476.6) and (매수변동폭 < 3750) and (시가총액 >= 4078.6)):
        필터통과 = True

# [소형주_T3_102900_105900]
if (시가총액 >= 2500 and 시가총액 < 5000 and 시분초 >= 102900 and 시분초 < 105900):
    if ((매수변동폭비율 >= 6.0478) and (시가총액 >= 2851.2) and (당일거래대금_전틱분봉_비율 < 4.445)):
        필터통과 = True

# [소형주_T4_105900_112900]
if (시가총액 >= 2500 and 시가총액 < 5000 and 시분초 >= 105900 and 시분초 < 112900):
    if ((매수호가잔량비 >= 42950) and (매수전일비 >= 53.65) and (매수전일동시간비 >= 1212.66)):
        필터통과 = True

# [소형주_T5_112900_115900]
if (시가총액 >= 2500 and 시가총액 < 5000 and 시분초 >= 112900 and 시분초 < 115900):
    if ((매수전일비 >= 65.304) and (매수스프레드 >= 135.28)):
        필터통과 = True

# [중형주_T1_092900_095900]
if (시가총액 >= 5000 and 시가총액 < 10000 and 시분초 >= 92900 and 시분초 < 95900):
    if ((매수호가잔량비 >= 47505) and (매수전일비 < 196.26) and (매수체결강도 >= 94.274)):
        필터통과 = True

# [중형주_T2_095900_102900]
if (시가총액 >= 5000 and 시가총액 < 10000 and 시분초 >= 95900 and 시분초 < 102900):
    if ((매수스프레드 >= -45.125) and (시가총액 < 9182.1) and (초당매도_매수_비율 < 0.225387)):
        필터통과 = True

# [중형주_T3_102900_105900]
if (시가총액 >= 5000 and 시가총액 < 10000 and 시분초 >= 102900 and 시분초 < 105900):
    if ((매수가 < 47877.55) and (매수당일거래대금 < 169796) and (매수체결강도 >= 92.312)):
        필터통과 = True

# [중형주_T4_105900_112900]
if (시가총액 >= 5000 and 시가총액 < 10000 and 시분초 >= 105900 and 시분초 < 112900):
    if ((초당순매수수량 < 44585.7) and (매수금액 < 20038022.8) and (초당매수수량_매도총잔량_비율 >= 11166.8)):
        필터통과 = True

# [중형주_T5_112900_115900]
if (시가총액 >= 5000 and 시가총액 < 10000 and 시분초 >= 112900 and 시분초 < 115900):
    필터통과 = False  # 세그먼트 전체 제외

# [초소형주_T1_092900_095900]
if (시가총액 >= 0 and 시가총액 < 2500 and 시분초 >= 92900 and 시분초 < 95900):
    필터통과 = False  # 세그먼트 전체 제외

# [초소형주_T2_095900_102900]
if (시가총액 >= 0 and 시가총액 < 2500 and 시분초 >= 95900 and 시분초 < 102900):
    필터통과 = False  # 세그먼트 전체 제외

# [초소형주_T3_102900_105900]
if (시가총액 >= 0 and 시가총액 < 2500 and 시분초 >= 102900 and 시분초 < 105900):
    if ((매수변동폭비율 < 31.3684) and (위험도점수 < 75) and (매수변동폭 < 459)):
        필터통과 = True

# [초소형주_T4_105900_112900]
if (시가총액 >= 0 and 시가총액 < 2500 and 시분초 >= 105900 and 시분초 < 112900):
    필터통과 = False  # 세그먼트 전체 제외

# [초소형주_T5_112900_115900]
if (시가총액 >= 0 and 시가총액 < 2500 and 시분초 >= 112900 and 시분초 < 115900):
    필터통과 = False  # 세그먼트 전체 제외

# ================================
# 매수 실행 (세그먼트 필터 결합)
# ================================
매수 = 매수 and 필터통과
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)

# [매도 조건식은 원본 유지]
```

---

## 6. 적용/검증 체크리스트

- [ ] `segment_combos.csv`에서 Global Best 조합 확인
- [ ] `segment_ranges.csv`에서 구간 정의 확인
- [ ] `segment_code_final.txt` 생성 여부 확인
- [ ] 최종 조건식으로 재백테스트 수행
- [ ] `report.txt` 및 `segment_summary_full.txt` 검증

---

## 7. 변경 이력

- 2025-12-29: 원본 조건식 + 세그먼트 필터(Global Best) 통합 정리
- 2025-12-29: 최종 통합 조건식(`*_segment_code_final.txt`) 산출 흐름 반영
