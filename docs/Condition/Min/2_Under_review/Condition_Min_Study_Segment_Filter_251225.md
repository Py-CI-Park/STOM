# 조건식(Condition) - 분봉(Minute) 기반 세그먼트 필터 전략

- STOM 주식 자동거래에 사용하기 위한 분봉 조건식 문서
- [[Back_Testing_Guideline_Min]] 을(를) 기반으로 작성
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

---

## 1. 개요 (Overview)

본 문서는 **분봉 백테스트 스터디(Min_B_Study_251225)** 결과인 세그먼트 필터 코드를 기반으로 작성된 전략입니다. 시가총액 규모와 시간대별로 최적화된 필터링 조건을 적용하여 수익성을 극대화하고 리스크를 관리합니다.

- **전략 시간 구간**: 09:29:00 ~ 15:09:00 (세그먼트 T1 ~ T11)
- **대상 종목 범위**: 시가총액 전체 (대형주/중형주/소형주 세그먼트 분리)
- **전략 타입**: 세그먼트 기반 동적 필터링 (Market-Cap Adaptive Strategy)
- **핵심 변수**: 시가총액, 시분초, 체결강도, 회전율, 거래대금, 스프레드 등
- **업데이트 이력**: 
    - 2025-12-27: 세그먼트 필터 결과 반영 최초 생성

---

## 2. 공통 계산 지표 (Common Indicators)

조건식 및 최적화에서 공통으로 사용되는 지표의 계산식입니다. 본 전략은 세그먼트 필터링 결과의 임계값을 정확히 적용하기 위해 내부 엔진(`metrics.py`)의 계산 공식을 따릅니다.

```python
# ================================
#  공통 계산 지표
# ================================
# [기본 변수 계산]
전일종가 = 현재가 / (1 + (등락율 / 100))
시가등락율 = ((시가 - 전일종가) / 전일종가) * 100         # 일봉 시가 갭
시가대비등락율 = ((현재가 - 분봉시가) / 분봉시가) * 100   # 분봉 시가 대비 등락 (초기 조건식 변수명 유지)
매수분 = (시분초 // 100) % 100

# [세그먼트 필터용 지표 & 호환성 처리]
# Min 엔진용: 분당 -> 초당 변환
if '초당매수수량' not in locals():
    초당매수수량 = 분당매수수량 / 60
    초당매도수량 = 분당매도수량 / 60
# Tick 엔진용: 초당 -> 분당 변환 (혹시 Tick 엔진에서 돌릴 경우 대비)
if '분당매수수량' not in locals():
    분당매수수량 = 초당매수수량 * 60
    분당매도수량 = 초당매도수량 * 60

# [파생 지표]
매수시가등락율 = 시가등락율  # 별칭 매핑
매수스프레드 = ((매도호가1 - 매수호가1) / 매수호가1) * 100  # 퍼센트 스프레드
초당매도_매수_비율 = 초당매도수량 / (초당매수수량 + 1e-6)
매수고저범위위치 = (현재가 - 저가) / (고가 - 저가 + 1e-6) * 100
매도_매수_잔량비율 = 매도총잔량 / (매수총잔량 + 1e-6)
매수호가잔량비 = (매수총잔량 / (매도총잔량 + 1e-6)) * 100 # metrics.py 호환용
매수변동폭 = 고가 - 저가
매수변동폭비율 = ((고가 - 저가) / 저가) * 100
초당순매수금액 = (초당매수수량 - 초당매도수량) * 현재가 / 1000000  # 백만원 단위
분당순매수금액 = (분당매수수량 - 분당매도수량) * 현재가 / 1000000  # 백만원 단위 (초기 조건식용)
누적거래대금비율 = 당일거래대금 / (시가총액 * 회전율 / 100) * 100 if (시가총액 * 회전율 / 100) != 0 else 0

# --------------------------------
# 위험도 점수 (Risk Score) 계산
# --------------------------------
# metrics.py의 CalculateEnhancedDerivedMetrics 로직과 동기화
위험도점수 = 0
# 1) 등락율 과열
if 등락율 >= 20: 위험도점수 += 20
if 등락율 >= 25: 위험도점수 += 10
if 등락율 >= 30: 위험도점수 += 10
# 2) 체결강도 (약세 및 과열)
if 체결강도 < 80: 위험도점수 += 15
if 체결강도 < 60: 위험도점수 += 10
if 체결강도 >= 150: 위험도점수 += 10
if 체결강도 >= 200: 위험도점수 += 10 # 추가
if 체결강도 >= 250: 위험도점수 += 10 # 추가
# 3) 거래대금 부족 (단위: 백만원 -> 억 환산 비교)
if 당일거래대금/100 < 50: 위험도점수 += 15
if 당일거래대금/100 < 100: 위험도점수 += 10
# 4) 시가총액 소형주
if 시가총액 < 1000: 위험도점수 += 15
if 시가총액 < 5000: 위험도점수 += 10
# 5) 호가 잔량비 (매도 우위)
if 매수호가잔량비 < 90: 위험도점수 += 10
if 매수호가잔량비 < 70: 위험도점수 += 15
# 6) 스프레드 (비유동성)
if 매수스프레드 >= 0.5: 위험도점수 += 10
if 매수스프레드 >= 1.0: 위험도점수 += 10
# 7) 회전율 (소외주)
if 회전율 < 10: 위험도점수 += 5   # 추가
if 회전율 < 5: 위험도점수 += 10   # 추가
# 8) 변동성 (과대 변동)
if 매수변동폭비율 >= 7.5: 위험도점수 += 10
if 매수변동폭비율 >= 10: 위험도점수 += 10
if 매수변동폭비율 >= 15: 위험도점수 += 10

위험도점수 = min(100, 위험도점수)

# --------------------------------
# 모멘텀 점수 (Momentum Score) 계산
# --------------------------------
# 실시간 근사치 사용
체결강도_norm = (체결강도 - 100) / 50
등락율_norm = 등락율
모멘텀점수 = (등락율_norm * 0.4 + 체결강도_norm * 0.6) * 10
```

---

## 3. 주식 매수 조건식 (Buy Condition)

**초기 매수 조건식(Min_B_Study_251225)**을 기본 필터로 적용하고, 그 위에 **세그먼트 필터**를 추가 적용하는 구조입니다.

```python
# [C_S_251225_B_Min]
매수 = True

# =========================================================
# 1. Global Basic Filters (공통 선결 조건)
# =========================================================
# - 초기 조건식(Min_B_Study_251225)의 안전장치 반영
# - 대상: 전체 종목 공통 적용
# ---------------------------------------------------------
if not (관심종목 == 1):
    매수 = False
elif not (0 < 현재가 <= 30000):  # 저가~중가주 타겟
    매수 = False
elif not (1.0 < 등락율 <= 20.0): # 급등락 제외 및 최소 등락
    매수 = False
elif not (고저평균대비등락율 > 0): # 추세 확인
    매수 = False
elif not (현재가 < VI아래5호가): # VI 근접 매수 제한
    매수 = False
elif 라운드피겨위5호가이내:        # 저항선 근처 매수 제한
    매수 = False
elif not (분당거래대금 > 분당거래대금N(1) * 1.0): # 거래대금 증가 추세
    매수 = False
elif 시분초 >= 151000:             # 장 마감 임박 매수 제한 (15:10 이후)
    매수 = False


# =========================================================
# 2. Segment Filters (세그먼트별 정밀 필터)
# =========================================================
# - 세그먼트 분석(Min_B_Study_251225) 결과 적용
# - 시가총액 및 시간대별 최적화된 필터링
# ---------------------------------------------------------
if 매수: # 기본 필터를 통과한 경우에만 세그먼트 필터 검사
    
    # ---------------------------------------------------------
    # 2.1 대형주 세그먼트 (시가총액 >= 10,000)
    # ---------------------------------------------------------
    if 시가총액 >= 10000:
        # T11, T5: 세그먼트 전체 제외
        if (143800 <= 시분초 < 150900) or (113300 <= 시분초 < 120400):
            매수 = False
        # T10, T6: 필터 없음 (Pass)
        elif (140700 <= 시분초 < 143800) or (120400 <= 시분초 < 123400):
            pass
        # T1: 09:29~10:00
        elif 92900 <= 시분초 < 100000:
            if not (초당매도_매수_비율 < 0.8309 and 매수스프레드 >= 4.31 and 초당순매수금액 >= 99.02):
                매수 = False
        # T2: 10:00~10:31
        elif 100000 <= 시분초 < 103100:
            if not (당일거래대금 >= 17305 and 고가 < 30440 and 회전율 >= 0.456):
                매수 = False
        # T3: 10:31~11:02
        elif 103100 <= 시분초 < 110200:
            if not (매수분 >= 35 and 등락율 < 18.105):
                매수 = False
        # T4: 110200~113300
        elif 110200 <= 시분초 < 113300:
            if not (매수스프레드 < 131.61 and 위험도점수 >= 30):
                매수 = False
        # T7: 123400~130500
        elif 123400 <= 시분초 < 130500:
            pass 
        # T8: 130500~133600
        elif 130500 <= 시분초 < 133600:
            if not (등락율 < 13.17):
                매수 = False
        # T9: 133600~140700
        elif 133600 <= 시분초 < 140700:
            if not (현재가_고저범위_위치 >= 52.86 and 매수시가등락율 >= -0.211):
                매수 = False
        else:
            매수 = False

    # ---------------------------------------------------------
    # 2.2 중형주 세그먼트 (3,000 <= 시가총액 < 10,000)
    # ---------------------------------------------------------
    elif 3000 <= 시가총액 < 10000:
        # T7: 세그먼트 전체 제외
        if 123400 <= 시분초 < 130500:
            매수 = False
        # T10
        elif 140700 <= 시분초 < 143800:
            if not (전일동시간비 < 121.74 and 전일비 < 95.13):
                매수 = False
        # T11
        elif 143800 <= 시분초 < 150900:
            if not (등락율 < 16.98 and 매도_매수_잔량비율 < 0.00076):
                매수 = False
        # T1
        elif 92900 <= 시분초 < 100000:
            if not (시가총액 >= 3494 and 체결강도 >= 88.6):
                매수 = False
        # T2
        elif 100000 <= 시분초 < 103100:
            if not (모멘텀점수 >= 5.61):
                매수 = False
        # T3
        elif 103100 <= 시분초 < 110200:
            if not (당일거래대금 < 252680 and 회전율 >= 5.4):
                매수 = False
        # T4
        elif 110200 <= 시분초 < 113300:
            if not (매도호가1 < 329496 and 매수변동폭 < 2830):
                매수 = False
        # T5
        elif 113300 <= 시분초 < 120400:
            if not (시가총액 < 8776 and 당일거래대금 < 136661):
                매수 = False
        # T6
        elif 120400 <= 시분초 < 123400:
            if not (매수변동폭비율 >= 8.713):
                 매수 = False
        # T8
        elif 130500 <= 시분초 < 133600:
            if not (모멘텀점수 >= -4.31):
                매수 = False
        # T9
        elif 133600 <= 시분초 < 140700:
            if not (회전율 >= 9.264 and 매수분 < 51.6):
                매수 = False
        else:
            매수 = False

    # ---------------------------------------------------------
    # 2.3 소형주 세그먼트 (시가총액 < 3,000)
    # ---------------------------------------------------------
    else:
        # T1, T2, T4, T6, T9, T11: 세그먼트 전체 제외
        if (92900 <= 시분초 < 110200) or (110200 <= 시분초 < 113300) or \
           (120400 <= 시분초 < 123400) or (133600 <= 시분초 < 150900):
            매수 = False
        # T10
        elif 140700 <= 시분초 < 143800:
            if not (초당매도_매수_비율 < 0.67 and 시가총액 >= 889):
                매수 = False
        # T3
        elif 103100 <= 시분초 < 110200:
            if not (11.395 <= 회전율 < 53.12 and 매수변동폭 < 440):
                매수 = False
        # T5
        elif 113300 <= 시분초 < 120400:
            if not (체결강도 >= 84.04 and 등락율 >= 2.887 and 초당매도_매수_비율 < 0.226):
                매수 = False
        # T7
        elif 123400 <= 시분초 < 130500:
            if not (모멘텀점수 < 4.56 and 매수스프레드 < -36.8):
                매수 = False
        # T8
        elif 130500 <= 시분초 < 133600:
            if not (매수호가1 < 68285 and 당일거래대금 < 37017):
                매수 = False
        else:
            매수 = False

# 매수 실행
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)


---

## 4. 주식 매도 조건식 (Sell Condition)

수익 실현 및 손절매 로직입니다. (Min_S_Study_251226 적용)

```python
# [C_S_251226_S_Min]
매도 = False

if 등락율 > 29.5:
    매도 = True
elif 보유시간 > 10 and 현재가 < 최저현재가(30, 보유시간):
    매도 = True
elif 시가대비등락율 < 0 and 수익률 <= -2.0 and 현재가 < 최저현재가(30, 보유시간):
    매도 = True
elif 시분초 < 151500:
    if 7 <= 수익률:
        매도 = True
    elif 수익률 <= -5.0:
        매도 = True
    elif 최고수익률 > 6 and 최고수익률 * 0.6 >= 수익률:
        매도 = True
    elif 시가총액 < 10000:
        if 5 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
            매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 4) # 강제청산=4
```

---

## 5. 최적화 범위 설정 (Optimize Range)

세그먼트별 주요 필터 임계값을 최적화하기 위한 변수 매핑입니다.

```python
# [C_S_251225_OR_Min]
self.vars[0] = [[20], 20]  # 고정값: 평균 틱수(분)

# 대형주 주요 임계값 (vars[1~5])
self.vars[1] = [[0.5, 1.5, 0.1], 0.83]    # 대형 T1: 매도/매수 비율 하한
self.vars[2] = [[15000, 20000, 1000], 17305] # 대형 T2: 당일거래대금 하한
self.vars[3] = [[15.0, 20.0, 1.0], 18.1]   # 대형 T3: 등락율 상한
self.vars[4] = [[20, 50, 5], 30]           # 대형 T4: 위험도점수 하한
self.vars[5] = [[40, 70, 5], 52.8]         # 대형 T9: 고저범위위치 하한

# 중형주 주요 임계값 (vars[6~10])
self.vars[6] = [[80, 120, 10], 88.6]       # 중형 T1: 체결강도 하한
self.vars[7] = [[3, 8, 1], 5.6]            # 중형 T2: 모멘텀점수 하한
self.vars[8] = [[5.0, 10.0, 1.0], 5.4]     # 중형 T3: 회전율 하한
self.vars[9] = [[-5, 0, 1], -4.3]          # 중형 T8: 모멘텀점수 하한
self.vars[10] = [[100, 150, 10], 121.7]    # 중형 T10: 전일동시간비 상한

# 소형주 주요 임계값 (vars[11~15])
self.vars[11] = [[80, 100, 5], 84.0]       # 소형 T5: 체결강도 하한
self.vars[12] = [[2.0, 5.0, 0.5], 2.8]     # 소형 T5: 등락율 하한
self.vars[13] = [[50, 200, 25], 115]       # 소형 T3: 회전율 조정(임시)
self.vars[14] = [[30000, 50000, 5000], 37017] # 소형 T8: 당일거래대금 상한
self.vars[15] = [[0, 10, 2], 4.5]          # 소형 T7: 모멘텀점수 상한
```

---

## 6. 조건식 개선 방향 연구

1.  **변수명 표준화**: `매수변동폭비율` 등 세그먼트 코드에만 존재하고 엔진 기본 변수에는 없는 지표들에 대한 정확한 수식 정의를 `Utility` 모듈에 추가 필요 (High Priority)
2.  **시간대 병합 최적화**: 현재 T1~T11로 잘게 쪼개진 세그먼트 중 성과가 유사한 구간을 병합하여 과적합(Overfitting) 방지 (Medium Priority)
3.  **시장 환경 필터 추가**: 시장 전체 지수(KOSPI/KOSDAQ)의 상태에 따라 세그먼트 필터 가중치를 조절하는 상위 레이어 로직 연구 (Low Priority)

## 7. 검증 기록
- 2025-12-27: AI 에이전트(Antigravity)에 의한 자동 생성 및 가이드라인 준수 여부 셀프 체크 완료
- 2025-12-27: 초기 매수 조건식(안전장치) 및 매도 조건식 추가 반영
- 검증 도구: STOM Standard Compliance Checker v1.0
