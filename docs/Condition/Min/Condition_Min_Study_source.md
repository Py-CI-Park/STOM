# 조건식(Condition) - 분봉(Minute) 기반

- STOM 주식 자동거래에 사용하기 위한 분봉 조건식 문서
- [[Back_Testing_Guideline_Min]] 을(를) 기반으로 작성
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **분봉 기반 902~905 통합 전략**을 정의한다.

- **대상 시간 구간**: 09:00:00 ~ 09:05:00 (장초 5분)
- **대상 종목**: 시가총액 3,000억 미만 중소형주, 가격대 1,000원~50,000원
- **전략 타입**: 갭상승 + 거래대금 가속 모멘텀 전략 (분봉 기반)
- **핵심 변수**: 시가등락율, 시가대비등락율, 분당순매수금액, 분당거래대금, 체결강도, 회전율, 당일거래대금각도
- **업데이트 이력**:
  - 초기 버전: Tick 데이터 기반 조건식
  - 2025-11-21: 분봉 데이터 기반으로 전면 수정 (틱 변수 → 분봉 변수 변환)

## 매수 조건식 - Min_B_902_905

```python
# ================================
#  공통 계산 지표 (분봉 기반)
# ================================
전일종가          = 현재가 / (1 + (등락율 / 100))                      # 단위: 원
시가등락율        = ((시가 - 전일종가) / 전일종가) * 100                # 단위: 퍼센트
시가대비등락율    = ((현재가 - 시가) / 시가) * 100                      # 단위: 퍼센트
분당순매수금액    = (분당매수수량 - 분당매도수량) * 현재가 / 1_000_000   # 단위: 백만원
# ------------------------------------------------
#  New 지표 (미사용 시 주석 처리)
#    · 누적거래대금비율 · 분당순매수비율 · 거래대금/체결강도 가속도 등
# ------------------------------------------------



# ================================
#  매수 조건 (902 ↔ 905 통합)
# ================================
매수 = True


if not (관심종목 == 1):                         # 공통 필터 – 관심종목
    매수 = False


# ---------- 09:00:00 ~ 09:02:00 (902 전략) ----------
elif 시분초 < 90200:
    if not (1000 < 현재가 <= 50000):
        매수 = False
    elif not (1.0 < 등락율 <= 8.0):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (현재가 < VI아래5호가):
        매수 = False
    elif 라운드피겨위5호가이내:
        매수 = False
    # 분당거래대금 필터
    elif 시분초 < 90200:                         # 세부 조건
        if 시가총액 < 3000:
            if not (2.0 <= 시가등락율 < 4.0):
                매수 = False
            elif not (0.5 <= 시가대비등락율 < 6.0):
                매수 = False
            elif not (1 < 분당순매수금액 < 1000):
                매수 = False
            elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
                매수 = False
            elif not (전일비 > 0 and 전일동시간비 > 0):
                매수 = False
            elif not (회전율 > 2):
                매수 = False
            elif not (당일거래대금 > 5 * 100):
                매수 = False
            elif not (당일거래대금각도(30) > 1 and 당일거래대금각도(30) < 30):
                매수 = False
            elif not (분당거래대금 / 분당거래대금평균(30) > 3.0):
                매수 = False
            elif not (분당매수수량 > 매도총잔량 * 0.20):
                매수 = False
            elif not (매도총잔량 > 매수총잔량 * 0.10 and 매도총잔량 < 매수총잔량 * 2.0):
                매수 = False
            elif not (체결강도 >= 100 and 체결강도 <= 300):
                매수 = False
        else:
            매수 = False
    else:
        매수 = False


# ---------- 09:02:00 ~ 09:05:00 (905 전략) ----------
elif 90200 <= 시분초 < 90500:
    if not (1000 < 현재가 <= 30000):
        매수 = False
    elif not (2.0 < 등락율 <= 15.0):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (현재가 < VI아래5호가):
        매수 = False
    elif 라운드피겨위5호가이내:
        매수 = False
    elif not (분당거래대금 > 분당거래대금N(1) * 1.0):
        매수 = False
    else:
        if 시가총액 < 3000:
            if not (0.0 <= 시가등락율 < 8.0):
                매수 = False
            elif not (3.0 <= 시가대비등락율 < 8.0):
                매수 = False
            elif not (1 < 분당순매수금액 < 1000):
                매수 = False
            elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
                매수 = False
            elif not (전일비 > 5 and 전일동시간비 > 0):
                매수 = False
            elif not (회전율 > 1.5):
                매수 = False
            elif not (당일거래대금 > 50 * 100):
                매수 = False
            elif not (당일거래대금각도(30) > 10 and 당일거래대금각도(30) < 30):
                매수 = False
            elif not (분당거래대금 / 분당거래대금평균(30) > 2.0):
                매수 = False
            elif not (분당매수수량 > 매도총잔량 * 0.30):
                매수 = False
            elif not (매도총잔량 * 0.10 < 매수총잔량 * 1.0):
                매수 = False
            elif not (누적분당매수수량(30) * 0.5 < 누적분당매도수량(30) * 1.0):
                매수 = False
            elif not (누적분당매도수량(30) * 1.0 < 누적분당매수수량(30) * 1.0):
                매수 = False
            elif not (체결강도 >= 50 and 체결강도 <= 300):
                매수 = False
        else:
            매수 = False

# # ---------- 09:05:00 ~ 09:10:00 (910 전략) ----------
# elif 90500 <= 시분초 < 91000:
#     if not (1000 < 현재가 <= 30000):
#         매수 = False
#     elif not (2.0 < 등락율 <= 15.0):
#         매수 = False
#     elif not (고저평균대비등락율 > 0):
#         매수 = False
#     elif not (현재가 < VI아래5호가):
#         매수 = False
#     elif 라운드피겨위5호가이내:
#         매수 = False
#     elif not (분당거래대금 > 분당거래대금N(1) * 1.0):
#         매수 = False
#     else:
#         if 시가총액 < 3000:
#             if not (0.0 <= 시가등락율 < 8.0):
#                 매수 = False
#             elif not (3.0 <= 시가대비등락율 < 8.0):
#                 매수 = False
#             elif not (1 < 분당순매수금액 < 1000):
#                 매수 = False
#             elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
#                 매수 = False
#             elif not (전일비 > 5 and 전일동시간비 > 0):
#                 매수 = False
#             elif not (회전율 > 1.5):
#                 매수 = False
#             elif not (당일거래대금 > 50 * 100):
#                 매수 = False
#             elif not (당일거래대금각도(30) > 10 and 당일거래대금각도(30) < 30):
#                 매수 = False
#             elif not (분당거래대금 / 분당거래대금평균(30) > 2.0):
#                 매수 = False
#             elif not (분당매수수량 > 매도총잔량 * 0.30):
#                 매수 = False
#             elif not (매도총잔량 * 0.10 < 매수총잔량 * 1.0):
#                 매수 = False
#             elif not (누적분당매수수량(30) * 0.5 < 누적분당매도수량(30) * 1.0):
#                 매수 = False
#             elif not (누적분당매도수량(30) * 1.0 < 누적분당매수수량(30) * 1.0):
#                 매수 = False
#             elif not (체결강도 >= 50 and 체결강도 <= 300):
#                 매수 = False
#         else:
#             매수 = False


else:
    매수 = False


# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

**변경사항**:
- `초당매수수량`, `초당매도수량` → `분당매수수량`, `분당매도수량`
- `초당거래대금`, `초당거래대금평균` → `분당거래대금`, `분당거래대금평균`
- `초당순매수금액` → `분당순매수금액`
- `누적초당매수수량`, `누적초당매도수량` → `누적분당매수수량`, `누적분당매도수량`
- 분봉 데이터 특성에 맞게 변수 사용법 조정

## 매도 조건식 - Min_S_902_905

```python
# ================================
#  공통 계산 지표 (분봉 기반)
# ================================
시가대비등락율    = ((현재가 - 시가) / 시가) * 100                      # 단위: 퍼센트
# ------------------------------------------------
#  New 지표 (미사용 시 주석 처리)
#   · 매도잔량압력 · 체결강도변동성 · RSI변화율 등
# ------------------------------------------------



# ================================
#  매도 조건 (902 ↔ 905 통합)
# ================================
매도 = False


# 등락율 상한가 직전
if 등락율 > 29.5:
    매도 = True
elif 시가대비등락율 < 0 and 수익률 <= -2.0 and 현재가 < 최저현재가(60, 보유시간):
    매도 = True


elif 보유시간 > 60 and 현재가 < 최저현재가(60, 보유시간):
    매도 = True
elif 시분초 < 93000:
    if 수익률 >= 5 or 수익률 <= -5.0:
        매도 = True
    elif 최고수익률 > 6 and 최고수익률 * 0.6 >= 수익률:
        매도 = True
    elif 시가총액 < 10000:
        if 등락율각도(30) >= 10 and (분당매도수량 - 분당매수수량) >= 매수총잔량 * 0.5 and (현재가 / 현재가N(1) - 1) * 100 < -0.5:
            매도 = True
        elif 등락율각도(30) < 10 and 등락율각도(30) >= 5 and (분당매도수량 - 분당매수수량) >= 매수총잔량 * 0.7 and (현재가 / 현재가N(1) - 1) * 100 < -0.7:
            매도 = True
        elif 등락율각도(30) < 5 and 등락율각도(30) >= 0 and (분당매도수량 - 분당매수수량) >= 매수총잔량 * 0.8 and (현재가 / 현재가N(1) - 1) * 100 < -0.5:
            매도 = True
        elif 4.5 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
            매도 = True


# ================================
#  매도 호출
# ================================
if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

**변경사항**:
- `초당매도수량`, `초당매수수량` → `분당매도수량`, `분당매수수량`
- `최저현재가(int(60), int(보유시간))` → `최저현재가(60, 보유시간)` (분봉에서는 int() 캐스팅 불필요)
- 보유시간은 분(Minutes) 단위로 해석 (분봉 가이드라인 준수)

## 조건식 개선 방향 연구

### 1. 분봉 전용 지표 활용 연구

**우선순위: 높음**
- **TA-Lib RSI 추가**
  - RSI 과매수(70 이상)/과매도(30 이하) 구간 필터링
  - RSI 골든크로스(30 돌파) 시 매수 신호 강화
  - 구현 난이도: 낮음

**우선순위: 높음**
- **볼린저 밴드 활용**
  - 볼린저 밴드 하단(BBL) 근처에서 반등 매수
  - 볼린저 밴드 상단(BBU) 돌파 시 익절
  - 구현 난이도: 낮음

**우선순위: 중간**
- **MACD 지표 추가**
  - MACD 골든크로스 확인으로 추세 전환 포착
  - MACD 히스토그램 증가 시 매수 신호 강화
  - 구현 난이도: 중

### 2. 시간대별 전략 세분화 연구

**우선순위: 높음**
- **902 vs 905 전략 차별화**
  - 902 (09:00~09:02): 갭상승 초기 포착, 보수적 진입
  - 905 (09:02~09:05): 모멘텀 가속 확인, 공격적 진입
  - 각 구간별 다른 임계값 적용
  - 구현 난이도: 낮음

**우선순위: 중간**
- **910 전략 활성화**
  - 현재 주석 처리된 910 전략을 활성화
  - 09:05~09:10 구간 안정화 국면 포착
  - 구현 난이도: 낮음

### 3. 매도 조건 고도화 연구

**우선순위: 높음**
- **보유시간 기반 동적 손익 조정**
  - 보유시간 30분 이상: 손절 -3% → -2%, 익절 5% → 3%
  - 보유시간 60분 이상: 빠른 청산 (손익 불문)
  - 구현 난이도: 중

**우선순위: 중간**
- **등락율각도 기반 추세 약화 감지**
  - 등락율각도(30) 급격한 하락 시 조기 청산
  - 당일거래대금각도(30) 하락과 결합 확인
  - 구현 난이도: 낮음

### 4. 리스크 관리 강화 연구

**우선순위: 높음**
- **최저현재가 추적 강화**
  - 최저현재가 구간을 60분 → 30분으로 단축
  - 최저가 대비 일정 비율 하락 시 즉시 청산
  - 구현 난이도: 낮음

**우선순위: 중간**
- **분당거래대금 급감 감지**
  - 분당거래대금이 평균의 50% 이하로 하락 시 청산 고려
  - 거래 활성도 저하 시 빠른 이탈
  - 구현 난이도: 낮음

### 5. 분봉 데이터 최적화 연구

**우선순위: 높음**
- **분봉시가/고가/저가 활용**
  - 현재 일봉 고가/저가 사용 → 분봉고가/분봉저가로 변경
  - 분봉 캔들 패턴 분석 (망치형, 역망치형 등)
  - 구현 난이도: 중

**우선순위: 중간**
- **이동평균 기간 최적화**
  - 현재 60분 이동평균 → 20분/60분 이중 이동평균 활용
  - 단기/중기 이동평균 골든크로스 확인
  - 구현 난이도: 낮음

### 구현 우선순위

1. **1단계 (즉시 구현)**:
   - RSI 추가
   - 볼린저 밴드 활용
   - 902 vs 905 전략 차별화
   - 최저현재가 추적 강화

2. **2단계 (1개월 내)**:
   - 보유시간 기반 동적 손익 조정
   - 분봉시가/고가/저가 활용
   - 등락율각도 기반 추세 약화 감지

3. **3단계 (3개월 내)**:
   - MACD 지표 추가
   - 910 전략 활성화
   - 이동평균 기간 최적화

---

## 태그

#주식트레이딩 #분봉트레이딩 #매수조건 #매도조건 #최적화 #파이썬 #트레이딩로직 #분봉백테스팅 #갭상승전략 #장초전략 #리스크관리

---

**Last Update**: 2025-11-21
**버전**: v2.0 (틱 데이터 기반에서 분봉 데이터 기반으로 전면 수정)
