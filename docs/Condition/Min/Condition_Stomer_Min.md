# 조건식 찾기 - 분봉 버전 (Stomer Strategy - Minute Version)

- STOM 주식 자동거래에 사용하기 위한 분봉 조건식 문서
- [[Back_Testing_Guideline_Min]] 을(를) 기반으로 작성
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **분봉 기반 Stomer 전략**을 정의한다.

- **대상 시간 구간**: 09:00:00 ~ 15:30:00 (장 전체)
- **대상 종목**: 시가총액 3,000억 차등 기준
- **전략 타입**: 분봉 기반 종합 전략 (거래대금, 순매수금액, 체결강도, TA-Lib 지표 활용)
- **핵심 변수**: 분당거래대금, 분당순매수금액, 체결강도, RSI, MACD, 볼린저밴드
- **업데이트 이력**:
  - 2025-07-13: 초기 문서 작성 (틱→분봉 변환 버전)

## 제한조건
```
# 백테스팅 실행 시 다음 제한조건을 반드시 준수해야 합니다:
# 1. Back_Testing_Guideline_Min.md에 명시된 변수와 함수만 사용해야 합니다.
# 2. 조합된 변수는 직접 사용할 수 없으며, 기본 변수의 조합으로 표현해야 합니다.
# 3. 매수조건은 반드시 'not (조건)' 형태로 작성해야 합니다(False 조건).
# 4. 매도조건은 반드시 '조건' 형태로 작성해야 합니다(True 조건).
# 5. 조건식은 반드시 한 줄에 하나씩 작성해야 합니다.
# 6. '< > <= >= == !=' 같은 비교 연산자와 'and or not' 같은 논리 연산자만 사용합니다.
# 7. 복잡한 비교(a < b < c)는 명시적으로 분리해야 합니다(a < b and b < c).
# 8. 0으로 나누는 오류를 방지하기 위해 분모에 작은 값(예: 0.0001)을 더하는 것이 좋습니다.
# 9. 변수명은 정확하게 사용해야 하며, 오타가 있으면 시스템이 인식하지 못합니다.
# 10. 과도하게 복잡한 산술식은 백테스팅 성능에 영향을 줄 수 있습니다.
```

## 가이드라인
```
# 조건 편집기 작성 방법 안내
# 한줄에 하나의 조건을 작성해야하며
# "if" 와 ":"를 제외하고 조건을 작성해야합니다.
# 하한 조건일 경우 너무 낮은 값보다는 높아야합니다.
# 상한 조건일 경우 너무 높은 값보다는 낮아야합니다.
# 매수조건은 False 조건을 작성하십시오.
# 매도조건은 True 조건을 작성하십시오.
# 구분용으로 조건이 없는 빈칸을 입력할 수 있으며
# "# 조건설명" 형태로 주석을 추가하실 수 있습니다.
# 사용자의 조건 설정에 따라 유용한 조합이 나올수도
# 무의미한 조합이 나올수도 있습니다.
# 조건이 무조건 많다고 좋은 것은 아니니
# 대충 만든 조건 보다는 의미있는 조건들로
# 설정개수보다 최소 두배 이상의 조건을 작성하십시오.
```

## 매수 조건식 예제
```python
# 등락율 및 현재가
not (현재가 > 시가)
not (고저평균대비등락율 >= 0)
not (3 <= 등락율 <= 25)

# 거래대금
not (당일거래대금 >= 2000)
not (분당거래대금 >= 5)
not (분당거래대금 > 분당거래대금평균(30))
not (분당거래대금평균(30) > 분당거래대금평균(30, 1))

# 분당매도수수량
not (분당매수수량 > 분당매도수량)
not (분당매수수량 > 분당매수수량N(1))

# 이동평균선
not (이동평균(60) > 이동평균(60, 1))

# 체결강도
not (체결강도 >= 체결강도평균(30) + 3)

# 호가정보
not (매도총잔량 > 매수총잔량)
not (매도잔량1 > 매수잔량1)
```

## 매도 조건식 예제
```python
# 수익률
수익률 <= -2
수익률 >= 3
최고수익률 > 3 and 수익률 < 최고수익률 * 0.75

# 등락율
등락율 > 29
고저평균대비등락율 < 0

# 기타
보유시간 > 30
체결강도 <= 최고체결강도(30) - 5
매도총잔량 < 매수총잔량
```

## 매수 조건식
```python
# 일반 선결 조건
매수 = False

# 분당순매수금액 계산
분당순매수금액 = (분당매수수량 - 분당매도수량) * 현재가 / 1_000_000

# 기본 필터링 조건
if 데이터길이 > 60 and 체결강도평균 >= 체결강도평균N(30):                    # 충분한 데이터 확보 및 체결강도 평균 추세                   [순수 변수]
    매수 = False
elif not (분당거래대금 > 분당거래대금N(1)):                                   # 분당거래대금이 직전보다 증가한 종목만 매수 대상            [순수 변수]
    매수 = False
elif not (현재가 < VI아래5호가):                                              # VI아래5호가보다 현재가가 높은 종목만 매수 대상            [순수 변수]
    매수 = False
elif 라운드피겨위5호가이내:                                                    # 라운드피겨 가격대 상위 5호가 이내인 종목 제외             [순수 변수]
    매수 = False

# 시가총액별 조건 분기
elif 시가총액 < 3000:                                                         # 시가총액 3000억 원 미만 (중소형 종목)                   [순수 변수]
    # 중소형 종목 조건
    if not ((현재가 / 시가 - 1) * 100 > 0):                                 # 시가 대비 현재가 상승 종목만 매수 대상                    [조합 변수: 시가대비등락율]
        매수 = False
    elif not ((현재가 / 고가 - 1) * 100 > -2):                              # 고가 대비 현재가 하락률 2% 이내 종목만 매수 대상         [조합 변수: 고가대비하락율]
        매수 = False
    elif not (고저평균대비등락율 > 0):                                        # 고저평균 대비 등락율이 양수인 종목만 매수 대상           [순수 변수]
        매수 = False
    elif not (등락율 <= 23):                                               # 등락율 23% 이하 종목만 매수 대상                       [순수 변수]
        매수 = False
    elif not (회전율 > 1):                                                 # 회전율 1% 초과 종목만 매수 대상                        [순수 변수]
        매수 = False
    elif not (전일비 > 2):                                                 # 전일 대비 거래량 비율 2% 초과 종목만 매수 대상          [순수 변수]
        매수 = False
    elif not (전일동시간비 > 20):                                           # 전일 동시간 대비 거래량 20% 초과 종목만 매수 대상       [순수 변수]
        매수 = False
    elif not (당일거래대금 > 10 * 100):                                     # 당일거래대금 1000억 초과 종목만 매수 대상               [순수 변수]
        매수 = False
    elif not (400 > 분당거래대금 - 분당거래대금평균(30)):                    # 분당거래대금 급증 400백만 이내 종목만 매수 대상          [순수 변수]
        매수 = False
    elif not (400 > 분당순매수금액 and 분당순매수금액 > 0):                   # 분당순매수금액 0~400백만 범위 종목만 매수 대상         [조합 변수: 분당순매수금액]
        매수 = False
    elif not (분당매수수량 > 매도총잔량 * 20 / 100):                         # 분당매수수량이 매도총잔량의 20% 초과 종목만 매수 대상    [순수 변수]
        매수 = False
else:                                                                         # 시가총액 3000억 원 이상 (대형 종목)
    # 대형 종목 조건
    if not ((현재가 / 시가 - 1) * 100 > -1):                               # 시가 대비 현재가 하락률 1% 이내 종목만 매수 대상         [조합 변수: 시가대비등락율]
        매수 = False
    elif not ((현재가 / 고가 - 1) * 100 > -3):                              # 고가 대비 현재가 하락률 3% 이내 종목만 매수 대상         [조합 변수: 고가대비하락율]
        매수 = False
    elif not (고저평균대비등락율 > 0):                                        # 고저평균 대비 등락율이 양수인 종목만 매수 대상           [순수 변수]
        매수 = False
    elif not (등락율 <= 20):                                               # 등락율 20% 이하 종목만 매수 대상                       [순수 변수]
        매수 = False
    elif not (회전율 > 2):                                                 # 회전율 2% 초과 종목만 매수 대상                        [순수 변수]
        매수 = False
    elif not (전일비 > 2):                                                 # 전일 대비 거래량 비율 2% 초과 종목만 매수 대상          [순수 변수]
        매수 = False
    elif not (전일동시간비 > 40):                                           # 전일 동시간 대비 거래량 40% 초과 종목만 매수 대상       [순수 변수]
        매수 = False
    elif not (당일거래대금 > 70 * 100):                                     # 당일거래대금 7000억 초과 종목만 매수 대상               [순수 변수]
        매수 = False
    elif not (300 > 분당거래대금 - 분당거래대금평균(30)):                    # 분당거래대금 급증 300백만 이내 종목만 매수 대상          [순수 변수]
        매수 = False
    elif not (400 > 분당순매수금액 and 분당순매수금액 > 0):                   # 분당순매수금액 0~400백만 범위 종목만 매수 대상         [조합 변수: 분당순매수금액]
        매수 = False
    elif not (분당매수수량 > 매도총잔량 * 25 / 100):                         # 분당매수수량이 매도총잔량의 25% 초과 종목만 매수 대상    [순수 변수]
        매수 = False

# TA-Lib 지표 조건 추가
elif not (RSI > 30 and RSI < 70):                                            # RSI 과매수/과매도 구간 회피                          [TA-Lib]
    매수 = False
elif not (MACD > MACDS and MACD_N(1) <= MACDS_N(1)):                         # MACD 골든크로스                                     [TA-Lib]
    매수 = False
elif not (현재가 > BBL and 현재가 < BBU):                                    # 볼린저밴드 중간 영역                                [TA-Lib]
    매수 = False

# 최종 매수 실행
else:
    매수 = True
```

## 매도 조건식
```python
매도 = False

# 상한가 근접 조건
if 등락율 > 29.5:                                                             # 상한가 근접 시 매도                                 [순수 변수]
    매도 = True

# 시가총액별 매도 조건 분기
elif 시가총액 < 3000:                                                         # 시가총액 3000억 원 미만 (중소형 종목)               [순수 변수]
    # 중소형 종목 매도 조건
    if 수익률 < -2 and 체결강도N(1) >= 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:  # 손실 2% 이상이고 체결강도 하락 시 손절  [순수 변수]
        매도 = True
    elif 수익률 < -2 and 누적분당매도수량(30) > 누적분당매수수량(30) * 5:       # 손실 2% 이상이고 매도 거래량 급증 시 손절            [순수 변수]
        매도 = True
    elif -1 < 수익률 <= 7 and (분당매도수량 - 분당매수수량) >= 매수총잔량 * 45 / 100:  # 수익률 -1%~7%에서 매도세 우위 시 매도  [순수 변수]
        매도 = True
    elif 2 < 수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:  # 수익률 2% 초과하고 이동평균 하향 돌파 시 이익 실현 [순수 변수]
        매도 = True
else:                                                                         # 시가총액 3000억 원 이상 (대형 종목)
    # 대형 종목 매도 조건
    if 수익률 < -2 and 체결강도N(1) >= 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:  # 손실 2% 이상이고 체결강도 하락 시 손절  [순수 변수]
        매도 = True
    elif -1 < 수익률 <= 15 and (분당매도수량 - 분당매수수량) >= 매수총잔량 * 50 / 100:  # 수익률 -1%~15%에서 매도세 우위 시 매도  [순수 변수]
        매도 = True
    elif 2 < 수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:  # 수익률 2% 초과하고 이동평균 하향 돌파 시 이익 실현 [순수 변수]
        매도 = True

# TA-Lib 지표 기반 매도
elif RSI > 75 and 수익률 > 0.3:                                              # RSI 과매수 구간에서 이익 실현                       [TA-Lib]
    매도 = True
elif MACD < MACDS and MACD_N(1) >= MACDS_N(1) and 수익률 > 0.2:               # MACD 데드크로스에서 이익 실현                      [TA-Lib]
    매도 = True
elif 현재가 < BBM and 현재가N(1) >= BBM_N(1) and 수익률 > 0.1:                 # 볼린저밴드 중심선 하향 돌파 시 매도                 [TA-Lib]
    매도 = True

# 최저가 돌파 조건
elif 현재가 < 최저현재가(30, 보유시간) and 데이터길이 > 30:                     # 보유 후 최저가 돌파 시 매도(30분 기준)             [순수 변수]
    매도 = True
elif 현재가 < 최저현재가(20, 보유시간) and 데이터길이 > 20:                     # 보유 후 최저가 돌파 시 매도(20분 기준)             [순수 변수]
    매도 = True
elif 현재가 < 최저현재가(10, 보유시간) and 데이터길이 > 10:                     # 보유 후 최저가 돌파 시 매도(10분 기준)             [순수 변수]
    매도 = True
```

## 최적화 조건식

### 매수 최적화 조건식

```python

```

### 매수 최적화 범위

```python

```

### 매도 최적화 조건식

```python

```

### 매도 최적화 범위

```python

```

### 예상 시간 계산

모든 변수의 범위 갯수를 곱하여 모든 경우의 수를 계산합니다.

- **전체 변수 범위**: 
  - 1 × 5 × 3 × 4 × 5 × 5 × 5 × 4 × 3 × 5 × 5 × 5 × 4 × 3 × 5 × 5 × 4 × 5 × 4 × 6 × 3 × 6 × 4 × 5 × 5 × 6 × 3 × 4 × 9

- **총 경우의 수**: 
  - 1,889,568,000,000,000,000

각 경우에 1분이 걸린다고 가정하면:
- **분**: 1,152,921,504,606,846,976분
- **시간**: 1,152,921,504,606,846,976 / 60 = 19,215,358,410,114,116시간
- **일**: 19,215,358,410,114,116 / 24 = 800,639,933,754,754일
- **년**: 800,639,933,754,754 / 365 ≈ 2,193,534,062,611년

**가정**: 각 경우의 수를 처리하는 데 1분이 소요된다고 가정하였습니다. 이는 현실적으로 불가능한 시간이므로, 범위를 더 좁히거나 간격을 늘려야 할 수 있습니다.

---

### GA 최적화 범위

- GA 최적화 변환 방법 및 원리:
  - 기존의 최적화 범위는 `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]` 형식으로 설정됩니다.
  - GA 최적화에서는 이 범위를 `self.vars[정수] = [전체 리스트, 최적값]` 형식으로 변환합니다.
  - 전체 리스트는 시작값부터 종료값까지 간격에 따라 생성된 값들의 집합입니다.
  - 예를 들어, `self.vars[1] = [[0, 10, 1], 3]`는 `self.vars[1] = [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 3]`로 변환됩니다.
  - GA 최적화는 이 전체 리스트를 사용하여 유전 알고리즘을 통해 최적의 값을 탐색합니다.
  - 유전 알고리즘은 자연 선택, 교차, 돌연변이 등의 과정을 통해 최적의 해를 찾습니다.
  - 최적값은 유전 알고리즘 실행 후 도출된 최적의 값으로 설정됩니다.
  - 이 방법은 탐색 공간을 명시적으로 정의하여 GA가 보다 효율적으로 탐색할 수 있도록 돕습니다.

```python

```

## 참고사항
- 각 조건에는 [순수 변수] 또는 [조합 변수: 설명] 형태로 변수 유형을 표시했습니다.
- 순수 변수는 Back_Testing_Guideline_Min.md에 직접 명시된 변수입니다.
- 조합 변수는 여러 기본 변수를 조합하여 만든 표현식입니다.
- 틱 데이터의 초당 단위를 분당 단위로 변환하여 적용했습니다.
- 분봉 데이터에서 사용 가능한 TA-Lib 지표들을 추가로 활용했습니다.
- 시가총액별 차별화된 조건을 유지하면서 분봉 환경에 맞게 조정했습니다.
- 모든 조건은 백테스팅 시스템에서 오류 없이 실행될 수 있도록 가이드라인에 맞게 작성되었습니다.

**최종 업데이트: 2025-07-13 (틱→분봉 변환 버전)**