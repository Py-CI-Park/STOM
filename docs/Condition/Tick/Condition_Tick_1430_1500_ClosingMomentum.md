# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- [[Back_Testing_Guideline_Tick]] 을(를) 기반으로 작성한 Tick 조건식
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **장 마감 30분 모멘텀 구간(14:30~15:00) 전략**을 정의한다.

- **대상 시간 구간**: 14:30:00 ~ 15:00:00 (장 마감 30분)
- **대상 종목**: 관심종목
- **전략 타입**: 마감 모멘텀 포착 (Closing Momentum)
- **핵심 변수**: 초당거래대금평균(180), 등락율각도(30), 당일거래대금각도(30), 최고초당매수수량(60), 최고초당매도수량(60)
- **업데이트 이력**:
  - 초기 문서 작성: 장 마감 모멘텀 전략

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - Tick 1430_1500 ClosingMomentum](#condition---tick-1430_1500-closingmomentum)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_1430_1500_CM_B](#매수-조건식---c_t_1430_1500_cm_b)
    - [매도 조건식 - C_T_1430_1500_CM_S](#매도-조건식---c_t_1430_1500_cm_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_1430_1500_CM_BO](#매수-최적화-조건식---c_t_1430_1500_cm_bo)
    - [매수 최적화 범위 - C_T_1430_1500_CM_BOR](#매수-최적화-범위---c_t_1430_1500_cm_bor)
    - [매도 최적화 조건식 - C_T_1430_1500_CM_SO](#매도-최적화-조건식---c_t_1430_1500_cm_so)
    - [매도 최적화 범위 - C_T_1430_1500_CM_SOR](#매도-최적화-범위---c_t_1430_1500_cm_sor)
    - [GA 최적화 범위 - C_T_1430_1500_CM_GAR](#ga-최적화-범위---c_t_1430_1500_cm_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 14:30:00 ~ 15:00:00 구간의 장 마감 모멘텀 전략(ClosingMomentum)을 위한 조건식과 최적화 범위를 제공합니다. 장 마감 30분 전부터 나타나는 마지막 모멘텀을 포착하여 단기 수익을 추구하는 전략입니다.

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.
- 최적화 조건식은 `self.vars[i]`로 치환하여 탐색 범위를 별도로 정의합니다.
- 최적화 범위 포맷: `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]`
- 변수/함수 표기 및 사용 규칙은 Back_Testing_Guideline_Tick.md를 따릅니다.

### 저장 이름 규칙

1. 기본 규칙:
   - `C`: Condition
   - `T`: Tick
   - `1430_1500`: 시간대
   - `CM`: ClosingMomentum
   - `B`/`S`: 매수/매도 조건식
   - `BO`/`SO`: 매수/매도 최적화 조건식
   - `BOR`/`SOR`: 매수/매도 최적화 범위
   - `GAR`: GA 최적화 범위

---

# Condition - Tick 1430_1500 ClosingMomentum

## 전략 개요

장 마감 전(14:30~15:00)은 당일 마지막 기회로 강한 모멘텀이 발생하는 구간입니다. 이 시간대의 특징:

- 기관/외국인의 마감 전 포지션 조정
- 개인투자자의 단타 거래 증가
- 빠른 진입/청산 (14:50 이후 진입 금지)
- 목표 수익률 축소 (빠른 실현)

## 조건식

### 매수 조건식 - C_T_1430_1500_CM_B

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
마감모멘텀여부        = (초당거래대금 > 초당거래대금평균(180) * 2.0)
강한상승여부          = (등락율각도(30) > 10 and 당일거래대금각도(30) > 5)
지속매수압력여부      = (최고초당매수수량(60) > 최고초당매도수량(60) * 1.5)

# ================================
#  매수 조건
# ================================
매수 = True

# 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (143000 <= 시분초 < 145000):  # 14:50까지만 진입
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 마감 모멘텀 확인
elif not 마감모멘텀여부:
    매수 = False

# 강한 상승 확인
elif not 강한상승여부:
    매수 = False

# 지속 매수 압력 확인
elif not 지속매수압력여부:
    매수 = False

# 시가총액별 세부 조건
elif 시가총액 < 3000:
    if not (1.0 < 등락율 <= 20.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
        매수 = False
    elif not (회전율 > 3.0):
        매수 = False
    elif not (전일비 > 100):
        매수 = False
    elif not (체결강도 >= 150 and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.50):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * 1.2):
        매수 = False
    elif not (당일거래대금 > 200 * 100):
        매수 = False
elif 시가총액 < 5000:
    if not (0.8 < 등락율 <= 15.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
        매수 = False
    elif not (회전율 > 2.0):
        매수 = False
    elif not (전일비 > 70):
        매수 = False
    elif not (체결강도 >= 130 and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.40):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * 1.1):
        매수 = False
    elif not (당일거래대금 > 300 * 100):
        매수 = False
else:
    if not (0.5 < 등락율 <= 12.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.30)):
        매수 = False
    elif not (회전율 > 1.5):
        매수 = False
    elif not (전일비 > 50):
        매수 = False
    elif not (체결강도 >= 120 and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.35):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * 1.1):
        매수 = False
    elif not (당일거래대금 > 500 * 100):
        매수 = False

# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식 - C_T_1430_1500_CM_S

```python
# ================================
#  공통 계산 지표
# ================================
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -1.0 and (초당매도수량 > 초당매수수량 * 2.0)
모멘텀약화여부        = (초당거래대금 < 초당거래대금평균(30) * 0.7)

매도 = False

# 상한가 부근 안전장치
if 등락율 > 29.5:
    매도 = True

# 손절 및 목표가 도달 (빠른 실현)
elif 수익률 >= 2.0 or 수익률 <= -1.5:
    매도 = True

# 트레일링 스톱 (공격적)
elif 최고수익률 > 3.0 and 최고수익률 * 0.75 >= 수익률:
    매도 = True

# 보유시간 기반 청산 (짧게)
elif 보유시간 > 900:  # 15분
    매도 = True

# 급락 신호
elif 급락신호:
    매도 = True

# 모멘텀 약화
elif 모멘텀약화여부:
    매도 = True

# 등락율 각도 하락 전환
elif 등락율각도(30) < -8:
    매도 = True

# 체결강도 급락
elif 체결강도 < 체결강도평균(30) * 0.6:
    매도 = True

# 14:55 이후 무조건 청산
elif 시분초 >= 145500:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_1430_1500_CM_BO

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
마감모멘텀여부        = (초당거래대금 > 초당거래대금평균(180) * self.vars[1])
강한상승여부          = (등락율각도(30) > self.vars[2] and 당일거래대금각도(30) > self.vars[3])
지속매수압력여부      = (최고초당매수수량(60) > 최고초당매도수량(60) * self.vars[4])

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (143000 <= 시분초 < 145000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not 마감모멘텀여부:
    매수 = False
elif not 강한상승여부:
    매수 = False
elif not 지속매수압력여부:
    매수 = False

elif 시가총액 < 3000:
    if not (self.vars[5] < 등락율 <= self.vars[6]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[7] / 100)):
        매수 = False
    elif not (회전율 > self.vars[8]):
        매수 = False
    elif not (전일비 > self.vars[9]):
        매수 = False
    elif not (체결강도 >= self.vars[10] and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[11]):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * self.vars[12]):
        매수 = False
    elif not (당일거래대금 > self.vars[13] * 100):
        매수 = False

elif 시가총액 < 5000:
    if not (self.vars[14] < 등락율 <= self.vars[15]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[16] / 100)):
        매수 = False
    elif not (회전율 > self.vars[17]):
        매수 = False
    elif not (전일비 > self.vars[18]):
        매수 = False
    elif not (체결강도 >= self.vars[19] and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[20]):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * self.vars[21]):
        매수 = False
    elif not (당일거래대금 > self.vars[22] * 100):
        매수 = False

else:
    if not (self.vars[23] < 등락율 <= self.vars[24]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[25] / 100)):
        매수 = False
    elif not (회전율 > self.vars[26]):
        매수 = False
    elif not (전일비 > self.vars[27]):
        매수 = False
    elif not (체결강도 >= self.vars[28] and 체결강도 <= 500):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[29]):
        매수 = False
    elif not (누적초당매수수량(60) > 누적초당매도수량(60) * self.vars[30]):
        매수 = False
    elif not (당일거래대금 > self.vars[31] * 100):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_1430_1500_CM_BOR

```python
# 공통
self.vars[1]  = [[1.8, 2.2, 0.2], 2.0]               # 마감 모멘텀 비율
self.vars[2]  = [[8, 12, 2], 10]                     # 등락율각도 하한
self.vars[3]  = [[3, 7, 2], 5]                       # 당일거래대금각도 하한
self.vars[4]  = [[1.3, 1.7, 0.2], 1.5]               # 매수 압력 비율

# 시가총액 < 3000
self.vars[5]  = [[0.8, 1.2, 0.2], 1.0]               # 등락율 하한
self.vars[6]  = [[18.0, 22.0, 2.0], 20.0]            # 등락율 상한
self.vars[7]  = [[15, 25, 5], 20]                    # 고가 대비 현재가 임계(%)
self.vars[8]  = [[2.5, 3.5, 0.5], 3.0]               # 회전율 하한
self.vars[9]  = [[80, 120, 20], 100]                 # 전일비 하한
self.vars[10] = [[140, 160, 10], 150]                # 체결강도 하한
self.vars[11] = [[0.45, 0.55, 0.05], 0.50]           # 초당매수수량/매도총잔량
self.vars[12] = [[1.1, 1.3, 0.1], 1.2]               # 누적매수/누적매도 비율
self.vars[13] = [[150, 250, 50], 200]                # 당일거래대금(백만)

# 시가총액 < 5000
self.vars[14] = [[0.6, 1.0, 0.2], 0.8]               # 등락율 하한
self.vars[15] = [[13.0, 17.0, 2.0], 15.0]            # 등락율 상한
self.vars[16] = [[20, 30, 5], 25]                    # 고가 대비 현재가 임계(%)
self.vars[17] = [[1.5, 2.5, 0.5], 2.0]               # 회전율 하한
self.vars[18] = [[60, 80, 10], 70]                   # 전일비 하한
self.vars[19] = [[120, 140, 10], 130]                # 체결강도 하한
self.vars[20] = [[0.35, 0.45, 0.05], 0.40]           # 초당매수수량/매도총잔량
self.vars[21] = [[1.0, 1.2, 0.1], 1.1]               # 누적매수/누적매도 비율
self.vars[22] = [[250, 350, 50], 300]                # 당일거래대금(백만)

# 시가총액 >= 5000
self.vars[23] = [[0.4, 0.6, 0.1], 0.5]               # 등락율 하한
self.vars[24] = [[10.0, 14.0, 2.0], 12.0]            # 등락율 상한
self.vars[25] = [[25, 35, 5], 30]                    # 고가 대비 현재가 임계(%)
self.vars[26] = [[1.2, 1.8, 0.3], 1.5]               # 회전율 하한
self.vars[27] = [[40, 60, 10], 50]                   # 전일비 하한
self.vars[28] = [[110, 130, 10], 120]                # 체결강도 하한
self.vars[29] = [[0.30, 0.40, 0.05], 0.35]           # 초당매수수량/매도총잔량
self.vars[30] = [[1.0, 1.2, 0.1], 1.1]               # 누적매수/누적매도 비율
self.vars[31] = [[450, 550, 50], 500]                # 당일거래대금(백만)
```

### 매도 최적화 조건식 - C_T_1430_1500_CM_SO

```python
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -self.vars[33] and (초당매도수량 > 초당매수수량 * self.vars[34])
모멘텀약화여부        = (초당거래대금 < 초당거래대금평균(30) * self.vars[35])

매도 = False

if 등락율 > self.vars[32]:
    매도 = True
elif 수익률 >= self.vars[36] or 수익률 <= self.vars[37]:
    매도 = True
elif 최고수익률 > self.vars[38] and 최고수익률 * self.vars[39] >= 수익률:
    매도 = True
elif 보유시간 > self.vars[40]:
    매도 = True
elif 급락신호:
    매도 = True
elif 모멘텀약화여부:
    매도 = True
elif 등락율각도(30) < -self.vars[41]:
    매도 = True
elif 체결강도 < 체결강도평균(30) * self.vars[42]:
    매도 = True
elif 시분초 >= 145500:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_1430_1500_CM_SOR

```python
self.vars[32] = [[28.0, 30.0, 0.5], 29.5]            # 등락율 상한가 근접치
self.vars[33] = [[0.8, 1.2, 0.2], 1.0]               # 단기 하락률 임계
self.vars[34] = [[1.8, 2.2, 0.2], 2.0]               # 매도 우위 비율
self.vars[35] = [[0.6, 0.8, 0.1], 0.7]               # 모멘텀 약화 비율
self.vars[36] = [[1.5, 2.5, 0.5], 2.0]               # 목표 수익 실현
self.vars[37] = [[-2.0, -1.0, 0.5], -1.5]            # 최대 손실 컷
self.vars[38] = [[2.5, 3.5, 0.5], 3.0]               # 최고수익률 기준값
self.vars[39] = [[0.70, 0.80, 0.05], 0.75]           # 트레일링 보정 비율
self.vars[40] = [[600, 1200, 300], 900]              # 최대 보유시간(초)
self.vars[41] = [[6, 10, 2], 8]                      # 등락율각도 하락 임계
self.vars[42] = [[0.5, 0.7, 0.1], 0.6]               # 체결강도 약화 비율
```

### GA 최적화 범위 - C_T_1430_1500_CM_GAR

```python
# 공통
self.vars[1]  = [[1.8, 2.0, 2.2], 2.0]
self.vars[2]  = [[8, 10, 12], 10]
self.vars[3]  = [[3, 5, 7], 5]
self.vars[4]  = [[1.3, 1.5, 1.7], 1.5]

# 시가총액 < 3000
self.vars[5]  = [[0.8, 1.0, 1.2], 1.0]
self.vars[6]  = [[18.0, 19.0, 20.0, 21.0, 22.0], 20.0]
self.vars[10] = [[140, 145, 150, 155, 160], 150]

# 시가총액 < 5000
self.vars[14] = [[0.6, 0.8, 1.0], 0.8]
self.vars[15] = [[13.0, 14.0, 15.0, 16.0, 17.0], 15.0]
self.vars[19] = [[120, 125, 130, 135, 140], 130]

# 시가총액 >= 5000
self.vars[23] = [[0.4, 0.5, 0.6], 0.5]
self.vars[24] = [[10.0, 11.0, 12.0, 13.0, 14.0], 12.0]
self.vars[28] = [[110, 115, 120, 125, 130], 120]

# 매도
self.vars[36] = [[1.5, 2.0, 2.5], 2.0]
self.vars[37] = [[-2.0, -1.5, -1.0], -1.5]
self.vars[39] = [[0.70, 0.75, 0.80], 0.75]
```

---

## 조건식 개선 방향 연구

1) **14:50 이후 진입 금지**
   - 장 마감 10분 전부터는 청산에만 집중
   - 신규 진입 차단

2) **마감 시간 접근 시 목표 수익률 축소**
   - 14:30~14:45: 목표 2.0%
   - 14:45~14:50: 목표 1.5%
   - 14:50~14:55: 목표 1.0%

3) **시간 가중 손절**
   - 초반 5분: -1.5%
   - 이후 10분: -1.0%
   - 마지막 5분: -0.5%

4) **동시호가 준비**
   - 14:55 이후 모든 포지션 청산
   - 동시호가 시간 진입 방지

5) **변동성 확대 감지**
   - 장 마감 전 급격한 변동성 증가 시 진입 중단
   - ATR 임계값 설정

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #파이썬
- #트레이딩로직
- #1430_1500전략
- #장마감전략
- #모멘텀전략
- #리스크관리
