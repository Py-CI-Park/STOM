# 조건식(Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- [Back_Testing_Guideline_Tick](../../Guideline/Back_Testing_Guideline_Tick.md) 을(를) 기반으로 작성한 Tick 조건식
- [Condition_Document_Template_Guideline](../../Guideline/Condition_Document_Template_Guideline.md) 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 목차

- [조건식(Condition)](#조건식condition)
  - [목차](#목차)
  - [개요](#개요)
  - [가이드라인](#가이드라인)
    - [이름 규칙](#이름-규칙)
- [Condition - Tick 900_920](#condition---tick-900_920)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_900_920_U1_B](#매수-조건식---c_t_900_920_u1_b)
    - [매도 조건식 - C_T_900_920_U1_S](#매도-조건식---c_t_900_920_u1_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_900_920_U1_BO](#매수-최적화-조건식---c_t_900_920_u1_bo)
    - [매수 최적화 범위 - C_T_900_920_U1_BOR](#매수-최적화-범위---c_t_900_920_u1_bor)
    - [매도 최적화 조건식 - C_T_900_920_U1_SO](#매도-최적화-조건식---c_t_900_920_u1_so)
    - [매도 최적화 범위 - C_T_900_920_U1_SOR](#매도-최적화-범위---c_t_900_920_u1_sor)
    - [매수·매도 통합 최적화 범위 - C_T_900_920_U1_OR](#매수매도-통합-최적화-범위---c_t_900_920_u1_or)
    - [이상 시간 계산](#이상-시간-계산)
    - [GA 최적화 범위 - C_T_900_920_U1_GAR](#ga-최적화-범위---c_t_900_920_u1_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **장 초반 09:00:00 ~ 09:20:00 (Tick 데이터)** 구간에 사용하는 조건식을 정의한다.  
기존 `Condition_Tick_902_905_update_2` 전략이 09:00~09:05에 집중된 단기 스캘핑 전략이라면, 본 전략은 이를 확장하여 **장초 20분 동안의 모멘텀 + 거래대금 기반 추세 추종 전략**을 목표로 한다.

- 대상 구간
  - 09:00:00 ~ 09:05:00 : 초반 시초가 갭 + 체결강도 중심
  - 09:05:00 ~ 09:10:00 : 추세 지속 + 거래대금 가속
  - 09:10:00 ~ 09:15:00 : 고점 돌파 + 모멘텀 유지
  - 09:15:00 ~ 09:20:00 : 후반부 보수적 추세 진입
- 전략 성격
  - 구간별로 **조건을 다르게 적용하는 시간 분할 전략**
  - Tick 가이드라인의 핵심 변수(체결강도, 초당거래대금, 일일비, 회전율, 각도 계열)를 적극적으로 사용

## 가이드라인

- 모든 조건식은 Python 코드로 구현되며, 실거래를 전제로 작성한다.
- 조건식은
  - (1) **기본 필터** → (2) **추세/거래대금 필터** → (3) **시간대별 세부 조건** → (4) **예외/위험 관리**
  순서로 평가하는 것을 기본 구조로 한다.
- 최적화 조건식은 동일한 논리를 사용하되, **임계값을 `self.vars[i]`로 치환**하여 백테스트/GA 최적화에 활용한다.
- 최적화 범위는
  - 일반 그리드 탐색: `self.vars[i] = [[시작값, 종료값, 간격], 기본값]`
  - GA용 범위리스트: `self.vars[i] = [[값1, 값2, ...], 기본값]`
  형식으로 정의한다.

### 이름 규칙

- `C` : Condition
- `T` : Tick
- 숫자 : 시간/전략 번호 (예: `900_920`은 09:00~09:20 전략)
- `U1` : Update 1 버전
- `B` : 매수 조건식
- `S` : 매도 조건식
- `BO` : 매수 최적화 조건식
- `SO` : 매도 최적화 조건식
- `BOR` : 매수 최적화 범위
- `SOR` : 매도 최적화 범위
- `OR` : 매수·매도 통합 최적화 범위
- `GAR` : GA 최적화 범위

예시:

- `C_T_900_920_U1_B` : 09:00~09:20 Tick 전략 v1 매수 조건식
- `C_T_900_920_U1_S` : 09:00~09:20 Tick 전략 v1 매도 조건식
- `C_T_900_920_U1_BO` : 09:00~09:20 Tick 전략 v1 매수 최적화 조건식

---

# Condition - Tick 900_920

## 조건식

### 매수 조건식 - C_T_900_920_U1_B

장 초반 20분 구간에서 **유동성·체결강도·거래대금 가속**이 충분한 종목만을 선택하여 진입하는 것을 목표로 한다.  
기본 구조는 `Condition_Tick_902_905_update_2`의 902/905 전략을 확장한 형태이며, 시간대를 4개 구간으로 세분화한다.

```python
# Tick 기반 주요 변수 (Back_Testing_Guideline_Tick 참조)
# 현재가, 시가, 고가, 저가, 등락률, 일일거래대금, 체결강도,
# 초당거래대금, 초당거래대금N(1), 일일비, 회전율, 일일시간비,
# 일일거래대금각도(30), 등락각도(30), 분초 등.

매수 = True

# 1. 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (1000 <= 현재가 <= 50000):
    # 지나치게 저가/고가인 종목 제외
    매수 = False
elif not (일일거래대금 >= 5_000_000_000):
    # 최소 일일 거래대금 50억 이상
    매수 = False
elif not (일일비 >= 80 and 회전율 >= 0.5):
    # 일정 수준 이상의 회전율·일일비 확보
    매수 = False
elif not (일일시간비 >= 80):
    # 동시간 대비 거래가 충분히 몰린 종목만
    매수 = False

# 2. 기본 추세/모멘텀 필터
elif not (등락률 >= 1.5):
    # 장 초반 최소 시세 분출
    매수 = False
elif not (현재가 > 저가 * 1.01):
    # 저가 대비 최소 1% 이상은 위에서 거래
    매수 = False

# 3. 시간대별 세부 조건
if 매수:
    # 09:00:00 ~ 09:05:00 (초기: 강한 매수세 위주)
    if 분초 < 90500:
        # 체결강도·초당거래대금이 매우 강한 종목에만 진입
        if not (체결강도 >= 100 and 초당거래대금 >= 300_000_000):
            매수 = False
        elif not (초당거래대금 > 초당거래대금N(1)):
            # 직전 초 대비 거래대금이 증가 추세
            매수 = False

    # 09:05:00 ~ 09:10:00 (초기 모멘텀 지속 + 거래대금 가속)
    elif 분초 < 91000:
        if not (체결강도 >= 80 and 초당거래대금 >= 200_000_000):
            매수 = False
        elif not (일일거래대금각도(30) > 5.0):
            # 최근 30초 기준 일일거래대금 기울기가 양(+)의 가파른 구간
            매수 = False

    # 09:10:00 ~ 09:15:00 (고점 돌파 + 모멘텀 유지)
    elif 분초 < 91500:
        if not (현재가 >= 고가N(1)):
            # 직전 초 고가 돌파 종목 위주
            매수 = False
        elif not (체결강도 >= 70 and 초당거래대금 >= 150_000_000):
            매수 = False
        elif not (등락각도(30) > 3.0):
            # 가격 상승 각도도 일정 수준 이상 유지
            매수 = False

    # 09:15:00 ~ 09:20:00 (후반부 보수적 추세 진입)
    elif 분초 < 92000:
        if not (현재가 >= 시가 * 1.02):
            # 시가 대비 2% 이상 위에서 거래 중인 종목
            매수 = False
        elif not (체결강도 >= 60):
            매수 = False
        elif not (일일비 >= 120 and 회전율 >= 1.5):
            # 장초 15분 경과 시점에서도 거래 집중도가 높은 종목만
            매수 = False
        elif not (초당거래대금 >= 100_000_000):
            매수 = False

    # 그 외 시간은 본 전략의 대상이 아님
    else:
        매수 = False
```

#### 매수 조건식 요약

- **공통 필터**
  - 가격: 1,000원 이상 50,000원 이하
  - 일일거래대금: 50억 이상
  - 일일비·회전율·일일시간비: 일정 기준 이상
- **공통 모멘텀**
  - 등락률 1.5% 이상
  - 저가 대비 최소 1% 이상 위에서 거래
- **시간대별 조건**
  - 09:00~09:05: 체결강도 100 이상, 초당거래대금 ≥ 3억, 직전 초보다 증가
  - 09:05~09:10: 체결강도 80 이상, 초당거래대금 ≥ 2억, 일일거래대금각도(30) > 5
  - 09:10~09:15: 직전초 고가 돌파, 체결강도 70 이상, 초당거래대금 ≥ 1.5억, 등락각도(30) > 3
  - 09:15~09:20: 시가 대비 2% 이상, 체결강도 60 이상, 일일비/회전율/초당거래대금 추가 필터

---

### 매도 조건식 - C_T_900_920_U1_S

매도 조건식은 **손절·익절·시간·추세 훼손** 네 가지 축으로 구성한다.  
Tick 가이드라인의 매도 변수들을 사용하여, 장초 20분 전략 특성에 맞게 비교적 빠른 청산을 지향한다.

```python
# 매도 = True 로 시작하지 않고, 매도 조건을 만족할 때만 True 로 전환
매도 = False

# 1. 기본 손절 (가격 기준)
if 수익률 <= -3.0:
    # 진입가 대비 -3% 도달 시 손절
    매도 = True

# 2. 기본 익절 (가격 기준)
elif 수익률 >= 6.0:
    # 진입가 대비 +6% 도달 시 기본 익절
    매도 = True

# 3. 추세 훼손 (체결강도/거래대금 약화)
elif 체결강도 <= 40 and 초당거래대금 < 초당거래대금N(1):
    # 체결강도 급락 + 거래대금 감소 동시 발생 시 추세 이탈로 간주
    매도 = True

# 4. 시간 기반 청산
elif 보유시간 >= 600:
    # 10분 이상 보유 시, 장초 전략 특성상 청산
    매도 = True

# 5. 전략 시간 범위 종료 후 강제 청산
elif 분초 >= 92000:
    # 09:20 이후에는 전략 범위를 벗어나므로 보수적으로 전량 청산
    매도 = True
```

#### 매도 조건식 요약

- **손절**: 수익률 ≤ -3%
- **익절**: 수익률 ≥ +6%
- **추세 훼손**: 체결강도 40 이하 & 초당거래대금이 직전 초보다 감소
- **시간 제한**: 보유시간 ≥ 600초(10분)
- **전략 종료**: 09:20 이후 강제 청산

---

## 최적화 조건식

### 매수 최적화 조건식 - C_T_900_920_U1_BO

위 매수 조건식에서 사용한 임계값들을 `self.vars[i]` 로 치환하여, 백테스트/GA에서 자동으로 최적의 값을 찾도록 한다.  
기본 아이디어는 다음과 같다.

```python
# 예시: 공통 필터 부분만 최적화용으로 표현
매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (self.vars[1][1] <= 현재가 <= self.vars[2][1]):
    매수 = False
elif not (일일거래대금 >= self.vars[3][1]):
    매수 = False
elif not (일일비 >= self.vars[4][1] and 회전율 >= self.vars[5][1]):
    매수 = False
elif not (일일시간비 >= self.vars[6][1]):
    매수 = False
elif not (등락률 >= self.vars[7][1]):
    매수 = False
elif not (현재가 > 저가 * (1 + self.vars[8][1] / 100)):
    매수 = False

# 이하 시간대별 조건에서도 체결강도/초당거래대금/각도 등의 임계값을
# self.vars[9] ~ self.vars[n] 으로 치환하여 사용
```

#### 매수 최적화 대상 변수 개요

- `self.vars[1]` : 최소 현재가
- `self.vars[2]` : 최대 현재가
- `self.vars[3]` : 최소 일일거래대금
- `self.vars[4]` : 최소 일일비
- `self.vars[5]` : 최소 회전율
- `self.vars[6]` : 최소 일일시간비
- `self.vars[7]` : 최소 등락률
- `self.vars[8]` : 저가 대비 최소 상승률(%)
- `self.vars[9]` : (09:00~09:05) 최소 체결강도
- `self.vars[10]` : (09:00~09:05) 최소 초당거래대금
- `self.vars[11]` : (09:05~09:10) 최소 체결강도
- `self.vars[12]` : (09:05~09:10) 일일거래대금각도(30) 하한
- `self.vars[13]` : (09:10~09:15) 최소 체결강도
- `self.vars[14]` : (09:10~09:15) 최소 초당거래대금
- `self.vars[15]` : (09:10~09:15) 등락각도(30) 하한
- `self.vars[16]` : (09:15~09:20) 시가 대비 상승률 하한(%)
- `self.vars[17]` : (09:15~09:20) 최소 체결강도
- `self.vars[18]` : (09:15~09:20) 최소 일일비
- `self.vars[19]` : (09:15~09:20) 최소 회전율
- `self.vars[20]` : (09:15~09:20) 최소 초당거래대금

---

### 매수 최적화 범위 - C_T_900_920_U1_BOR

Tick 가이드라인의 권장 원칙(각 변수가 20개 이하의 후보, 너무 촘촘하지 않게)을 지키면서,  
**범위를 넓게 설정하여 다양한 장세에서 학습**이 가능하도록 한다.

```python
# self.vars[0] 은 고정값 (사용하지 않음 또는 전략 ID 등)

# 가격 구간
self.vars[1]  = [[  500,  5000,   500], 1000]          # 최소 현재가 (500 ~ 5000, 500 단위)
self.vars[2]  = [[20000, 80000, 10000], 50000]         # 최대 현재가 (2만 ~ 8만)

# 유동성/거래대금
self.vars[3]  = [[1_000_000_000, 20_000_000_000, 1_000_000_000], 5_000_000_000]
                                                     # 최소 일일거래대금 (10억 ~ 200억)
self.vars[4]  = [[  50,  300,   20],  80]            # 최소 일일비 (50 ~ 300)
self.vars[5]  = [[ 0.3,  5.0,  0.2], 0.5]            # 최소 회전율 (0.3 ~ 5.0)
self.vars[6]  = [[  50,  300,   20],  80]            # 최소 일일시간비 (50 ~ 300)

# 공통 모멘텀
self.vars[7]  = [[ 1.0, 15.0,  0.5], 1.5]            # 최소 등락률 (1% ~ 15%)
self.vars[8]  = [[ 0.5, 10.0,  0.5], 1.0]            # 저가 대비 최소 상승률 (%)

# 09:00 ~ 09:05
self.vars[9]  = [[ 60, 200,  10], 100]               # 최소 체결강도
self.vars[10] = [[50_000_000, 800_000_000, 50_000_000], 300_000_000]
                                                     # 최소 초당거래대금 (0.5억 ~ 8억)

# 09:05 ~ 09:10
self.vars[11] = [[ 50, 180,  10],  80]               # 최소 체결강도
self.vars[12] = [[ 2.0, 20.0, 1.0],  5.0]            # 일일거래대금각도(30) 하한

# 09:10 ~ 09:15
self.vars[13] = [[ 40, 160,  10],  70]               # 최소 체결강도
self.vars[14] = [[30_000_000, 500_000_000, 30_000_000], 150_000_000]
                                                     # 최소 초당거래대금
self.vars[15] = [[ 1.0, 15.0, 1.0],  3.0]            # 등락각도(30) 하한

# 09:15 ~ 09:20
self.vars[16] = [[ 1.0, 10.0, 0.5],  2.0]            # 시가 대비 상승률 하한 (%)
self.vars[17] = [[ 40, 150, 10],  60]                # 최소 체결강도
self.vars[18] = [[ 80, 300, 20], 120]                # 최소 일일비
self.vars[19] = [[ 0.5, 5.0, 0.5], 1.5]              # 최소 회전율
self.vars[20] = [[20_000_000, 400_000_000, 20_000_000], 100_000_000]
                                                     # 최소 초당거래대금
```

---

### 매도 최적화 조건식 - C_T_900_920_U1_SO

매도 조건식의 임계값 역시 `self.vars` 로 치환하여 유연하게 조정할 수 있도록 한다.

```python
매도 = False

# 손절/익절 기준
if 수익률 <= self.vars[21][1]:
    매도 = True
elif 수익률 >= self.vars[22][1]:
    매도 = True

# 추세 훼손 기준
elif 체결강도 <= self.vars[23][1] and 초당거래대금 < 초당거래대금N(1):
    매도 = True

# 시간/전략 종료 기준
elif 보유시간 >= self.vars[24][1]:
    매도 = True
elif 분초 >= 92000:
    매도 = True
```

#### 매도 최적화 대상 변수 개요

- `self.vars[21]` : 손절 수익률 (%)
- `self.vars[22]` : 익절 수익률 (%)
- `self.vars[23]` : 추세 훼손 체결강도 기준
- `self.vars[24]` : 최대 보유시간 (초)

---

### 매도 최적화 범위 - C_T_900_920_U1_SOR

```python
self.vars[21] = [[-8.0, -1.0, 0.5], -3.0]     # 손절 수익률 (-8% ~ -1%)
self.vars[22] = [[ 2.0, 15.0, 0.5],  6.0]     # 익절 수익률 (2% ~ 15%)
self.vars[23] = [[10,  80,  5],     40]       # 추세 훼손 체결강도 (10 ~ 80)
self.vars[24] = [[120, 900, 60],   600]       # 최대 보유시간 (2분 ~ 15분)
```

---

### 매수·매도 통합 최적화 범위 - C_T_900_920_U1_OR

실전에서는 모든 변수를 동시에 최적화하기보다는,  
**핵심 변수만 묶어 통합 탐색**을 수행하는 것이 효율적이다.

```python
# 예: 핵심 10개 변수를 통합 OR 세트로 구성
# (가격/유동성/등락률/체결강도/손절/익절/보유시간 등)

OR_INDEX = [1, 2, 3, 7, 9, 10, 16, 21, 22, 24]
```

- 위와 같이 인덱스 리스트만 정의하고, 실제 구현에서는
  - `OR_INDEX` 에 들어있는 변수들만 조합 탐색/GA 대상에 포함한다.

---

### 이상 시간 계산

본 전략은 **09:00:00 ~ 09:20:00** 구간에만 유효하다.  
Tick 가이드라인의 시간 인코딩 규칙을 사용하여, 분초 기준으로 아래와 같이 판단한다.

```python
if not (90000 <= 분초 < 92000):
    # 전략 시간대가 아니면 매수는 항상 False
    매수 = False
```

- 시간 필터는 매수 조건식 최상단에서 사용하는 것을 권장한다.
- 매도 조건식에서는 `분초 >= 92000` 일 때 강제 청산 로직으로 사용한다.

---

### GA 최적화 범위 - C_T_900_920_U1_GAR

GA(유전 알고리즘)를 사용할 때는, 일부 핵심 변수에 대해 **범위리스트 기반 후보값**을 제공한다.  
아래 예시는 위 `BOR`, `SOR` 범위 중 중요한 변수에 대해, 보다 촘촘한 후보값을 정의한 것이다.

```python
# GA용 매수 핵심 변수
self.vars[30] = [[1.0, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0], 1.5]      # 최소 등락률 후보
self.vars[31] = [[80, 100, 120, 140, 160, 180, 200], 100]      # 09:00~09:05 체결강도
self.vars[32] = [[100_000_000, 200_000_000, 300_000_000,
                  400_000_000, 500_000_000, 600_000_000], 300_000_000]
                                                                # 09:00~09:05 초당거래대금
self.vars[33] = [[2.0, 3.0, 5.0, 7.0, 10.0], 5.0]              # 일일거래대금각도(30)
self.vars[34] = [[1.0, 2.0, 3.0, 4.0, 5.0], 2.0]               # 시가 대비 상승률 하한

# GA용 매도 핵심 변수
self.vars[35] = [[-6.0, -5.0, -4.0, -3.0, -2.0], -3.0]         # 손절 수익률 후보
self.vars[36] = [[ 4.0,  5.0,  6.0,  7.0,  8.0, 10.0], 6.0]    # 익절 수익률 후보
self.vars[37] = [[20, 30, 40, 50, 60], 40]                     # 추세 훼손 체결강도 후보
self.vars[38] = [[300, 480, 600, 720, 900], 600]               # 최대 보유시간 후보
```

- 각 범위는 20개 이하의 후보값으로 구성하여, GA 탐색 시 과도한 조합 폭발을 방지한다.
- 1차 GA에서 대략적인 구간을 찾고, 2차에서는 해당 구간을 중심으로 더 촘촘한 리스트를 구성하는 2단계 전략을 권장한다.

---

## 조건식 개선 방향 연구

1. **장세별 성능 분리 분석**
   - 상승장(갭 상승 + 추세 지속), 변동성 장(갭 후 흔들림), 횡보장 각각에 대해 승률·MDD·PF를 분리 측정.
2. **시간대별 전략 분리**
   - 09:00~09:05, 09:05~09:10, 09:10~09:15, 09:15~09:20 구간을 개별 전략으로도 나누어 성능 비교.
3. **복합 지표 조합**
   - 기존 902/905 전략에서 제안된 매수압력지수, 거래신뢰지수 등을 본 전략에도 이식하여, 단일 임계값 대신 복합 점수 기반 필터 검토.
4. **리스크 관리 강화**
   - 연속 손실 횟수, 동시 보유 종목 수, 시총 필터 등을 추가하여 계좌 단위 리스크 제한.

---

## 태그

- #주식트레이딩
- #Tick전략
- #장초전략
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #STOM
- #900_920전략
