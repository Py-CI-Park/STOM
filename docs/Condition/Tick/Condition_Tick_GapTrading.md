# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- [[Back_Testing_Guideline_Tick]] 을(를) 기반으로 작성한 Tick 조건식
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **장 초반 갭 매매 전략(09:00~10:00)**을 정의한다.

- **대상 시간 구간**: 09:00:00 ~ 10:00:00 (장 시작 1시간)
- **대상 종목**: 관심종목, 가격대 1,000원~50,000원, 갭비율 2% 이상
- **전략 타입**: 갭 확대 포착 (Gap Trading)
- **핵심 변수**: 갭비율, 시가대비상승율, 초당거래대금평균(60/120), 초당매수수량, 초당매도수량
- **업데이트 이력**:
  - 초기 문서 작성: 갭 매매 전략

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
- [Condition - Tick GapTrading](#condition---tick-gaptrading)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
  - [최적화 조건식](#최적화-조건식)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 갭 매매 전략(Gap Trading Strategy)을 위한 조건식을 제공합니다. 시가와 전일 종가 간의 갭을 활용하여 갭 메우기 또는 갭 확대 패턴을 포착하는 전략입니다.

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.

---

# Condition - Tick GapTrading

## 전략 개요

갭 매매 전략은 시가와 전일 종가 사이의 가격 차이를 활용합니다:

- 상승 갭 발생 시 갭 확대 패턴 포착
- 갭 비율 2% 이상
- 시가 대비 추가 상승 확인
- 거래량 동반 확인

## 조건식

### 매수 조건식

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
갭비율                = ((시가 - 전일종가) / 전일종가) * 100
시가대비상승율        = ((현재가 - 시가) / 시가) * 100
갭확대여부            = (갭비율 >= 2.0 and 시가대비상승율 >= 1.0)
거래량동반여부        = (초당거래대금평균(60) > 초당거래대금평균(120) * 1.3)
강한매수세여부        = (초당매수수량 > 초당매도수량 * 1.5)

매수 = True

# 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (90000 <= 시분초 <= 100000):  # 장 시작 1시간 이내
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 갭 확대 확인
elif not 갭확대여부:
    매수 = False

# 거래량 동반 확인
elif not 거래량동반여부:
    매수 = False

# 강한 매수세 확인
elif not 강한매수세여부:
    매수 = False

# 시가총액별 세부 조건
elif 시가총액 < 3000:
    if not (2.0 < 갭비율 <= 10.0):
        매수 = False
    elif not (1.0 <= 시가대비상승율 < 5.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
        매수 = False
    elif not (회전율 > 2.0):
        매수 = False
    elif not (체결강도 >= 120):
        매수 = False
    elif not (등락율각도(30) > 5):
        매수 = False
else:
    if not (2.0 < 갭비율 <= 8.0):
        매수 = False
    elif not (0.8 <= 시가대비상승율 < 4.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.30)):
        매수 = False
    elif not (회전율 > 1.5):
        매수 = False
    elif not (체결강도 >= 110):
        매수 = False
    elif not (등락율각도(30) > 3):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식

```python
# ================================
#  공통 계산 지표
# ================================
갭메우기시작여부      = (현재가 < 시가 and 현재가N(1) >= 시가)
급락신호              = (등락율각도(30) < -10)

매도 = False

if 등락율 > 29.5:
    매도 = True
elif 수익률 >= 3.0 or 수익률 <= -2.0:
    매도 = True
elif 최고수익률 > 4.0 and 최고수익률 * 0.65 >= 수익률:
    매도 = True
elif 보유시간 > 1800:  # 30분
    매도 = True
elif 갭메우기시작여부:
    매도 = True
elif 급락신호:
    매도 = True
elif 체결강도 < 100:
    매도 = True
elif 시분초 >= 100000:  # 10시 이후 청산
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_GT_BO

```python
전일종가              = 현재가 / (1 + (등락율 / 100))
갭비율                = ((시가 - 전일종가) / 전일종가) * 100
시가대비상승율        = ((현재가 - 시가) / 시가) * 100
갭확대여부            = (갭비율 >= self.vars[1] and 시가대비상승율 >= self.vars[2])
거래량동반여부        = (초당거래대금평균(60) > 초당거래대금평균(120) * self.vars[3])
강한매수세여부        = (초당매수수량 > 초당매도수량 * self.vars[4])

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (90000 <= 시분초 <= 100000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not 갭확대여부:
    매수 = False
elif not 거래량동반여부:
    매수 = False
elif not 강한매수세여부:
    매수 = False

elif 시가총액 < 3000:
    if not (self.vars[5] < 갭비율 <= self.vars[6]):
        매수 = False
    elif not (self.vars[7] <= 시가대비상승율 < self.vars[8]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[9] / 100)):
        매수 = False
    elif not (회전율 > self.vars[10]):
        매수 = False
    elif not (체결강도 >= self.vars[11]):
        매수 = False
    elif not (등락율각도(30) > self.vars[12]):
        매수 = False
else:
    if not (self.vars[13] < 갭비율 <= self.vars[14]):
        매수 = False
    elif not (self.vars[15] <= 시가대비상승율 < self.vars[16]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[17] / 100)):
        매수 = False
    elif not (회전율 > self.vars[18]):
        매수 = False
    elif not (체결강도 >= self.vars[19]):
        매수 = False
    elif not (등락율각도(30) > self.vars[20]):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_GT_BOR

```python
# 공통
self.vars[1]  = [[1.5, 2.5, 0.5], 2.0]               # 갭 비율 하한
self.vars[2]  = [[0.8, 1.2, 0.2], 1.0]               # 시가대비 상승율 하한
self.vars[3]  = [[1.2, 1.4, 0.1], 1.3]               # 거래량 동반 비율
self.vars[4]  = [[1.3, 1.7, 0.2], 1.5]               # 강한 매수세 비율

# 시가총액 < 3000
self.vars[5]  = [[1.5, 2.5, 0.5], 2.0]               # 갭 비율 하한
self.vars[6]  = [[8.0, 12.0, 2.0], 10.0]             # 갭 비율 상한
self.vars[7]  = [[0.8, 1.2, 0.2], 1.0]               # 시가대비 상승율 하한
self.vars[8]  = [[4.0, 6.0, 1.0], 5.0]               # 시가대비 상승율 상한
self.vars[9]  = [[20, 30, 5], 25]                    # 고가 대비 현재가 임계(%)
self.vars[10] = [[1.5, 2.5, 0.5], 2.0]               # 회전율 하한
self.vars[11] = [[110, 130, 10], 120]                # 체결강도 하한
self.vars[12] = [[3, 7, 2], 5]                       # 등락율각도 하한

# 시가총액 >= 3000
self.vars[13] = [[1.5, 2.5, 0.5], 2.0]               # 갭 비율 하한
self.vars[14] = [[6.0, 10.0, 2.0], 8.0]              # 갭 비율 상한
self.vars[15] = [[0.6, 1.0, 0.2], 0.8]               # 시가대비 상승율 하한
self.vars[16] = [[3.0, 5.0, 1.0], 4.0]               # 시가대비 상승율 상한
self.vars[17] = [[25, 35, 5], 30]                    # 고가 대비 현재가 임계(%)
self.vars[18] = [[1.2, 1.8, 0.3], 1.5]               # 회전율 하한
self.vars[19] = [[100, 120, 10], 110]                # 체결강도 하한
self.vars[20] = [[2, 4, 1], 3]                       # 등락율각도 하한
```

### 매도 최적화 조건식 - C_T_GT_SO

```python
갭메우기시작여부      = (현재가 < 시가 and 현재가N(1) >= 시가)
급락신호              = (등락율각도(30) < -self.vars[22])

매도 = False

if 등락율 > 29.5:
    매도 = True
elif 수익률 >= self.vars[23] or 수익률 <= self.vars[24]:
    매도 = True
elif 최고수익률 > self.vars[25] and 최고수익률 * self.vars[26] >= 수익률:
    매도 = True
elif 보유시간 > self.vars[27]:
    매도 = True
elif 갭메우기시작여부:
    매도 = True
elif 급락신호:
    매도 = True
elif 체결강도 < self.vars[28]:
    매도 = True
elif 시분초 >= 100000:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_GT_SOR

```python
self.vars[22] = [[8, 12, 2], 10]                     # 급락 각도 임계
self.vars[23] = [[2.5, 3.5, 0.5], 3.0]               # 목표 수익 실현
self.vars[24] = [[-2.5, -1.5, 0.5], -2.0]            # 최대 손실 컷
self.vars[25] = [[3.5, 4.5, 0.5], 4.0]               # 최고수익률 기준값
self.vars[26] = [[0.60, 0.70, 0.05], 0.65]           # 트레일링 보정 비율
self.vars[27] = [[1500, 2100, 300], 1800]            # 최대 보유시간(초)
self.vars[28] = [[90, 110, 10], 100]                 # 체결강도 하한
```

---

## 조건식 개선 방향 연구

1) **갭 유형 분류**
   - 상승 갭, 하락 갭, 돌파 갭 구분
   - 갭 유형별 다른 전략 적용

2) **갭 메우기 속도 측정**
   - 갭 메우기 시간 예측
   - 빠른 메우기 시 진입 금지

3) **거래량 프로파일 분석**
   - 갭 발생 시 거래량 패턴 확인
   - 충분한 거래량 동반 여부

4) **갭 비율별 차등 적용**
   - 소형 갭(1-3%), 중형 갭(3-5%), 대형 갭(5%+)
   - 갭 크기별 다른 임계값

5) **리스크 관리**
   - 10시 이후 무조건 청산
   - 갭 메우기 시작 시 즉시 청산

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #갭매매
- #장초반전략
- #시가갭
- #리스크관리
