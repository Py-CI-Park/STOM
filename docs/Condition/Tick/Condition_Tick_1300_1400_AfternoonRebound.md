# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- Back_Testing_Guideline_Tick.md 가이드라인 반영

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - Tick 1300_1400 AfternoonRebound](#condition---tick-1300_1400-afternoonrebound)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_1300_1400_AR_B](#매수-조건식---c_t_1300_1400_ar_b)
    - [매도 조건식 - C_T_1300_1400_AR_S](#매도-조건식---c_t_1300_1400_ar_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_1300_1400_AR_BO](#매수-최적화-조건식---c_t_1300_1400_ar_bo)
    - [매수 최적화 범위 - C_T_1300_1400_AR_BOR](#매수-최적화-범위---c_t_1300_1400_ar_bor)
    - [매도 최적화 조건식 - C_T_1300_1400_AR_SO](#매도-최적화-조건식---c_t_1300_1400_ar_so)
    - [매도 최적화 범위 - C_T_1300_1400_AR_SOR](#매도-최적화-범위---c_t_1300_1400_ar_sor)
    - [GA 최적화 범위 - C_T_1300_1400_AR_GAR](#ga-최적화-범위---c_t_1300_1400_ar_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 13:00:00 ~ 14:00:00 구간의 오후 초반 반등 전략(AfternoonRebound)을 위한 조건식과 최적화 범위를 제공합니다. 점심시간 이후 오후 장이 시작되면서 나타나는 반등 패턴을 포착하는 전략입니다.

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.
- 최적화 조건식은 `self.vars[i]`로 치환하여 탐색 범위를 별도로 정의합니다.
- 최적화 범위 포맷: `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]`
- 변수/함수 표기 및 사용 규칙은 Back_Testing_Guideline_Tick.md를 따릅니다.

### 저장 이름 규칙

1. 기본 규칙:
   - `C`: Condition
   - `T`: Tick
   - `1300_1400`: 시간대
   - `AR`: AfternoonRebound
   - `B`/`S`: 매수/매도 조건식
   - `BO`/`SO`: 매수/매도 최적화 조건식
   - `BOR`/`SOR`: 매수/매도 최적화 범위
   - `GAR`: GA 최적화 범위

---

# Condition - Tick 1300_1400 AfternoonRebound

## 전략 개요

오후 장 초반(13:00~14:00)은 점심시간 이후 새로운 방향성이 형성되는 구간입니다. 이 시간대의 특징:

- 점심시간 동안 가격 조정 후 반등
- 오후 장 시작과 함께 거래량 증가
- 저항선 돌파 시 강한 상승 모멘텀
- 이동평균선 재정렬 확인

## 조건식

### 매수 조건식 - C_T_1300_1400_AR_B

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
반등신호              = (현재가 > 최저현재가(60) * 1.015) if 데이터길이 > 60 else False
거래량급증여부        = (초당거래대금 > 초당거래대금평균(120) * 1.8)
체결강도회복여부      = (체결강도 > 최저체결강도(120) * 1.3) if 최저체결강도(120) > 0 else False
이평회복여부          = (현재가 > 이동평균(60) and 이동평균(60) > 이동평균(60, 1))

# ================================
#  매수 조건
# ================================
매수 = True

# 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (130000 <= 시분초 < 140000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 반등 신호 확인
elif not 반등신호:
    매수 = False

# 거래량 급증 확인
elif not 거래량급증여부:
    매수 = False

# 체결강도 회복 확인
elif not 체결강도회복여부:
    매수 = False

# 이동평균선 회복 확인
elif not 이평회복여부:
    매수 = False

# 시가총액별 세부 조건
elif 시가총액 < 3000:
    if not (-2.0 < 등락율 <= 12.0):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * 0.40)):
        매수 = False
    elif not (회전율 > 2.0):
        매수 = False
    elif not (전일비 > 60):
        매수 = False
    elif not (체결강도 >= 120 and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * 1.3):
        매수 = False
    elif not (등락율각도(30) > 3):
        매수 = False
    elif not (당일거래대금 > 150 * 100):
        매수 = False
elif 시가총액 < 5000:
    if not (-1.5 < 등락율 <= 10.0):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * 0.35)):
        매수 = False
    elif not (회전율 > 1.5):
        매수 = False
    elif not (전일비 > 40):
        매수 = False
    elif not (체결강도 >= 110 and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * 1.2):
        매수 = False
    elif not (등락율각도(30) > 2):
        매수 = False
    elif not (당일거래대금 > 250 * 100):
        매수 = False
else:
    if not (-1.0 < 등락율 <= 8.0):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * 0.30)):
        매수 = False
    elif not (회전율 > 1.0):
        매수 = False
    elif not (전일비 > 30):
        매수 = False
    elif not (체결강도 >= 100 and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * 1.1):
        매수 = False
    elif not (등락율각도(30) > 1):
        매수 = False
    elif not (당일거래대금 > 400 * 100):
        매수 = False

# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식 - C_T_1300_1400_AR_S

```python
# ================================
#  공통 계산 지표
# ================================
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -0.8 and (초당매도수량 > 초당매수수량 * 1.6)
이평이탈여부          = (현재가 < 이동평균(60) * 0.98)
체결강도급락여부      = (체결강도 < 체결강도평균(30) * 0.65)

매도 = False

# 상한가 부근 안전장치
if 등락율 > 29.5:
    매도 = True

# 손절 및 목표가 도달
elif 수익률 >= 4.0 or 수익률 <= -2.5:
    매도 = True

# 트레일링 스톱
elif 최고수익률 > 5.0 and 최고수익률 * 0.60 >= 수익률:
    매도 = True

# 보유시간 기반 청산
elif 보유시간 > 2400:  # 40분
    매도 = True

# 급락 신호
elif 급락신호:
    매도 = True

# 이동평균선 이탈
elif 이평이탈여부:
    매도 = True

# 체결강도 급락
elif 체결강도급락여부:
    매도 = True

# 등락율 각도 하락 전환
elif 등락율각도(30) < -7:
    매도 = True

# 거래대금 급감
elif 초당거래대금 < 초당거래대금평균(60) * 0.5:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_1300_1400_AR_BO

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
반등신호              = (현재가 > 최저현재가(60) * (1 + self.vars[1] / 100)) if 데이터길이 > 60 else False
거래량급증여부        = (초당거래대금 > 초당거래대금평균(120) * self.vars[2])
체결강도회복여부      = (체결강도 > 최저체결강도(120) * self.vars[3]) if 최저체결강도(120) > 0 else False
이평회복여부          = (현재가 > 이동평균(60) and 이동평균(60) > 이동평균(60, 1))

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (130000 <= 시분초 < 140000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not 반등신호:
    매수 = False
elif not 거래량급증여부:
    매수 = False
elif not 체결강도회복여부:
    매수 = False
elif not 이평회복여부:
    매수 = False

elif 시가총액 < 3000:
    if not (self.vars[4] < 등락율 <= self.vars[5]):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * self.vars[6] / 100)):
        매수 = False
    elif not (회전율 > self.vars[7]):
        매수 = False
    elif not (전일비 > self.vars[8]):
        매수 = False
    elif not (체결강도 >= self.vars[9] and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * self.vars[10]):
        매수 = False
    elif not (등락율각도(30) > self.vars[11]):
        매수 = False
    elif not (당일거래대금 > self.vars[12] * 100):
        매수 = False

elif 시가총액 < 5000:
    if not (self.vars[13] < 등락율 <= self.vars[14]):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * self.vars[15] / 100)):
        매수 = False
    elif not (회전율 > self.vars[16]):
        매수 = False
    elif not (전일비 > self.vars[17]):
        매수 = False
    elif not (체결강도 >= self.vars[18] and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * self.vars[19]):
        매수 = False
    elif not (등락율각도(30) > self.vars[20]):
        매수 = False
    elif not (당일거래대금 > self.vars[21] * 100):
        매수 = False

else:
    if not (self.vars[22] < 등락율 <= self.vars[23]):
        매수 = False
    elif not (현재가 > (저가 + (고가 - 저가) * self.vars[24] / 100)):
        매수 = False
    elif not (회전율 > self.vars[25]):
        매수 = False
    elif not (전일비 > self.vars[26]):
        매수 = False
    elif not (체결강도 >= self.vars[27] and 체결강도 <= 400):
        매수 = False
    elif not (초당매수수량 > 초당매도수량 * self.vars[28]):
        매수 = False
    elif not (등락율각도(30) > self.vars[29]):
        매수 = False
    elif not (당일거래대금 > self.vars[30] * 100):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_1300_1400_AR_BOR

```python
# 공통
self.vars[1]  = [[1.0, 2.0, 0.5], 1.5]               # 반등 신호 비율(%)
self.vars[2]  = [[1.5, 2.1, 0.3], 1.8]               # 거래량 급증 비율
self.vars[3]  = [[1.2, 1.4, 0.1], 1.3]               # 체결강도 회복 비율

# 시가총액 < 3000
self.vars[4]  = [[-2.5, -1.5, 0.5], -2.0]            # 등락율 하한
self.vars[5]  = [[10.0, 14.0, 2.0], 12.0]            # 등락율 상한
self.vars[6]  = [[35, 45, 5], 40]                    # 저가 대비 현재가 임계(%)
self.vars[7]  = [[1.5, 2.5, 0.5], 2.0]               # 회전율 하한
self.vars[8]  = [[50, 70, 10], 60]                   # 전일비 하한
self.vars[9]  = [[110, 130, 10], 120]                # 체결강도 하한
self.vars[10] = [[1.2, 1.4, 0.1], 1.3]               # 매수/매도수량 비율
self.vars[11] = [[2, 4, 1], 3]                       # 등락율각도 하한
self.vars[12] = [[100, 200, 50], 150]                # 당일거래대금(백만)

# 시가총액 < 5000
self.vars[13] = [[-2.0, -1.0, 0.5], -1.5]            # 등락율 하한
self.vars[14] = [[8.0, 12.0, 2.0], 10.0]             # 등락율 상한
self.vars[15] = [[30, 40, 5], 35]                    # 저가 대비 현재가 임계(%)
self.vars[16] = [[1.0, 2.0, 0.5], 1.5]               # 회전율 하한
self.vars[17] = [[30, 50, 10], 40]                   # 전일비 하한
self.vars[18] = [[100, 120, 10], 110]                # 체결강도 하한
self.vars[19] = [[1.1, 1.3, 0.1], 1.2]               # 매수/매도수량 비율
self.vars[20] = [[1, 3, 1], 2]                       # 등락율각도 하한
self.vars[21] = [[200, 300, 50], 250]                # 당일거래대금(백만)

# 시가총액 >= 5000
self.vars[22] = [[-1.5, -0.5, 0.5], -1.0]            # 등락율 하한
self.vars[23] = [[6.0, 10.0, 2.0], 8.0]              # 등락율 상한
self.vars[24] = [[25, 35, 5], 30]                    # 저가 대비 현재가 임계(%)
self.vars[25] = [[0.8, 1.2, 0.2], 1.0]               # 회전율 하한
self.vars[26] = [[25, 35, 5], 30]                    # 전일비 하한
self.vars[27] = [[90, 110, 10], 100]                 # 체결강도 하한
self.vars[28] = [[1.0, 1.2, 0.1], 1.1]               # 매수/매도수량 비율
self.vars[29] = [[0, 2, 1], 1]                       # 등락율각도 하한
self.vars[30] = [[350, 450, 50], 400]                # 당일거래대금(백만)
```

### 매도 최적화 조건식 - C_T_1300_1400_AR_SO

```python
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -self.vars[32] and (초당매도수량 > 초당매수수량 * self.vars[33])
이평이탈여부          = (현재가 < 이동평균(60) * (1 - self.vars[34] / 100))
체결강도급락여부      = (체결강도 < 체결강도평균(30) * self.vars[35])

매도 = False

if 등락율 > self.vars[31]:
    매도 = True
elif 수익률 >= self.vars[36] or 수익률 <= self.vars[37]:
    매도 = True
elif 최고수익률 > self.vars[38] and 최고수익률 * self.vars[39] >= 수익률:
    매도 = True
elif 보유시간 > self.vars[40]:
    매도 = True
elif 급락신호:
    매도 = True
elif 이평이탈여부:
    매도 = True
elif 체결강도급락여부:
    매도 = True
elif 등락율각도(30) < -self.vars[41]:
    매도 = True
elif 초당거래대금 < 초당거래대금평균(60) * self.vars[42]:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_1300_1400_AR_SOR

```python
self.vars[31] = [[28.0, 30.0, 0.5], 29.5]            # 등락율 상한가 근접치
self.vars[32] = [[0.6, 1.0, 0.2], 0.8]               # 단기 하락률 임계
self.vars[33] = [[1.4, 1.8, 0.2], 1.6]               # 매도 우위 비율
self.vars[34] = [[1.5, 2.5, 0.5], 2.0]               # 이평 이탈 비율(%)
self.vars[35] = [[0.60, 0.70, 0.05], 0.65]           # 체결강도 급락 비율
self.vars[36] = [[3.5, 4.5, 0.5], 4.0]               # 목표 수익 실현
self.vars[37] = [[-3.0, -2.0, 0.5], -2.5]            # 최대 손실 컷
self.vars[38] = [[4.5, 5.5, 0.5], 5.0]               # 최고수익률 기준값
self.vars[39] = [[0.55, 0.65, 0.05], 0.60]           # 트레일링 보정 비율
self.vars[40] = [[2100, 2700, 300], 2400]            # 최대 보유시간(초)
self.vars[41] = [[5, 9, 2], 7]                       # 등락율각도 하락 임계
self.vars[42] = [[0.4, 0.6, 0.1], 0.5]               # 거래대금 급감 비율
```

### GA 최적화 범위 - C_T_1300_1400_AR_GAR

```python
# 공통
self.vars[1]  = [[1.0, 1.5, 2.0], 1.5]
self.vars[2]  = [[1.5, 1.8, 2.1], 1.8]
self.vars[3]  = [[1.2, 1.3, 1.4], 1.3]

# 시가총액 < 3000
self.vars[4]  = [[-2.5, -2.0, -1.5], -2.0]
self.vars[5]  = [[10.0, 11.0, 12.0, 13.0, 14.0], 12.0]
self.vars[9]  = [[110, 115, 120, 125, 130], 120]

# 시가총액 < 5000
self.vars[13] = [[-2.0, -1.5, -1.0], -1.5]
self.vars[14] = [[8.0, 9.0, 10.0, 11.0, 12.0], 10.0]
self.vars[18] = [[100, 105, 110, 115, 120], 110]

# 시가총액 >= 5000
self.vars[22] = [[-1.5, -1.0, -0.5], -1.0]
self.vars[23] = [[6.0, 7.0, 8.0, 9.0, 10.0], 8.0]
self.vars[27] = [[90, 95, 100, 105, 110], 100]

# 매도
self.vars[36] = [[3.5, 4.0, 4.5], 4.0]
self.vars[37] = [[-3.0, -2.5, -2.0], -2.5]
self.vars[39] = [[0.55, 0.60, 0.65], 0.60]
```

---

## 조건식 개선 방향 연구

1) **점심시간 전후 가격 비교**
   - 11:30 가격 대비 현재가 위치 확인
   - 하락 후 반등 패턴 정교화

2) **V자 반등 패턴 감지**
   - 최저가 대비 회복률 계산
   - 회복 속도(각도) 측정

3) **거래량 패턴 분석**
   - 점심시간 거래량 대비 증가율
   - 지속적 거래량 증가 확인

4) **외국인/기관 동향**
   - 점심시간 이후 외국인/기관 순매수 확인 (데이터 가능 시)

5) **멀티타임프레임 분석**
   - 5분봉, 15분봉 추세 동시 확인
   - 단기/중기 추세 일치 시 진입

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #파이썬
- #트레이딩로직
- #1300_1400전략
- #오후장전략
- #반등전략
- #리스크관리
