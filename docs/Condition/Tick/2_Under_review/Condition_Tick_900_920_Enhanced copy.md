# 조건식(Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- [[Back_Testing_Guideline_Tick]] 을(를) 기반으로 작성한 Tick 조건식
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 목차

- [조건식(Condition)](#조건식condition)
  - [목차](#목차)
  - [개요](#개요)
    - [전략 배경 및 차별점](#전략-배경-및-차별점)
    - [타겟 시간대 및 시장 특성](#타겟-시간대-및-시장-특성)
    - [핵심 전략 로직](#핵심-전략-로직)
  - [가이드라인](#가이드라인)
    - [이름 규칙](#이름-규칙)
- [Condition - Tick 900\_920 Enhanced](#condition---tick-900_920-enhanced)
  - [조건식](#조건식)
    - [매수 조건식 - C\_T\_900\_920\_U2\_B](#매수-조건식---c_t_900_920_u2_b)
    - [매도 조건식 - C\_T\_900\_920\_U2\_S](#매도-조건식---c_t_900_920_u2_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C\_T\_900\_920\_U2\_BO](#매수-최적화-조건식---c_t_900_920_u2_bo)
    - [매수 최적화 범위 - C\_T\_900\_920\_U2\_BOR](#매수-최적화-범위---c_t_900_920_u2_bor)
    - [매도 최적화 조건식 - C\_T\_900\_920\_U2\_SO](#매도-최적화-조건식---c_t_900_920_u2_so)
    - [매도 최적화 범위 - C\_T\_900\_920\_U2\_SOR](#매도-최적화-범위---c_t_900_920_u2_sor)
    - [매수·매도 통합 최적화 범위 - C\_T\_900\_920\_U2\_OR](#매수매도-통합-최적화-범위---c_t_900_920_u2_or)
    - [예상 시간 계산](#예상-시간-계산)
    - [GA 최적화 범위 - C\_T\_900\_920\_U2\_GAR](#ga-최적화-범위---c_t_900_920_u2_gar)
  - [최적화 조건식](#최적화-조건식-1)
  - [BO (Buy Optimization)](#bo-buy-optimization)
  - [BOR (Buy Optimization Range)](#bor-buy-optimization-range)
  - [SO (Sell Optimization)](#so-sell-optimization)
  - [SOR (Sell Optimization Range)](#sor-sell-optimization-range)
  - [OR (Optimum Range)](#or-optimum-range)
  - [GAR (Genetic Algorithm Range)](#gar-genetic-algorithm-range)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
    - [1. 추가 지표 활용 연구](#1-추가-지표-활용-연구)
      - [1.1 누적거래대금비율](#11-누적거래대금비율)
      - [1.2 초당순매수비율](#12-초당순매수비율)
      - [1.3 거래대금가속도](#13-거래대금가속도)
      - [1.4 체결강도가속도](#14-체결강도가속도)
    - [2. TA-Lib 보조지표 활용 연구](#2-ta-lib-보조지표-활용-연구)
      - [2.1 볼린저 밴드 (BBU, BBM, BBL)](#21-볼린저-밴드-bbu-bbm-bbl)
      - [2.2 MACD 지표](#22-macd-지표)
      - [2.3 RSI 지표](#23-rsi-지표)
      - [2.4 이동평균선 (MA)](#24-이동평균선-ma)
    - [3. 구간 연산 변수 활용 연구](#3-구간-연산-변수-활용-연구)
      - [3.1 등락율각도 세분화](#31-등락율각도-세분화)
      - [3.2 체결강도평균 활용](#32-체결강도평균-활용)
      - [3.3 최고/최저 변수 활용](#33-최고최저-변수-활용)
    - [4. 매도 조건 고도화 연구](#4-매도-조건-고도화-연구)
      - [4.1 시가총액별 손절 기준 차등화](#41-시가총액별-손절-기준-차등화)
      - [4.2 보유시간별 익절 기준 차등화](#42-보유시간별-익절-기준-차등화)
      - [4.3 동적 Trailing Stop](#43-동적-trailing-stop)
    - [5. 복합 지표 조합 연구](#5-복합-지표-조합-연구)
      - [5.1 매수세 강도 지수 (Buy Pressure Index)](#51-매수세-강도-지수-buy-pressure-index)
      - [5.2 거래 신뢰도 지수 (Trade Reliability Index)](#52-거래-신뢰도-지수-trade-reliability-index)
      - [5.3 모멘텀 지속성 지수 (Momentum Persistence Index)](#53-모멘텀-지속성-지수-momentum-persistence-index)
    - [6. 시간대별 전략 세분화 연구](#6-시간대별-전략-세분화-연구)
      - [6.1 09:00~09:05 구간 3분할](#61-09000905-구간-3분할)
      - [6.2 시간 경과 가중치 시스템](#62-시간-경과-가중치-시스템)
    - [7. 최적화 전략 개선 연구](#7-최적화-전략-개선-연구)
      - [7.1 계층적 최적화 (Hierarchical Optimization)](#71-계층적-최적화-hierarchical-optimization)
      - [7.2 앙상블 최적화](#72-앙상블-최적화)
      - [7.3 강건성 테스트 (Robustness Test)](#73-강건성-테스트-robustness-test)
    - [8. 리스크 관리 강화 연구](#8-리스크-관리-강화-연구)
      - [8.1 포지션 사이징 (Position Sizing)](#81-포지션-사이징-position-sizing)
      - [8.2 동시 보유 종목 수 제한](#82-동시-보유-종목-수-제한)
      - [8.3 연속 손실 제한](#83-연속-손실-제한)
      - [8.4 일일 손실 한도 (Daily Loss Limit)](#84-일일-손실-한도-daily-loss-limit)
    - [9. 백테스팅 개선 방향](#9-백테스팅-개선-방향)
      - [9.1 슬리피지 (Slippage) 반영](#91-슬리피지-slippage-반영)
      - [9.2 시장 충격 (Market Impact)](#92-시장-충격-market-impact)
      - [9.3 체결 지연 (Execution Delay)](#93-체결-지연-execution-delay)
    - [10. 구현 우선순위](#10-구현-우선순위)
      - [10.1 즉시 적용 가능 (High Priority)](#101-즉시-적용-가능-high-priority)
      - [10.2 단기 적용 (Medium Priority, 1~2주)](#102-단기-적용-medium-priority-12주)
      - [10.3 중장기 연구 (Low Priority, 1~2개월)](#103-중장기-연구-low-priority-12개월)
      - [10.4 최적화 실행 계획 (2~3주)](#104-최적화-실행-계획-23주)
  - [태그](#태그)

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **장 초반 09:00:00 ~ 09:20:00 (Tick 데이터)** 구간에 사용하는 Enhanced 조건식을 정의한다.

- **대상 시간 구간**: 09:00:00 ~ 09:20:00 (4개 시간대로 세분화)
- **대상 종목**: 관심종목, 시가총액 차등 기준 (3,000억 / 10,000억)
- **전략 타입**: 시간대별 차등 모멘텀 추종 + 추세 지속 전략
- **핵심 변수**: 체결강도, 초당거래대금, 시가등락율, 시가대비등락율, 각도 지표, 누적지표

### 전략 배경 및 차별점

**기존 전략 대비 개선점**:
- `Condition_Tick_902_905_update_2`는 장 초반 5분(09:00~09:05)에 집중된 초단타 스캘핑 전략
- **본 전략(900_920 Enhanced)**은 장 초반 20분으로 확장하여 **모멘텀 지속 및 추세 추종** 전략 구현
- 4개 시간 구간별 차등 조건 적용으로 장세 변화에 유연하게 대응
- 시가총액별 차등 필터로 대형주/중소형주 특성 반영

**Enhanced Version 주요 변경사항**:
1. **공통 계산 지표 도입**: 전일종가, 시가등락율, 시가대비등락율, 초당순매수금액
2. **시가총액별 차등 조건**: 소형주(< 3,000억), 중형주(3,000~10,000억), 대형주(> 10,000억)
3. **호가 기반 리스크 관리**: VI 호가, 라운드 피겨, 호가 잔량 분석
4. **누적 지표 활용**: 누적초당매수/매도수량으로 매매 압력 측정
5. **최적화 범위 확대**: 넓은 범위 탐색으로 다양한 장세 대응

### 타겟 시간대 및 시장 특성

**시간 구간별 전략**:
- **09:00:00 ~ 09:05:00 (초기 5분)**:
  - 시초가 갭 + 강한 매수세 중심
  - 체결강도 100 이상, 초당거래대금 3억 이상
  - 급등주 포착 및 초기 모멘텀 진입

- **09:05:00 ~ 09:10:00 (추세 지속)**:
  - 초기 모멘텀 지속 여부 확인
  - 거래대금 가속도 및 각도 지표 활용
  - 체결강도 70 이상, 거래대금각도(30) > 3

- **09:10:00 ~ 09:15:00 (고점 돌파)**:
  - 직전 고가 돌파 종목 포착
  - 추세 강도 유지 확인
  - 등락각도(30) > 2, 체결강도 60 이상

- **09:15:00 ~ 09:20:00 (후반부 보수적 진입)**:
  - 시가 대비 상승률 기준 강화
  - 거래 집중도 재확인 (일일비, 회전율)
  - 체결강도 50 이상, 안정적 추세 종목만 선별

### 핵심 전략 로직

1. **공통 필터 (모든 시간대 적용)**:
   - 관심종목, 가격대, 최소 거래대금, 유동성 기준
   - VI 호가 및 라운드 피겨 리스크 관리

2. **시간대별 차등 조건**:
   - 구간별로 체결강도, 초당거래대금, 각도 지표 임계값 차등화
   - 시간 경과에 따라 조건 점진적 완화 또는 강화

3. **시가총액별 세부 필터**:
   - 소형주: 높은 변동성 활용, 시가등락율/시가대비등락율 엄격
   - 중형주: 균형잡힌 조건
   - 대형주: 안정적 추세 중심

4. **매도 전략**:
   - 손절/익절 기준 + 추세 훼손 감지
   - 시간 기반 청산 + 전략 종료 시점 강제 청산
   - 최고수익률 대비 trailing stop 적용

## 가이드라인

- 모든 조건식은 Python 코드로 구현되며, 실거래를 전제로 작성한다.
- 조건식 평가 순서:
  1. **공통 필터** (관심종목, 가격, 거래대금, 유동성)
  2. **리스크 관리 필터** (VI 호가, 라운드 피겨)
  3. **시간대별 분기** (09:00~09:05, 09:05~09:10, 09:10~09:15, 09:15~09:20)
  4. **시가총액별 세부 조건** (소형주/중형주/대형주)
  5. **최종 매수/매도 결정**

- 최적화 조건식:
  - 동일한 논리를 사용하되, 임계값을 `self.vars[i]`로 치환
  - 각 변수는 `self.vars[정수] = [[시작값, 종료값, 간격], 기본값]` 형식
  - GA 최적화는 `self.vars[정수] = [[값1, 값2, ...], 기본값]` 형식

- 최적화 범위 설계 원칙:
  - 각 변수당 범위 개수 20개 이하 권장
  - 넓은 범위 탐색으로 다양한 장세 대응
  - 2단계 최적화 전략: 1차(넓은 범위) → 2차(정밀 탐색)

### 이름 규칙

- `C`: Condition
- `T`: Tick
- `900_920`: 09:00~09:20 전략
- `U2`: Update 2 (Enhanced 버전)
- `B`: 매수 조건식
- `S`: 매도 조건식
- `BO`: 매수 최적화 조건식
- `SO`: 매도 최적화 조건식
- `BOR`: 매수 최적화 범위
- `SOR`: 매도 최적화 범위
- `OR`: 매수·매도 통합 최적화 범위
- `GAR`: GA 최적화 범위

예시:
- `C_T_900_920_U2_B`: 09:00~09:20 Tick Enhanced 매수 조건식
- `C_T_900_920_U2_BO`: 09:00~09:20 Tick Enhanced 매수 최적화 조건식
- `C_T_900_920_U2_GAR`: 09:00~09:20 Tick Enhanced GA 최적화 범위

---

# Condition - Tick 900_920 Enhanced

## 조건식

### 매수 조건식 - C_T_900_920_U2_B

장 초반 20분 구간에서 **시간대별·시가총액별 차등 조건**을 적용하여, 유동성·체결강도·거래대금 가속이 충분한 종목을 선별한다.

```python
# ================================
#  공통 계산 지표
# ================================
전일종가          = 현재가 / (1 + (등락율 / 100))                      # 단위: 원
시가등락율        = ((시가 - 전일종가) / 전일종가) * 100                # 단위: 퍼센트
시가대비등락율    = ((현재가 - 시가) / 시가) * 100                      # 단위: 퍼센트
초당순매수금액    = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000   # 단위: 백만원
# ------------------------------------------------
#  추가 지표 (활용 가능)
# ------------------------------------------------
# 누적거래대금비율 = 당일거래대금 / (시가총액 * 회전율 / 100) * 100 if (시가총액 * 회전율 / 100) != 0 else 0
# 초당순매수비율 = 초당매수수량 / (초당매수수량 + 초당매도수량) * 100 if (초당매수수량 + 초당매도수량) != 0 else 0
# 거래대금가속도 = (초당거래대금 - 초당거래대금N(1)) / 초당거래대금N(1) * 100 if 초당거래대금N(1) != 0 else 0
# 체결강도가속도 = (체결강도 - 체결강도N(1)) / 체결강도N(1) * 100 if 체결강도N(1) != 0 else 0


# ================================
#  매수 조건
# ================================
매수 = True

# 1. 공통 필터
if not (관심종목 == 1):                         # 관심종목 필터
    매수 = False
elif not (1000 <= 현재가 <= 50000):              # 가격대 필터 (1,000원 ~ 50,000원)
    매수 = False
elif not (당일거래대금 >= 3 * 100):        # 최소 당일거래대금 3억(300백만) 이상
    매수 = False

# 2. 기본 추세/모멘텀 필터
elif not (등락율 >= 0.5):                       # 최소 등락율 0.5% 이상
    매수 = False
elif not (고저평균대비등락율 > 0):               # 고가·저가 평균 대비 현재가 위치
    매수 = False

# 3. 리스크 관리 필터
elif not (현재가 < VI아래5호가):                # VI 발동 리스크 회피
    매수 = False
elif 라운드피겨위5호가이내:                     # 라운드 피겨 저항 회피
    매수 = False

# ================================
#  시간대별 전략 분기
# ================================

# ---------- 09:00:00 ~ 09:05:00 (초기 5분: 급등주 포착) ----------
if 매수 and 시분초 < 90500:

    # 시가총액별 차등 조건
    if 시가총액 < 3000:                         # 소형주 (< 3,000억)
        if not (1.5 <= 시가등락율 < 5.0):
            매수 = False
        elif not (0.5 <= 시가대비등락율 < 8.0):
            매수 = False
        elif not (1 < 초당순매수금액 < 10 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
            # 고가 근처 20% 이내에서 거래 중
            매수 = False
        elif not (전일비 > 0 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 2.0):
            매수 = False
        # elif not (당일거래대금각도(30) > 5 and 당일거래대금각도(30) < 30):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 2.0):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.20):
        #     매수 = False
        # elif not (매도총잔량 > 매수총잔량 * 0.10 and 매도총잔량 < 매수총잔량 * 2.0):
        #     매수 = False
        # elif not (체결강도 >= 100 and 체결강도 <= 300):
        #     매수 = False

    elif 시가총액 < 10000:                      # 중형주 (3,000억 ~ 10,000억)
        if not (1.5 <= 시가등락율 < 4.0):
            매수 = False
        elif not (0.3 <= 시가대비등락율 < 6.0):
            매수 = False
        elif not (0.5 < 초당순매수금액 < 8 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
            매수 = False
        elif not (전일비 > 0 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.5):
            매수 = False
        # elif not (당일거래대금각도(30) > 3 and 당일거래대금각도(30) < 25):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 2.5):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.15):
        #     매수 = False
        # elif not (매도총잔량 > 매수총잔량 * 0.08 and 매도총잔량 < 매수총잔량 * 2.5):
        #     매수 = False
        # elif not (체결강도 >= 80 and 체결강도 <= 280):
        #     매수 = False

    else:                                       # 대형주 (> 10,000억)
        if not (1.0 <= 시가등락율 < 3.0):
            매수 = False
        elif not (0.2 <= 시가대비등락율 < 5.0):
            매수 = False
        elif not (0.3 < 초당순매수금액 < 6 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.30)):
            매수 = False
        elif not (전일비 > 0 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.0):
            매수 = False
        # elif not (당일거래대금각도(30) > 2 and 당일거래대금각도(30) < 20):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 2.0):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.12):
        #     매수 = False
        # elif not (매도총잔량 > 매수총잔량 * 0.05 and 매도총잔량 < 매수총잔량 * 3.0):
        #     매수 = False
        # elif not (체결강도 >= 70 and 체결강도 <= 250):
        #     매수 = False


# ---------- 09:05:00 ~ 09:10:00 (추세 지속 단계) ----------
elif 매수 and 90500 <= 시분초 < 91000:

    if 시가총액 < 3000:                         # 소형주
        if not (0.0 <= 시가등락율 < 10.0):
            매수 = False
        elif not (3.0 <= 시가대비등락율 < 12.0):
            매수 = False
        elif not (1 < 초당순매수금액 < 10 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
            매수 = False
        elif not (전일비 > 4 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.5):
            매수 = False
        elif not (당일거래대금 > 10 * 100):
            매수 = False
        # elif not (당일거래대금각도(30) > 3 and 당일거래대금각도(30) < 30):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 2.0):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.25):
        #     매수 = False
        # elif not (매도총잔량 * 0.10 < 매수총잔량 * 1.0):
        #     매수 = False
        # elif not (누적초당매수수량(30) * 0.5 < 누적초당매도수량(30) * 1.0):
        #     매수 = False
        # elif not (누적초당매도수량(30) * 1.0 < 누적초당매수수량(30) * 1.0):
        #     매수 = False
        # elif not (체결강도 >= 70 and 체결강도 <= 300):
            매수 = False

    elif 시가총액 < 10000:                      # 중형주
        if not (0.0 <= 시가등락율 < 8.0):
            매수 = False
        elif not (2.5 <= 시가대비등락율 < 10.0):
            매수 = False
        elif not (0.8 < 초당순매수금액 < 8 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
            매수 = False
        elif not (전일비 > 3 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.2):
            매수 = False
        elif not (당일거래대금 > 15 * 100):
            매수 = False
        # elif not (당일거래대금각도(30) > 2 and 당일거래대금각도(30) < 25):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.8):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.20):
        #     매수 = False
        # elif not (매도총잔량 * 0.08 < 매수총잔량 * 1.0):
        #     매수 = False
        # elif not (누적초당매수수량(30) * 0.4 < 누적초당매도수량(30) * 1.0):
        #     매수 = False
        # elif not (누적초당매도수량(30) * 1.0 < 누적초당매수수량(30) * 1.0):
        #     매수 = False
        # elif not (체결강도 >= 60 and 체결강도 <= 280):
        #     매수 = False

    else:                                       # 대형주
        if not (0.0 <= 시가등락율 < 6.0):
            매수 = False
        elif not (2.0 <= 시가대비등락율 < 8.0):
            매수 = False
        elif not (0.5 < 초당순매수금액 < 6 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.30)):
            매수 = False
        elif not (전일비 > 2 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.0):
            매수 = False
        elif not (당일거래대금 > 20 * 100):
            매수 = False
        # elif not (당일거래대금각도(30) > 1.5 and 당일거래대금각도(30) < 20):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.5):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.15):
        #     매수 = False
        # elif not (매도총잔량 * 0.05 < 매수총잔량 * 1.0):
        #     매수 = False
        # elif not (누적초당매수수량(30) * 0.3 < 누적초당매도수량(30) * 1.0):
        #     매수 = False
        # elif not (누적초당매도수량(30) * 1.0 < 누적초당매수수량(30) * 1.0):
        #     매수 = False
        # elif not (체결강도 >= 50 and 체결강도 <= 250):
        #     매수 = False


# ---------- 09:10:00 ~ 09:15:00 (고점 돌파 단계) ----------
elif 매수 and 91000 <= 시분초 < 91500:

    # 직전 고가 돌파 확인 (공통)
    if not (현재가 >= 고가N(1)):
        매수 = False

    elif 시가총액 < 3000:                       # 소형주
        if not (-1.0 <= 시가등락율 < 12.0):
            매수 = False
        elif not (2.5 <= 시가대비등락율 < 15.0):
            매수 = False
        elif not (0.8 < 초당순매수금액 < 10 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.15)):
            매수 = False
        elif not (전일비 > 3 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.2):
            매수 = False
        # elif not (등락각도(30) > 2 and 등락각도(30) < 25):
        #     매수 = False
        # elif not (당일거래대금각도(30) > 2 and 당일거래대금각도(30) < 28):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.8):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.20):
        #     매수 = False
        elif not (체결강도 >= 60 and 체결강도 <= 300):
            매수 = False

    elif 시가총액 < 10000:                      # 중형주
        if not (-0.5 <= 시가등락율 < 10.0):
            매수 = False
        elif not (2.0 <= 시가대비등락율 < 12.0):
            매수 = False
        elif not (0.6 < 초당순매수금액 < 8 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
            매수 = False
        elif not (전일비 > 2 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.0):
            매수 = False
        # elif not (등락각도(30) > 1.5 and 등락각도(30) < 20):
        #     매수 = False
        # elif not (당일거래대금각도(30) > 1.5 and 당일거래대금각도(30) < 23):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.5):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.15):
            매수 = False
        elif not (체결강도 >= 50 and 체결강도 <= 280):
            매수 = False

    else:                                       # 대형주
        if not (0.0 <= 시가등락율 < 8.0):
            매수 = False
        elif not (1.5 <= 시가대비등락율 < 10.0):
            매수 = False
        elif not (0.4 < 초당순매수금액 < 6 * 100):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
            매수 = False
        elif not (전일비 > 1 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 0.8):
            매수 = False
        # elif not (등락각도(30) > 1.0 and 등락각도(30) < 18):
        #     매수 = False
        # elif not (당일거래대금각도(30) > 1.0 and 당일거래대금각도(30) < 20):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.3):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.12):
            매수 = False
        elif not (체결강도 >= 45 and 체결강도 <= 250):
            매수 = False


# ---------- 09:15:00 ~ 09:20:00 (후반부 보수적 진입) ----------
elif 매수 and 91500 <= 시분초 < 92000:

    # 시가 대비 상승률 확인 (공통)
    if not (현재가 >= 시가 * 1.01):             # 시가 대비 최소 1% 이상
        매수 = False

    elif 시가총액 < 3000:                       # 소형주
        if not (0.0 <= 시가등락율 < 10.0):
            매수 = False
        elif not (2.0 <= 시가대비등락율 < 12.0):
            매수 = False
        elif not (0.5 < 초당순매수금액 < 10 * 100):
            매수 = False
        elif not (전일비 > 2 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.0):
            매수 = False
        # elif not (당일거래대금각도(30) > 1.5 and 당일거래대금각도(30) < 25):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.5):
            매수 = False
        # elif not (초당매수수량 > 매도총잔량 * 0.15):
        #     매수 = False
        elif not (체결강도 >= 50 and 체결강도 <= 300):
            매수 = False

    elif 시가총액 < 10000:                      # 중형주
        if not (0.0 <= 시가등락율 < 8.0):
            매수 = False
        elif not (1.5 <= 시가대비등락율 < 10.0):
            매수 = False
        elif not (0.4 < 초당순매수금액 < 8 * 100):
            매수 = False
        elif not (전일비 > 1.5 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 0.8):
            매수 = False
        # elif not (당일거래대금각도(30) > 1.0 and 당일거래대금각도(30) < 20):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.3):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.12):
            매수 = False
        elif not (체결강도 >= 45 and 체결강도 <= 280):
            매수 = False

    else:                                       # 대형주
        if not (0.0 <= 시가등락율 < 6.0):
            매수 = False
        elif not (1.0 <= 시가대비등락율 < 8.0):
            매수 = False
        elif not (0.3 < 초당순매수금액 < 600):
            매수 = False
        elif not (전일비 > 1 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 0.6):
            매수 = False
        # elif not (당일거래대금각도(30) > 0.5 and 당일거래대금각도(30) < 18):
        #     매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.2):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.10):
            매수 = False
        elif not (체결강도 >= 40 and 체결강도 <= 250):
            매수 = False


# ---------- 09:20:00 이후 ----------
else:
    매수 = False


# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

---

### 매도 조건식 - C_T_900_920_U2_S

매도 조건식은 **손절·익절·추세 훼손·시간 기반 청산** 네 가지 축으로 구성한다.

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율    = ((현재가 - 시가) / 시가) * 100                      # 단위: 퍼센트
# ------------------------------------------------
#  추가 지표 (활용 가능)
# ------------------------------------------------
# 매도잔량압력 = 매도총잔량 / 초당매도수량 if 초당매도수량 != 0 else 0
# 체결강도변동성 = (최고체결강도(10) - 최저체결강도(10)) / 체결강도평균(10) * 100 if 체결강도평균(10) != 0 else 0


# ================================
#  매도 조건
# ================================
매도 = False


# 1. 등락율 상한가 직전
if 등락율 > 29.0:
    매도 = True


# 2. 기본 손절 (가격 기준)
elif 시가대비등락율 < 0 and 수익률 <= -2.5 and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True


# 3. 보유시간 기반 손절
# elif 보유시간 > 60 and 현재가 < 최저현재가(int(60), int(보유시간)):
#     매도 = True


# 4. 시간대별 익절/손절 기준
elif 시분초 < 93000:                            # 09:30 이전

    # 기본 익절/손절
    if 수익률 >= 6.0 or 수익률 <= -5.0:
        매도 = True

    # Trailing Stop (최고수익률 대비)
    elif 최고수익률 > 7.0 and 최고수익률 * 0.6 >= 수익률:
        매도 = True

    # 시가총액별 추세 훼손 감지
    elif 시가총액 < 10000:
        if 등락율각도(30) >= 10 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.5 and (현재가 / 현재가N(1) - 1) * 100 < -0.5:
            매도 = True
        elif 등락율각도(30) < 10 and 등락율각도(30) >= 5 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.7 and (현재가 / 현재가N(1) - 1) * 100 < -0.7:
            매도 = True
        elif 등락율각도(30) < 5 and 등락율각도(30) >= 0 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.8 and (현재가 / 현재가N(1) - 1) * 100 < -0.5:
            매도 = True
        elif 5.0 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
            매도 = True


# 5. 체결강도 급락 + 거래대금 감소
elif 체결강도 <= 35 and 초당거래대금 < 초당거래대금N(1):
    매도 = True


# 6. 최대 보유시간 초과
elif 보유시간 >= 720:                          # 12분 초과 시 청산
    매도 = True


# 7. 전략 시간 종료 후 강제 청산
elif 시분초 >= 92000:                          # 09:20 이후 강제 청산
    매도 = True


# ================================
#  매도 호출
# ================================
if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

---

## 최적화 조건식

### 매수 최적화 조건식 - C_T_900_920_U2_BO

매수 조건식의 임계값들을 `self.vars[i]`로 치환하여 백테스트/GA에서 자동 최적화한다.

```python
# ================================
#  공통 계산 지표
# ================================
전일종가          = 현재가 / (1 + (등락율 / 100))
시가등락율        = ((시가 - 전일종가) / 전일종가) * 100
시가대비등락율    = ((현재가 - 시가) / 시가) * 100
초당순매수금액    = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000

매수 = True

# 1. 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (self.vars[1] <= 현재가 <= self.vars[2]):
    매수 = False
elif not (당일거래대금 >= self.vars[3]):
    매수 = False
elif not (등락율 >= self.vars[4]):
    매수 = False
elif not (고저평균대비등락율 > 0):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 시간대별 분기 및 최적화 변수 적용
# (각 시간대별로 self.vars[5] ~ self.vars[N] 사용)
# 구조는 기본 조건식과 동일하되, 모든 임계값을 self.vars로 치환
```

**매수 최적화 대상 변수 목록** (총 70개):

**공통 필터 변수 (1~4)**:
- `self.vars[1]`: 최소 현재가
- `self.vars[2]`: 최대 현재가
- `self.vars[3]`: 최소 당일거래대금
- `self.vars[4]`: 최소 등락율

**09:00~09:05 소형주 변수 (5~18)**:
- `self.vars[5]`: 시가등락율 하한
- `self.vars[6]`: 시가등락율 상한
- `self.vars[7]`: 시가대비등락율 하한
- `self.vars[8]`: 시가대비등락율 상한
- `self.vars[9]`: 초당순매수금액 상한
- `self.vars[10]`: 고가 대비 비율
- `self.vars[11]`: 회전율 하한
- `self.vars[12]`: 당일거래대금각도 하한
- `self.vars[13]`: 당일거래대금각도 상한
- `self.vars[14]`: 초당거래대금 배율
- `self.vars[15]`: 초당매수수량 대비 매도총잔량 비율
- `self.vars[16]`: 매도총잔량 하한 배율
- `self.vars[17]`: 매도총잔량 상한 배율
- `self.vars[18]`: 체결강도 하한

**(이하 중형주/대형주, 다른 시간대 변수 계속...)**

---

### 매수 최적화 범위 - C_T_900_920_U2_BOR

넓은 범위를 탐색하여 다양한 장세에서 최적값을 찾을 수 있도록 설정한다.

```python
# ================================
#  공통 필터 변수
# ================================
self.vars[1]  = [[500, 10000, 500], 1000]                              # 최소 현재가, 범위 개수: 20
self.vars[2]  = [[20000, 100000, 5000], 50000]                         # 최대 현재가, 범위 개수: 17
self.vars[3]  = [[1_000_000_000, 50_000_000_000, 5_000_000_000],
                  5_000_000_000]                                       # 최소 당일거래대금, 범위 개수: 10
self.vars[4]  = [[0.5, 10.0, 0.5], 1.0]                                # 최소 등락율, 범위 개수: 20


# ================================
#  09:00~09:05 소형주 변수
# ================================
self.vars[5]  = [[0.5, 5.0, 0.5], 2.0]                                 # 시가등락율 하한, 범위 개수: 10
self.vars[6]  = [[3.0, 10.0, 1.0], 5.0]                                # 시가등락율 상한, 범위 개수: 8
self.vars[7]  = [[0.0, 3.0, 0.5], 0.5]                                 # 시가대비등락율 하한, 범위 개수: 7
self.vars[8]  = [[5.0, 15.0, 1.0], 8.0]                                # 시가대비등락율 상한, 범위 개수: 11
self.vars[9]  = [[500, 2000, 100], 1000]                               # 초당순매수금액 상한, 범위 개수: 16
self.vars[10] = [[0.10, 0.30, 0.05], 0.20]                             # 고가 대비 비율, 범위 개수: 5
self.vars[11] = [[1.0, 5.0, 0.5], 2.0]                                 # 회전율 하한, 범위 개수: 9
self.vars[12] = [[2, 10, 1], 5]                                        # 당일거래대금각도 하한, 범위 개수: 9
self.vars[13] = [[20, 40, 2], 30]                                      # 당일거래대금각도 상한, 범위 개수: 11
self.vars[14] = [[1.5, 5.0, 0.5], 3.0]                                 # 초당거래대금 배율, 범위 개수: 8
self.vars[15] = [[0.10, 0.40, 0.05], 0.20]                             # 초당매수수량 대비 매도총잔량, 범위 개수: 7
self.vars[16] = [[0.05, 0.20, 0.05], 0.10]                             # 매도총잔량 하한 배율, 범위 개수: 4
self.vars[17] = [[1.5, 3.0, 0.5], 2.0]                                 # 매도총잔량 상한 배율, 범위 개수: 4
self.vars[18] = [[60, 150, 10], 100]                                   # 체결강도 하한, 범위 개수: 10

# 매수 총 경우의 수 (09:00~09:05 소형주만):
# 20 × 17 × 10 × 20 × 10 × 8 × 7 × 11 × 16 × 5 × 9 × 9 × 11 × 8 × 7 × 4 × 4 × 10
# = 매우 큰 수 (단계별 최적화 필요)


# ================================
#  09:00~09:05 중형주 변수
# ================================
self.vars[19] = [[0.5, 4.0, 0.5], 1.5]                                 # 시가등락율 하한, 범위 개수: 8
self.vars[20] = [[2.5, 8.0, 0.5], 4.0]                                 # 시가등락율 상한, 범위 개수: 12
self.vars[21] = [[0.0, 1.8, 0.3], 0.3]                                 # 시가대비등락율 하한, 범위 개수: 7
self.vars[22] = [[4.0, 12.0, 1.0], 6.0]                                # 시가대비등락율 상한, 범위 개수: 9
self.vars[23] = [[400, 1500, 100], 800]                                # 초당순매수금액 상한, 범위 개수: 12
self.vars[24] = [[0.15, 0.35, 0.05], 0.25]                             # 고가 대비 비율, 범위 개수: 5
self.vars[25] = [[0.8, 2.9, 0.3], 1.5]                                 # 회전율 하한, 범위 개수: 8
self.vars[26] = [[1, 8, 1], 3]                                         # 당일거래대금각도 하한, 범위 개수: 8
self.vars[27] = [[18, 34, 2], 25]                                      # 당일거래대금각도 상한, 범위 개수: 9
self.vars[28] = [[1.5, 4.0, 0.5], 2.5]                                 # 초당거래대금 배율, 범위 개수: 6
self.vars[29] = [[0.10, 0.30, 0.05], 0.15]                             # 초당매수수량 대비 매도총잔량, 범위 개수: 5
self.vars[30] = [[0.05, 0.15, 0.02], 0.08]                             # 매도총잔량 하한 배율, 범위 개수: 6
self.vars[31] = [[1.5, 3.5, 0.5], 2.5]                                 # 매도총잔량 상한 배율, 범위 개수: 5
self.vars[32] = [[50, 140, 10], 80]                                    # 체결강도 하한, 범위 개수: 10


# ================================
#  09:00~09:05 대형주 변수
# ================================
self.vars[33] = [[0.5, 3.0, 0.5], 1.0]                                 # 시가등락율 하한, 범위 개수: 6
self.vars[34] = [[2.0, 6.0, 0.5], 3.0]                                 # 시가등락율 상한, 범위 개수: 9
self.vars[35] = [[0.0, 1.4, 0.2], 0.2]                                 # 시가대비등락율 하한, 범위 개수: 8
self.vars[36] = [[3.0, 10.0, 1.0], 5.0]                                # 시가대비등락율 상한, 범위 개수: 8
self.vars[37] = [[300, 1000, 100], 600]                                # 초당순매수금액 상한, 범위 개수: 8
self.vars[38] = [[0.20, 0.40, 0.05], 0.30]                             # 고가 대비 비율, 범위 개수: 5
self.vars[39] = [[0.5, 2.3, 0.3], 1.0]                                 # 회전율 하한, 범위 개수: 7
self.vars[40] = [[1, 6, 1], 2]                                         # 당일거래대금각도 하한, 범위 개수: 6
self.vars[41] = [[15, 29, 2], 20]                                      # 당일거래대금각도 상한, 범위 개수: 8
self.vars[42] = [[1.2, 3.3, 0.3], 2.0]                                 # 초당거래대금 배율, 범위 개수: 8
self.vars[43] = [[0.08, 0.23, 0.03], 0.12]                             # 초당매수수량 대비 매도총잔량, 범위 개수: 6
self.vars[44] = [[0.03, 0.09, 0.02], 0.05]                             # 매도총잔량 하한 배율, 범위 개수: 4
self.vars[45] = [[2.0, 4.0, 0.5], 3.0]                                 # 매도총잔량 상한 배율, 범위 개수: 5
self.vars[46] = [[40, 130, 10], 70]                                    # 체결강도 하한, 범위 개수: 10


# ================================
#  09:05~09:10 소형주 변수 (47~61)
# ================================
self.vars[47] = [[-1.0, 5.0, 1.0], 0.0]                                # 시가등락율 하한, 범위 개수: 7
self.vars[48] = [[8.0, 15.0, 1.0], 10.0]                               # 시가등락율 상한, 범위 개수: 8
self.vars[49] = [[2.0, 6.0, 0.5], 3.0]                                 # 시가대비등락율 하한, 범위 개수: 9
self.vars[50] = [[10.0, 18.0, 1.0], 12.0]                              # 시가대비등락율 상한, 범위 개수: 9
self.vars[51] = [[500, 2000, 150], 1000]                               # 초당순매수금액 상한, 범위 개수: 11
self.vars[52] = [[3, 15, 2], 5]                                        # 전일비 하한, 범위 개수: 7
self.vars[53] = [[0.8, 2.9, 0.3], 1.5]                                 # 회전율 하한, 범위 개수: 8
self.vars[54] = [[30, 100, 10], 50]                                    # 당일거래대금 하한, 범위 개수: 8
self.vars[55] = [[1, 8, 1], 3]                                         # 당일거래대금각도 하한, 범위 개수: 8
self.vars[56] = [[20, 40, 2], 30]                                      # 당일거래대금각도 상한, 범위 개수: 11
self.vars[57] = [[1.2, 3.9, 0.3], 2.0]                                 # 초당거래대금 배율, 범위 개수: 10
self.vars[58] = [[0.15, 0.40, 0.05], 0.25]                             # 초당매수수량 대비 매도총잔량, 범위 개수: 6
self.vars[59] = [[0.3, 0.7, 0.1], 0.5]                                 # 누적초당매수수량 하한 비율, 범위 개수: 5
self.vars[60] = [[0.8, 1.2, 0.1], 1.0]                                 # 누적초당매도수량 비율, 범위 개수: 5
self.vars[61] = [[50, 140, 10], 70]                                    # 체결강도 하한, 범위 개수: 10

# (이하 09:05~09:10 중형주/대형주, 09:10~09:15, 09:15~09:20 변수 계속...)
# 총 변수 개수: 약 100개 내외
```

---

### 매도 최적화 조건식 - C_T_900_920_U2_SO

매도 조건식의 임계값을 `self.vars`로 치환한다.

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율    = ((현재가 - 시가) / 시가) * 100

매도 = False

# 1. 등락율 상한가 직전
if 등락율 > self.vars[101]:
    매도 = True

# 2. 기본 손절
elif 시가대비등락율 < 0 and 수익률 <= self.vars[102] and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True

# 3. 보유시간 기반 손절
elif 보유시간 > 60 and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True

# 4. 익절/손절 기준
elif 시분초 < 93000:
    if 수익률 >= self.vars[103] or 수익률 <= self.vars[104]:
        매도 = True
    elif 최고수익률 > self.vars[105] and 최고수익률 * self.vars[106] >= 수익률:
        매도 = True
    # (이하 추세 훼손 조건 동일)

# 5. 체결강도 급락
elif 체결강도 <= self.vars[107] and 초당거래대금 < 초당거래대금N(1):
    매도 = True

# 6. 최대 보유시간
elif 보유시간 >= self.vars[108]:
    매도 = True

# 7. 전략 종료
elif 시분초 >= 92000:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

**매도 최적화 대상 변수**:
- `self.vars[101]`: 등락율 상한가 기준
- `self.vars[102]`: 손절 수익률
- `self.vars[103]`: 익절 수익률
- `self.vars[104]`: 손절 수익률 하한
- `self.vars[105]`: Trailing Stop 최고수익률 기준
- `self.vars[106]`: Trailing Stop 비율
- `self.vars[107]`: 추세 훼손 체결강도
- `self.vars[108]`: 최대 보유시간

---

### 매도 최적화 범위 - C_T_900_920_U2_SOR

```python
# ================================
#  매도 최적화 범위
# ================================
self.vars[101] = [[27.0, 30.0, 0.5], 29.0]                             # 등락율 상한가, 범위 개수: 7
self.vars[102] = [[-4.0, -1.0, 0.5], -2.5]                             # 손절 수익률, 범위 개수: 7
self.vars[103] = [[3.0, 10.0, 0.5], 6.0]                               # 익절 수익률, 범위 개수: 15
self.vars[104] = [[-8.0, -3.0, 0.5], -5.0]                             # 손절 수익률 하한, 범위 개수: 11
self.vars[105] = [[5.0, 10.0, 0.5], 7.0]                               # Trailing Stop 기준, 범위 개수: 11
self.vars[106] = [[0.5, 0.8, 0.05], 0.6]                               # Trailing Stop 비율, 범위 개수: 7
self.vars[107] = [[20, 60, 5], 35]                                     # 추세 훼손 체결강도, 범위 개수: 9
self.vars[108] = [[300, 1200, 60], 720]                                # 최대 보유시간(초), 범위 개수: 16

# 매도 총 경우의 수: 7 × 7 × 15 × 11 × 11 × 7 × 9 × 16 = 108,584,220
```

---

### 매수·매도 통합 최적화 범위 - C_T_900_920_U2_OR

전체 변수를 동시에 최적화하면 계산 시간이 과도하게 소요되므로, **핵심 변수만 선별**하여 통합 최적화한다.

```python
# ================================
#  핵심 변수 선별 (20개)
# ================================
# 공통 필터 (4개): vars[1], vars[2], vars[3], vars[4]
# 09:00~09:05 소형주 핵심 (6개): vars[5], vars[8], vars[11], vars[14], vars[15], vars[18]
# 09:05~09:10 소형주 핵심 (4개): vars[49], vars[53], vars[57], vars[61]
# 매도 핵심 (6개): vars[101], vars[102], vars[103], vars[104], vars[105], vars[106]

# 통합 최적화 인덱스 리스트
OR_CORE_VARS = [1, 2, 3, 4, 5, 8, 11, 14, 15, 18, 49, 53, 57, 61,
                101, 102, 103, 104, 105, 106]

# 총 경우의 수 (핵심 변수만):
# 20 × 17 × 10 × 20 × 10 × 11 × 9 × 8 × 7 × 10 × 9 × 8 × 10 × 10
# × 7 × 7 × 15 × 11 × 11 × 7
# = 매우 큰 수 (GA 최적화 권장)
```

---

### 예상 시간 계산

**전체 변수 조합 계산 (비현실적)**:
- 매수 변수: ~100개 변수, 각 평균 범위 개수 8개
- 매도 변수: 8개 변수, 총 경우의 수 108,584,220
- 전체 조합: 사실상 계산 불가능

**현실적 최적화 전략**:

1. **단계별 최적화**:
   - 1단계: 공통 필터 변수만 최적화 (vars[1]~vars[4])
   - 2단계: 09:00~09:05 소형주 최적화
   - 3단계: 다른 시간대 및 시가총액 최적화
   - 4단계: 매도 조건 최적화
   - 5단계: 핵심 변수 통합 최적화

2. **GA 최적화 우선 사용**:
   - 전체 그리드 탐색 대신 GA로 효율적 탐색
   - 세대당 100개 개체, 50세대 = 5,000회 평가
   - 각 평가 1분 소요 시 총 5,000분 ≈ 83시간 ≈ 3.5일

3. **2단계 정밀 탐색**:
   - 1차 GA로 최적 구간 파악
   - 2차 GA로 해당 구간 정밀 탐색

---

### GA 최적화 범위 - C_T_900_920_U2_GAR

GA 최적화를 위해 각 변수를 리스트 형태로 변환한다.

```python
# ================================
#  공통 필터 변수 (GA 변환)
# ================================
self.vars[1]  = [[500, 1000, 2000, 3000, 5000, 7000, 10000], 1000]    # 최소 현재가, 범위 개수: 7
self.vars[2]  = [[20000, 30000, 40000, 50000, 60000, 80000, 100000],
                  50000]                                               # 최대 현재가, 범위 개수: 7
self.vars[3]  = [[1_000_000_000, 5_000_000_000, 10_000_000_000,
                  20_000_000_000, 30_000_000_000, 50_000_000_000],
                  5_000_000_000]                                       # 최소 당일거래대금, 범위 개수: 6
self.vars[4]  = [[0.5, 1.0, 1.5, 2.0, 3.0, 5.0, 7.0, 10.0], 1.0]      # 최소 등락율, 범위 개수: 8


# ================================
#  09:00~09:05 소형주 핵심 변수 (GA 변환)
# ================================
self.vars[5]  = [[0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0], 2.0]       # 시가등락율 하한, 범위 개수: 8
self.vars[6]  = [[3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0], 5.0]           # 시가등락율 상한, 범위 개수: 7
self.vars[7]  = [[0.0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0], 0.5]            # 시가대비등락율 하한, 범위 개수: 7
self.vars[8]  = [[5.0, 6.0, 7.0, 8.0, 10.0, 12.0, 15.0], 8.0]         # 시가대비등락율 상한, 범위 개수: 7
self.vars[9]  = [[500, 700, 1000, 1300, 1500, 2000], 1000]            # 초당순매수금액 상한, 범위 개수: 6
self.vars[10] = [[0.10, 0.15, 0.20, 0.25, 0.30], 0.20]                # 고가 대비 비율, 범위 개수: 5
self.vars[11] = [[1.0, 1.5, 2.0, 2.5, 3.0, 4.0, 5.0], 2.0]            # 회전율 하한, 범위 개수: 7
self.vars[12] = [[2, 3, 5, 7, 10], 5]                                 # 당일거래대금각도 하한, 범위 개수: 5
self.vars[13] = [[20, 25, 30, 35, 40], 30]                            # 당일거래대금각도 상한, 범위 개수: 5
self.vars[14] = [[1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 5.0], 3.0]            # 초당거래대금 배율, 범위 개수: 7
self.vars[15] = [[0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40], 0.20]    # 초당매수수량 대비 매도총잔량, 범위 개수: 7
self.vars[16] = [[0.05, 0.10, 0.15, 0.20], 0.10]                      # 매도총잔량 하한 배율, 범위 개수: 4
self.vars[17] = [[1.5, 2.0, 2.5, 3.0], 2.0]                           # 매도총잔량 상한 배율, 범위 개수: 4
self.vars[18] = [[60, 80, 100, 120, 150], 100]                        # 체결강도 하한, 범위 개수: 5


# ================================
#  매도 핵심 변수 (GA 변환)
# ================================
self.vars[101] = [[27.0, 28.0, 29.0, 29.5, 30.0], 29.0]               # 등락율 상한가, 범위 개수: 5
self.vars[102] = [[-4.0, -3.5, -3.0, -2.5, -2.0, -1.5, -1.0], -2.5]   # 손절 수익률, 범위 개수: 7
self.vars[103] = [[3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 10.0], 6.0]          # 익절 수익률, 범위 개수: 7
self.vars[104] = [[-8.0, -7.0, -6.0, -5.0, -4.0, -3.0], -5.0]         # 손절 수익률 하한, 범위 개수: 6
self.vars[105] = [[5.0, 6.0, 7.0, 8.0, 10.0], 7.0]                    # Trailing Stop 기준, 범위 개수: 5
self.vars[106] = [[0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8], 0.6]        # Trailing Stop 비율, 범위 개수: 7
self.vars[107] = [[20, 30, 35, 40, 50, 60], 35]                       # 추세 훼손 체결강도, 범위 개수: 6
self.vars[108] = [[300, 480, 600, 720, 900, 1200], 720]               # 최대 보유시간, 범위 개수: 6

# (이하 다른 시간대 및 시가총액 변수 계속...)
```

---



---

## 최적화 조건식

## BO (Buy Optimization)

```python
# 기본 매수 조건을 self.vars로 변환
# 주요 변수만 최적화 대상으로 선정
# self.vars[0] 사용 - 값: 0.05
# self.vars[1] 사용 - 값: 0.08
# self.vars[2] 사용 - 값: 0.1
# self.vars[3] 사용 - 값: 0.12
# self.vars[4] 사용 - 값: 0.15
# self.vars[5] 사용 - 값: 0.2
# self.vars[6] 사용 - 값: 0.25
# self.vars[7] 사용 - 값: 0.3
# self.vars[8] 사용 - 값: 0.4
# self.vars[9] 사용 - 값: 0.5
```

## BOR (Buy Optimization Range)

```python
self.vars[0] = [[0.1, 0.1, 0.1], 0.05]  # 비율 (0.05)
self.vars[1] = [[0.1, 0.1, 0.1], 0.08]  # 비율 (0.08)
self.vars[2] = [[0.1, 0.1, 0.1], 0.1]  # 비율 (0.1)
self.vars[3] = [[0.1, 0.2, 0.1], 0.12]  # 비율 (0.12)
self.vars[4] = [[0.1, 0.2, 0.1], 0.15]  # 비율 (0.15)
self.vars[5] = [[0.1, 0.3, 0.1], 0.2]  # 비율 (0.2)
self.vars[6] = [[0.2, 0.3, 0.1], 0.25]  # 비율 (0.25)
self.vars[7] = [[0.2, 0.4, 0.1], 0.3]  # 비율 (0.3)
self.vars[8] = [[0.3, 0.5, 0.1], 0.4]  # 비율 (0.4)
self.vars[9] = [[0.3, 0.7, 0.1], 0.5]  # 비율 (0.5)
self.vars[10] = [[0.4, 0.8, 0.1], 0.6]  # 비율 (0.6)
self.vars[11] = [[0.6, 1.0, 0.1], 0.8]  # 비율 (0.8)
self.vars[12] = [[1, 1, 1], 1]  # 카운트 (1)
self.vars[13] = [[1.0, 1.0, 1.0], 1.01]  # 카운트 (1.01)
self.vars[14] = [[1.0, 1.0, 1.0], 1.2]  # 카운트 (1.2)
self.vars[15] = [[1.0, 1.0, 1.0], 1.3]  # 카운트 (1.3)
self.vars[16] = [[1.0, 1.0, 1.0], 1.5]  # 카운트 (1.5)
self.vars[17] = [[1.0, 2.0, 1.0], 1.8]  # 카운트 (1.8)
self.vars[18] = [[1.0, 2.0, 1.0], 2.0]  # 카운트 (2.0)
self.vars[19] = [[1.0, 3.0, 1.0], 2.5]  # 카운트 (2.5)
```

## SO (Sell Optimization)

```python
# 기본 매도 조건을 self.vars로 변환
# 주요 변수만 최적화 대상으로 선정
# self.vars[20] 사용 - 값: 0.5
# self.vars[21] 사용 - 값: 0.6
# self.vars[22] 사용 - 값: 0.7
# self.vars[23] 사용 - 값: 0.8
# self.vars[24] 사용 - 값: 1
# self.vars[25] 사용 - 값: 2.5
# self.vars[26] 사용 - 값: 5.0
# self.vars[27] 사용 - 값: 6.0
# self.vars[28] 사용 - 값: 7.0
# self.vars[29] 사용 - 값: 10
```

## SOR (Sell Optimization Range)

```python
self.vars[20] = [[0.3, 0.7, 0.1], 0.5]  # 비율 (0.5)
self.vars[21] = [[0.4, 0.8, 0.1], 0.6]  # 비율 (0.6)
self.vars[22] = [[0.5, 0.9, 0.1], 0.7]  # 비율 (0.7)
self.vars[23] = [[0.6, 1.0, 0.1], 0.8]  # 비율 (0.8)
self.vars[24] = [[1, 1, 1], 1]  # 카운트 (1)
self.vars[25] = [[1.0, 3.0, 1.0], 2.5]  # 카운트 (2.5)
self.vars[26] = [[3.0, 6.0, 1.0], 5.0]  # 카운트 (5.0)
self.vars[27] = [[4.0, 7.0, 1.0], 6.0]  # 카운트 (6.0)
self.vars[28] = [[4.0, 9.0, 1.0], 7.0]  # 카운트 (7.0)
self.vars[29] = [[10, 13, 5], 10]  # 임계값 (10)
self.vars[30] = [[20.0, 37.0, 5.0], 29.0]  # 임계값 (29.0)
self.vars[31] = [[21, 39, 5], 30]  # 임계값 (30)
```

## OR (Optimum Range)

핵심 변수만 선별하여 최적화 (최대 10개)

```python
self.vars[0] = [[0.3, 0.7, 0.1], 0.5]  # 비율 (0.5)
self.vars[1] = [[0.4, 0.8, 0.1], 0.6]  # 비율 (0.6)
self.vars[2] = [[0.5, 0.9, 0.1], 0.7]  # 비율 (0.7)
self.vars[3] = [[0.6, 1.0, 0.1], 0.8]  # 비율 (0.8)
self.vars[4] = [[1, 1, 1], 1]  # 카운트 (1)
self.vars[5] = [[1.0, 3.0, 1.0], 2.5]  # 카운트 (2.5)
self.vars[6] = [[0.1, 0.1, 0.1], 0.05]  # 비율 (0.05)
self.vars[7] = [[0.1, 0.1, 0.1], 0.08]  # 비율 (0.08)
self.vars[8] = [[0.1, 0.1, 0.1], 0.1]  # 비율 (0.1)
self.vars[9] = [[0.1, 0.2, 0.1], 0.12]  # 비율 (0.12)
```

**예상 경우의 수**: 약 10,000,000,000

## GAR (Genetic Algorithm Range)

```python
self.vars[0] = [[0.3, 0.7], 0.5]  # 비율 (0.5)
self.vars[1] = [[0.4, 0.8], 0.6]  # 비율 (0.6)
self.vars[2] = [[0.5, 0.9], 0.7]  # 비율 (0.7)
self.vars[3] = [[0.6, 1.0], 0.8]  # 비율 (0.8)
self.vars[4] = [[1, 1]]  # 카운트 (1)
self.vars[5] = [[1.0, 3.0, 1.0], 2.5]  # 카운트 (2.5)
self.vars[6] = [[0.1, 0.1], 0.05]  # 비율 (0.05)
self.vars[7] = [[0.1, 0.1], 0.08]  # 비율 (0.08)
self.vars[8] = [[0.1, 0.1]]  # 비율 (0.1)
self.vars[9] = [[0.1, 0.2], 0.12]  # 비율 (0.12)
```

## 조건식 개선 방향 연구

### 1. 추가 지표 활용 연구

#### 1.1 누적거래대금비율
```python
누적거래대금비율 = 당일거래대금 / (시가총액 * 회전율 / 100) * 100 if (시가총액 * 회전율 / 100) != 0 else 0
```
- **활용 방안**: 시가총액 대비 거래대금 비율로 과열 여부 판단
- **적용 예시**: `누적거래대금비율 > 150` → 과열 구간, 매수 제한
- **최적화 범위**: `[[100, 250, 20], 150]`, 범위 개수: 8

#### 1.2 초당순매수비율
```python
초당순매수비율 = 초당매수수량 / (초당매수수량 + 초당매도수량) * 100 if (초당매수수량 + 초당매도수량) != 0 else 0
```
- **활용 방안**: 매수세 우위 정도 측정
- **적용 예시**: `초당순매수비율 > 60` → 강한 매수세 확인
- **최적화 범위**: `[[50, 80, 5], 60]`, 범위 개수: 7
- **시간대별 차등**: 09:00~09:05 (60), 09:05~09:10 (55), 09:10~09:15 (50), 09:15~09:20 (45)

#### 1.3 거래대금가속도
```python
거래대금가속도 = (초당거래대금 - 초당거래대금N(1)) / 초당거래대금N(1) * 100 if 초당거래대금N(1) != 0 else 0
```
- **활용 방안**: 거래대금 급증 시점 포착
- **적용 예시**: `거래대금가속도 > 30` → 급격한 거래 증가
- **최적화 범위**: `[[10, 60, 10], 30]`, 범위 개수: 6

#### 1.4 체결강도가속도
```python
체결강도가속도 = (체결강도 - 체결강도N(1)) / 체결강도N(1) * 100 if 체결강도N(1) != 0 else 0
```
- **활용 방안**: 체결강도 급상승 포착
- **적용 예시**: `체결강도가속도 > 20` → 매수세 급증
- **최적화 범위**: `[[10, 40, 5], 20]`, 범위 개수: 7

---

### 2. TA-Lib 보조지표 활용 연구

#### 2.1 볼린저 밴드 (BBU, BBM, BBL)
```python
# 매수 조건에 추가
if not (BBL < 현재가 < BBU):                    # 볼린저 밴드 내부에서 거래
    매수 = False
elif not (현재가 > BBM):                        # 중심선 위에서 매수
    매수 = False
```
- **활용 방안**: 과매도 구간 진입 및 중심선 돌파 확인
- **시간대별 적용**: 09:15~09:20 후반부에서 안정성 확인용
- **최적화 범위**: BBM 대비 현재가 비율 `[[0.98, 1.10, 0.02], 1.00]`, 범위 개수: 7

#### 2.2 MACD 지표
```python
# 매수 조건에 추가
if not (MACD > MACDS and MACD_N(1) <= MACDS_N(1)):    # 골든크로스
    매수 = False
elif not (MACD > 0):                                 # MACD > 0 (상승 추세)
    매수 = False
```
- **활용 방안**: 추세 전환 시점 포착
- **시간대별 적용**: 09:05~09:10, 09:10~09:15 추세 지속 확인
- **최적화 범위**: MACD 차이값 `[[-10, 10, 2], 0]`, 범위 개수: 11

#### 2.3 RSI 지표
```python
# 매수 조건에 추가
if not (25 < RSI < 75):                              # 과매도/과매수 구간 제외
    매수 = False
```
- **활용 방안**: 극단적 과매도/과매수 구간 회피
- **최적화 범위**:
  - RSI 하한 `[[20, 40, 5], 25]`, 범위 개수: 5
  - RSI 상한 `[[60, 80, 5], 75]`, 범위 개수: 5
- **시간대별 차등**: 초반일수록 넓은 범위 허용

#### 2.4 이동평균선 (MA)
```python
# 매수 조건에 추가
if not (현재가 > 이동평균(60)):                     # 60틱 이동평균 위
    매수 = False
elif not (이동평균(30) > 이동평균(60)):             # 단기 > 장기 (골든크로스)
    매수 = False
```
- **활용 방안**: 단기/장기 이동평균 관계로 추세 확인
- **최적화 범위**:
  - 단기 이동평균 기간 `[[20, 60, 10], 30]`, 범위 개수: 5
  - 장기 이동평균 기간 `[[40, 120, 20], 60]`, 범위 개수: 5

---

### 3. 구간 연산 변수 활용 연구

#### 3.1 등락율각도 세분화
```python
# 시간대별 등락율각도 조합
if 시분초 < 90500:                                  # 09:00~09:05
    if not (등락율각도(30) > 5 and 등락율각도(30) < 25):
        매수 = False
elif 90500 <= 시분초 < 91000:                       # 09:05~09:10
    if not (등락율각도(30) > 3 and 등락율각도(30) < 20):
        매수 = False
elif 91000 <= 시분초 < 91500:                       # 09:10~09:15
    if not (등락율각도(30) > 2 and 등락율각도(30) < 18):
        매수 = False
else:                                               # 09:15~09:20
    if not (등락율각도(30) > 1 and 등락율각도(30) < 15):
        매수 = False
```
- **활용 방안**: 시간 경과에 따른 각도 임계값 완화
- **최적화 범위** (09:00~09:05): `[[3, 10, 1], 5]`, 범위 개수: 8

#### 3.2 체결강도평균 활용
```python
# 매수 조건에 추가
if not (체결강도 > 체결강도평균(30) * 1.2):         # 평균 대비 120% 이상
    매수 = False
```
- **활용 방안**: 최근 평균 대비 체결강도 증가 확인
- **최적화 범위**: `[[1.0, 2.0, 0.1], 1.2]`, 범위 개수: 11

#### 3.3 최고/최저 변수 활용
```python
# 매수 조건에 추가
if not (현재가 >= 최고현재가(30) * 0.95):            # 최근 30틱 최고가 근처
    매수 = False
```
- **활용 방안**: 최근 고점 근처에서만 매수
- **최적화 범위**: `[[0.90, 1.00, 0.02], 0.95]`, 범위 개수: 6

---

### 4. 매도 조건 고도화 연구

#### 4.1 시가총액별 손절 기준 차등화
```python
# 시가총액별 손절 차등
if 시가총액 < 3000:                                 # 소형주
    if 수익률 <= -3.5:
        매도 = True
elif 시가총액 < 10000:                              # 중형주
    if 수익률 <= -3.0:
        매도 = True
else:                                               # 대형주
    if 수익률 <= -2.5:
        매도 = True
```
- **활용 방안**: 변동성 차이 반영
- **최적화 범위**:
  - 소형주 손절 `[[-5.0, -2.0, 0.5], -3.5]`, 범위 개수: 7
  - 중형주 손절 `[[-4.5, -1.5, 0.5], -3.0]`, 범위 개수: 7
  - 대형주 손절 `[[-4.0, -1.0, 0.5], -2.5]`, 범위 개수: 7

#### 4.2 보유시간별 익절 기준 차등화
```python
# 보유시간별 익절
if 보유시간 < 60:                                   # 1분 이내
    if 수익률 >= 3.0:
        매도 = True
elif 보유시간 < 180:                                # 3분 이내
    if 수익률 >= 4.5:
        매도 = True
elif 보유시간 < 360:                                # 6분 이내
    if 수익률 >= 6.0:
        매도 = True
else:                                               # 6분 이상
    if 수익률 >= 7.0:
        매도 = True
```
- **활용 방안**: 보유시간에 따른 목표 수익률 조정
- **최적화 범위**:
  - 단기(< 60초) 익절 `[[2.0, 5.0, 0.5], 3.0]`, 범위 개수: 7
  - 중기(< 180초) 익절 `[[3.0, 7.0, 0.5], 4.5]`, 범위 개수: 9
  - 장기(< 360초) 익절 `[[4.0, 10.0, 0.5], 6.0]`, 범위 개수: 13

#### 4.3 동적 Trailing Stop
```python
# 동적 Trailing Stop
if 최고수익률 > 10.0:                               # 고수익 구간
    if 수익률 < 최고수익률 * 0.7:
        매도 = True
elif 최고수익률 > 7.0:                              # 중수익 구간
    if 수익률 < 최고수익률 * 0.6:
        매도 = True
elif 최고수익률 > 5.0:                              # 저수익 구간
    if 수익률 < 최고수익률 * 0.5:
        매도 = True
```
- **활용 방안**: 최고수익률 구간별 차등 Trailing
- **최적화 범위**:
  - 고수익 비율 `[[0.6, 0.8, 0.05], 0.7]`, 범위 개수: 5
  - 중수익 비율 `[[0.5, 0.7, 0.05], 0.6]`, 범위 개수: 5
  - 저수익 비율 `[[0.4, 0.6, 0.05], 0.5]`, 범위 개수: 5

---

### 5. 복합 지표 조합 연구

#### 5.1 매수세 강도 지수 (Buy Pressure Index)
```python
# 복합 매수세 강도 지수
매수세강도 = (
    (초당매수수량 / 매도총잔량 * 100 if 매도총잔량 != 0 else 0) * 0.25 +
    체결강도 * 0.30 +
    (초당순매수금액 / 100) * 0.20 +
    등락율각도(30) * 0.15 +
    (초당거래대금 / 초당거래대금평균(30) * 10 if 초당거래대금평균(30) != 0 else 0) * 0.10
)

if not (매수세강도 > 100):                          # 임계값 설정
    매수 = False
```
- **활용 방안**: 다차원 매수 신호 종합
- **최적화 범위**: `[[80, 150, 10], 100]`, 범위 개수: 8
- **시간대별 차등**: 초반 높은 임계값, 후반 낮은 임계값

#### 5.2 거래 신뢰도 지수 (Trade Reliability Index)
```python
# 거래량 기반 신뢰도
거래신뢰도 = (
    (전일비 / 100) * 0.35 +
    (회전율 / 5) * 0.30 +
    (당일거래대금각도(30) / 20) * 0.25 +
    (전일동시간비 / 100) * 0.10
)

if not (거래신뢰도 > 0.8):                          # 임계값 설정
    매수 = False
```
- **활용 방안**: 거래량 기반 신뢰도 평가
- **최적화 범위**: `[[0.6, 1.2, 0.1], 0.8]`, 범위 개수: 7

#### 5.3 모멘텀 지속성 지수 (Momentum Persistence Index)
```python
# 모멘텀 지속성 평가
모멘텀지속성 = (
    (등락율 / 10) * 0.30 +
    (시가대비등락율 / 10) * 0.25 +
    (등락율각도(30) / 10) * 0.25 +
    (현재가 / 고가 * 100) * 0.20
)

if not (모멘텀지속성 > 0.7):                        # 임계값 설정
    매수 = False
```
- **활용 방안**: 가격 모멘텀 지속 가능성 평가
- **최적화 범위**: `[[0.5, 1.0, 0.1], 0.7]`, 범위 개수: 6

---

### 6. 시간대별 전략 세분화 연구

#### 6.1 09:00~09:05 구간 3분할
```python
# 09:00~09:05를 3개 구간으로 세분화
if 시분초 < 90100:                                  # 09:00~09:01 (초기 1분)
    # 매우 보수적 조건 (체결강도 120 이상, 초당거래대금 5억 이상)
    if not (체결강도 >= 120 and 초당거래대금 >= 500_000_000):
        매수 = False

elif 시분초 < 90300:                                # 09:01~09:03 (중기 2분)
    # 표준 조건 (체결강도 100 이상, 초당거래대금 3억 이상)
    if not (체결강도 >= 100 and 초당거래대금 >= 300_000_000):
        매수 = False

else:                                               # 09:03~09:05 (후기 2분)
    # 완화된 조건 (체결강도 80 이상, 초당거래대금 2억 이상)
    if not (체결강도 >= 80 and 초당거래대금 >= 200_000_000):
        매수 = False
```
- **활용 방안**: 장 시작 직후 변동성 반영
- **최적화 범위**: 각 구간별 체결강도/초당거래대금 독립 최적화

#### 6.2 시간 경과 가중치 시스템
```python
# 시간 경과에 따른 동적 가중치
경과시간 = (시분초 - 90000) / 100                   # 0 ~ 20분 사이 값

# 체결강도 임계값 동적 조정
체결강도임계값 = 100 - (경과시간 * 2)                # 100에서 시작하여 20분 후 60

if not (체결강도 >= 체결강도임계값):
    매수 = False
```
- **활용 방안**: 시간 흐름에 따른 자연스러운 조건 완화
- **최적화 범위**:
  - 초기 임계값 `[[80, 150, 10], 100]`, 범위 개수: 8
  - 감소율 `[[1, 5, 0.5], 2]`, 범위 개수: 9

---

### 7. 최적화 전략 개선 연구

#### 7.1 계층적 최적화 (Hierarchical Optimization)
```
Level 1: 공통 필터 최적화 (vars[1]~vars[4])
  ↓
Level 2: 시간대별 최적화 (09:00~09:05, 09:05~09:10, ...)
  ↓
Level 3: 시가총액별 최적화 (소형주, 중형주, 대형주)
  ↓
Level 4: 매도 조건 최적화 (vars[101]~vars[108])
  ↓
Level 5: 핵심 변수 통합 최적화 (GA)
```
- **장점**: 단계별 최적화로 계산 시간 단축
- **예상 시간**: 각 레벨당 2~3일, 총 10~15일

#### 7.2 앙상블 최적화
```python
# 여러 최적화 결과 조합
최종조건 = (
    GA최적화결과1 * 0.4 +
    GA최적화결과2 * 0.3 +
    그리드탐색결과 * 0.3
)
```
- **활용 방안**: 여러 최적화 방법의 장점 결합
- **구현**: 각 방법별 상위 10개 결과의 가중 평균

#### 7.3 강건성 테스트 (Robustness Test)
```python
# 최적값 주변 ±10% 범위에서 성능 테스트
for 변수 in 핵심변수들:
    최적값 = self.vars[변수][1]
    for 배율 in [0.9, 0.95, 1.0, 1.05, 1.1]:
        테스트값 = 최적값 * 배율
        성능측정(테스트값)
```
- **활용 방안**: 과최적화 방지 및 안정성 확인
- **기준**: ±10% 범위에서 성능 변동 < 20%

---

### 8. 리스크 관리 강화 연구

#### 8.1 포지션 사이징 (Position Sizing)
```python
# 시가총액별 차등 매수수량
if 시가총액 < 3000:                                 # 소형주
    매수수량 = 기본매수수량 * 0.7                     # 70%만 매수
elif 시가총액 < 10000:                              # 중형주
    매수수량 = 기본매수수량 * 1.0                     # 100% 매수
else:                                               # 대형주
    매수수량 = 기본매수수량 * 1.3                     # 130% 매수
```
- **활용 방안**: 변동성에 따른 포지션 조절
- **최적화 범위**:
  - 소형주 비율 `[[0.5, 1.0, 0.1], 0.7]`, 범위 개수: 6
  - 대형주 비율 `[[1.0, 1.5, 0.1], 1.3]`, 범위 개수: 6

#### 8.2 동시 보유 종목 수 제한
```python
# 전역 변수로 현재 보유 종목 수 관리
if 현재보유종목수 >= 5:                              # 최대 5개 동시 보유
    매수 = False
```
- **활용 방안**: 분산 투자 및 집중 리스크 관리
- **최적화 범위**: `[[2, 10, 1], 5]`, 범위 개수: 9

#### 8.3 연속 손실 제한
```python
# 전역 변수로 연속 손실 횟수 추적
if 연속손실횟수 >= 3:                               # 3회 연속 손실 시 중단
    매수 = False
```
- **활용 방안**: 시스템 오작동 또는 장세 부적합 시 손실 최소화
- **최적화 범위**: `[[2, 7, 1], 3]`, 범위 개수: 6

#### 8.4 일일 손실 한도 (Daily Loss Limit)
```python
# 당일 누적 손실 확인
if 당일누적손실 <= -100000:                         # -10만원 이상 손실 시 중단
    매수 = False
```
- **활용 방안**: 계좌 보호
- **최적화 범위**: `[[-200000, -50000, 25000], -100000]`, 범위 개수: 7

---

### 9. 백테스팅 개선 방향

#### 9.1 슬리피지 (Slippage) 반영
```python
# 실제 체결가 = 호가 + 슬리피지
if 매수:
    슬리피지 = 호가단위 * 0.5                        # 평균 0.5호가 불리
    실제매수가 = 매도호가1 + 슬리피지
```
- **적용**: 백테스팅 시 수익률 계산에 슬리피지 반영
- **최적화 범위**: `[[0.2, 1.0, 0.1], 0.5]`, 범위 개수: 9

#### 9.2 시장 충격 (Market Impact)
```python
# 대량 매수 시 가격 상승 효과
if 매수수량 > 매도총잔량 * 0.3:
    시장충격비율 = (매수수량 / 매도총잔량) * 0.02
    실제매수가 = 매도호가1 * (1 + 시장충격비율)
```
- **적용**: 대량 주문 시 가격 영향 반영
- **최적화 범위**: `[[0.01, 0.05, 0.01], 0.02]`, 범위 개수: 5

#### 9.3 체결 지연 (Execution Delay)
```python
# 주문 후 1~2틱 지연 반영
체결가 = 현재가N(1)                                  # 1틱 전 가격으로 체결
```
- **적용**: 실제 체결 시간 지연 반영

---

### 10. 구현 우선순위

#### 10.1 즉시 적용 가능 (High Priority)

1. **시가총액별 차등 조건 완성** (이미 구현됨)
   - 소형주/중형주/대형주 세부 조건 설정

2. **최적화 범위 확대**
   - 각 변수당 범위 개수 증가 (기존 5~7개 → 7~10개)
   - 넓은 범위 탐색으로 다양한 장세 대응

3. **계층적 최적화 전략 수립**
   - Level 1~5 단계별 최적화 로드맵 작성

#### 10.2 단기 적용 (Medium Priority, 1~2주)

1. **복합 지표 추가**
   - 매수세강도 지수 구현
   - 거래신뢰도 지수 구현
   - 모멘텀지속성 지수 구현

2. **매도 조건 고도화**
   - 시가총액별 손절 차등화
   - 보유시간별 익절 차등화
   - 동적 Trailing Stop

3. **TA-Lib 지표 통합**
   - 볼린저 밴드 조건 추가
   - MACD 골든크로스 추가
   - RSI 필터 추가

#### 10.3 중장기 연구 (Low Priority, 1~2개월)

1. **시간대 세분화 연구**
   - 09:00~09:05를 3구간으로 분할
   - 시간 경과 가중치 시스템 도입

2. **리스크 관리 시스템**
   - 포지션 사이징 구현
   - 동시 보유 종목 수 제한
   - 연속 손실 제한
   - 일일 손실 한도

3. **백테스팅 고도화**
   - 슬리피지 반영
   - 시장 충격 반영
   - 체결 지연 반영

#### 10.4 최적화 실행 계획 (2~3주)

**Week 1**:
- Level 1 최적화 (공통 필터)
- Level 2 최적화 (09:00~09:05 소형주)

**Week 2**:
- Level 2 최적화 (09:00~09:05 중형주/대형주)
- Level 3 최적화 (09:05~09:10 전체)

**Week 3**:
- Level 3 최적화 (09:10~09:15, 09:15~09:20)
- Level 4 최적화 (매도 조건)
- Level 5 통합 최적화 (GA 핵심 변수)

---

## 태그

- #주식트레이딩
- #Tick전략
- #장초전략
- #900_920전략
- #Enhanced버전
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #STOM
- #시가총액차등
- #시간대분할
- #복합지표
- #리스크관리
- #계층적최적화
