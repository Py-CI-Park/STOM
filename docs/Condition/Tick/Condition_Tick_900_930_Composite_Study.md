# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- Back_Testing_Guideline_Tick.md 가이드라인과 기존 902_905/905_915/910_930 문서 형식을 반영

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - Tick 900_930 Composite Study](#condition---tick-900_930-composite-study)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_900_930_CS_B](#매수-조건식---c_t_900_930_cs_b)
    - [매도 조건식 - C_T_900_930_CS_S](#매도-조건식---c_t_900_930_cs_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_900_930_CS_BO](#매수-최적화-조건식---c_t_900_930_cs_bo)
    - [매수 최적화 범위 - C_T_900_930_CS_BOR](#매수-최적화-범위---c_t_900_930_cs_bor)
    - [매도 최적화 조건식 - C_T_900_930_CS_SO](#매도-최적화-조건식---c_t_900_930_cs_so)
    - [매도 최적화 범위 - C_T_900_930_CS_SOR](#매도-최적화-범위---c_t_900_930_cs_sor)
    - [매수 매도 최적화 범위 - C_T_900_930_CS_OR](#매수-매도-최적화-범위---c_t_900_930_cs_or)
    - [예상 시간 계산](#예상-시간-계산)
    - [GA 최적화 범위 - C_T_900_930_CS_GAR](#ga-최적화-범위---c_t_900_930_cs_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 09:00:00 ~ 09:30:00 구간의 종합 전략(Composite)을 연구하기 위한 조건식과 최적화 범위를 제공합니다. 장 시작 30분 동안 나타나는 다양한 패턴(초기 모멘텀, 이어달리기, 긴꼬리 반전, 반등 돌파, 후기 추세지속)을 하나의 문서에서 실험할 수 있도록 구성했습니다.

본 문서는 다음 문서들의 형식을 최대한 준수합니다.
- docs/Condition/Tick/Condition_Tick_902_905_update_2.md
- docs/Condition/Tick/Condition_Tick_905_915_LongTail.md
- docs/Condition/Tick/Condition_Tick_910_930_Rebound.md

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.
- 조건식은 시간대별로 분기하며, 각 분기에서 추가 필터를 적용합니다.
- 최적화 조건식은 `self.vars[i]`로 치환하여 탐색 범위를 별도로 정의합니다.
- 최적화 범위 포맷: `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]` (OR/GAR에서는 리스트형 입력도 허용)
- 변수/함수 표기 및 사용 규칙은 Back_Testing_Guideline_Tick.md를 따릅니다.

### 저장 이름 규칙

조건식 저장 및 관리 편의를 위해 다음 규칙을 사용합니다.

1. 기본 규칙:
   - `C`: Condition
   - `T`: Tick
   - `900_930`: 시간대
   - `CS`: Composite Study (종합 연구)
   - `B`/`S`: 매수/매도 조건식
   - `BO`/`SO`: 매수/매도 최적화 조건식
   - `BOR`/`SOR`: 매수/매도 최적화 범위
   - `OR`: 매수/매도 통합 최적화 범위
   - `GAR`: GA 최적화 범위

2. 예시:
   - `C_T_900_930_CS_B`, `C_T_900_930_CS_S`
   - `C_T_900_930_CS_BO`, `C_T_900_930_CS_SO`
   - `C_T_900_930_CS_BOR`, `C_T_900_930_CS_SOR`, `C_T_900_930_CS_OR`, `C_T_900_930_CS_GAR`

---

# Condition - Tick 900_930 Composite Study

## 전략 개요

시간대별 패턴을 다음과 같이 세분화하여 하나의 전략으로 통합했습니다.

- 09:00:00 ~ 09:02:00: 장 시작 초기 모멘텀(902) 탐지
- 09:02:00 ~ 09:05:00: 이어달리기 모멘텀(905) 탐지
- 09:05:00 ~ 09:10:00: 긴 꼬리 반등(LongTail Early) 탐지
- 09:10:00 ~ 09:20:00: 반등 돌파(Rebound Breakout) 탐지
- 09:20:00 ~ 09:30:00: 후기 추세 지속(Trend Continuation) 확인

각 구간은 공통 필터(관심종목, 가격범위, VI 관련 안전장치 등)를 우선 적용한 뒤, 구간 특화 필터를 추가 적용합니다.

## 조건식

### 매수 조건식 - C_T_900_930_CS_B

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))                                     # 단위: 원
시가등락율            = ((시가 - 전일종가) / 전일종가) * 100                               # 단위: 퍼센트
시가대비등락율        = ((현재가 - 시가) / 시가) * 100                                     # 단위: 퍼센트
초당순매수금액        = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000                  # 단위: 백만원
캔들전체범위          = (고가 - 저가) if (고가 - 저가) != 0 else 1
아래꼬리비율          = max(0, (시가 - 저가) / 캔들전체범위)                               # 0~1
상단위치비율          = max(0, (고가 - 현재가) / 캔들전체범위)                               # 0~1 (상단과의 거리)
고점돌파여부          = (현재가 > 최고현재가(300)) if 데이터길이 > 300 else False            # 5분 고점 돌파
이평60상향돌파여부     = (현재가 > 이동평균(60) and 이동평균(60) > 이동평균(60, 1))
거래대금증가배수      = (초당거래대금 / 초당거래대금평균(120)) if 초당거래대금평균(120) != 0 else 0
체결강도회복률        = (체결강도 - 최저체결강도(120)) / 최저체결강도(120) * 100 if 최저체결강도(120) != 0 else 0
등락율전환여부        = (등락율각도(30) > 0 and 등락율각도(60) < 등락율각도(30))            # 하락→상승 전환

# TA-Lib 지표 (환경에서 지원 시 활용)
RSI_14               = RSI if 'RSI' in globals() or 'RSI' in dir() else 50
MACD_CROSS_UP        = (MACD > MACDS) if ('MACD' in globals() and 'MACDS' in globals()) else False


# ================================
#  매수 조건 (900 ↔ 930 통합)
# ================================
매수 = True

# 공통 필터 – 관심종목, 시간 범위, 가격/VI 안전장치
if not (관심종목 == 1):
    매수 = False
elif not (90000 <= 시분초 < 93000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# ---------- 09:00:00 ~ 09:02:00 (초기 모멘텀: 902) ----------
elif 시분초 < 90200:
    if not (1.0 < 등락율 <= 10.0):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif 시가총액 < 3000:
        if not (1.5 <= 시가등락율 < 4.5):
            매수 = False
        elif not (0.3 <= 시가대비등락율 < 6.0):
            매수 = False
        elif not (1 < 초당순매수금액 < 1000):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
            매수 = False
        elif not (전일비 > 0 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 2.0):
            매수 = False
        elif not (당일거래대금각도(30) > 5 and 당일거래대금각도(30) < 30):
            매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 2.5):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.20):
            매수 = False
        elif not (매도총잔량 > 매수총잔량 * 0.10 and 매도총잔량 < 매수총잔량 * 2.0):
            매수 = False
        elif not (체결강도 >= 50 and 체결강도 <= 300):
            매수 = False
    else:
        매수 = False

# ---------- 09:02:00 ~ 09:05:00 (이어달리기: 905) ----------
elif 90200 <= 시분초 < 90500:
    if not (2.0 < 등락율 <= 18.0):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (초당거래대금 > 초당거래대금N(1) * 1.0):
        매수 = False
    elif 시가총액 < 3000:
        if not (0.0 <= 시가등락율 < 10.0):
            매수 = False
        elif not (2.5 <= 시가대비등락율 < 9.0):
            매수 = False
        elif not (1 < 초당순매수금액 < 1000):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * 0.20)):
            매수 = False
        elif not (전일비 > 3 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > 1.0):
            매수 = False
        elif not (당일거래대금 > 30 * 100):
            매수 = False
        elif not (당일거래대금각도(30) > 3 and 당일거래대금각도(30) < 30):
            매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > 1.5):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * 0.25):
            매수 = False
        elif not (누적초당매수수량(30) * 0.8 < 누적초당매도수량(30) * 1.2):
            매수 = False
        elif not (체결강도 >= 50 and 체결강도 <= 300):
            매수 = False

# ---------- 09:05:00 ~ 09:10:00 (긴 꼬리 반등: LongTail Early) ----------
elif 90500 <= 시분초 < 91000:
    # 긴 아래꼬리 + 상단부 위치 + 거래대금 급증 + 매수 우위
    if not (아래꼬리비율 >= 0.5):                      # 아래꼬리 비율 50% 이상
        매수 = False
    elif not (상단위치비율 <= 0.3):                   # 현재가가 상단부 30% 이내
        매수 = False
    elif not (거래대금증가배수 >= 2.0):
        매수 = False
    elif not (체결강도 >= 70 and 체결강도평균(30) <= 체결강도):
        매수 = False
    elif not (최고초당매수수량(30) > 최고초당매도수량(30) * 1.1):
        매수 = False
    elif not (누적초당매수수량(30) > 누적초당매도수량(30) * 1.0):
        매수 = False
    elif not (현재가 > 이동평균(30)):
        매수 = False

# ---------- 09:10:00 ~ 09:20:00 (반등 돌파: Rebound Breakout) ----------
elif 91000 <= 시분초 < 92000:
    if not (데이터길이 >= 300):                        # 최소 5분 데이터
        매수 = False
    elif not 고점돌파여부:
        매수 = False
    elif not 이평60상향돌파여부:
        매수 = False
    elif not (현재가 > 이동평균(120)):
        매수 = False
    elif not (체결강도 >= 80 and 체결강도회복률 >= 30):
        매수 = False
    elif not (등락율전환여부):
        매수 = False
    elif not (거래대금증가배수 >= 2.0):
        매수 = False

# ---------- 09:20:00 ~ 09:30:00 (후기 추세 지속: Trend Continuation) ----------
elif 92000 <= 시분초 < 93000:
    if not (등락율 > 0.5 and 고저평균대비등락율 > -2.0):
        매수 = False
    elif not (이동평균(60) > 이동평균(120) and 현재가 > 이동평균(60)):
        매수 = False
    elif not (등락율각도(60) > 0 and 당일거래대금각도(60) > 0):
        매수 = False
    elif (RSI_14 is not None) and not (40 <= RSI_14 <= 80):
        매수 = False
    elif MACD_CROSS_UP is False:
        매수 = False


# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식 - C_T_900_930_CS_S

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율        = ((현재가 - 시가) / 시가) * 100                                # 단위: 퍼센트
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
이평역전여부          = (이동평균(30) < 이동평균(60)) or (현재가 < 이동평균(30))
급락신호              = (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.7 and 단기하락률 < -0.7

매도 = False

# 상한가 부근 안전장치 및 기본 청산
if 등락율 > 29.5:
    매도 = True
elif 시가대비등락율 < 0 and 수익률 <= -2.0 and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True
elif 보유시간 > 60 and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True

# 공통 트레일링/목표/손절
elif 수익률 >= 5.0 or 수익률 <= -5.0:
    매도 = True
elif 최고수익률 > 6.0 and 최고수익률 * 0.6 >= 수익률:
    매도 = True

# 위험 신호 기반 조기 청산
elif 급락신호:
    매도 = True
elif 이평역전여부 and 체결강도 < 체결강도평균(30):
    매도 = True
elif 91000 <= 시분초 < 93000 and 등락율각도(30) < 0 and 당일거래대금각도(30) < 0:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_900_930_CS_BO

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))                                    
시가등락율            = ((시가 - 전일종가) / 전일종가) * 100                               
시가대비등락율        = ((현재가 - 시가) / 시가) * 100                                     
초당순매수금액        = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000                  
캔들전체범위          = (고가 - 저가) if (고가 - 저가) != 0 else 1
아래꼬리비율          = max(0, (시가 - 저가) / 캔들전체범위)
상단위치비율          = max(0, (고가 - 현재가) / 캔들전체범위)
고점돌파여부          = (현재가 > 최고현재가(300)) if 데이터길이 > 300 else False
이평60상향돌파여부     = (현재가 > 이동평균(60) and 이동평균(60) > 이동평균(60, 1))
거래대금증가배수      = (초당거래대금 / 초당거래대금평균(120)) if 초당거래대금평균(120) != 0 else 0
체결강도회복률        = (체결강도 - 최저체결강도(120)) / 최저체결강도(120) * 100 if 최저체결강도(120) != 0 else 0
등락율전환여부        = (등락율각도(30) > 0 and 등락율각도(60) < 등락율각도(30))

# TA-Lib (옵션)
RSI_14               = RSI if 'RSI' in globals() or 'RSI' in dir() else 50
MACD_CROSS_UP        = (MACD > MACDS) if ('MACD' in globals() and 'MACDS' in globals()) else True

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (90000 <= 시분초 < 93000):
    매수 = False
elif not (self.vars[1] < 현재가 <= self.vars[2]):                 # 가격 하/상한
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# ---------- 09:00:00 ~ 09:02:00 (902) ----------
elif 시분초 < 90200:
    if not (1.0 < 등락율 <= self.vars[3]):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif 시가총액 < 3000:
        if not (self.vars[4] <= 시가등락율 < self.vars[5]):
            매수 = False
        elif not (self.vars[6] <= 시가대비등락율 < self.vars[7]):
            매수 = False
        elif not (1 < 초당순매수금액 < 1000):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * self.vars[8] / 100)):
            매수 = False
        elif not (전일비 > 0 and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > self.vars[9]):
            매수 = False
        elif not (당일거래대금각도(30) > self.vars[10] and 당일거래대금각도(30) < 30):
            매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > self.vars[11]):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * self.vars[12]):
            매수 = False
        elif not (매도총잔량 > 매수총잔량 * 0.10 and 매도총잔량 < 매수총잔량 * 2.0):
            매수 = False
        elif not (체결강도 >= self.vars[13] and 체결강도 <= 300):
            매수 = False

# ---------- 09:02:00 ~ 09:05:00 (905) ----------
elif 90200 <= 시분초 < 90500:
    if not (2.0 < 등락율 <= self.vars[14]):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (초당거래대금 > 초당거래대금N(1) * 1.0):
        매수 = False
    elif 시가총액 < 3000:
        if not (self.vars[15] <= 시가등락율 < self.vars[16]):
            매수 = False
        elif not (self.vars[17] <= 시가대비등락율 < self.vars[18]):
            매수 = False
        elif not (1 < 초당순매수금액 < 1000):
            매수 = False
        elif not (현재가 > (고가 - (고가 - 저가) * self.vars[19] / 100)):
            매수 = False
        elif not (전일비 > self.vars[20] and 전일동시간비 > 0):
            매수 = False
        elif not (회전율 > self.vars[21]):
            매수 = False
        elif not (당일거래대금 > self.vars[22] * 100):
            매수 = False
        elif not (당일거래대금각도(30) > self.vars[23] and 당일거래대금각도(30) < 30):
            매수 = False
        elif not (초당거래대금 / 초당거래대금평균(30) > self.vars[24]):
            매수 = False
        elif not (초당매수수량 > 매도총잔량 * self.vars[25]):
            매수 = False
        elif not (누적초당매수수량(30) * self.vars[26] < 누적초당매도수량(30) * self.vars[27]):
            매수 = False
        elif not (체결강도 >= self.vars[28] and 체결강도 <= 300):
            매수 = False

# ---------- 09:05:00 ~ 09:10:00 (LongTail Early) ----------
elif 90500 <= 시분초 < 91000:
    if not (아래꼬리비율 >= self.vars[29]):
        매수 = False
    elif not (상단위치비율 <= self.vars[30]):
        매수 = False
    elif not (거래대금증가배수 >= self.vars[31]):
        매수 = False
    elif not (체결강도 >= self.vars[32] and 체결강도평균(30) <= 체결강도):
        매수 = False
    elif not (최고초당매수수량(30) > 최고초당매도수량(30) * self.vars[33]):
        매수 = False
    elif not (누적초당매수수량(30) > 누적초당매도수량(30) * self.vars[34]):
        매수 = False
    elif not (현재가 > 이동평균(30)):
        매수 = False

# ---------- 09:10:00 ~ 09:20:00 (Rebound Breakout) ----------
elif 91000 <= 시분초 < 92000:
    if not (데이터길이 >= 300):
        매수 = False
    elif not 고점돌파여부:
        매수 = False
    elif not 이평60상향돌파여부:
        매수 = False
    elif not (현재가 > 이동평균(120)):
        매수 = False
    elif not (체결강도 >= self.vars[35] and 체결강도회복률 >= self.vars[36]):
        매수 = False
    elif not (등락율전환여부):
        매수 = False
    elif not (거래대금증가배수 >= self.vars[37]):
        매수 = False

# ---------- 09:20:00 ~ 09:30:00 (Trend Continuation) ----------
elif 92000 <= 시분초 < 93000:
    if not (등락율 > self.vars[38] and 고저평균대비등락율 > self.vars[39]):
        매수 = False
    elif not (이동평균(60) > 이동평균(120) and 현재가 > 이동평균(60)):
        매수 = False
    elif not (등락율각도(60) > self.vars[40] and 당일거래대금각도(60) > self.vars[41]):
        매수 = False
    elif (RSI_14 is not None) and not (self.vars[42] <= RSI_14 <= self.vars[43]):
        매수 = False
    elif MACD_CROSS_UP is False:
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_900_930_CS_BOR

```python
# 평균 틱수 고정값 / 가격 범위
self.vars[0]  = [[30, 30, 0], 30]                 # 평균 틱수 고정
self.vars[1]  = [[1000, 3000, 1000], 1000]        # 현재가 하한
self.vars[2]  = [[30000, 60000, 10000], 50000]    # 현재가 상한

# 902
self.vars[3]  = [[6.0, 10.0, 1.0], 8.0]           # 등락율 상한
self.vars[4]  = [[1.5, 3.0, 0.5], 2.0]            # 시가등락율 하한
self.vars[5]  = [[3.5, 5.0, 0.5], 4.0]            # 시가등락율 상한
self.vars[6]  = [[0.3, 1.0, 0.2], 0.5]            # 시가대비등락율 하한
self.vars[7]  = [[5.0, 8.0, 1.0], 6.0]            # 시가대비등락율 상한
self.vars[8]  = [[10, 30, 10], 20]                # 고가 대비 현재가 임계(%)
self.vars[9]  = [[1.5, 3.0, 0.5], 2.0]            # 회전율 하한
self.vars[10] = [[3, 7, 2], 5]                    # 당일거래대금각도(30) 하한
self.vars[11] = [[2.5, 4.0, 0.5], 3.0]            # 초당거래대금/평균(30)
self.vars[12] = [[0.15, 0.25, 0.05], 0.20]        # 초당매수수량/(매도총잔량) 비율
self.vars[13] = [[40, 60, 10], 50]                # 체결강도 하한

# 905
self.vars[14] = [[12.0, 18.0, 2.0], 15.0]         # 등락율 상한
self.vars[15] = [[-0.5, 1.0, 0.5], 0.0]           # 시가등락율 하한
self.vars[16] = [[7.0, 10.0, 1.0], 8.0]           # 시가등락율 상한
self.vars[17] = [[2.5, 4.0, 0.5], 3.0]            # 시가대비등락율 하한
self.vars[18] = [[7.0, 9.0, 1.0], 8.0]            # 시가대비등락율 상한
self.vars[19] = [[10, 30, 10], 20]                # 고가 대비 현재가 임계(%)
self.vars[20] = [[3, 7, 2], 5]                    # 전일비 하한
self.vars[21] = [[1.0, 2.0, 0.5], 1.5]            # 회전율 하한
self.vars[22] = [[30, 70, 20], 50]                # 당일거래대금(백만)
self.vars[23] = [[3, 7, 2], 5]                    # 당일거래대금각도(30) 하한
self.vars[24] = [[1.5, 2.5, 0.5], 2.0]            # 초당거래대금/평균(30)
self.vars[25] = [[0.25, 0.35, 0.05], 0.30]        # 초당매수수량/(매도총잔량)
self.vars[26] = [[0.4, 0.7, 0.1], 0.5]            # 누적매수 하한 배수
self.vars[27] = [[0.9, 1.3, 0.1], 1.2]            # 누적매도 상한 배수
self.vars[28] = [[40, 60, 10], 50]                # 체결강도 하한

# LongTail Early (905~910)
self.vars[29] = [[0.4, 0.7, 0.1], 0.5]            # 아래꼬리비율 하한
self.vars[30] = [[0.2, 0.4, 0.05], 0.3]           # 상단위치비율 상한
self.vars[31] = [[1.5, 3.0, 0.5], 2.0]            # 거래대금증가배수 하한
self.vars[32] = [[60, 90, 10], 70]                # 체결강도 하한
self.vars[33] = [[1.05, 1.30, 0.05], 1.10]        # 최고매수/최고매도 비율
self.vars[34] = [[0.9, 1.3, 0.1], 1.0]            # 누적매수/누적매도 비율

# Rebound Breakout (910~920)
self.vars[35] = [[70, 110, 10], 80]               # 체결강도 하한
self.vars[36] = [[20, 40, 5], 30]                 # 체결강도 회복률(%)
self.vars[37] = [[1.5, 3.0, 0.5], 2.0]            # 거래대금증가배수 하한

# Trend Continuation (920~930)
self.vars[38] = [[0.3, 1.0, 0.2], 0.5]            # 등락율 하한
self.vars[39] = [[-3.0, -1.0, 0.5], -2.0]         # 고저평균대비등락율 하한
self.vars[40] = [[0.0, 3.0, 1.0], 0.0]            # 등락율각도(60) 하한
self.vars[41] = [[0.0, 3.0, 1.0], 0.0]            # 당일거래대금각도(60) 하한
self.vars[42] = [[35, 45, 5], 40]                 # RSI 하한
self.vars[43] = [[70, 85, 5], 80]                 # RSI 상한

# 경우의 수 예시(대략):
# 902(11변수) × 905(15변수) × LT(6변수) × RB(3변수) × TC(6변수)
# = 11×15×6×3×6 = 17,820 (각 변수가 3~5개 구간을 갖는다고 가정 시 수백만 케이스)
```

### 매도 최적화 조건식 - C_T_900_930_CS_SO

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율        = ((현재가 - 시가) / 시가) * 100
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
이평역전여부          = (이동평균(30) < 이동평균(60)) or (현재가 < 이동평균(30))

매도 = False

if 등락율 > self.vars[44]:                                # 등락율 과열 구간 방지
    매도 = True
elif 시가대비등락율 < 0 and 수익률 <= self.vars[45] and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True
elif 보유시간 > 60 and 현재가 < 최저현재가(int(60), int(보유시간)):
    매도 = True
elif 90000 <= 시분초 < 93000:
    if 수익률 >= self.vars[46] or 수익률 <= self.vars[47]:
        매도 = True
    elif 최고수익률 > self.vars[48] and 최고수익률 * self.vars[49] >= 수익률:
        매도 = True
    elif (초당매도수량 - 초당매수수량) >= 매수총잔량 * self.vars[50] and 단기하락률 < -self.vars[51]:
        매도 = True
    elif 이평역전여부 and 체결강도 < 체결강도평균(30):
        매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_900_930_CS_SOR

```python
self.vars[44] = [[28.0, 30.0, 0.5], 29.5]        # 등락율 상한가 근접치
self.vars[45] = [[-3.0, -1.0, 0.5], -2.0]        # 초기 손실 컷
self.vars[46] = [[4.0, 6.0, 0.5], 5.0]           # 목표 수익 실현
self.vars[47] = [[-6.0, -4.0, 0.5], -5.0]        # 최대 손실 컷
self.vars[48] = [[5.0, 7.0, 0.5], 6.0]           # 최고수익률 기준값
self.vars[49] = [[0.5, 0.7, 0.05], 0.6]          # 트레일링 보정 비율
self.vars[50] = [[0.5, 0.8, 0.1], 0.7]           # 매도 잔량 우위 임계
self.vars[51] = [[0.5, 1.0, 0.1], 0.7]           # 단기 하락률 임계

# 매도 변수 경우의 수(예): 5 × 5 × 5 × 5 × 5 × 5 × 4 × 6 = 375,000
```

### 매수 매도 최적화 범위 - C_T_900_930_CS_OR

```python
# OR 모드는 BOR + SOR를 하나로 합친 형태입니다.
# 실험 시 단계별(넓게→좁게) 탐색을 권장합니다.
# 아래는 BOR/SOR의 동일 값을 그대로 사용합니다.

# 평균 틱수 고정값 / 가격 범위
self.vars[0]  = [[30, 30, 0], 30]
self.vars[1]  = [[1000, 3000, 1000], 1000]
self.vars[2]  = [[30000, 60000, 10000], 50000]

# 902 ~ Trend Continuation: 3 ~ 43번까지 BOR 동일
# (생략) — 실사용 시 BOR 블록을 그대로 복사해 붙여넣기

# 매도 44 ~ 51: SOR 동일
self.vars[44] = [[28.0, 30.0, 0.5], 29.5]
self.vars[45] = [[-3.0, -1.0, 0.5], -2.0]
self.vars[46] = [[4.0, 6.0, 0.5], 5.0]
self.vars[47] = [[-6.0, -4.0, 0.5], -5.0]
self.vars[48] = [[5.0, 7.0, 0.5], 6.0]
self.vars[49] = [[0.5, 0.7, 0.05], 0.6]
self.vars[50] = [[0.5, 0.8, 0.1], 0.7]
self.vars[51] = [[0.5, 1.0, 0.1], 0.7]

# 전체 경우의 수는 매우 커질 수 있으므로, 단계적 탐색(1단계 넓게 → 2단계 좁게)을 권장합니다.
```

### 예상 시간 계산

- 변수 갯수와 각 변수의 후보 수가 곱셈으로 누적되며, 09:00~09:30 통합 전략은 개별 전략 합보다 경우의 수가 기하급수적으로 증가합니다.
- 1단계: 각 변수 후보 수를 3~5개로 제한하여 대략 최적 영역 탐색
- 2단계: 1단계 결과 중심으로 2~3개 후보로 촘촘히 재탐색
- 교차검증/기간분할 옵션 사용 시 탐색 시간이 선형적으로 증가하므로, 우선 TRIAL 수를 축소한 후 점진 확대를 권장합니다.

### GA 최적화 범위 - C_T_900_930_CS_GAR

- 일반 최적화에서 확보한 최적값들을 중심으로, GA에서는 리스트 기반 후보 집합으로 전환합니다.
- 예시(일부 변수):

```python
# 902
self.vars[3]  = [[6.0, 7.0, 8.0, 9.0, 10.0], 8.0]
self.vars[4]  = [[1.5, 2.0, 2.5, 3.0], 2.0]
self.vars[11] = [[2.5, 3.0, 3.5, 4.0], 3.0]

# LongTail Early
self.vars[29] = [[0.4, 0.5, 0.6, 0.7], 0.5]
self.vars[31] = [[1.5, 2.0, 2.5, 3.0], 2.0]

# Rebound Breakout
self.vars[35] = [[70, 80, 90, 100, 110], 80]
self.vars[36] = [[20, 25, 30, 35, 40], 30]

# Trend Continuation
self.vars[42] = [[35, 40, 45], 40]
self.vars[43] = [[70, 75, 80, 85], 80]

# 매도
self.vars[46] = [[4.0, 4.5, 5.0, 5.5, 6.0], 5.0]
self.vars[49] = [[0.5, 0.55, 0.6, 0.65, 0.7], 0.6]
```

---

## 조건식 개선 방향 연구

1) 초기 902/905 구간의 RSI/볼린저밴드 도입 실험
- RSI 하한/상한과 등락율각도의 동시 조건으로 과매수/과매도 탈출 지점 필터링
- BBU/BBL 이탈 후 복귀를 추가 필터로 사용 (가짜 돌파 제거)

2) LongTail 조건 정교화
- 아래꼬리비율 + 초당거래대금 가속도(초당거래대금증가율, 체결강도가속도) 결합
- 최고초당매수수량(30)과 누적초당매수수량(30)의 동시 확인으로 일회성 스파이크 제거

3) Rebound 구간 추세 확인 강화
- 고점돌파여부 + 이평(60/120) 기울기 확인, 체결강도회복률 상향 조정 실험
- 전일비/전일동시간비 임계 상향 또는 하향 테스트

4) Trend Continuation 구간 안전장치 추가
- 라운드피겨 근접, VI아래5호가 여유, 거래신뢰도 지수(전일비/회전율/각도) 임계 테스트

5) 리스크 관리
- 동시 보유 종목 수 제한, 연속 손실 횟수 제한, 최대 포지션 크기 상한 실험

6) 최적화 절차
- 1단계(넓게) → 2단계(좁게) → GA(리스트) → 재탐색 루프 고정화

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #파이썬
- #트레이딩로직
- #900_930전략
- #Composite
- #조건식개선
- #TA-Lib
- #리스크관리

