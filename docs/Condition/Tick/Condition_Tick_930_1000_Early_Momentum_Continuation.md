# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- Back_Testing_Guideline_Tick.md 가이드라인 준수

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - Tick 930_1000 Early Momentum Continuation](#condition---tick-930_1000-early-momentum-continuation)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_930_1000_EMC_B](#매수-조건식---c_t_930_1000_emc_b)
    - [매도 조건식 - C_T_930_1000_EMC_S](#매도-조건식---c_t_930_1000_emc_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_930_1000_EMC_BO](#매수-최적화-조건식---c_t_930_1000_emc_bo)
    - [매수 최적화 범위 - C_T_930_1000_EMC_BOR](#매수-최적화-범위---c_t_930_1000_emc_bor)
    - [매도 최적화 조건식 - C_T_930_1000_EMC_SO](#매도-최적화-조건식---c_t_930_1000_emc_so)
    - [매도 최적화 범위 - C_T_930_1000_EMC_SOR](#매도-최적화-범위---c_t_930_1000_emc_sor)
    - [매수 매도 최적화 범위 - C_T_930_1000_EMC_OR](#매수-매도-최적화-범위---c_t_930_1000_emc_or)
    - [예상 시간 계산](#예상-시간-계산)
    - [GA 최적화 범위 - C_T_930_1000_EMC_GAR](#ga-최적화-범위---c_t_930_1000_emc_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 09:30:00 ~ 10:00:00 구간의 Early Momentum Continuation(초기 모멘텀 지속) 전략을 실험하기 위한 조건식과 최적화 범위를 제공합니다.

장 시작 후 30분이 지나 안정화 단계에 접어든 시점에서, 초기 모멘텀을 유지하면서 지속적인 상승세를 보이는 종목을 선별하여 진입하는 전략입니다. 급격한 초기 변동성이 줄어들고 안정적인 추세가 형성되는 구간에서 높은 확률로 수익을 실현할 수 있습니다.

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.
- 조건식은 시간대별로 분기하며, 각 분기에서 추가 필터를 적용합니다.
- 최적화 조건식은 `self.vars[i]`로 치환하여 탐색 범위를 별도로 정의합니다.
- 최적화 범위 포맷: `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]`
- 변수/함수 표기 및 사용 규칙은 Back_Testing_Guideline_Tick.md를 따릅니다.

### 저장 이름 규칙

조건식 저장 및 관리 편의를 위해 다음 규칙을 사용합니다.

1. 기본 규칙:
   - `C`: Condition
   - `T`: Tick
   - `930_1000`: 시간대
   - `EMC`: Early Momentum Continuation (초기 모멘텀 지속)
   - `B`/`S`: 매수/매도 조건식
   - `BO`/`SO`: 매수/매도 최적화 조건식
   - `BOR`/`SOR`: 매수/매도 최적화 범위
   - `OR`: 매수/매도 통합 최적화 범위
   - `GAR`: GA 최적화 범위

2. 예시:
   - `C_T_930_1000_EMC_B`, `C_T_930_1000_EMC_S`
   - `C_T_930_1000_EMC_BO`, `C_T_930_1000_EMC_SO`
   - `C_T_930_1000_EMC_BOR`, `C_T_930_1000_EMC_SOR`, `C_T_930_1000_EMC_OR`, `C_T_930_1000_EMC_GAR`

---

# Condition - Tick 930_1000 Early Momentum Continuation

## 전략 개요

09:30 ~ 10:00 시간대는 장 시작 후 초기 급격한 변동성이 진정되고 안정적인 추세가 형성되는 구간입니다. 이 전략은 다음 특징을 가집니다:

- **안정화 구간 진입**: 초기 30분간의 급격한 변동이 줄어들고 방향성이 명확해지는 시점
- **모멘텀 지속 확인**: 초기 상승 모멘텀이 지속되는 종목 선별
- **거래량 확인**: 꾸준한 거래량 유지로 신뢰성 검증
- **기술적 지표 활용**: 이동평균선, 체결강도, 각도 지표로 추세 확인
- **리스크 관리**: VI 근접, 라운드피겨, 과도한 등락율 종목 회피

핵심 전략:
1. 09:30 이전 초기 상승 모멘텀 형성 확인
2. 안정적인 거래대금 유지 확인
3. 이동평균선 위에서 지지 확인
4. 체결강도 및 각도 지표로 추세 방향 검증
5. 시가총액별 차별화된 필터 적용

## 조건식

### 매수 조건식 - C_T_930_1000_EMC_B

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
시가등락율            = ((시가 - 전일종가) / 전일종가) * 100
시가대비등락율        = ((현재가 - 시가) / 시가) * 100
초당순매수금액        = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000
고가대비하락율        = ((고가 - 현재가) / 고가) * 100
저가대비상승율        = ((현재가 - 저가) / 저가) * 100 if 저가 > 0 else 0

# 추세 관련 지표
이평단기상승여부      = (이동평균(30) > 이동평균(30, 1))
이평중기상승여부      = (이동평균(60) > 이동평균(60, 1))
이평장기상승여부      = (이동평균(120) > 이동평균(120, 1)) if 데이터길이 > 120 else True
가격이평위치          = (현재가 > 이동평균(30) and 현재가 > 이동평균(60))

# 거래량 관련 지표
거래대금안정성        = (초당거래대금평균(60) > 0 and abs(초당거래대금 - 초당거래대금평균(60)) / 초당거래대금평균(60) < 3.0)
매수세우위            = (최고초당매수수량(60) > 최고초당매도수량(60) * 1.3)

# TA-Lib 지표 (사용 가능 시)
RSI_VAL              = RSI if 'RSI' in globals() or 'RSI' in dir() else 50
MACD_UP              = (MACD > MACDS and MACD > 0) if ('MACD' in globals() and 'MACDS' in globals()) else False


# ================================
#  매수 조건
# ================================
매수 = True

# 공통 필터 – 기본 안전장치
if not (관심종목 == 1):
    매수 = False
elif not (93000 <= 시분초 < 100000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not (0.5 < 등락율 <= 20.0):
    매수 = False

# 공통 필터 – 모멘텀 지속 확인
elif not (시가등락율 > 0.5):                    # 시가부터 상승 시작
    매수 = False
elif not (시가대비등락율 > 0.3):                 # 시가 대비 현재가 상승 유지
    매수 = False
elif not (고가대비하락율 < 5.0):                 # 고가에서 5% 이내 유지
    매수 = False
elif not (저가대비상승율 > 1.0):                 # 저가 대비 1% 이상 상승
    매수 = False

# 공통 필터 – 이동평균선 및 추세 확인
elif not 가격이평위치:                           # 단기/중기 이평선 상단 유지
    매수 = False
elif not (이평단기상승여부 and 이평중기상승여부):
    매수 = False
elif not (등락율각도(60) > 0):                   # 등락율 상승 추세
    매수 = False

# 공통 필터 – 거래대금 및 체결강도
elif not (초당거래대금 > 초당거래대금N(1)):
    매수 = False
elif not 거래대금안정성:                         # 거래대금 안정성 확인
    매수 = False
elif not (체결강도 >= 60 and 체결강도 <= 350):
    매수 = False

# 시가총액별 세부 조건
elif 시가총액 < 2500:
    # 중소형 종목 (2500억 미만)
    if not (10 < 초당순매수금액 < 800):
        매수 = False
    elif not (전일비 > 20 and 전일동시간비 > 50):
        매수 = False
    elif not (회전율 > 2.0):
        매수 = False
    elif not (당일거래대금 > 50 * 100):
        매수 = False
    elif not (당일거래대금각도(60) > 3 and 당일거래대금각도(60) < 50):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < 60):
        매수 = False
    elif not 매수세우위:
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > 0.8 and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < 5.0):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.30):
        매수 = False
    elif not (매도총잔량 > 0 and 매수총잔량 > 매도총잔량 * 0.5):
        매수 = False
    elif not (체결강도평균(60) > 80):
        매수 = False

elif 시가총액 < 5000:
    # 중형 종목 (2500억 ~ 5000억)
    if not (20 < 초당순매수금액 < 1500):
        매수 = False
    elif not (전일비 > 10 and 전일동시간비 > 30):
        매수 = False
    elif not (회전율 > 1.0):
        매수 = False
    elif not (당일거래대금 > 100 * 100):
        매수 = False
    elif not (당일거래대금각도(60) > 2 and 당일거래대금각도(60) < 45):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < 55):
        매수 = False
    elif not (최고초당매수수량(60) > 최고초당매도수량(60) * 1.2):
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > 0.7 and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < 4.0):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.40):
        매수 = False
    elif not (매수총잔량 > 매도총잔량 * 0.6):
        매수 = False
    elif not (체결강도평균(60) > 85):
        매수 = False

else:
    # 대형 종목 (5000억 이상)
    if not (50 < 초당순매수금액 < 3000):
        매수 = False
    elif not (전일비 > 5 and 전일동시간비 > 20):
        매수 = False
    elif not (회전율 > 0.5):
        매수 = False
    elif not (당일거래대금 > 200 * 100):
        매수 = False
    elif not (당일거래대금각도(60) > 1 and 당일거래대금각도(60) < 40):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < 50):
        매수 = False
    elif not (최고초당매수수량(60) > 최고초당매도수량(60) * 1.1):
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > 0.6 and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < 3.5):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 0.50):
        매수 = False
    elif not (매수총잔량 > 매도총잔량 * 0.7):
        매수 = False
    elif not (체결강도평균(60) > 90):
        매수 = False


# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식 - C_T_930_1000_EMC_S

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율        = ((현재가 - 시가) / 시가) * 100
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
이평이탈여부          = (현재가 < 이동평균(30) or 현재가 < 이동평균(60))
급락신호              = ((초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.6 and 단기하락률 < -0.5)
추세약화              = (등락율각도(30) < 0 or 당일거래대금각도(30) < 0)

매도 = False

# 상한가 부근 및 기본 청산
if 등락율 > 29.5:
    매도 = True
elif 시가대비등락율 < -1.0 and 수익률 <= -1.5:
    매도 = True

# 목표 수익 및 손절
elif 수익률 >= 4.0:
    매도 = True
elif 수익률 <= -4.0:
    매도 = True
elif 최고수익률 > 5.0 and 최고수익률 - 수익률 >= 2.5:
    매도 = True
elif 최고수익률 > 3.0 and 최고수익률 * 0.7 >= 수익률:
    매도 = True

# 보유 시간 기반 청산
elif 보유시간 > 120 and 수익률 < 1.0:
    매도 = True

# 추세 이탈 및 위험 신호
elif 급락신호:
    매도 = True
elif 이평이탈여부 and 체결강도 < 체결강도평균(30):
    매도 = True
elif 추세약화 and 수익률 < 2.0:
    매도 = True
elif 현재가 < 최저현재가(int(60), int(보유시간)) and 보유시간 > 60:
    매도 = True

# 시가총액별 추가 조건
elif 시가총액 < 2500:
    if 0 < 수익률 <= 8 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.8:
        매도 = True
    elif 수익률 < -1.5 and 체결강도N(1) > 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:
        매도 = True
    elif 2.5 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
        매도 = True

else:
    if 0 < 수익률 <= 8 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * 0.65:
        매도 = True
    elif 수익률 < -1.5 and 체결강도N(1) > 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:
        매도 = True
    elif 2.5 < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
        매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_930_1000_EMC_BO

```python
# ================================
#  공통 계산 지표 (매수 최적화)
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
시가등락율            = ((시가 - 전일종가) / 전일종가) * 100
시가대비등락율        = ((현재가 - 시가) / 시가) * 100
초당순매수금액        = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000
고가대비하락율        = ((고가 - 현재가) / 고가) * 100
저가대비상승율        = ((현재가 - 저가) / 저가) * 100 if 저가 > 0 else 0

이평단기상승여부      = (이동평균(30) > 이동평균(30, 1))
이평중기상승여부      = (이동평균(60) > 이동평균(60, 1))
가격이평위치          = (현재가 > 이동평균(30) and 현재가 > 이동평균(60))

거래대금안정성        = (초당거래대금평균(60) > 0 and abs(초당거래대금 - 초당거래대금평균(60)) / 초당거래대금평균(60) < self.vars[11])
매수세우위            = (최고초당매수수량(60) > 최고초당매도수량(60) * self.vars[12])

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (93000 <= 시분초 < 100000):
    매수 = False
elif not (self.vars[1] < 현재가 <= self.vars[2]):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not (self.vars[3] < 등락율 <= self.vars[4]):
    매수 = False
elif not (시가등락율 > self.vars[5]):
    매수 = False
elif not (시가대비등락율 > self.vars[6]):
    매수 = False
elif not (고가대비하락율 < self.vars[7]):
    매수 = False
elif not (저가대비상승율 > self.vars[8]):
    매수 = False
elif not 가격이평위치:
    매수 = False
elif not (이평단기상승여부 and 이평중기상승여부):
    매수 = False
elif not (등락율각도(60) > self.vars[9]):
    매수 = False
elif not (초당거래대금 > 초당거래대금N(1)):
    매수 = False
elif not 거래대금안정성:
    매수 = False
elif not (체결강도 >= self.vars[10] and 체결강도 <= 350):
    매수 = False

elif 시가총액 < self.vars[13]:
    # 중소형 종목
    if not (self.vars[14] < 초당순매수금액 < self.vars[15]):
        매수 = False
    elif not (전일비 > self.vars[16] and 전일동시간비 > self.vars[17]):
        매수 = False
    elif not (회전율 > self.vars[18]):
        매수 = False
    elif not (당일거래대금 > self.vars[19] * 100):
        매수 = False
    elif not (당일거래대금각도(60) > self.vars[20] and 당일거래대금각도(60) < self.vars[21]):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < self.vars[22]):
        매수 = False
    elif not 매수세우위:
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > self.vars[23] and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < self.vars[24]):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[25]):
        매수 = False
    elif not (매수총잔량 > 매도총잔량 * self.vars[26]):
        매수 = False
    elif not (체결강도평균(60) > self.vars[27]):
        매수 = False

elif 시가총액 < self.vars[28]:
    # 중형 종목
    if not (self.vars[29] < 초당순매수금액 < self.vars[30]):
        매수 = False
    elif not (전일비 > self.vars[31] and 전일동시간비 > self.vars[32]):
        매수 = False
    elif not (회전율 > self.vars[33]):
        매수 = False
    elif not (당일거래대금 > self.vars[34] * 100):
        매수 = False
    elif not (당일거래대금각도(60) > self.vars[35] and 당일거래대금각도(60) < self.vars[36]):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < self.vars[37]):
        매수 = False
    elif not (최고초당매수수량(60) > 최고초당매도수량(60) * self.vars[38]):
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > self.vars[39] and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < self.vars[40]):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[41]):
        매수 = False
    elif not (매수총잔량 > 매도총잔량 * self.vars[42]):
        매수 = False
    elif not (체결강도평균(60) > self.vars[43]):
        매수 = False

else:
    # 대형 종목
    if not (self.vars[44] < 초당순매수금액 < self.vars[45]):
        매수 = False
    elif not (전일비 > self.vars[46] and 전일동시간비 > self.vars[47]):
        매수 = False
    elif not (회전율 > self.vars[48]):
        매수 = False
    elif not (당일거래대금 > self.vars[49] * 100):
        매수 = False
    elif not (당일거래대금각도(60) > self.vars[50] and 당일거래대금각도(60) < self.vars[51]):
        매수 = False
    elif not (전일비각도(60) > 0 and 전일비각도(60) < self.vars[52]):
        매수 = False
    elif not (최고초당매수수량(60) > 최고초당매도수량(60) * self.vars[53]):
        매수 = False
    elif not (초당거래대금 / (초당거래대금평균(60) + 0.0001) > self.vars[54] and 초당거래대금 / (초당거래대금평균(60) + 0.0001) < self.vars[55]):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * self.vars[56]):
        매수 = False
    elif not (매수총잔량 > 매도총잔량 * self.vars[57]):
        매수 = False
    elif not (체결강도평균(60) > self.vars[58]):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_930_1000_EMC_BOR

```python
# 공통 필터 변수
self.vars[1]  = [[1000, 3000, 1000], 1000]                 # 현재가 하한
self.vars[2]  = [[40000, 60000, 10000], 50000]             # 현재가 상한
self.vars[3]  = [[0.3, 0.7, 0.2], 0.5]                     # 등락율 하한
self.vars[4]  = [[15.0, 25.0, 5.0], 20.0]                  # 등락율 상한
self.vars[5]  = [[0.3, 0.7, 0.2], 0.5]                     # 시가등락율 하한
self.vars[6]  = [[0.2, 0.5, 0.1], 0.3]                     # 시가대비등락율 하한
self.vars[7]  = [[3.0, 7.0, 2.0], 5.0]                     # 고가대비하락율 상한
self.vars[8]  = [[0.5, 1.5, 0.5], 1.0]                     # 저가대비상승율 하한
self.vars[9]  = [[-1.0, 1.0, 0.5], 0.0]                    # 등락율각도(60) 하한
self.vars[10] = [[50, 70, 10], 60]                         # 체결강도 하한
self.vars[11] = [[2.5, 3.5, 0.5], 3.0]                     # 거래대금안정성 배수
self.vars[12] = [[1.2, 1.5, 0.1], 1.3]                     # 매수세우위 비율

# 중소형 종목 (시가총액 < vars[13])
self.vars[13] = [[2000, 3000, 500], 2500]                  # 시가총액 기준 (중소형)
self.vars[14] = [[5, 15, 5], 10]                           # 초당순매수금액 하한
self.vars[15] = [[700, 900, 100], 800]                     # 초당순매수금액 상한
self.vars[16] = [[15, 25, 5], 20]                          # 전일비 하한
self.vars[17] = [[40, 60, 10], 50]                         # 전일동시간비 하한
self.vars[18] = [[1.5, 2.5, 0.5], 2.0]                     # 회전율 하한
self.vars[19] = [[40, 60, 10], 50]                         # 당일거래대금 하한 (백만원)
self.vars[20] = [[2, 4, 1], 3]                             # 당일거래대금각도(60) 하한
self.vars[21] = [[45, 55, 5], 50]                          # 당일거래대금각도(60) 상한
self.vars[22] = [[55, 65, 5], 60]                          # 전일비각도(60) 상한
self.vars[23] = [[0.7, 0.9, 0.1], 0.8]                     # 초당거래대금/평균 하한
self.vars[24] = [[4.5, 5.5, 0.5], 5.0]                     # 초당거래대금/평균 상한
self.vars[25] = [[0.25, 0.35, 0.05], 0.30]                 # 초당매수수량/매도총잔량 비율
self.vars[26] = [[0.4, 0.6, 0.1], 0.5]                     # 매수총잔량/매도총잔량 비율
self.vars[27] = [[75, 85, 5], 80]                          # 체결강도평균(60) 하한

# 중형 종목 (vars[13] <= 시가총액 < vars[28])
self.vars[28] = [[4500, 5500, 500], 5000]                  # 시가총액 기준 (중형)
self.vars[29] = [[15, 25, 5], 20]                          # 초당순매수금액 하한
self.vars[30] = [[1400, 1600, 100], 1500]                  # 초당순매수금액 상한
self.vars[31] = [[8, 12, 2], 10]                           # 전일비 하한
self.vars[32] = [[25, 35, 5], 30]                          # 전일동시간비 하한
self.vars[33] = [[0.8, 1.2, 0.2], 1.0]                     # 회전율 하한
self.vars[34] = [[90, 110, 10], 100]                       # 당일거래대금 하한 (백만원)
self.vars[35] = [[1, 3, 1], 2]                             # 당일거래대금각도(60) 하한
self.vars[36] = [[40, 50, 5], 45]                          # 당일거래대금각도(60) 상한
self.vars[37] = [[50, 60, 5], 55]                          # 전일비각도(60) 상한
self.vars[38] = [[1.1, 1.3, 0.1], 1.2]                     # 최고매수/최고매도 비율
self.vars[39] = [[0.6, 0.8, 0.1], 0.7]                     # 초당거래대금/평균 하한
self.vars[40] = [[3.5, 4.5, 0.5], 4.0]                     # 초당거래대금/평균 상한
self.vars[41] = [[0.35, 0.45, 0.05], 0.40]                 # 초당매수수량/매도총잔량 비율
self.vars[42] = [[0.5, 0.7, 0.1], 0.6]                     # 매수총잔량/매도총잔량 비율
self.vars[43] = [[80, 90, 5], 85]                          # 체결강도평균(60) 하한

# 대형 종목 (시가총액 >= vars[28])
self.vars[44] = [[40, 60, 10], 50]                         # 초당순매수금액 하한
self.vars[45] = [[2800, 3200, 200], 3000]                  # 초당순매수금액 상한
self.vars[46] = [[3, 7, 2], 5]                             # 전일비 하한
self.vars[47] = [[15, 25, 5], 20]                          # 전일동시간비 하한
self.vars[48] = [[0.3, 0.7, 0.2], 0.5]                     # 회전율 하한
self.vars[49] = [[180, 220, 20], 200]                      # 당일거래대금 하한 (백만원)
self.vars[50] = [[0, 2, 1], 1]                             # 당일거래대금각도(60) 하한
self.vars[51] = [[35, 45, 5], 40]                          # 당일거래대금각도(60) 상한
self.vars[52] = [[45, 55, 5], 50]                          # 전일비각도(60) 상한
self.vars[53] = [[1.0, 1.2, 0.1], 1.1]                     # 최고매수/최고매도 비율
self.vars[54] = [[0.5, 0.7, 0.1], 0.6]                     # 초당거래대금/평균 하한
self.vars[55] = [[3.0, 4.0, 0.5], 3.5]                     # 초당거래대금/평균 상한
self.vars[56] = [[0.45, 0.55, 0.05], 0.50]                 # 초당매수수량/매도총잔량 비율
self.vars[57] = [[0.6, 0.8, 0.1], 0.7]                     # 매수총잔량/매도총잔량 비율
self.vars[58] = [[85, 95, 5], 90]                          # 체결강도평균(60) 하한

# 총 변수 수: 58개
# 대략 경우의 수: 각 변수당 평균 3~5개 후보 → 수백만 케이스 (단계적 탐색 필수)
```

### 매도 최적화 조건식 - C_T_930_1000_EMC_SO

```python
# ================================
#  공통 계산 지표
# ================================
시가대비등락율        = ((현재가 - 시가) / 시가) * 100
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
이평이탈여부          = (현재가 < 이동평균(30) or 현재가 < 이동평균(60))
급락신호              = ((초당매도수량 - 초당매수수량) >= 매수총잔량 * self.vars[66] and 단기하락률 < -self.vars[67])
추세약화              = (등락율각도(30) < 0 or 당일거래대금각도(30) < 0)

매도 = False

if 등락율 > self.vars[59]:
    매도 = True
elif 시가대비등락율 < -self.vars[60] and 수익률 <= -self.vars[61]:
    매도 = True
elif 수익률 >= self.vars[62]:
    매도 = True
elif 수익률 <= -self.vars[63]:
    매도 = True
elif 최고수익률 > self.vars[64] and 최고수익률 - 수익률 >= self.vars[65]:
    매도 = True
elif 최고수익률 > 3.0 and 최고수익률 * self.vars[68] >= 수익률:
    매도 = True
elif 보유시간 > self.vars[69] and 수익률 < self.vars[70]:
    매도 = True
elif 급락신호:
    매도 = True
elif 이평이탈여부 and 체결강도 < 체결강도평균(30):
    매도 = True
elif 추세약화 and 수익률 < self.vars[71]:
    매도 = True
elif 현재가 < 최저현재가(int(60), int(보유시간)) and 보유시간 > 60:
    매도 = True

elif 시가총액 < 2500:
    if 0 < 수익률 <= 8 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * self.vars[72]:
        매도 = True
    elif 수익률 < -self.vars[73] and 체결강도N(1) > 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:
        매도 = True
    elif self.vars[74] < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
        매도 = True

else:
    if 0 < 수익률 <= 8 and (초당매도수량 - 초당매수수량) >= 매수총잔량 * self.vars[75]:
        매도 = True
    elif 수익률 < -self.vars[76] and 체결강도N(1) > 체결강도평균(30, 1) and 체결강도평균(30) > 체결강도:
        매도 = True
    elif self.vars[77] < 최고수익률 and 현재가N(1) >= 이동평균(60, 1) and 이동평균(60) > 현재가:
        매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_930_1000_EMC_SOR

```python
self.vars[59] = [[28.5, 30.0, 0.5], 29.5]                  # 상한가 근접 등락율
self.vars[60] = [[0.5, 1.5, 0.5], 1.0]                     # 시가대비등락율 하락 기준
self.vars[61] = [[1.0, 2.0, 0.5], 1.5]                     # 초기 손실 컷 수익률
self.vars[62] = [[3.0, 5.0, 1.0], 4.0]                     # 목표 수익률
self.vars[63] = [[3.5, 4.5, 0.5], 4.0]                     # 최대 손실 컷 수익률
self.vars[64] = [[4.5, 5.5, 0.5], 5.0]                     # 최고수익률 기준값
self.vars[65] = [[2.0, 3.0, 0.5], 2.5]                     # 최고수익률 대비 하락폭
self.vars[66] = [[0.5, 0.7, 0.1], 0.6]                     # 급락신호 매도잔량 비율
self.vars[67] = [[0.4, 0.6, 0.1], 0.5]                     # 급락신호 단기하락률
self.vars[68] = [[0.6, 0.8, 0.1], 0.7]                     # 트레일링 스톱 비율
self.vars[69] = [[100, 140, 20], 120]                      # 보유시간 상한 (초)
self.vars[70] = [[0.8, 1.2, 0.2], 1.0]                     # 장기보유 손익 기준
self.vars[71] = [[1.5, 2.5, 0.5], 2.0]                     # 추세약화 수익률 기준
self.vars[72] = [[0.7, 0.9, 0.1], 0.8]                     # 중소형 매도우위 비율
self.vars[73] = [[1.3, 1.7, 0.2], 1.5]                     # 중소형 체결강도 손절 기준
self.vars[74] = [[2.0, 3.0, 0.5], 2.5]                     # 중소형 이평이탈 최고수익률
self.vars[75] = [[0.6, 0.7, 0.05], 0.65]                   # 대형 매도우위 비율
self.vars[76] = [[1.3, 1.7, 0.2], 1.5]                     # 대형 체결강도 손절 기준
self.vars[77] = [[2.0, 3.0, 0.5], 2.5]                     # 대형 이평이탈 최고수익률

# 총 변수 수: 19개 (매도)
# 대략 경우의 수: 각 변수당 평균 3~5개 후보 → 수만~수십만 케이스
```

### 매수 매도 최적화 범위 - C_T_930_1000_EMC_OR

```python
# OR 모드는 BOR + SOR를 하나로 합친 형태입니다.
# 매수 변수: vars[1] ~ vars[58]
# 매도 변수: vars[59] ~ vars[77]

# (BOR의 vars[1]~vars[58] 전체 복사)
# ... (생략: 실제 사용 시 BOR 블록 전체 복사)

# (SOR의 vars[59]~vars[77] 전체 복사)
self.vars[59] = [[28.5, 30.0, 0.5], 29.5]
self.vars[60] = [[0.5, 1.5, 0.5], 1.0]
self.vars[61] = [[1.0, 2.0, 0.5], 1.5]
self.vars[62] = [[3.0, 5.0, 1.0], 4.0]
self.vars[63] = [[3.5, 4.5, 0.5], 4.0]
self.vars[64] = [[4.5, 5.5, 0.5], 5.0]
self.vars[65] = [[2.0, 3.0, 0.5], 2.5]
self.vars[66] = [[0.5, 0.7, 0.1], 0.6]
self.vars[67] = [[0.4, 0.6, 0.1], 0.5]
self.vars[68] = [[0.6, 0.8, 0.1], 0.7]
self.vars[69] = [[100, 140, 20], 120]
self.vars[70] = [[0.8, 1.2, 0.2], 1.0]
self.vars[71] = [[1.5, 2.5, 0.5], 2.0]
self.vars[72] = [[0.7, 0.9, 0.1], 0.8]
self.vars[73] = [[1.3, 1.7, 0.2], 1.5]
self.vars[74] = [[2.0, 3.0, 0.5], 2.5]
self.vars[75] = [[0.6, 0.7, 0.05], 0.65]
self.vars[76] = [[1.3, 1.7, 0.2], 1.5]
self.vars[77] = [[2.0, 3.0, 0.5], 2.5]

# 전체 경우의 수는 매우 커질 수 있으므로, 단계적 탐색을 권장합니다.
```

### 예상 시간 계산

- 변수 갯수가 매우 많으므로 (매수 58개 + 매도 19개 = 총 77개), 전체 경우의 수는 기하급수적으로 증가합니다.
- **권장 접근법**:
  1. 1단계: 각 변수 후보 수를 2~3개로 제한하여 대략적인 최적 영역 탐색
  2. 2단계: 1단계 결과 중심으로 촘촘히 재탐색
  3. 3단계: GA 최적화로 미세 조정
  4. 교차검증/기간분할 옵션 사용 시 탐색 시간이 선형적으로 증가하므로 우선 TRIAL 수를 축소 후 점진 확대

### GA 최적화 범위 - C_T_930_1000_EMC_GAR

- 일반 최적화에서 확보한 최적값들을 중심으로, GA에서는 리스트 기반 후보 집합으로 전환합니다.
- 예시(일부 변수):

```python
# 공통 필터
self.vars[1]  = [[1000, 2000, 3000], 1000]
self.vars[2]  = [[40000, 50000, 60000], 50000]
self.vars[3]  = [[0.3, 0.5, 0.7], 0.5]
self.vars[4]  = [[15.0, 20.0, 25.0], 20.0]
self.vars[9]  = [[-1.0, 0.0, 0.5, 1.0], 0.0]
self.vars[10] = [[50, 60, 70], 60]

# 중소형 종목
self.vars[14] = [[5, 10, 15], 10]
self.vars[15] = [[700, 800, 900], 800]
self.vars[16] = [[15, 20, 25], 20]
self.vars[27] = [[75, 80, 85], 80]

# 중형 종목
self.vars[29] = [[15, 20, 25], 20]
self.vars[34] = [[90, 100, 110], 100]
self.vars[43] = [[80, 85, 90], 85]

# 대형 종목
self.vars[44] = [[40, 50, 60], 50]
self.vars[49] = [[180, 200, 220], 200]
self.vars[58] = [[85, 90, 95], 90]

# 매도
self.vars[62] = [[3.0, 4.0, 5.0], 4.0]
self.vars[63] = [[3.5, 4.0, 4.5], 4.0]
self.vars[65] = [[2.0, 2.5, 3.0], 2.5]
self.vars[68] = [[0.6, 0.7, 0.8], 0.7]
self.vars[69] = [[100, 120, 140], 120]
```

---

## 조건식 개선 방향 연구

1) **TA-Lib 지표 활용 강화**
   - RSI, MACD, Bollinger Bands 등 기술적 지표를 조건에 추가하여 신뢰성 향상
   - 과매수/과매도 구간 회피 조건 추가

2) **거래대금 안정성 개선**
   - 거래대금 변동률의 표준편차 활용
   - 비정상적인 스파이크 제거

3) **시가총액 세분화**
   - 중소형/중형/대형 외에 초대형(1조 이상) 구간 추가
   - 각 구간별 최적 파라미터 재탐색

4) **시간대별 세분화**
   - 09:30~09:40, 09:40~09:50, 09:50~10:00으로 10분 단위 세분화
   - 각 시간대별 특성 반영

5) **리스크 관리 강화**
   - 연속 손실 횟수 제한
   - 최대 포지션 크기 상한
   - 동시 보유 종목 수 제한

6) **최적화 절차**
   - 1단계(넓게) → 2단계(좁게) → GA(리스트) → 재탐색 루프 반복

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #파이썬
- #트레이딩로직
- #930_1000전략
- #모멘텀지속
- #안정화구간
- #TA-Lib
- #리스크관리
