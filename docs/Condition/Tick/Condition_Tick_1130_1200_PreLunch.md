# 조건식 (Condition)

- STOM 주식 자동거래에 사용하기 위한 조건식 문서
- [[Back_Testing_Guideline_Tick]] 을(를) 기반으로 작성한 Tick 조건식
- [[Condition_Document_Template_Guideline]] 을(를) 바탕으로 템플릿 구조를 적용한 문서

## 개요

본 문서는 STOM 주식 자동거래 시스템에서 **점심시간 전 청산 구간(11:30~12:00) 전략**을 정의한다.

- **대상 시간 구간**: 11:30:00 ~ 12:00:00 (점심시간 전 청산 구간)
- **대상 종목**: 관심종목, 가격대 1,000원~50,000원
- **전략 타입**: 점심시간 전 포지션 정리 (PreLunch)
- **핵심 변수**: 등락율각도(30/60), 초당거래대금평균(60/120), 초당매수수량, 초당매도수량
- **업데이트 이력**:
  - 초기 문서 작성: 점심시간 전 전략

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - Tick 1130_1200 PreLunch](#condition---tick-1130_1200-prelunch)
  - [전략 개요](#전략-개요)
  - [조건식](#조건식)
    - [매수 조건식 - C_T_1130_1200_PL_B](#매수-조건식---c_t_1130_1200_pl_b)
    - [매도 조건식 - C_T_1130_1200_PL_S](#매도-조건식---c_t_1130_1200_pl_s)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식 - C_T_1130_1200_PL_BO](#매수-최적화-조건식---c_t_1130_1200_pl_bo)
    - [매수 최적화 범위 - C_T_1130_1200_PL_BOR](#매수-최적화-범위---c_t_1130_1200_pl_bor)
    - [매도 최적화 조건식 - C_T_1130_1200_PL_SO](#매도-최적화-조건식---c_t_1130_1200_pl_so)
    - [매도 최적화 범위 - C_T_1130_1200_PL_SOR](#매도-최적화-범위---c_t_1130_1200_pl_sor)
    - [GA 최적화 범위 - C_T_1130_1200_PL_GAR](#ga-최적화-범위---c_t_1130_1200_pl_gar)
  - [조건식 개선 방향 연구](#조건식-개선-방향-연구)
  - [태그](#태그)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 11:30:00 ~ 12:00:00 구간의 점심시간 전 청산 전략(PreLunch)을 위한 조건식과 최적화 범위를 제공합니다. 점심시간 전 변동성 축소 및 포지션 정리 구간에서 단기 수익을 목표로 하는 전략입니다.

## 가이드라인

- 모든 조건식은 Python 스타일의 의사코드로 작성되어 있으며, STOM 백테스터가 인식하는 변수/함수 규칙을 따릅니다.
- 최적화 조건식은 `self.vars[i]`로 치환하여 탐색 범위를 별도로 정의합니다.
- 최적화 범위 포맷: `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]`
- 변수/함수 표기 및 사용 규칙은 Back_Testing_Guideline_Tick.md를 따릅니다.

### 저장 이름 규칙

1. 기본 규칙:
   - `C`: Condition
   - `T`: Tick
   - `1130_1200`: 시간대
   - `PL`: PreLunch
   - `B`/`S`: 매수/매도 조건식
   - `BO`/`SO`: 매수/매도 최적화 조건식
   - `BOR`/`SOR`: 매수/매도 최적화 범위
   - `GAR`: GA 최적화 범위

---

# Condition - Tick 1130_1200 PreLunch

## 전략 개요

점심시간 전(11:30~12:00)은 거래량이 감소하고 변동성이 낮아지는 구간입니다. 이 시간대의 특징:

- 점심시간 전 포지션 정리로 변동성 축소
- 단기 수익 실현 목표 (보수적 전략)
- 빠른 진입/청산 (보유시간 최소화)
- 안전마진 확대 (손절률 강화)

## 조건식

### 매수 조건식 - C_T_1130_1200_PL_B

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
안정적상승여부        = (등락율각도(30) > 0 and 등락율각도(60) > 0)
거래량안정여부        = (초당거래대금평균(60) > 초당거래대금평균(120) * 0.8)
매수우위여부          = (초당매수수량 > 초당매도수량 * 1.2)

# ================================
#  매수 조건
# ================================
매수 = True

# 공통 필터
if not (관심종목 == 1):
    매수 = False
elif not (113000 <= 시분초 < 120000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 안정적 상승 확인
elif not 안정적상승여부:
    매수 = False

# 거래량 안정성 확인
elif not 거래량안정여부:
    매수 = False

# 매수 우위 확인
elif not 매수우위여부:
    매수 = False

# 시가총액별 세부 조건
elif 시가총액 < 3000:
    if not (0.3 < 등락율 <= 10.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.25)):
        매수 = False
    elif not (회전율 > 1.0):
        매수 = False
    elif not (체결강도 >= 110 and 체결강도 <= 350):
        매수 = False
    elif not (초당거래대금 > 초당거래대금평균(30) * 1.3):
        매수 = False
    elif not (당일거래대금 > 100 * 100):
        매수 = False
    elif not (이동평균(60) > 이동평균(120)):
        매수 = False
else:
    if not (0.2 < 등락율 <= 8.0):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * 0.35)):
        매수 = False
    elif not (회전율 > 0.5):
        매수 = False
    elif not (체결강도 >= 100 and 체결강도 <= 350):
        매수 = False
    elif not (초당거래대금 > 초당거래대금평균(30) * 1.2):
        매수 = False
    elif not (당일거래대금 > 200 * 100):
        매수 = False
    elif not (이동평균(60) > 이동평균(120)):
        매수 = False

# ================================
#  매수 호출
# ================================
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식 - C_T_1130_1200_PL_S

```python
# ================================
#  공통 계산 지표
# ================================
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -0.5 and (초당매도수량 > 초당매수수량 * 1.5)

매도 = False

# 상한가 부근 안전장치
if 등락율 > 29.5:
    매도 = True

# 손절 및 목표가 도달 (보수적 설정)
elif 수익률 >= 1.5 or 수익률 <= -1.5:
    매도 = True

# 트레일링 스톱 (공격적)
elif 최고수익률 > 2.0 and 최고수익률 * 0.70 >= 수익률:
    매도 = True

# 보유시간 기반 청산 (짧게 설정)
elif 보유시간 > 600:  # 10분
    매도 = True

# 급락 신호
elif 급락신호:
    매도 = True

# 등락율 각도 하락 전환
elif 등락율각도(30) < -3:
    매도 = True

# 체결강도 약화
elif 체결강도 < 체결강도평균(30) * 0.8:
    매도 = True

# 11:55 이후 무조건 청산
elif 시분초 >= 115500:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

## 최적화 조건식

### 매수 최적화 조건식 - C_T_1130_1200_PL_BO

```python
# ================================
#  공통 계산 지표
# ================================
전일종가              = 현재가 / (1 + (등락율 / 100))
안정적상승여부        = (등락율각도(30) > 0 and 등락율각도(60) > 0)
거래량안정여부        = (초당거래대금평균(60) > 초당거래대금평균(120) * self.vars[1])
매수우위여부          = (초당매수수량 > 초당매도수량 * self.vars[2])

매수 = True

if not (관심종목 == 1):
    매수 = False
elif not (113000 <= 시분초 < 120000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif not 안정적상승여부:
    매수 = False
elif not 거래량안정여부:
    매수 = False
elif not 매수우위여부:
    매수 = False

elif 시가총액 < 3000:
    if not (self.vars[3] < 등락율 <= self.vars[4]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[5] / 100)):
        매수 = False
    elif not (회전율 > self.vars[6]):
        매수 = False
    elif not (체결강도 >= self.vars[7] and 체결강도 <= 350):
        매수 = False
    elif not (초당거래대금 > 초당거래대금평균(30) * self.vars[8]):
        매수 = False
    elif not (당일거래대금 > self.vars[9] * 100):
        매수 = False
    elif not (이동평균(60) > 이동평균(120)):
        매수 = False
else:
    if not (self.vars[10] < 등락율 <= self.vars[11]):
        매수 = False
    elif not (현재가 > (고가 - (고가 - 저가) * self.vars[12] / 100)):
        매수 = False
    elif not (회전율 > self.vars[13]):
        매수 = False
    elif not (체결강도 >= self.vars[14] and 체결강도 <= 350):
        매수 = False
    elif not (초당거래대금 > 초당거래대금평균(30) * self.vars[15]):
        매수 = False
    elif not (당일거래대금 > self.vars[16] * 100):
        매수 = False
    elif not (이동평균(60) > 이동평균(120)):
        매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위 - C_T_1130_1200_PL_BOR

```python
# 공통
self.vars[1]  = [[0.7, 0.9, 0.1], 0.8]               # 거래량 안정성 비율
self.vars[2]  = [[1.1, 1.3, 0.1], 1.2]               # 매수 우위 비율

# 시가총액 < 3000
self.vars[3]  = [[0.2, 0.4, 0.1], 0.3]               # 등락율 하한
self.vars[4]  = [[8.0, 12.0, 2.0], 10.0]             # 등락율 상한
self.vars[5]  = [[20, 30, 5], 25]                    # 고가 대비 현재가 임계(%)
self.vars[6]  = [[0.8, 1.2, 0.2], 1.0]               # 회전율 하한
self.vars[7]  = [[100, 120, 10], 110]                # 체결강도 하한
self.vars[8]  = [[1.2, 1.4, 0.1], 1.3]               # 초당거래대금/평균 비율
self.vars[9]  = [[80, 120, 20], 100]                 # 당일거래대금(백만)

# 시가총액 >= 3000
self.vars[10] = [[0.1, 0.3, 0.1], 0.2]               # 등락율 하한
self.vars[11] = [[6.0, 10.0, 2.0], 8.0]              # 등락율 상한
self.vars[12] = [[30, 40, 5], 35]                    # 고가 대비 현재가 임계(%)
self.vars[13] = [[0.4, 0.6, 0.1], 0.5]               # 회전율 하한
self.vars[14] = [[90, 110, 10], 100]                 # 체결강도 하한
self.vars[15] = [[1.1, 1.3, 0.1], 1.2]               # 초당거래대금/평균 비율
self.vars[16] = [[150, 250, 50], 200]                # 당일거래대금(백만)
```

### 매도 최적화 조건식 - C_T_1130_1200_PL_SO

```python
단기하락률            = (현재가 / max(현재가N(1), 1) - 1) * 100
급락신호              = 단기하락률 < -self.vars[18] and (초당매도수량 > 초당매수수량 * self.vars[19])

매도 = False

if 등락율 > self.vars[17]:
    매도 = True
elif 수익률 >= self.vars[20] or 수익률 <= self.vars[21]:
    매도 = True
elif 최고수익률 > self.vars[22] and 최고수익률 * self.vars[23] >= 수익률:
    매도 = True
elif 보유시간 > self.vars[24]:
    매도 = True
elif 급락신호:
    매도 = True
elif 등락율각도(30) < -self.vars[25]:
    매도 = True
elif 체결강도 < 체결강도평균(30) * self.vars[26]:
    매도 = True
elif 시분초 >= 115500:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 매도수량, 현재가, 매도호가1, 매수호가1, 강제청산)
```

### 매도 최적화 범위 - C_T_1130_1200_PL_SOR

```python
self.vars[17] = [[28.0, 30.0, 0.5], 29.5]            # 등락율 상한가 근접치
self.vars[18] = [[0.4, 0.6, 0.1], 0.5]               # 단기 하락률 임계
self.vars[19] = [[1.3, 1.7, 0.2], 1.5]               # 매도 우위 비율
self.vars[20] = [[1.2, 1.8, 0.3], 1.5]               # 목표 수익 실현
self.vars[21] = [[-1.8, -1.2, 0.3], -1.5]            # 최대 손실 컷
self.vars[22] = [[1.8, 2.2, 0.2], 2.0]               # 최고수익률 기준값
self.vars[23] = [[0.65, 0.75, 0.05], 0.70]           # 트레일링 보정 비율
self.vars[24] = [[450, 750, 150], 600]               # 최대 보유시간(초)
self.vars[25] = [[2, 4, 1], 3]                       # 등락율각도 하락 임계
self.vars[26] = [[0.7, 0.9, 0.1], 0.8]               # 체결강도 약화 비율
```

### GA 최적화 범위 - C_T_1130_1200_PL_GAR

```python
# 공통
self.vars[1]  = [[0.7, 0.8, 0.9], 0.8]
self.vars[2]  = [[1.1, 1.2, 1.3], 1.2]

# 시가총액 < 3000
self.vars[3]  = [[0.2, 0.3, 0.4], 0.3]
self.vars[4]  = [[8.0, 9.0, 10.0, 11.0, 12.0], 10.0]
self.vars[7]  = [[100, 105, 110, 115, 120], 110]

# 시가총액 >= 3000
self.vars[10] = [[0.1, 0.2, 0.3], 0.2]
self.vars[11] = [[6.0, 7.0, 8.0, 9.0, 10.0], 8.0]
self.vars[14] = [[90, 95, 100, 105, 110], 100]

# 매도
self.vars[20] = [[1.2, 1.5, 1.8], 1.5]
self.vars[21] = [[-1.8, -1.5, -1.2], -1.5]
self.vars[23] = [[0.65, 0.70, 0.75], 0.70]
```

---

## 조건식 개선 방향 연구

1) **시간대별 차등 목표 수익률**
   - 11:30~11:45: 목표 2.0%
   - 11:45~11:55: 목표 1.5%
   - 11:55~12:00: 즉시 청산

2) **변동성 축소 감지**
   - ATR(Average True Range) 계산
   - 변동성이 일정 수준 이하로 축소되면 진입 중단

3) **호가창 두께 분석**
   - 매수/매도 잔량 비율 세밀화
   - 호가창이 얇은 종목 회피

4) **점심시간 직전 청산 강화**
   - 11:55 이후 목표 수익률 0.5%로 하향
   - 손절률도 -0.5%로 강화

## 태그
- #주식트레이딩
- #틱트레이딩
- #매수조건
- #매도조건
- #최적화
- #유전알고리즘
- #파이썬
- #트레이딩로직
- #1130_1200전략
- #점심시간전략
- #단기전략
- #리스크관리
