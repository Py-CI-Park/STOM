# ICOS 구현 실행 계획

> **작성일**: 2026-01-15
> **브랜치**: feature/iterative-condition-optimizer
> **목적**: ICOS 핵심 문제 해결 및 구현 완성을 위한 실행 계획
> **참조 문서**: 20260115_ICOS_Pipeline_Analysis_and_Integration_Plan.md

---

## 1. 핵심 문제 요약

### 1.1 현재 상태 분석

**SyncBacktestRunner 구현 현황 (680줄)**:

```
backtester/iterative_optimizer/backtest_sync.py
├── SyncBacktestRunner 클래스
│   ├── __init__() - 초기화 (52-96줄) ✅ 구현완료
│   ├── run() - 백테스트 실행 (194-334줄) ✅ 구현완료
│   ├── _load_period_data() - 데이터 로드 (111-166줄) ✅ 구현완료
│   ├── _run_backengine_sync() - 백엔진 동기 실행 (336-405줄) ✅ 구현완료
│   ├── _strategy() - 전략 실행 (415-556줄) ⚠️ 지표 함수 부족
│   ├── Buy() - 매수 실행 (558-571줄) ✅ 구현완료
│   ├── Sell() - 매도 실행 (573-576줄) ✅ 구현완료
│   └── _calculation_eyun() - 수익 계산 (578-616줄) ✅ 구현완료
```

### 1.2 ICOS가 작동하지 않는 원인

**SyncBacktestRunner의 지표 함수 부족**으로 조건식 실행 실패:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ★ 실제 문제점 ★                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SyncBacktestRunner._strategy() 지표 함수 현황                             │
│                                                                             │
│  BackEngine (44개+):              SyncBacktestRunner (15개):               │
│  ─────────────────                ──────────────────────                   │
│  ✓ 현재가N ~ 체결강도N            ✓ 현재가N ~ 체결강도N                    │
│  ✓ 거래대금증감N                  ✗ 미구현                                 │
│  ✓ 전일비N, 회전율N               ✗ 미구현                                 │
│  ✓ 시가총액N                      ✗ 미구현                                 │
│  ✓ 매도호가1~5N, 매수호가1~5N     ✗ 1단계만 구현                           │
│  ✓ 매도잔량1~5N, 매수잔량1~5N     ✗ 1단계만 구현                           │
│  ✓ 이동평균, 최고/최저현재가       ✓ 구현됨                                │
│  ... (30개+ 추가 지표)            ✗ 미구현                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 영향 체인

```
사용자 조건식에 미구현 지표 포함 (예: 거래대금증감N, 전일비N)
      │
      ▼
SyncBacktestRunner._strategy() 실행 중 NameError 발생
      │
      ▼
try-except에서 조용히 무시됨 (backtest_sync.py:548-550)
      │
      ▼
매수 조건이 항상 실패 → 거래 0건 → 빈 결과
      │
      ▼
★ ICOS가 빈 결과로 동작 → 의미 있는 개선 불가 ★
```

---

## 2. 해결 방안: SyncBacktestRunner 지표 함수 완성

### 2.1 추가할 지표 함수 목록

**BackEngine에서 추출한 전체 지표 함수 목록 (44개)**:

| 함수명 | 인덱스 | 설명 | 구현상태 |
|--------|--------|------|---------|
| `현재가N` | 1 | 현재가 | ✅ |
| `시가N` | 2 | 시가 | ✅ |
| `고가N` | 3 | 고가 | ✅ |
| `저가N` | 4 | 저가 | ✅ |
| `등락율N` | 5 | 등락율 | ✅ |
| `당일거래대금N` | 6 | 당일 거래대금 | ✅ |
| `체결강도N` | 7 | 체결강도 | ✅ |
| `거래대금증감N` | 8 | 거래대금 증감 | ❌ **추가 필요** |
| `전일비N` | 9 | 전일 비 | ❌ **추가 필요** |
| `회전율N` | 10 | 회전율 | ❌ **추가 필요** |
| `전일동시간비N` | 11 | 전일 동시간비 | ❌ **추가 필요** |
| `시가총액N` | 12 | 시가총액 | ❌ **추가 필요** |
| `라운드피겨위5호가이내N` | 13 | 라운드피겨 위 5호가 이내 | ❌ **추가 필요** |
| `초당매수수량N` | 14 | 초당 매수수량 | ❌ **추가 필요** |
| `초당매도수량N` | 15 | 초당 매도수량 | ❌ **추가 필요** |
| `초당거래대금N` | 19 | 초당 거래대금 | ❌ **추가 필요** |
| `고저평균대비등락율N` | 20 | 고저평균 대비 등락율 | ❌ **추가 필요** |
| `매도총잔량N` | 21 | 매도총 잔량 | ❌ **추가 필요** |
| `매수총잔량N` | 22 | 매수총 잔량 | ❌ **추가 필요** |
| `매도호가5N` | 23 | 매도호가 5단계 | ❌ **추가 필요** |
| `매도호가4N` | 24 | 매도호가 4단계 | ❌ **추가 필요** |
| `매도호가3N` | 25 | 매도호가 3단계 | ❌ **추가 필요** |
| `매도호가2N` | 26 | 매도호가 2단계 | ❌ **추가 필요** |
| `매도호가1N` | 27 | 매도호가 1단계 | ✅ |
| `매수호가1N` | 28 | 매수호가 1단계 | ✅ |
| `매수호가2N` | 29 | 매수호가 2단계 | ❌ **추가 필요** |
| `매수호가3N` | 30 | 매수호가 3단계 | ❌ **추가 필요** |
| `매수호가4N` | 31 | 매수호가 4단계 | ❌ **추가 필요** |
| `매수호가5N` | 32 | 매수호가 5단계 | ❌ **추가 필요** |
| `매도잔량5N` | 33 | 매도잔량 5단계 | ❌ **추가 필요** |
| `매도잔량4N` | 34 | 매도잔량 4단계 | ❌ **추가 필요** |
| `매도잔량3N` | 35 | 매도잔량 3단계 | ❌ **추가 필요** |
| `매도잔량2N` | 36 | 매도잔량 2단계 | ❌ **추가 필요** |
| `매도잔량1N` | 37 | 매도잔량 1단계 | ✅ |
| `매수잔량1N` | 38 | 매수잔량 1단계 | ✅ |
| `매수잔량2N` | 39 | 매수잔량 2단계 | ❌ **추가 필요** |
| `매수잔량3N` | 40 | 매수잔량 3단계 | ❌ **추가 필요** |
| `매수잔량4N` | 41 | 매수잔량 4단계 | ❌ **추가 필요** |
| `매수잔량5N` | 42 | 매수잔량 5단계 | ❌ **추가 필요** |
| `매도수5호가잔량합N` | 43 | 매도수 5호가 잔량합 | ❌ **추가 필요** |
| `관심종목N` | 44 | 관심종목 | ⚠️ 부분 구현 |

**고급 분석 함수**:

| 함수명 | 파라미터 | 설명 | 구현상태 |
|--------|---------|------|---------|
| `이동평균` | `(tick, pre=0)` | 이동평균 계산 | ✅ |
| `최고현재가` | `(tick, pre=0)` | 기간 내 최고 현재가 | ✅ |
| `최저현재가` | `(tick, pre=0)` | 기간 내 최저 현재가 | ✅ |
| `체결강도평균` | `(tick, pre=0)` | 체결강도 평균 | ❌ **추가 필요** |
| `최고체결강도` | `(tick, pre=0)` | 최고 체결강도 | ❌ **추가 필요** |
| `최저체결강도` | `(tick, pre=0)` | 최저 체결강도 | ❌ **추가 필요** |
| `등락율각도` | `(tick, pre=0)` | 등락율 각도 | ✅ |
| `당일거래대금각도` | `(tick, pre=0)` | 거래대금 각도 | ✅ |
| `전일비각도` | `(tick, pre=0)` | 전일비 각도 | ❌ **추가 필요** |
| `경과틱수` | `(조건명)` | 조건 발생 후 경과 틱수 | ❌ **추가 필요** |

### 2.2 구현 계획

```
Phase 1: 기본 지표 함수 추가 (30개)
─────────────────────────────────────
├─ 거래대금증감N, 전일비N, 회전율N, 전일동시간비N
├─ 시가총액N, 라운드피겨위5호가이내N
├─ 초당매수수량N, 초당매도수량N, 초당거래대금N
├─ 고저평균대비등락율N
├─ 매도총잔량N, 매수총잔량N
├─ 매도호가2~5N, 매수호가2~5N
├─ 매도잔량2~5N, 매수잔량2~5N
└─ 매도수5호가잔량합N

Phase 2: 고급 분석 함수 추가 (10개)
─────────────────────────────────────
├─ 체결강도평균, 최고체결강도, 최저체결강도
├─ 최고초당매수수량, 최고초당매도수량
├─ 누적초당매수수량, 누적초당매도수량
├─ 초당거래대금평균
├─ 전일비각도
└─ 경과틱수

Phase 3: 예외 처리 개선
─────────────────────────────────────
├─ NameError 감지 및 로깅
├─ 지원 지표 목록 안내 메시지
└─ verbose 모드 상세 출력
```

---

## 3. 성공 기준

### 3.1 기능적 기준

- [ ] 기본 지표만 사용하는 조건식으로 ICOS 정상 실행
- [ ] 거래가 1건 이상 발생하는 것 확인
- [ ] 반복 사이클에서 조건식 개선 관찰
- [ ] 모든 BackEngine 지표가 SyncBacktestRunner에서 지원됨

### 3.2 품질 기준

- [ ] 동일 조건식에서 BackEngine과 SyncBacktestRunner 결과 비교
- [ ] 오차율 5% 이내 (허용 오차: 부동소수점 차이)
- [ ] 예외 발생 시 명확한 에러 메시지 출력

---

## 4. 구현 체크리스트

- [ ] Phase 1: 기본 지표 함수 30개 추가
- [ ] Phase 2: 고급 분석 함수 10개 추가
- [ ] Phase 3: 예외 처리 개선
- [ ] Phase 4: 통합 테스트

---

**문서 작성 완료**: 2026-01-15
**작성자**: Claude Code Assistant
**브랜치**: feature/iterative-condition-optimizer
