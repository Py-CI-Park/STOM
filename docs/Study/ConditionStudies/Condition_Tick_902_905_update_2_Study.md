# Condition_Tick_902_905_update_2 스터디 노트

- 대상: `docs/Condition/Tick/Condition_Tick_902_905_update_2.md`
- 참고: `docs/Guideline/Back_Testing_Guideline_Tick.md`, `docs/Guideline/Back_Testing_Guideline_Min.md`, `docs/check/STOM_Optimization_System_Improvements.md`
- 목적: 조건식 특성 파악, 적용/조합 방법, 최적화 범위 설계, 특정 조건을 무력화(Always True)하며 스터디하는 방법 정리

## 1) 조건식 핵심 특성 요약
- **시간 구간**: 09:00:00~09:02:00(902), 09:02:00~09:05:00(905) 두 분할. 09:05 이후는 미사용.
- **시총 필터**: 사실상 시총 < 3,000 억 조건에서만 동작. 중/대형주 차등 로직이 없어 저유동·고변동 종목 위주로 포착.
- **가격/변동성**: 902 구간 1천~5만, 1~8% 갭·당일/전일 상승률, 905 구간 1천~3만, 2~15%로 높은 변동 구간만 캡처.
- **체결·수급**: 체결강도 50~300, 초당 순매수금액 1~1000 백만, 매도/매수 잔량 비율 체크가 강함(미스 매치 시 쉽게 탈락).
- **각도 지표**: 당일거래대금 각도 30초 기준(5~30) 등 각도 필터가 다수. 초반 샘플 수를 급감시킬 수 있음.
- **매도**: 손절/익절 + 최고수익 대비 회수 트레일링, 시총 < 1조에서 거래각도·순매도 강도 기반 급락 컷.

## 2) 성과 부진 가능 요인
1. **표본 부족**: 시총 < 3,000 억 + 좁은 시가/각도/잔량 필터로 트리거 희박 → 백테·GA가 과최적화/노이즈에 민감.
2. **조건 충돌**: VI 하단 필터 + 고가 근접(20%) + 잔량 비율(0.1~0.3) + 체결강도 50~300 동시 만족 종목이 드묾.
3. **각도 과잉**: `당일거래대금각도(30)` 등 각도 필터가 상승 초입(거래 기울기 낮은 구간)에서 신호를 제거.
4. **매도 비대칭**: 손익/최고수익 비율 컷이 빠르나, 초단타 구간에서 슬리피지/호가 공백 고려가 없음 → 실제 체결 수익률 하락.

## 3) 언제/어떻게 쓸지
- **주도 섹터 초반 시총 하위 랠리 포착**: 테마 초입 5분 내 급등 종목 선행 포착에 적합.
- **시장 강한 변동성 날**: 체결강도 50~300 구간이 꾸준히 발생하는 날(갭업+거래 폭발)에 집중.
- **잔량 왜곡이 잦은 날은 주의**: 장전 호가 잔량이 비정상일 때 매수/매도잔량 비율 필터가 오탐/미탐을 유발.

## 4) 권장 최적화 설계(902/905 별)
- **2단계(Coarse→Fine)**:  
  - 1단계: 폭 넓은 간격(예: 체결강도 40~320 step 20, 초당 순매수금액 0~1200 step 100)로 대략적 sweet-spot 탐색.  
  - 2단계: 1단계 상위 구간 중심 ±15~20% 범위로 세분화(step 절반).  
- **교차검증**: `6분할 exp weight` 대신 `조화 평균`(STOM_Optimization_System_Improvements.md 제안) 사용 시 극단값 증폭 억제.
- **변수 중요도 우선순위**(표본 영향↑): 체결강도, 초당 순매수금액, 잔량 비율, 각도(당일거래대금각도). 이 4개를 먼저 고정 후 나머지 탐색.
- **902 전용 범위 제안**:  
  - 체결강도: 60~260 (step 20) → 후속 Fine 80~220 (step 10)  
  - 초당 순매수금액: 0.5~8억 (step 0.5) → Fine 1~5억 (step 0.25)  
  - 잔량 비율(매수/매도): 0.15~0.45 (step 0.05) → Fine 0.20~0.35 (step 0.03)  
  - 각도(당일거래대금각도30): 2~18 (step 2) → Fine 4~12 (step 1)  
- **905 전용 범위 제안**(체결강도 완화, 추세 확인):  
  - 체결강도: 40~220 (step 20) → Fine 60~180 (step 10)  
  - 초당 순매수금액: 0.3~6억 (step 0.5) → Fine 0.8~4억 (step 0.25)  
  - 잔량 비율(매수/매도): 0.20~0.50 (step 0.05) → Fine 0.25~0.40 (step 0.03)  
  - 각도(당일거래대금각도30): 1~15 (step 2) → Fine 3~10 (step 1)

## 5) 조건식 조합 아이디어
- **초기 모멘텀 → 추세 필터**: 본 조건을 **진입**으로, 분봉 가이드라인(Min) 기반 `MA(5/20/60) 정배열 + RSI > 45`를 **보유/익절 연장** 필터로 사용해 과잉 이탈 방지.
- **호가 우위 강화**: `Condition_Tick_Order_Book_Imbalance`의 호가 스프레드/잔량 불균형 체크를 905 구간에만 추가 → 후속 추격 시 낙폭 리스크 축소.
- **볼린저 재진입**: `Condition_Tick_900_920_Enhanced`의 볼린저/체결강도 추세 확인 부분을 905 구간 뒤(09:04~09:06)에 재진입 필터로 적용하면 재랠리 포착률 상승.
- **분봉 캔들 확인**: 백테스팅 Min 가이드대로 `분봉고가 돌파 + 분당거래대금평균(20) 상회`를 덧붙여 시세 연속성 확보.

## 6) 범위 확장/조건 생략(Always-True) 스터디 방법
특정 조건 영향도를 제거하고 싶을 때, 최적화 범위를 아래처럼 넓혀 “항상 통과”에 가깝게 만든다.

| 조건 | 기본 역할 | 무력화용 범위 예시 |
| --- | --- | --- |
| 체결강도 하한/상한 | 저품질 호가 차단 | 0~400 (step 50) |
| 초당 순매수금액 | 수급 확인 | 0~1500 백만 (step 150) |
| 잔량 비율(매도총잔/매수총잔) | 호가 균형 | 0.0~5.0 (step 0.5) |
| 각도(당일거래대금각도30) | 추세 기울기 | 0~40 (step 4) |
| VI/라운드피겨 | 리스크 회피 | VI 하단: 0~100000, 라운드피겨: False 전용 플래그 추가 또는 주석 처리 후 실험 |
| 시총 필터 | 초저유동 제한 | 0~30000 억 (step 5000) |

실험 절차: (1) 위 범위로 1차 최적화 → (2) 영향 큰 변수부터 원래 범위로 되돌려 단계별 감도 측정 → (3) 중요도가 낮은 조건은 제거/완화 결정.

## 7) 백테/최적화 운영 플로우(권장)
1. **데이터 전처리**: 슬리피지 0.3~0.5틱, 체결 지연 1틱 반영(Optimization Improvements 문서 9.1~9.2 참고).  
2. **Coarse 최적화**: 위 “4) 권장 최적화 설계” 1단계.  
3. **Fine 최적화**: 상위 20% 케이스만 좁혀 2단계.  
4. **강건성 테스트**: 최적 해 근방 ±10% 변경 시 수익률/MDD 변동 < 20%인지 확인.  
5. **분할 교차검증**: 6분할 → 3분할 비교, 가중치 exponential/균등 모두 측정.  
6. **리포트**: 조건별 필터 통과율, 체결강도/각도 분포, 슬리피지 적용 후 체결률을 함께 로그화.  
7. **실거래 전 리스크 컷**: 시총·거래대금 급락일에는 매수량 스케일 다운(30~50%) 규칙 추가.

## 8) 체크리스트
- [ ] 시총 < 3,000 억에 과도하게 치우치지 않는지(필요 시 10,000 억까지 열어 샘플 확보).  
- [ ] 체결강도/잔량/각도 중 하나라도 지나치게 좁게 설정되지 않았는지.  
- [ ] 902와 905 구간 조건이 중복/충돌하지 않는지(같은 값 요구 여부).  
- [ ] 분봉 추세 필터(RSI/MA/BB) 적용 시 트리거 수 급감 여부.  
- [ ] 슬리피지/지연을 넣어도 손익 구조가 유지되는지.  
- [ ] 강건성 테스트(±10%) 통과 여부.  

---

작성자: Codex (GPT-5), 2025-11-27

---

## Back_Testing_Guideline_Tick 조건 정리(전 항목 요약)
- **기본 가격/캔들**: 현재가, 시가, 고가, 저가, 당일락폭, 고저평균대비등락률. → 가격·갭 필터, 강한 변동 필터.
- **거래/체결**: 일거래대금, 거래대금증가, 일비, 회전율, 일시간비, 시총, 라운드피겨, 초당매수/매도량, 초당거래대금, 매도/매수잔량, 호가/호가량(1~5), 매도누적호가량. → 유동성/수급·호가 균형 체크.
- **구간산출(초 단위)**: 이동평균(N), 최고/최저현재가(N), 초당거래대금평균(N), 체결강도평균(N), 최고/최저체결강도(N), 누적초당매수/매도량(N), 최고초당매수/매도량(N), 일거래대금각도(N), 일비각도(N), 당일락각도(N). → 추세·기울기·극값 감지.
- **TA-Lib**: BBU/BBM/BBL, MACD/MACDS/MACDH, APO, KAMA, RSI, HT_SINE/LSINE/PHASE/QUDRA, OBV. `_N(k)`로 과거 조회.
- **기타**: VI제한시간/가격/호가/이탈, 평균값계산틱수, 시간(분), 종목명/코드.
- **작성 규칙 체크**: 범위 함수 괄호 필수, self.vars 형식 `[[start, end, step], init]`, 범위 개수 ≤ 20, 간격 부호 일관.
- **Updated 매수 예시 핵심**: 09:25 이전, VI 하단, 초당거래대금 증가, 시총별 잔량/거래/각도 조건 세트. → 902_905와 결합 시 잔량/각도/체결강도 로직 유사.
- **Updated 매도 예시 핵심**: 상한가 근접, 손절/익절 절대·트레일링, 시총·각도·순매도량 기반 급락 컷.

## Back_Testing_Guideline_Min(분봉) 조건 정리(전 항목 요약)
- **기본 가격/캔들**: 분봉 종가/시고저, 일락폭, 고저평균대비등락률, 일거래대금, 체결강도, 거래대금증가, 일비/회전율/일시간비, 시총, 라운드피겨.
- **분당 거래/호가**: 분당매수/매도량, 분당거래대금, 매도/매수잔량, 호가/호가량(1~5), 매수5호가량.
- **구간산출(분봉 단위)**: 이동평균(N), 최고/최저현재가(N), 최고분봉고가/최저분봉저가(N), 분당거래대금평균(N), 체결강도평균/최고/최저(N), 누적분당매수/매도량(N), 최고분당매수/매도량(N), 일거래대금각도/일비각도/락각도(N). → 추세·변동성·각도 기반 분봉 필터.
- **TA-Lib 분봉**: AD/ADOSC/ADXR, APO, AROOND/U, ATR, Bollinger, CCI, DIM/DIP, MACD 계열, MFI/MOM/OBV/PPO/ROC, RSI/SAR, STOCH 계열, WILLR. `_N(k)`로 과거 조회.
- **보유 상태 변수**: 수익률, 최고/최저수익률, 보유수량·보유시간, 매수틱 인덱스(-1 조회 허용).
- **작성 규칙**: Tick과 동일한 범위 함수 검증(괄호, self.vars 형식, 범위 개수 ≤ 20, 간격 부호).
- **매수 예시 핵심**: 60분 MA 상회 + 체결강도평균 + RSI 반등 + 분당거래대금 2배 → 추세 확인 후 진입.
- **매도 예시 핵심**: RSI 70, 목표 수익, 보유시간 초과, Bollinger 상단 돌파 후 이탈, MACD 데드크로스 → 후행 추세 종료 컷.
- **시간·구간 주의**: HHMMSS 6자리 사용, 분봉 이동평균은 `(기간, 전봉수)` 표기, 매도에서 -1 사용 가능.
