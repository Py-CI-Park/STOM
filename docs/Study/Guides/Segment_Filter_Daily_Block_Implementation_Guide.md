# 세그먼트 필터 당일 재매수 차단 기능 구현 가이드

> 작성일: 2026-01-09
> 브랜치: `feature/segment-filter-daily-block-implementation`
> 관련 분석 문서: `docs/Study/SystemAnalysis/20260108_Segment_Filter_Prediction_vs_Actual_Discrepancy_Analysis.md`

---

## 1. 개요

### 1.1 문제 상황

세그먼트 필터 적용 시 예측과 실제 거래 수 사이에 심각한 괴리가 발생했습니다:

| 구분 | 값 |
|------|-----|
| 예측 거래 수 | 1,497건 |
| 실제 거래 수 | 2,955건 |
| 괴리율 | **+97.4%** |

### 1.2 근본 원인: "대체 매수" 현상

```
시나리오 예시:
1. 종목 A, 09:30 - 세그먼트 필터에 의해 차단됨
2. 종목 A, 10:15 - 다시 매수 조건에 걸림
3. 10:15의 세그먼트 필터 → 통과!
4. 결과: 09:30에 차단된 거래가 10:15에 "대체 매수"됨
```

이러한 "대체 매수" 현상으로 인해 세그먼트 필터의 예측과 실제 사이에 괴리가 발생합니다.

### 1.3 해결 방안

**옵션 1: 조건식 + 인프라 통합 방식 (본 구현)**

세그먼트 필터에서 한 번 차단된 종목은 해당 날짜 동안 전체 매수를 금지합니다.

---

## 2. 아키텍처

### 2.1 인프라 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        전략 엔진                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    인프라 변수                           │ │
│  │  self.세그먼트차단종목 = {}                              │ │
│  │    키: (종목코드, 날짜)                                  │ │
│  │    값: 최초 차단 시분초                                  │ │
│  │                                                         │ │
│  │  self._세그먼트차단_마지막날짜 = 0                       │ │
│  │    (날짜 변경 감지용)                                   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 수정된 파일 목록

| 파일 | 역할 | 수정 내용 |
|------|------|----------|
| `stock/kiwoom_strategy_tick.py` | 실전 거래 엔진 | 인프라 변수 추가 |
| `backtester/backengine_kiwoom_tick.py` | 주식 백테스팅 | 인프라 변수 추가 |
| `backtester/backengine_upbit_tick.py` | 업비트 백테스팅 | 인프라 변수 추가 |
| `backtester/backengine_binance_tick.py` | 바이낸스 백테스팅 | 인프라 변수 추가 |
| `backtester/segment_analysis/code_generator.py` | 코드 생성기 | 당일 차단 로직 생성 |

### 2.3 상속 구조

```
BackEngineKiwoomTick (부모 - 인프라 정의)
        │
        └── BackEngineKiwoomMin (자식 - 상속받아 사용)

BackEngineUpbitTick (부모 - 인프라 정의)
        │
        └── BackEngineUpbitMin (자식 - 상속받아 사용)

BackEngineBinanceTick (부모 - 인프라 정의)
        │
        └── BackEngineBinanceMin (자식 - 상속받아 사용)
```

---

## 3. 구현 상세

### 3.1 인프라 코드 (4개 파일 공통)

```python
# === 세그먼트 필터 당일 재매수 차단 인프라 (2026-01-09 추가) ===
# 세그먼트 필터에서 차단된 종목을 당일 전체 매수 금지하기 위한 저장소
# 키: (종목코드, 날짜), 값: 최초 차단 시분초
# 조건식 코드에서 self.세그먼트차단종목[(종목코드, 날짜)] 형태로 접근
self.세그먼트차단종목 = {}
self._세그먼트차단_마지막날짜 = 0
```

### 3.2 코드 생성기 수정

#### 3.2.1 새로운 함수: `_build_daily_block_preamble()`

날짜 변경 감지 및 이미 차단된 종목 확인 코드를 생성합니다:

```python
def _build_daily_block_preamble() -> List[str]:
    """
    생성되는 코드:

    # === 세그먼트 필터 당일 재매수 차단 (2026-01-09) ===
    # 날짜 추출 (index에서 YYYYMMDD 부분)
    try:
        _오늘날짜 = int(str(self.index)[:8]) if len(str(self.index)) >= 8 else 0
    except (AttributeError, ValueError):
        _오늘날짜 = 0

    # 날짜 변경 감지 시 차단 목록 초기화
    if _오늘날짜 != self._세그먼트차단_마지막날짜:
        self.세그먼트차단종목 = {}
        self._세그먼트차단_마지막날짜 = _오늘날짜

    # 이미 오늘 차단된 종목인지 확인 (당일 재매수 차단)
    _이미차단됨 = (종목코드, _오늘날짜) in self.세그먼트차단종목
    if _이미차단됨:
        매수 = False  # 당일 재매수 차단: 이미 차단된 종목
    """
```

#### 3.2.2 새로운 함수: `_build_daily_block_record()`

세그먼트 필터에서 차단된 종목을 기록하는 코드를 생성합니다:

```python
def _build_daily_block_record() -> List[str]:
    """
    생성되는 코드:

    # 세그먼트 필터에서 차단된 경우, 차단 목록에 기록
    if not 매수 and (종목코드, _오늘날짜) not in self.세그먼트차단종목:
        try:
            self.세그먼트차단종목[(종목코드, _오늘날짜)] = 시분초
        except NameError:
            self.세그먼트차단종목[(종목코드, _오늘날짜)] = 0
    """
```

#### 3.2.3 수정된 함수: `_inject_segment_filter_first()`

```python
def _inject_segment_filter_first(
    working_lines: List[str],
    segment_code_lines: List[str],
    enable_daily_block: bool = True,  # 새 파라미터
) -> Tuple[List[str], bool]:
```

---

## 4. 동작 흐름

### 4.1 전체 흐름도

```
┌──────────────────────────────────────────────────────────────┐
│                    매수 조건 평가 시작                         │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  1. 날짜 추출 (_오늘날짜 = index에서 YYYYMMDD)                │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  2. 날짜 변경 확인                                            │
│     if _오늘날짜 != self._세그먼트차단_마지막날짜:             │
│         self.세그먼트차단종목 = {}  # 초기화                   │
│         self._세그먼트차단_마지막날짜 = _오늘날짜              │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│  3. 이미 차단된 종목 확인                                     │
│     if (종목코드, _오늘날짜) in self.세그먼트차단종목:         │
│         매수 = False  ──────────────────────────────────────┼─┐
└──────────────────────────────────────────────────────────────┘ │
                              │                                   │
                              ▼                                   │
┌──────────────────────────────────────────────────────────────┐ │
│  4. 세그먼트 필터 평가                                        │ │
│     (기존 세그먼트 필터 로직 실행)                            │ │
│     → 조건 불충족 시 매수 = False                             │ │
└──────────────────────────────────────────────────────────────┘ │
                              │                                   │
                              ▼                                   │
┌──────────────────────────────────────────────────────────────┐ │
│  5. 차단 기록                                                 │ │
│     if not 매수 and 아직 기록 안 됨:                          │ │
│         self.세그먼트차단종목[(종목코드, _오늘날짜)] = 시분초  │ │
└──────────────────────────────────────────────────────────────┘ │
                              │                                   │
                              ▼                                   │
┌──────────────────────────────────────────────────────────────┐ │
│  6. 기존 매수 조건 평가                                       │◄┘
│     (세그먼트 필터 통과 시에만 의미 있음)                     │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 시나리오 예시

#### 시나리오: 동일 종목 다중 매수 시도

```
시간    종목    세그먼트 필터 결과    당일 차단 동작
────────────────────────────────────────────────────────
09:30   A      차단 (매수=False)    차단 목록에 추가 (A, 20260109)
10:15   A      -                    이미 차단됨 → 즉시 매수=False
10:45   A      -                    이미 차단됨 → 즉시 매수=False
11:00   B      통과                 통과 (차단 목록에 없음)
14:30   A      -                    이미 차단됨 → 즉시 매수=False

다음날 (2026-01-10):
09:00   -      -                    날짜 변경 → 차단 목록 초기화
09:15   A      통과                 새 날짜이므로 정상 평가
```

---

## 5. 테스트 방법

### 5.1 단위 테스트

```python
# 테스트 시나리오
def test_daily_block():
    # 1. 첫 번째 거래 차단 확인
    # 2. 같은 종목 두 번째 거래 즉시 차단 확인
    # 3. 다른 종목은 정상 평가 확인
    # 4. 날짜 변경 시 초기화 확인
    pass
```

### 5.2 통합 테스트

1. 백테스팅 실행 전/후 거래 수 비교
2. 예측 거래 수와 실제 거래 수 일치 확인
3. 동일 종목 다중 매수 시도 시 첫 번째만 기록 확인

### 5.3 검증 체크리스트

- [ ] 인프라 변수가 올바르게 초기화되는가?
- [ ] 날짜 변경 시 차단 목록이 초기화되는가?
- [ ] 이미 차단된 종목이 즉시 차단되는가?
- [ ] 새로 차단된 종목이 목록에 기록되는가?
- [ ] 예측 거래 수와 실제 거래 수가 일치하는가?

---

## 6. 성능 고려사항

### 6.1 메모리 사용량

- 차단 목록은 `dict` 자료구조 사용
- 키: `(종목코드, 날짜)` 튜플
- 하루 최대 종목 수: 약 2,500개 (코스피+코스닥)
- 예상 메모리: 약 200KB/일 (무시 가능)

### 6.2 조회 성능

- `dict` 조회: O(1) 평균
- 추가적인 성능 오버헤드: 무시 가능

---

## 7. 주의사항

### 7.1 분봉 엔진 호환성

분봉 엔진(`BackEngine*Min`)은 틱 엔진을 상속받으므로 자동으로 인프라를 사용합니다.
별도의 수정 없이 동작합니다.

### 7.2 날짜 형식

`self.index`에서 날짜를 추출합니다:
- 형식: `YYYYMMDDHHMMSS...`
- 예: `20260109093045123` → `20260109`

### 7.3 실전 거래 vs 백테스팅

실전 거래와 백테스팅 모두 동일한 인프라를 사용하여 일관성을 보장합니다.

---

## 8. 향후 개선 방향

### 8.1 단기 개선

- [ ] 차단 통계 로깅 추가
- [ ] 차단 종목 목록 UI 표시

### 8.2 중장기 개선

- [ ] 세그먼트별 차단 정책 세분화
- [ ] 차단 해제 조건 추가 (예: 급등 시)
- [ ] 차단 이력 데이터베이스 저장

---

## 9. 관련 문서

- [세그먼트 필터 예측-실제 괴리 분석](../SystemAnalysis/20260108_Segment_Filter_Prediction_vs_Actual_Discrepancy_Analysis.md)
- [세그먼트 필터 조건식 통합 가이드](Segment_Filter_Condition_Integration_Guide.md)
- [세그먼트 필터 검증 체크리스트](Segment_Filter_Verification_Checklist.md)

---

## 10. 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-09 | 1.0 | 최초 작성 |
