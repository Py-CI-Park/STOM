# 조건식 최적화 및 분석 가이드 (Condition Optimization & Analysis Guide)

## 1. 개요
본 문서는 `Condition_Tick_902_905_update_2.md`의 성과 부진 원인을 분석하고, `Back_Testing_Guideline_Tick.md` 및 `Back_Testing_Guideline_Min.md`에 정의된 **모든 변수**에 대한 상세 설명과 최적화 가이드를 제공합니다. 특히 조건식의 개별 특성, 조합 방법, 그리고 효율적인 최적화 방법론(조건 무력화/Neutralization)을 심층적으로 다룹니다.

---

## 2. 변수 사전 및 최적화 가이드 (Variable Dictionary & Optimization Guide)

백테스팅 가이드라인에 명시된 모든 변수를 7가지 카테고리로 분류하여 설명합니다. 각 변수별로 **특성**, **활용 팁**, 그리고 최적화 시 해당 조건을 사실상 삭제하는 효과를 내는 **무력화(Neutralization) 설정값**을 제시합니다.

### 2.1 가격 관련 변수 (Price Variables)
주가의 절대적 위치나 상대적 변동을 측정합니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) | 무력화 설정 (Neutralization) |
| :--- | :--- | :--- | :--- |
| **현재가** | 현재 체결 가격 | 특정 가격대(동전주, 고가주) 필터링 | 하한: `[[0], 0]`, 상한: `[[99999999], 99999999]` |
| **시가, 고가, 저가** | 당일 일봉 기준 시가, 고가, 저가 | 캔들 형태 분석 (양봉/음봉, 꼬리) | - |
| **분봉시가, 분봉고가, 분봉저가** | (분봉전용) 해당 분봉의 시/고/저가 | 분봉 내 캔들 패턴 분석 | - |
| **등락율** | 전일 종가 대비 현재가 등락 비율(%) | 너무 높은 급등주 제외 또는 주도주 포착 | 하한: `[[-30.0], -30.0]`, 상한: `[[30.0], 30.0]` |
| **시가등락율** | 전일 종가 대비 시가 등락 비율(%) | 갭상승 과다 종목 필터링 | 하한: `[[-30.0], -30.0]`, 상한: `[[30.0], 30.0]` |
| **시가대비등락율** | 당일 시가 대비 현재가 등락 비율(%) | 장중 상승 강도 측정 (시가 회복 여부) | 하한: `[[-30.0], -30.0]`, 상한: `[[30.0], 30.0]` |
| **고저평균대비등락율** | (고가+저가)/2 대비 현재가 위치(%) | 당일 평균 가격 대비 고평가/저평가 판단 | 하한: `[[-100.0], -100.0]` |
| **이동평균(N)** | 최근 N틱/분 동안의 가격 평균 | 지지선/저항선, 정배열 확인 | - |
| **최고현재가(N), 최저현재가(N)** | 최근 N틱/분 동안의 최고/최저가 | 고점 돌파(Breakout) 또는 저점 지지 확인 | - |
| **최고분봉고가(N), 최저분봉저가(N)** | (분봉전용) 최근 N분간 분봉 고가/저가의 극값 | 더 넓은 범위의 고점/저점 파악 | - |
| **VI가격, VI해제시간** | 변동성 완화장치(VI) 관련 정보 | VI 발동 직전 매수 금지 등 리스크 관리 | - |
| **VI아래5호가** | 현재가가 VI 발동가 아래 5호가 이내인지 | VI에 갇힐 위험 회피 | - |
| **라운드피겨위5호가이내** | 1000원, 10000원 등 주요 가격대 근처 | 저항선 돌파 직전인지 확인 | - |

### 2.2 거래량 및 유동성 변수 (Volume & Liquidity Variables)
거래의 활발함과 자금의 유입 강도를 측정합니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) | 무력화 설정 (Neutralization) |
| :--- | :--- | :--- | :--- |
| **당일거래대금** | 장 시작 후 누적 거래대금 | 주도주 판별의 제1기준 (최소 유동성 확보) | 하한: `[[0], 0]` |
| **초당거래대금** | (틱전용) 1초간 체결된 거래대금 | 순간적인 매수세 유입 포착 (스캘핑 핵심) | 하한: `[[0], 0]` |
| **분당거래대금** | (분봉전용) 1분간 체결된 거래대금 | 분봉 단위 거래량 급증 포착 | 하한: `[[0], 0]` |
| **초당거래대금평균(N)** | 최근 N틱간 초당거래대금의 평균 | 평소 대비 거래량 폭발(Spike) 감지 | - |
| **분당거래대금평균(N)** | 최근 N분간 분당거래대금의 평균 | 평소 대비 거래량 폭발 감지 | - |
| **거래대금증감** | 전일 거래대금 대비 당일 증가분 | 전일보다 거래가 활발한지 확인 | 하한: `[[-9999999999], 0]` |
| **전일비** | 전일 거래량 대비 당일 거래량 비율(%) | 거래량 갱신 여부 확인 | 하한: `[[0], 0]` |
| **전일동시간비** | 전일 동시간대 대비 거래량 비율(%) | 장 초반 거래량 급증 종목 포착에 유용 | 하한: `[[0], 0]` |
| **회전율** | 상장주식수 대비 거래량 비율(%) | 손바뀜 활발한 종목 선정 (단타 필수) | 하한: `[[0], 0]` |
| **시가총액** | 상장주식수 × 현재가 | 대형주/중소형주 구분하여 전략 차별화 | 하한: `[[0], 0]`, 상한: `[[99999999], 99999999]` |

### 2.3 모멘텀 및 체결강도 변수 (Momentum & Strength Variables)
매수세와 매도세의 힘의 균형을 측정합니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) | 무력화 설정 (Neutralization) |
| :--- | :--- | :--- | :--- |
| **체결강도** | (매수체결량/매도체결량) × 100 | 100 이상이면 매수 우위. 급등 시 100~200 유지. | 하한: `[[0], 0]`, 상한: `[[9999], 9999]` |
| **체결강도평균(N)** | 최근 N틱/분 체결강도 평균 | 순간적 노이즈를 제거한 추세적 힘 확인 | - |
| **최고체결강도(N), 최저체결강도(N)** | 최근 N틱/분 체결강도 극값 | 체결강도가 바닥을 찍고 올라오는지 확인 | - |
| **초당매수수량, 초당매도수량** | (틱전용) 1초간 매수/매도 체결 수량 | 순매수(매수-매도)가 양수인지 확인 | - |
| **분당매수수량, 분당매도수량** | (분봉전용) 1분간 매수/매도 체결 수량 | 분 단위 매수 우위 확인 | - |
| **누적초당매수/매도수량(N)** | 최근 N틱간 초당 매수/매도 수량 합 | 일정 기간 동안의 누적된 매집 힘 확인 | - |
| **누적분당매수/매도수량(N)** | 최근 N분간 분당 매수/매도 수량 합 | 일정 기간 동안의 누적된 매집 힘 확인 | - |
| **최고초당매수/매도수량(N)** | 최근 N틱간 가장 높았던 매수/매도 수량 | 매수세의 최대 폭발력 측정 | - |

### 2.4 추세 및 각도 변수 (Trend & Angle Variables)
시계열 데이터의 기울기를 통해 추세의 가속도를 측정합니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) | 무력화 설정 (Neutralization) |
| :--- | :--- | :--- | :--- |
| **등락율각도(N)** | 최근 N틱/분 동안 등락율의 기울기 | 가격 상승 속도가 빨라지는 시점 포착 | 하한: `[[-90], -90]` |
| **당일거래대금각도(N)** | 최근 N틱/분 동안 거래대금의 기울기 | 돈이 급격하게 들어오는 구간 포착 | 하한: `[[-90], -90]` |
| **전일비각도(N)** | 최근 N틱/분 동안 전일비의 기울기 | 거래량 증가 속도 측정 | 하한: `[[-90], -90]` |

### 2.5 호가창 변수 (Order Book Variables)
매수/매도 대기 물량을 분석합니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) | 무력화 설정 (Neutralization) |
| :--- | :--- | :--- | :--- |
| **매수총잔량, 매도총잔량** | 매수/매도 호가 총 잔량 | 매도잔량이 많아야 주가가 오르기 쉽다는 이론 활용 | - |
| **매수호가1~5, 매도호가1~5** | 1~5단계 호가 가격 | 호가 공백(Spread) 확인 | - |
| **매수잔량1~5, 매도잔량1~5** | 1~5단계 호가 잔량 | 특정 가격대에 큰 물량(벽)이 있는지 확인 | - |
| **매수5호가잔량합, 매도수5호가잔량합** | 5호가까지의 잔량 합계 | 근접 호가의 매수/매도 압력 비교 | - |

### 2.6 TA-Lib 보조지표 (Technical Indicators)
기술적 분석 지표를 활용합니다. (틱/분봉 공통)

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) |
| :--- | :--- | :--- |
| **이동평균(MA)** | 단순이동평균 | 정배열, 골든크로스, 지지선 |
| **BBU, BBM, BBL** | 볼린저밴드 상한/중심/하한 | 밴드 상단 돌파(추세), 하단 반등(역추세) |
| **MACD, MACDS, MACDH** | MACD 라인, 시그널, 히스토그램 | 추세 전환 신호, 0선 돌파 |
| **RSI** | 상대강도지수 | 과매수(70이상)/과매도(30이하) 판단 |
| **OBV** | 거래량 지표 | 주가는 하락하나 OBV는 상승(다이버전스) 시 매수 |
| **그 외 (AD, ATR, CCI 등)** | 다양한 모멘텀/변동성 지표 | 전략의 보조 필터로 활용 |

### 2.7 매도 및 기타 변수 (Sell & Other Variables)
매도 시점 판단 및 기타 정보입니다.

| 변수명 | 설명 (Description) | 활용 팁 (Usage Tip) |
| :--- | :--- | :--- |
| **수익률** | 현재 보유 종목의 수익률(%) | 익절/손절의 기본 기준 |
| **최고수익률, 최저수익률** | 보유 기간 중 달성한 최고/최저 수익률 | 트레일링 스탑(Trailing Stop) 구현에 필수 |
| **보유시간** | 매수 후 경과 시간 (틱:초, 분봉:분) | 시간 내 승부가 안 나면 청산(Time Cut) |
| **매수틱번호** | 매수 시점의 데이터 인덱스 | 매수 시점 대비 현재 상태 비교 (`-1` 인덱스 활용) |
| **관심종목** | 관심종목 등록 여부 (1 or 0) | 사전에 선별된 종목만 매매할 때 사용 |
| **데이터길이** | 장 시작 후 누적된 데이터 수 | 장 초반 데이터 부족 시 매매 제한 |

---

## 3. 조건식 조합 및 최적화 전략

### 3.1 조건 무력화(Neutralization) 기법 상세
최적화를 진행할 때, 특정 조건이 성과에 미치는 영향을 파악하거나, 불필요한 조건을 걸러내기 위해 **"조건을 항상 참(True)으로 만드는 범위"**를 설정하는 기법입니다. 이를 통해 해당 조건을 코드 수정 없이 논리적으로 삭제하는 효과를 낼 수 있습니다.

#### 적용 방법
최적화 변수 `self.vars`의 범위를 설정할 때, 해당 조건이 물리적으로 항상 만족할 수밖에 없는 값을 포함시킵니다.

1.  **하한값 조건 무력화**:
    *   코드: `if 변수 < self.vars[i]: 매수 = False`
    *   설정: `self.vars[i] = [[0], 0]` (변수가 0보다 작을 수 없는 경우) 또는 `[[-999], -999]`
2.  **상한값 조건 무력화**:
    *   코드: `if 변수 > self.vars[i]: 매수 = False`
    *   설정: `self.vars[i] = [[99999], 99999]` (도달 불가능한 큰 값)
3.  **범위 조건 무력화**:
    *   코드: `if not (self.vars[i] <= 변수 < self.vars[j]):`
    *   설정: `self.vars[i] = [[-999], -999]`, `self.vars[j] = [[999], 999]`

### 3.2 단계별 최적화 프로세스 (Step-by-Step Optimization)

성과가 나오지 않을 때, 모든 변수를 동시에 최적화하면 원인을 알 수 없습니다. 다음 순서로 진행해 보세요.

1.  **Step 1: 핵심 트리거(Trigger) 선정 및 나머지 무력화**
    *   매수의 핵심 논리(예: 초당거래대금 급증 + 고점 돌파) 1~2개만 남깁니다.
    *   나머지 필터(각도, 이격도, 회전율 등)는 모두 무력화 범위로 설정합니다.
    *   이 상태에서 수익이 나는지 확인합니다. 여기서 수익이 안 나면 진입 논리 자체가 틀린 것입니다.

2.  **Step 2: 필터(Filter) 점진적 활성화**
    *   수익이 나는 트리거를 고정한 채, 리스크 관리 변수(예: 등락율 상한, 시가총액 제한)를 하나씩 정상 범위로 좁혀봅니다.
    *   MDD(최대 낙폭)가 줄어들고 승률이 오르는지 확인합니다.

3.  **Step 3: 교집합 최적화**
    *   유의미한 변수들만 남기고, 영향력이 없는 변수는 코드에서 삭제하거나 무력화 상태로 둡니다.

---

## 4. 현재 파일(`Condition_Tick_902_905_update_2`) 분석 및 개선안

### 4.1 문제점 진단
*   **과도한 제약 (Over-constrained)**: 가격, 거래량, 각도, 갭 비율 등 너무 많은 조건이 동시에 타이트하게 설정되어 있어 진입 기회 자체가 차단되고 있습니다.
*   **중복 조건**: `시가등락율`, `시가대비등락율`, `등락율`이 동시에 적용되면 교집합이 매우 작아집니다.
*   **각도 지표의 후행성**: `당일거래대금각도(30)` 등은 30틱 간의 변화를 보므로, 급등주에서는 이미 늦은 신호일 수 있습니다.

### 4.2 개선 제안 (Action Plan)
`BOR` (매수 최적화 범위) 섹션을 수정하여 **조건 무력화**를 적용해 보십시오.

**연구용 BOR 설정 예시**:
```python
# 1. 등락율/시가등락율 상한 제한 해제 (무력화)
self.vars[1] = [[29.0], 29.0]  # 등락율 상한 무력화
self.vars[3] = [[29.0], 29.0]  # 시가등락율 상한 무력화

# 2. 각도 조건 무력화 (일단 양수면 통과)
self.vars[7] = [[0], 0]        # 당일거래대금각도 하한 0으로 완화

# 3. 핵심 변수(체결강도, 거래대금)만 집중 최적화
self.vars[10] = [[50, 150, 10], 100] # 체결강도 정밀 탐색
self.vars[8] = [[1.5, 5.0, 0.5], 3.0] # 거래대금 급증 비율 탐색
```

위와 같이 설정 후 백테스팅을 수행하여, 어떤 조건이 수익을 방해하고 있었는지 파악하시기 바랍니다.

---
**작성자**: Antigravity (Google Deepmind Team)
**작성일**: 2025-11-29
