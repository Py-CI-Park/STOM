# 강화된 백테스팅 분석 시스템 종합 연구 보고서

## 문서 정보
- **작성일**: 2026-01-06
- **분석 기간**: 커밋 `12d4a1226fe9d075c6d81e1752b0a398d0553f6f` ~ 현재 (`865faed6`)
- **분석 대상**: 백테스트 결과 강화 분석 및 세그먼트 필터 시스템
- **상태**: 🔴 **심각한 버그 발견** - 세그먼트 필터 조건식 적용 시 예측값과 실제값 불일치

---

## 1. 시스템 개요

### 1.1 목적
STOM 백테스팅 시스템의 결과 분석을 강화하여:
1. **통계적 유의성 검증**: t-test, Cohen's d 효과 크기, 95% 신뢰구간
2. **세그먼트 필터링**: 시가총액×시간대별 세분화된 필터 최적화
3. **조건식 자동 생성**: 분석 결과를 즉시 적용 가능한 매수 조건식으로 변환
4. **예측-실제 일치**: 분석 예측값과 실제 백테스트 결과의 정확한 일치

### 1.2 핵심 철학
```
백테스트 → 세그먼트 필터링 → 최적 조합 → 조건식 생성 → **직접 적용**
```
사용자는 생성된 조건식을 **그대로** 사용하여 예측된 성과를 달성해야 함.

---

## 2. 코드 변경 분석 (Git Diff)

### 2.1 변경 통계
- **변경된 파일**: 118개
- **추가된 라인**: ~36,264
- **삭제된 라인**: ~632

### 2.2 주요 커밋 히스토리

| 커밋 | 설명 | 중요도 |
|------|------|--------|
| `865faed6` | 출력 파일 번호 체계 재정비 | 🟢 |
| `60b7fe7a` | 세그먼트 런타임 매핑 개선 | 🟡 |
| `d14855a5` | 세그먼트 필터 파이프라인 리팩토링 | 🟡 |
| `26ff3040` | **세그먼트 필터 버그 수정: 예측값=실제값** | 🔴 핵심 |
| `174adac6` | if → elif 논리 수정 | 🟡 |
| `b83d5a03` | locals() 제거 | 🟡 |
| `2ba19c06` | 런타임 매핑 함수 체크 버그 수정 | 🟡 |
| `4c1be61d` | 최상위 템플릿 segment_code 사용 | 🟡 |
| `38555c4a` | 시가총액 4구간 자동 동적 분할 | 🟡 |

---

## 3. 시스템 아키텍처

### 3.1 파이프라인 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        백테스트 실행 (PltShow)                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Phase 1: 기본 분석                                                       │
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│ │ GetResultDataframe│→│ AddMdd          │→│ CalculateDerived│           │
│ │                  │  │                  │  │ Metrics         │           │
│ └─────────────────┘  └─────────────────┘  └─────────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Phase 2: 강화 분석 (RunEnhancedAnalysis)                                 │
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│ │ Enhanced        │→│ ML 위험도       │→│ Filter Effects  │           │
│ │ DerivedMetrics  │  │ Prediction      │  │ Enhanced        │           │
│ └─────────────────┘  └─────────────────┘  └─────────────────┘           │
│          │                                                               │
│          ▼                                                               │
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│ │ Optimal         │→│ Filter          │→│ Filter          │           │
│ │ Thresholds      │  │ Combinations    │  │ Stability       │           │
│ └─────────────────┘  └─────────────────┘  └─────────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Phase 3: 세그먼트 분석                                                   │
│ ┌─────────────────────────────────────────────────────────────────┐     │
│ │ run_phase2() - 기본 세그먼트 분석                                 │     │
│ │ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │     │
│ │ │ Segment     │→│ Filter      │→│ Local       │               │     │
│ │ │ Builder     │  │ Evaluator   │  │ Combinations│               │     │
│ │ └─────────────┘  └─────────────┘  └─────────────┘               │     │
│ │         │                                                       │     │
│ │         ▼                                                       │     │
│ │ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │     │
│ │ │ Global      │→│ ranges.csv  │→│ combos.csv  │               │     │
│ │ │ Combination │  │ (경계값 저장)│  │ (예측 저장) │               │     │
│ │ └─────────────┘  └─────────────┘  └─────────────┘               │     │
│ └─────────────────────────────────────────────────────────────────┘     │
│                              │                                           │
│                              ▼                                           │
│ ┌─────────────────────────────────────────────────────────────────┐     │
│ │ run_segment_template_comparison() - 템플릿 비교                   │     │
│ │ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │     │
│ │ │ T3C3_time3  │  │ T4C3_base   │  │ T5C3_time5  │               │     │
│ │ │ fixed/dyn   │  │ fixed       │  │ fixed/dyn   │               │     │
│ │ └─────────────┘  └─────────────┘  └─────────────┘               │     │
│ │         │                │                │                     │     │
│ │         └────────────────┼────────────────┘                     │     │
│ │                          ▼                                       │     │
│ │                 ┌─────────────────┐                              │     │
│ │                 │ 최상위 템플릿   │                              │     │
│ │                 │ (score 기준)    │                              │     │
│ │                 └─────────────────┘                              │     │
│ └─────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Phase 4: 최종 조건식 생성                                                │
│ ┌─────────────────────────────────────────────────────────────────┐     │
│ │ _resolve_best_template_segment_code()                            │     │
│ │ - 최상위 템플릿의 segment_code_path 결정                          │     │
│ │ - global_best['ranges_path'] 로드 → fixed 모드                   │     │
│ └─────────────────────────────────────────────────────────────────┘     │
│                              │                                           │
│                              ▼                                           │
│ ┌─────────────────────────────────────────────────────────────────┐     │
│ │ build_segment_final_code()                                       │     │
│ │ ┌─────────────────┐                                              │     │
│ │ │ 매수 조건식     │ + 세그먼트 필터 → segment_code_final.txt      │     │
│ │ │ (원본)          │   (런타임 매핑)                               │     │
│ │ └─────────────────┘                                              │     │
│ └─────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ Phase 5: 검증                                                           │
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │
│ │ build_segment   │→│ segment_        │→│ segment_        │           │
│ │ _mask_from      │  │ verification    │  │ filtered.png    │           │
│ │ _global_best    │  │ .csv            │  │                  │           │
│ └─────────────────┘  └─────────────────┘  └─────────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 주요 모듈 구조

```
backtester/
├── back_static.py                    # 핵심 API (PltShow 등)
│   ├── _load_segment_config_from_ranges()  # [NEW] ranges.csv 로드
│   └── _build_segment_mask_from_global_best()  # 필터 마스크 생성
│
├── analysis/                         # 기본 분석 모듈
│   ├── plotting.py                   # 차트 생성
│   ├── metrics_base.py               # 파생 지표 계산
│   ├── exports.py                    # CSV 출력
│   └── results.py                    # 결과 DataFrame
│
├── analysis_enhanced/                # 강화 분석 모듈
│   ├── runner.py                     # 강화 분석 오케스트레이터
│   │   ├── RunEnhancedAnalysis()     # 메인 함수
│   │   └── _resolve_best_template_segment_code()  # 최상위 템플릿 결정
│   ├── metrics_enhanced.py           # 강화 파생 지표
│   ├── filters.py                    # 필터 분석
│   ├── ml.py                         # ML 예측
│   └── plotting.py                   # 강화 차트
│
└── segment_analysis/                 # 세그먼트 분석 모듈
    ├── phase2_runner.py              # Phase 2 실행
    │   └── global_best['ranges_path'] = ranges_path  # [FIX] 경계값 저장
    ├── phase3_runner.py              # Phase 3 (히트맵/검증)
    ├── segment_apply.py              # 필터 적용
    │   ├── load_segment_config_from_ranges()  # ranges.csv 로드
    │   └── build_segment_mask_from_global_best()  # 마스크 생성
    ├── code_generator.py             # 조건식 코드 생성
    │   ├── build_segment_filter_code()  # 세그먼트 필터 코드
    │   ├── build_segment_final_code()   # 최종 조건식
    │   └── save_segment_code_final()    # 파일 저장
    └── segmentation.py               # 세그먼트 빌더
```

---

## 4. 신규 변수 및 파생 지표

### 4.1 매수 시점 변수 (Runtime Mapping)

| 변수명 | 공식 | 용도 |
|--------|------|------|
| `매수시` | `시분초 // 10000` | 시간대 필터 |
| `매수분` | `(시분초 // 100) % 100` | 분 단위 필터 |
| `매수초` | `시분초 % 100` | 초 단위 필터 |
| `매수시간` | `시분초` | 전체 시간 |
| `매수등락율` | `등락율` | 스냅샷 |
| `매수시가등락율` | `시가등락율` | 스냅샷 |
| `매수체결강도` | `체결강도` | 스냅샷 |
| `매수호가잔량비` | `(매수총잔량 / 매도총잔량) * 100` | 수급 지표 |
| `매수스프레드` | `((매도호가1 - 매수호가1) / 매수호가1) * 100` | 유동성 지표 |
| `매수변동폭` | `고가 - 저가` | 변동성 |
| `매수변동폭비율` | `((고가 - 저가) / 저가) * 100` | 변동성 비율 |

### 4.2 파생 지표 (강화 분석)

| 지표명 | 범위 | 공식 | 용도 |
|--------|------|------|------|
| 거래품질점수 | 0-100 | 체결강도, 호가잔량비, 시가총액 종합 | 거래 품질 평가 |
| 위험도점수 | 0-100 | 등락율 급변, 체결강도 하락 등 | 리스크 평가 |
| 모멘텀점수 | -30~+30 | 등락율 × 체결강도 | 추세 강도 |
| 초당매수수량 | 수량 | 분당매수수량 / 60 | 유동성 |
| 초당매도_매수_비율 | 배율 | 초당매도수량 / 초당매수수량 | 수급 불균형 |
| 현재가_고저범위_위치 | 0-100% | (현재가 - 저가) / (고가 - 저가) | 가격 위치 |
| 당일거래대금_전틱분봉_비율 | 배율 | 현재 / 이전 당일거래대금 | 거래량 추세 |

---

## 5. 핵심 버그 수정 이력

### 5.1 예측값-실제값 불일치 버그 (커밋 `26ff3040`)

**문제**:
```
분석 예측: +1,091M원 (1,372건, 27.07% 잔여)
실제 적용: 다른 결과
```

**원인**:
- 세그먼트 분석 시 동적(quantile) 분할로 경계 계산: 대형주 ≥ 6,432억
- 필터 적용 시 `SegmentBuilder()` 새로 생성 → 경계 **재계산**
- 다른 데이터셋으로 다른 경계 생성

**해결**:
```python
# phase2_runner.py:94-98
if global_best and isinstance(global_best, dict):
    global_best['ranges_path'] = ranges_path  # 경계값 저장

# segment_apply.py:83-84
seg_config = load_segment_config_from_ranges(global_best)  # 저장된 경계 로드
builder = SegmentBuilder(seg_config)  # fixed 모드로 생성
```

### 5.2 if/elif 논리 버그 (커밋 `174adac6`)

**문제**:
```python
# 기존 (잘못됨)
if (시가총액 >= 6432 and 시분초 >= 92900 and 시분초 < 95900):
    ...
if (시가총액 >= 6432 and 시분초 >= 95900 and 시분초 < 102900):  # 중복 체크!
    ...
```

**해결**:
```python
# 수정 후 (올바름)
if (시가총액 >= 6432 and 시분초 >= 92900 and 시분초 < 95900):
    ...
elif (시가총액 >= 6432 and 시분초 >= 95900 and 시분초 < 102900):
    ...
```

### 5.3 locals() 제거 (커밋 `b83d5a03`)

**문제**:
- `locals()` 사용 시 동적 변수 정의가 인식되지 않음
- 세그먼트 필터 조건에서 NameError 발생

**해결**:
- try/except로 개별 변수 존재 여부 확인
- 명시적 변수 매핑

---

## 6. 현재 발견된 심각한 버그 🔴

### 6.1 문제 상황

**원본 백테스트** (`stock_bt_Min_B_Study_251227_20260105235820`):
- 거래 수: 5,087건
- 총 수익금: -997,550,667원
- 세그먼트 검증 (segment_verification.csv):
  - remaining_trades: 1,372건 (27.07%)
  - improvement: +1,093,809,575원
  - expected_improvement: +1,091,124,351원
  - **내부 검증은 일치!** ✅

**필터 적용 백테스트** (`stock_bt_Min_B_Study_251227_Filter_20260106000209`):
- 거래 수: **2,885건** (예상: 1,372건)
- 총 수익금: **-292,233,394원** (예상: +96,258,908원)
- **완전히 다른 결과!** ❌

### 6.2 원인 분석

#### 6.2.1 내부 검증 vs 실제 적용의 차이

```
                    내부 검증                      실제 적용
                    (runner.py)                  (backtest.py)
                        │                             │
    detail.csv ────────▶│ build_segment_mask         │◀──── 실시간 데이터
    (완료된 거래)        │ _from_global_best()        │      (매수 시점)
                        │                             │
                        │ 매수시, 매수분, 시가총액    │      시분초, 등락율
                        │ 컬럼이 이미 존재            │      변수를 런타임 계산
                        │                             │
                        ▼                             ▼
                  1,372건 통과                   2,885건 통과
                  (정확함)                       (다름!)
```

#### 6.2.2 핵심 문제: 변수 매핑 불일치

**segment_code_final.txt 조건**:
```python
# 런타임 매핑
매수분 = (_t // 100) % 100  # _t = 시분초

# 세그먼트 필터
if (시가총액 >= 6432 and 시분초 >= 92900 and 시분초 < 95900):
    if ((매수매도총잔량 >= 9436.4) and (매수스프레드 < 0.332) ...):
        필터통과 = True
```

**문제점**:
1. `매수매도총잔량`은 detail.csv에서 `매도총잔량`(매수 시점 스냅샷)
2. 하지만 실시간 백테스트에서는 `매도총잔량` 변수명으로 접근
3. 변수명 불일치로 조건 평가 실패

#### 6.2.3 시간 조건 문제

**detail.csv 컬럼**:
- `매수시`: 9, 10, 11 (시 단위)
- `매수분`: 0-59 (분 단위)

**segment_code_final.txt**:
- `시분초`: 92900, 102900, ... (HHMMSS 형식)

**문제**: 조건이 `시분초 >= 92900`로 되어 있지만, 실제 백테스트에서:
- `시분초` 변수가 다른 형식일 수 있음
- 또는 존재하지 않을 수 있음

---

## 7. 해결 방안

### 7.1 변수 매핑 테이블 정비

| detail.csv 컬럼 | 실시간 변수 | 매핑 필요 |
|-----------------|-------------|-----------|
| 시가총액 | 시가총액 | ✅ 동일 |
| 매수시 | 시분초 // 10000 | ⚠️ 계산 필요 |
| 매수분 | (시분초 // 100) % 100 | ⚠️ 계산 필요 |
| 매수매도총잔량 | 매도총잔량 | ❌ 이름 다름 |
| 매수스프레드 | (계산) | ⚠️ 계산 필요 |
| 매수호가잔량비 | (계산) | ⚠️ 계산 필요 |

### 7.2 수정 필요 사항

1. **code_generator.py**: 런타임 매핑 코드 수정
   - `매수매도총잔량` → `매도총잔량`
   - `매수스프레드` → 실시간 계산식

2. **segment_code_final.txt 생성 시**:
   - 변수명을 실시간 백테스트에서 사용하는 이름으로 변환
   - 또는 모든 필요 변수를 런타임에서 계산하는 코드 추가

3. **검증 프로세스 강화**:
   - segment_code_final.txt 생성 후 syntax 검증
   - 사용된 변수 목록과 실제 사용 가능 변수 비교

---

## 8. 출력 파일 구조

### 8.1 번호 체계

| 접두사 | 카테고리 | 예시 |
|--------|----------|------|
| 0-x | 메타데이터 | manifest.json, report.txt |
| 1-x | 기본 분석 | summary.csv, detail.csv, .png |
| 2-x | 강화 분석 | filter.csv, enhanced.png |
| 3-x | 세그먼트 분석 | segment_*.csv, segment_*.txt |

### 8.2 주요 파일

| 파일명 | 용도 |
|--------|------|
| `*_segment_combos.csv` | 전역 최적 조합 (예측값) |
| `*_segment_ranges.csv` | 세그먼트 경계값 |
| `*_segment_code.txt` | 세그먼트 필터 조건식 |
| `*_segment_code_final.txt` | 최종 적용용 조건식 |
| `*_segment_verification.csv` | 검증 결과 |
| `*_segment_filtered.png` | 필터 적용 미리보기 차트 |

---

## 9. 성능 개선 사항

### 9.1 속도 최적화

| 항목 | 이전 | 이후 | 개선 |
|------|------|------|------|
| CSV 청크 저장 | 미지원 | 지원 | 메모리 효율 |
| 병렬 플로팅 | 순차 | 멀티프로세스 | ~30% 단축 |
| 캐시 활용 | 미사용 | LRU 캐시 | 반복 계산 제거 |

### 9.2 출력 개선

| 항목 | 설명 |
|------|------|
| 매니페스트 | 모든 출력 파일 목록/설명 JSON |
| 리포트 | 성과 요약 및 추천 TXT |
| 스터디 노트 | 조건식/필터 분석 MD |

---

## 10. 결론 및 권장 사항

### 10.1 현재 상태
- ✅ 내부 검증 (segment_verification.csv)은 정확함
- ❌ 실제 백테스트 적용 시 결과 불일치
- 🔴 **segment_code_final.txt의 변수 매핑 문제**

### 10.2 즉시 수정 필요
1. `code_generator.py`의 런타임 변수 매핑 수정
2. 변수명 일관성 확보 (detail.csv ↔ 실시간)
3. 검증 프로세스에 실제 적용 테스트 추가

### 10.3 장기 개선
1. 변수 매핑 테이블 중앙화
2. 조건식 자동 검증 도구
3. 실시간 백테스트와 분석의 변수 스키마 통합

---

## 부록 A: 참고 파일 위치

- `backtester/back_static.py`: 핵심 API
- `backtester/analysis_enhanced/runner.py`: 강화 분석
- `backtester/segment_analysis/code_generator.py`: 조건식 생성
- `backtester/segment_analysis/segment_apply.py`: 필터 적용
- `docs/Study/segment_filter_verification_issue.md`: 이전 검증 이슈

## 부록 B: 테스트 데이터

- 원본: `stock_bt_Min_B_Study_251227_20260105235820`
- 필터 적용: `stock_bt_Min_B_Study_251227_Filter_20260106000209`
