# 위험도점수(Risk Score) 개선 연구 보고서

> **버전**: 1.0.0  
> **작성일**: 2026-01-07  
> **작성자**: AI 어시스턴트 (Sisyphus)  
> **목적**: 백테스팅 필터에 가장 영향을 많이 주는 위험도점수 계산 방법의 개선 연구

---

## 목차

1. [연구 개요](#1-연구-개요)
2. [현재 위험도점수 계산 로직 분석](#2-현재-위험도점수-계산-로직-분석)
3. [필터 효과 데이터 분석](#3-필터-효과-데이터-분석)
4. [문제점 식별](#4-문제점-식별)
5. [개선 방안 연구](#5-개선-방안-연구)
6. [구현 계획](#6-구현-계획)
7. [코드 예시](#7-코드-예시)
8. [기대 효과 및 검증 방법](#8-기대-효과-및-검증-방법)
9. [결론 및 권장사항](#9-결론-및-권장사항)

---

## 1. 연구 개요

### 1.1 연구 배경

STOM V1 백테스팅 시스템에서 **위험도점수**는 매수 시점의 종합적인 위험 수준을 0~100 점수로 계량화하는 핵심 파생 변수입니다. 이 점수는:

- 매수 진입 필터로 사용 가능 (룩어헤드 없음)
- 8개의 원본 변수를 조합하여 산출
- 복합 점수 방식으로 여러 위험 요소를 통합

### 1.2 연구 목적

1. **현재 계산 로직의 효과성 검증**
2. **개별 구성 변수 vs 복합 점수의 필터 성능 비교**
3. **개선 방안 도출** (세분화, 단순화, 새로운 접근법)
4. **구체적인 구현 계획 및 코드 제안**

### 1.3 관련 파일

| 파일 | 역할 |
|------|------|
| `backtester/analysis_enhanced/metrics_enhanced.py` | 위험도점수 계산 로직 (Line 170-232) |
| `backtester/variable_registry.py` | 변수 정의 및 메타데이터 |
| `backtester/analysis_enhanced/filters.py` | 필터 후보 판단 및 분석 |
| `backtester/analysis/metric_registry.py` | 필터 후보 컬럼 목록 |

---

## 2. 현재 위험도점수 계산 로직 분석

### 2.1 계산 구조

현재 위험도점수는 **8개의 위험 요소**를 가산 방식으로 합산합니다.

```
위험도점수 = Σ(개별 위험 요소) → clip(0, 100)
```

### 2.2 상세 계산식

| # | 위험 요소 | 원본 변수 | 조건 | 가중치 | 최대 기여 |
|:-:|----------|----------|------|:------:|:---------:|
| 1 | **과열 위험** | 매수등락율 | ≥20% | +20 | |
|   |              |           | ≥25% | +10 | |
|   |              |           | ≥30% | +10 | **40점** |
| 2 | **체결강도 위험** | 매수체결강도 | <80 | +15 | |
|   |                 |             | <60 | +10 | |
|   |                 |             | ≥150 | +10 | |
|   |                 |             | ≥200 | +10 | |
|   |                 |             | ≥250 | +10 | **55점** |
| 3 | **유동성 위험** | 매수당일거래대금 | <50억 | +15 | |
|   |               |                 | <100억 | +10 | **25점** |
| 4 | **소형주 위험** | 시가총액 | <1,000억 | +15 | |
|   |               |         | <5,000억 | +10 | **25점** |
| 5 | **호가 불균형** | 매수호가잔량비 | <90 | +10 | |
|   |               |               | <70 | +15 | **25점** |
| 6 | **슬리피지 위험** | 매수스프레드 | ≥0.5% | +10 | |
|   |                 |             | ≥1.0% | +10 | **20점** |
| 7 | **회전율 위험** | 매수회전율 | <10 | +5 | |
|   |               |           | <5 | +10 | **15점** |
| 8 | **변동성 위험** | 매수변동폭비율 | ≥7.5% | +10 | |
|   |               |               | ≥10% | +10 | |
|   |               |               | ≥15% | +10 | **30점** |

**이론적 최대 합계**: 235점 → **clip(0, 100)**으로 제한

### 2.3 현재 로직의 특징

#### 장점
- ✅ **룩어헤드 없음**: 매수 시점 데이터만 사용
- ✅ **해석 용이성**: 각 구성 요소가 명확
- ✅ **타임프레임 중립**: 틱/분봉 데이터에서 동일 결과

#### 단점
- ❌ **가중치 임의성**: 경험적 설정, 데이터 기반 최적화 없음
- ❌ **임계값 고정**: 시장 상황에 따른 동적 조정 불가
- ❌ **구성 요소 간 상호작용 미고려**: 단순 가산 방식
- ❌ **거래품질점수와 중복**: 일부 변수 중복 사용

---

## 3. 필터 효과 데이터 분석

### 3.1 위험도점수 필터 효과

최근 백테스팅 결과(`stock_bt_Min_B_Study_251227`)에서 위험도점수의 필터 효과:

| 필터 조건 | 수익개선금액 | 제외비율 | 잔여비율 | 효과 해석 |
|----------|:-----------:|:-------:|:-------:|----------|
| **위험도점수 65점 미만 제외** | +696M원 | 78.8% | 21.2% | 고위험 거래만 남김 |
| **위험도점수 80점 이상 제외** | +123M원 | 6.2% | 93.8% | 극고위험만 제외 |

### 3.2 관련 개별 변수 필터 효과 (Top 20)

| 순위 | 필터 | 수익개선금액 | 제외비율 | 분류 |
|:---:|------|:-----------:|:-------:|:---:|
| 1 | 모멘텀점수 7.61 미만 제외 | +796M원 | 76.0% | 모멘텀 |
| 2 | 매수매수총잔량 53,282 미만 제외 | +763M원 | 76.1% | 호가 |
| 3 | 모멘텀점수 2.63 이상 제외 | +758M원 | 71.3% | 모멘텀 |
| 4 | 매수저가 4,200 이상 제외 | +711M원 | 76.1% | 기타 |
| 5 | **위험도점수 65점 미만 제외** | +696M원 | 78.8% | **위험신호** |
| 6 | 매수체결강도 92.78 이상 제외 | +682M원 | 76.1% | 체결강도 |
| 7 | 매수초당매도수량 596 미만 제외 | +682M원 | 76.0% | 초당 |
| 8 | 매수회전율 26.93 미만 제외 | +646M원 | 76.0% | 회전율 |
| 9 | 매수매도총잔량 46,273 미만 제외 | +631M원 | 61.8% | 호가 |
| 10 | 매수변동폭비율 18.39 미만 제외 | +614M원 | 76.1% | 기타 |
| ... | ... | ... | ... | ... |
| 17 | **거래품질점수 70점 이상 제외** | +328M원 | 43.2% | **품질** |
| 26 | **거래품질점수 51점 미만 제외** | +219M원 | 14.5% | **품질** |

### 3.3 핵심 발견사항

#### 3.3.1 복합 점수 vs 개별 변수

```
┌─────────────────────────────────────────────────────────────────┐
│                    필터 효과 비교 분석                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [개별 변수 필터]                [복합 점수 필터]                 │
│   모멘텀점수 < 7.61: +796M원     위험도점수 < 65: +696M원         │
│   매수체결강도 >= 92.78: +682M원 위험도점수 >= 80: +123M원        │
│   매수회전율 < 26.93: +646M원    거래품질점수 >= 70: +328M원      │
│                                                                 │
│  → 개별 변수 필터가 복합 점수보다 더 높은 수익개선 가능!          │
│  → 복합 점수의 가중치/임계값 최적화 필요성 확인                   │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 위험도점수 구성 변수의 개별 성과

| 구성 변수 | 위험도점수 기여 | 개별 필터 효과 | 평가 |
|----------|:-------------:|:-------------:|:----:|
| 매수등락율 | max 40점 | +90M원 (등락율 18.81 이상 제외) | ⚠️ 낮음 |
| 매수체결강도 | max 55점 | +682M원 (체결강도 92.78 이상) | ✅ 높음 |
| 매수당일거래대금 | max 25점 | +587M원 (316억 미만 제외) | ✅ 높음 |
| 시가총액 | max 25점 | +509M원 (1,309억 이상 제외) | ✅ 높음 |
| 매수호가잔량비 | max 25점 | (직접 필터 없음) | ❓ 미확인 |
| 매수스프레드 | max 20점 | +250M원 (0.24 이상 제외) | ⚠️ 중간 |
| 매수회전율 | max 15점 | +646M원 (26.93 미만 제외) | ✅ 높음 |
| 매수변동폭비율 | max 30점 | +614M원 (18.39 미만 제외) | ✅ 높음 |

**핵심 인사이트**: 
- **매수등락율**의 기여도(max 40점)가 실제 필터 효과(+90M원)에 비해 과대
- **매수회전율**의 기여도(max 15점)가 실제 필터 효과(+646M원)에 비해 과소

---

## 4. 문제점 식별

### 4.1 가중치 불균형

현재 가중치 배분이 실제 필터 효과와 불일치:

```
┌────────────────────────────────────────────────────────────────┐
│              가중치 vs 실제 효과 불일치 분석                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  변수              현재 가중치   실제 필터 효과   불일치 정도     │
│  ─────────────────────────────────────────────────────────────│
│  매수등락율          40점        +90M원          ⚠️ 과대평가     │
│  매수체결강도        55점        +682M원         ✅ 적정         │
│  매수회전율          15점        +646M원         🔴 과소평가     │
│  매수변동폭비율      30점        +614M원         ⚠️ 과소평가     │
│  매수당일거래대금    25점        +587M원         ⚠️ 과소평가     │
│  시가총액            25점        +509M원         ⚠️ 과소평가     │
│  매수스프레드        20점        +250M원         ✅ 적정         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 4.2 임계값 최적화 부재

현재 임계값은 도메인 지식 기반이지만, 데이터 기반 최적화가 필요:

| 변수 | 현재 임계값 | 최적 필터 임계값 (데이터 기반) | 개선 필요 |
|------|-----------|---------------------------|:---------:|
| 매수등락율 | 20%, 25%, 30% | 18.81% | ⚠️ 하향 조정 |
| 매수체결강도 | 60, 80, 150, 200, 250 | 92.78 (상한) | ⚠️ 재설계 |
| 매수당일거래대금 | 50억, 100억 | 316억 | 🔴 상향 조정 |
| 매수회전율 | 5, 10 | 26.93 | 🔴 상향 조정 |
| 매수변동폭비율 | 7.5%, 10%, 15% | 18.39% | ⚠️ 상향 조정 |

### 4.3 거래품질점수와의 중복

두 점수가 유사한 변수를 사용하여 중복 계산:

| 공통 사용 변수 | 위험도점수 | 거래품질점수 |
|---------------|:----------:|:------------:|
| 매수체결강도 | ✅ | ✅ |
| 매수호가잔량비 | ✅ | ✅ |
| 시가총액 | ✅ | ✅ |
| 매수등락율 | ✅ | ✅ |
| 매수스프레드 | ✅ | ✅ |

**문제**: 필터 분석 시 두 점수가 유사한 거래를 제외하여 **시너지 효과 감소**

### 4.4 정적 임계값의 한계

시장 상황(변동성, 유동성)에 따라 "위험"의 정의가 달라져야 하나, 현재는 고정:

```
예시: 급등장 vs 횡보장
├── 급등장: 등락율 20%가 흔함 → 임계값 상향 필요
└── 횡보장: 등락율 10%도 높음 → 임계값 하향 필요
```

---

## 5. 개선 방안 연구

### 5.1 개선 방향 개요

| # | 개선 방향 | 복잡도 | 기대 효과 | 우선순위 |
|:-:|----------|:------:|:--------:|:--------:|
| A | 가중치 최적화 | 낮음 | ⭐⭐⭐ | 🔴 긴급 |
| B | 임계값 동적화 | 중간 | ⭐⭐⭐⭐ | 🟠 높음 |
| C | 구성 요소 재설계 | 중간 | ⭐⭐⭐⭐ | 🟠 높음 |
| D | 세그먼트별 분리 | 높음 | ⭐⭐⭐⭐⭐ | 🟡 중간 |
| E | ML 기반 점수화 | 높음 | ⭐⭐⭐⭐⭐ | 🟢 장기 |
| F | 단순화 버전 | 낮음 | ⭐⭐⭐ | 🔴 긴급 |

---

### 5.2 방안 A: 가중치 최적화 (긴급)

#### 5.2.1 현재 vs 제안 가중치

```python
# 현재 가중치 (이론적 최대 235점)
CURRENT_WEIGHTS = {
    '매수등락율': 40,      # 과대평가
    '매수체결강도': 55,    # 적정
    '매수당일거래대금': 25, # 과소평가
    '시가총액': 25,        # 과소평가
    '매수호가잔량비': 25,  # 미확인
    '매수스프레드': 20,    # 적정
    '매수회전율': 15,      # 과소평가
    '매수변동폭비율': 30,  # 과소평가
}

# 제안 가중치 (필터 효과 기반 조정, 최대 200점)
PROPOSED_WEIGHTS_V1 = {
    '매수등락율': 15,       # 40 → 15 (과열 위험 축소)
    '매수체결강도': 40,     # 55 → 40 (적정 유지)
    '매수당일거래대금': 30, # 25 → 30 (유동성 강조)
    '시가총액': 25,         # 25 → 25 (유지)
    '매수호가잔량비': 20,   # 25 → 20 (약간 감소)
    '매수스프레드': 15,     # 20 → 15 (약간 감소)
    '매수회전율': 30,       # 15 → 30 (대폭 증가!)
    '매수변동폭비율': 25,   # 30 → 25 (약간 감소)
}
```

#### 5.2.2 가중치 조정 근거

| 변수 | 조정 | 근거 |
|------|:----:|------|
| 매수등락율 | 40→15 | 필터 효과 +90M원으로 실제 영향 낮음 |
| 매수회전율 | 15→30 | 필터 효과 +646M원으로 실제 영향 높음 |
| 매수당일거래대금 | 25→30 | 필터 효과 +587M원, 유동성 중요도 반영 |

---

### 5.3 방안 B: 임계값 동적화

#### 5.3.1 백분위 기반 동적 임계값

```python
def calculate_dynamic_risk_score(df, config=None):
    """
    동적 임계값 기반 위험도점수 계산
    
    Args:
        df: 백테스팅 데이터
        config: 임계값 설정 (None이면 자동 계산)
    """
    if config is None:
        # 데이터 기반 백분위 임계값 계산
        config = {
            '매수등락율': {
                'high': df['매수등락율'].quantile(0.95),   # 상위 5%
                'medium': df['매수등락율'].quantile(0.80), # 상위 20%
            },
            '매수체결강도': {
                'weak_low': df['매수체결강도'].quantile(0.20),  # 하위 20%
                'weak_mid': df['매수체결강도'].quantile(0.10),  # 하위 10%
                'overheat': df['매수체결강도'].quantile(0.90),  # 상위 10%
            },
            '매수당일거래대금': {
                'low': df['매수당일거래대금'].quantile(0.20),   # 하위 20%
                'very_low': df['매수당일거래대금'].quantile(0.10), # 하위 10%
            },
            # ... 기타 변수
        }
    
    # 동적 임계값 기반 점수 계산
    score = pd.Series(0, index=df.index)
    
    # 매수등락율 위험
    score += (df['매수등락율'] >= config['매수등락율']['medium']) * 10
    score += (df['매수등락율'] >= config['매수등락율']['high']) * 5
    
    # ... 기타 계산
    
    return score.clip(0, 100)
```

#### 5.3.2 현재 vs 동적 임계값 비교

| 변수 | 현재 임계값 | 동적 임계값 (예시) | 방식 |
|------|-----------|------------------|------|
| 매수등락율 | 20%, 25%, 30% | P80, P95 | 상위 백분위 |
| 매수당일거래대금 | 50억, 100억 | P10, P20 | 하위 백분위 |
| 매수회전율 | 5, 10 | P10, P20 | 하위 백분위 |
| 매수스프레드 | 0.5%, 1.0% | P80, P95 | 상위 백분위 |

---

### 5.4 방안 C: 구성 요소 재설계

#### 5.4.1 3-Tier 위험도 체계

현재 8개 구성 요소를 **3개의 위험 카테고리**로 재구성:

```
┌─────────────────────────────────────────────────────────────────┐
│                    3-Tier 위험도 체계                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Tier 1: 유동성 위험]  ←── 매수당일거래대금, 시가총액, 매수회전율  │
│   - 거래 체결 가능성                                             │
│   - 슬리피지 발생 가능성                                         │
│   - 가중치: 40%                                                 │
│                                                                 │
│  [Tier 2: 수급 위험]    ←── 매수체결강도, 매수호가잔량비, 스프레드  │
│   - 매수/매도 세력 균형                                          │
│   - 호가창 상태                                                  │
│   - 가중치: 35%                                                 │
│                                                                 │
│  [Tier 3: 과열 위험]    ←── 매수등락율, 매수변동폭비율            │
│   - 추격 매수 위험                                               │
│   - 변동성 위험                                                  │
│   - 가중치: 25%                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 5.4.2 Tier별 점수 계산

```python
def calculate_tiered_risk_score(df):
    """3-Tier 위험도점수 계산"""
    
    # Tier 1: 유동성 위험 (max 40점)
    tier1_score = 0
    
    # 거래대금 (억 단위)
    trade_money_eok = df['매수당일거래대금'] / 100
    tier1_score += (trade_money_eok < 50) * 15
    tier1_score += (trade_money_eok < 100) * 5
    
    # 시가총액
    tier1_score += (df['시가총액'] < 1000) * 10
    tier1_score += (df['시가총액'] < 3000) * 5
    
    # 회전율
    tier1_score += (df['매수회전율'] < 15) * 10
    tier1_score += (df['매수회전율'] < 30) * 5
    
    tier1_score = tier1_score.clip(0, 40)
    
    # Tier 2: 수급 위험 (max 35점)
    tier2_score = 0
    
    # 체결강도
    tier2_score += (df['매수체결강도'] < 80) * 10
    tier2_score += (df['매수체결강도'] < 60) * 5
    tier2_score += (df['매수체결강도'] >= 180) * 10
    
    # 호가잔량비
    tier2_score += (df['매수호가잔량비'] < 85) * 10
    
    # 스프레드
    tier2_score += (df['매수스프레드'] >= 0.3) * 5
    tier2_score += (df['매수스프레드'] >= 0.6) * 5
    
    tier2_score = tier2_score.clip(0, 35)
    
    # Tier 3: 과열 위험 (max 25점)
    tier3_score = 0
    
    # 등락율
    tier3_score += (df['매수등락율'] >= 18) * 10
    tier3_score += (df['매수등락율'] >= 25) * 5
    
    # 변동폭비율
    tier3_score += (df['매수변동폭비율'] >= 15) * 10
    
    tier3_score = tier3_score.clip(0, 25)
    
    # 종합 점수
    total_score = tier1_score + tier2_score + tier3_score
    
    return total_score.clip(0, 100), {
        'tier1_유동성': tier1_score,
        'tier2_수급': tier2_score,
        'tier3_과열': tier3_score,
    }
```

---

### 5.5 방안 D: 세그먼트별 분리

#### 5.5.1 시간대별 위험도 조정

```python
# 시간대별 위험도 가중치 조정
TIME_SEGMENT_ADJUSTMENTS = {
    9: {  # 9시대: 장 시작 변동성 높음
        '매수등락율_weight': 0.8,      # 과열 위험 감소 (흔함)
        '매수체결강도_weight': 1.2,    # 체결강도 중요도 증가
        '매수변동폭비율_weight': 0.7,  # 변동성 흔함
    },
    10: { # 10시대: 상대적 안정
        '매수등락율_weight': 1.0,
        '매수체결강도_weight': 1.0,
        '매수변동폭비율_weight': 1.0,
    },
    11: { # 11시대: 점심 전 둔화
        '매수등락율_weight': 1.2,      # 과열 위험 증가
        '매수체결강도_weight': 0.9,
        '매수변동폭비율_weight': 1.1,
    },
    # ... 기타 시간대
}
```

#### 5.5.2 시가총액별 위험도 조정

```python
# 시가총액 세그먼트별 조정
MARKET_CAP_SEGMENT_ADJUSTMENTS = {
    'small': {    # < 1,000억
        '유동성_weight': 1.5,   # 유동성 위험 강조
        '과열_weight': 0.8,     # 과열 빈번
    },
    'medium': {   # 1,000억 ~ 5,000억
        '유동성_weight': 1.0,
        '과열_weight': 1.0,
    },
    'large': {    # > 5,000억
        '유동성_weight': 0.5,   # 유동성 충분
        '과열_weight': 1.2,     # 과열 시 위험
    },
}
```

---

### 5.6 방안 E: ML 기반 점수화 (장기)

#### 5.6.1 감독 학습 기반 위험도

```python
from sklearn.ensemble import GradientBoostingClassifier
import shap

def train_ml_risk_model(df_train):
    """
    ML 기반 위험도 모델 학습
    
    Target: 손실 거래 (수익금 < 0)
    Features: 매수 시점 변수들
    """
    # 특성 준비
    feature_cols = [
        '매수등락율', '매수체결강도', '매수당일거래대금', '시가총액',
        '매수호가잔량비', '매수스프레드', '매수회전율', '매수변동폭비율',
        '모멘텀점수', '매도잔량_매수잔량_비율'
    ]
    
    X = df_train[feature_cols].fillna(0)
    y = (df_train['수익금'] < 0).astype(int)  # 손실 = 1
    
    # 모델 학습
    model = GradientBoostingClassifier(
        n_estimators=100,
        max_depth=4,
        learning_rate=0.1,
        random_state=42
    )
    model.fit(X, y)
    
    # SHAP 기반 특성 중요도
    explainer = shap.TreeExplainer(model)
    shap_values = explainer.shap_values(X)
    
    return model, shap_values

def predict_risk_score(model, df):
    """ML 모델 기반 위험도 예측"""
    feature_cols = [...]  # 동일
    X = df[feature_cols].fillna(0)
    
    # 손실 확률을 0-100 점수로 변환
    loss_prob = model.predict_proba(X)[:, 1]
    risk_score = (loss_prob * 100).round(0).astype(int)
    
    return risk_score
```

#### 5.6.2 SHAP 기반 가중치 학습

```
┌─────────────────────────────────────────────────────────────────┐
│                SHAP Feature Importance (예시)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  매수회전율          ████████████████████████  0.23             │
│  매수체결강도        ██████████████████████    0.21             │
│  매수당일거래대금    ████████████████████      0.19             │
│  매수변동폭비율      ██████████████████        0.17             │
│  시가총액            ████████████              0.10             │
│  매수호가잔량비      ██████████                0.08             │
│  매수스프레드        ████████                  0.06             │
│  매수등락율          ██████                    0.05   ← 현재 과대평가! │
│                                                                 │
│  → ML 기반 가중치가 실제 손실 예측력을 더 잘 반영                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 5.7 방안 F: 단순화 버전 (긴급)

#### 5.7.1 핵심 4요소 위험도

8개 → **4개** 핵심 요소로 단순화:

```python
def calculate_simple_risk_score(df):
    """
    단순화된 위험도점수 (4요소)
    
    핵심 요소:
    1. 유동성: 매수당일거래대금 + 매수회전율
    2. 수급: 매수체결강도
    3. 규모: 시가총액
    4. 변동성: 매수변동폭비율
    """
    score = pd.Series(0, index=df.index)
    
    # 1. 유동성 위험 (max 35점)
    trade_money_eok = df['매수당일거래대금'] / 100
    score += (trade_money_eok < 100) * 15
    score += (trade_money_eok < 200) * 5
    score += (df['매수회전율'] < 20) * 10
    score += (df['매수회전율'] < 30) * 5
    
    # 2. 수급 위험 (max 30점)
    score += (df['매수체결강도'] < 75) * 15
    score += (df['매수체결강도'] >= 160) * 15
    
    # 3. 규모 위험 (max 20점)
    score += (df['시가총액'] < 1500) * 10
    score += (df['시가총액'] < 3000) * 10
    
    # 4. 변동성 위험 (max 15점)
    score += (df['매수변동폭비율'] >= 12) * 10
    score += (df['매수변동폭비율'] >= 20) * 5
    
    return score.clip(0, 100)
```

#### 5.7.2 단순화 근거

| 제외 요소 | 제외 근거 |
|----------|----------|
| 매수등락율 | 필터 효과 낮음 (+90M원), 변동폭비율과 상관 |
| 매수호가잔량비 | 체결강도와 높은 상관관계 |
| 매수스프레드 | 거래대금과 상관관계, 독립적 효과 낮음 |
| (시가총액 유지) | 독립적인 규모 리스크 |

---

## 6. 구현 계획

### 6.1 단계별 로드맵

```
┌─────────────────────────────────────────────────────────────────┐
│                    구현 로드맵                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1 (1주) ──────────────────────────────────────────────── │
│  │ • 단순화 버전 (방안 F) 구현 및 테스트                          │
│  │ • 가중치 최적화 (방안 A) 적용                                  │
│  │ • A/B 테스트: 현재 vs 신규                                    │
│                                                                 │
│  Phase 2 (2주) ──────────────────────────────────────────────── │
│  │ • 3-Tier 체계 (방안 C) 구현                                   │
│  │ • 동적 임계값 (방안 B) 옵션 추가                               │
│  │ • 거래품질점수와 역할 분리 명확화                              │
│                                                                 │
│  Phase 3 (4주) ──────────────────────────────────────────────── │
│  │ • 세그먼트별 조정 (방안 D) 구현                                │
│  │ • ML 기반 점수화 (방안 E) 프로토타입                           │
│  │ • Walk-Forward 검증                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 파일 수정 계획

| Phase | 파일 | 수정 내용 |
|:-----:|------|----------|
| 1 | `metrics_enhanced.py` | 가중치 조정, 단순화 버전 추가 |
| 1 | `variable_registry.py` | 신규 버전 변수 등록 |
| 2 | `metrics_enhanced.py` | 3-Tier 함수 추가 |
| 2 | `config.py` | 동적 임계값 설정 옵션 |
| 3 | `segmentation.py` | 세그먼트별 위험도 조정 |
| 3 | `ml_risk_model.py` | ML 모델 학습/예측 (신규) |

### 6.3 검증 계획

| 검증 항목 | 방법 | 기준 |
|----------|------|------|
| 필터 효과 비교 | 동일 데이터셋 A/B 테스트 | 수익개선금액 10%+ 향상 |
| 오버피팅 검증 | Walk-Forward Analysis | OOS 저하율 < 30% |
| 타임프레임 호환성 | 틱/분봉 결과 비교 | 일관성 95%+ |
| 연산 성능 | 실행 시간 측정 | 기존 대비 +20% 이내 |

---

## 7. 코드 예시

### 7.1 metrics_enhanced.py 수정 제안

```python
# -*- coding: utf-8 -*-
# backtester/analysis_enhanced/metrics_enhanced.py

# === 위험도점수 버전 선택 ===
RISK_SCORE_VERSION = 'v2_optimized'  # 'v1_original', 'v2_optimized', 'v3_tiered', 'v4_simple'

# === V2: 가중치 최적화 버전 ===
RISK_WEIGHTS_V2 = {
    '매수등락율': {'thresholds': [18, 25, 30], 'weights': [10, 5, 5]},  # max 20 (40→20)
    '매수체결강도_weak': {'thresholds': [75, 55], 'weights': [12, 8]},   # max 20
    '매수체결강도_overheat': {'thresholds': [160, 200], 'weights': [10, 10]}, # max 20
    '매수당일거래대금': {'thresholds': [100, 200], 'weights': [12, 8]},  # max 20 (억 단위)
    '시가총액': {'thresholds': [1500, 4000], 'weights': [10, 8]},       # max 18
    '매수호가잔량비': {'thresholds': [85, 70], 'weights': [8, 8]},      # max 16
    '매수스프레드': {'thresholds': [0.3, 0.6], 'weights': [8, 6]},      # max 14
    '매수회전율': {'thresholds': [20, 35], 'weights': [15, 10]},        # max 25 (15→25!)
    '매수변동폭비율': {'thresholds': [12, 18, 25], 'weights': [8, 8, 6]}, # max 22
}
# 이론적 최대: 175점 → clip 100


def calculate_risk_score_v2(df):
    """
    V2: 가중치 최적화 위험도점수
    
    변경 사항:
    - 매수등락율 가중치 대폭 감소 (40→20)
    - 매수회전율 가중치 대폭 증가 (15→25)
    - 임계값 데이터 기반 조정
    """
    score = pd.Series(0.0, index=df.index)
    
    # 1. 과열 위험 (등락율) - 가중치 감소
    if '매수등락율' in df.columns:
        ret = pd.to_numeric(df['매수등락율'], errors='coerce')
        score += (ret >= 18) * 10
        score += (ret >= 25) * 5
        score += (ret >= 30) * 5
    
    # 2. 체결강도 위험 - 약세/과열 분리
    if '매수체결강도' in df.columns:
        power = pd.to_numeric(df['매수체결강도'], errors='coerce')
        # 약세
        score += (power < 75) * 12
        score += (power < 55) * 8
        # 과열
        score += (power >= 160) * 10
        score += (power >= 200) * 10
    
    # 3. 유동성 위험 (거래대금) - 임계값 상향
    if '매수당일거래대금' in df.columns:
        trade_money_eok = pd.to_numeric(df['매수당일거래대금'], errors='coerce') / 100
        score += (trade_money_eok < 100) * 12
        score += (trade_money_eok < 200) * 8
    
    # 4. 규모 위험 (시가총액) - 임계값 조정
    if '시가총액' in df.columns:
        mcap = pd.to_numeric(df['시가총액'], errors='coerce')
        score += (mcap < 1500) * 10
        score += (mcap < 4000) * 8
    
    # 5. 호가 불균형 - 약간 감소
    if '매수호가잔량비' in df.columns:
        hoga = pd.to_numeric(df['매수호가잔량비'], errors='coerce')
        score += (hoga < 85) * 8
        score += (hoga < 70) * 8
    
    # 6. 슬리피지 위험 - 임계값 조정
    if '매수스프레드' in df.columns:
        spread = pd.to_numeric(df['매수스프레드'], errors='coerce')
        score += (spread >= 0.3) * 8
        score += (spread >= 0.6) * 6
    
    # 7. 회전율 위험 - 가중치 대폭 증가!
    if '매수회전율' in df.columns:
        turn = pd.to_numeric(df['매수회전율'], errors='coerce')
        score += (turn < 20) * 15
        score += (turn < 35) * 10
    
    # 8. 변동성 위험 - 임계값 조정
    if '매수변동폭비율' in df.columns:
        vol = pd.to_numeric(df['매수변동폭비율'], errors='coerce')
        score += (vol >= 12) * 8
        score += (vol >= 18) * 8
        score += (vol >= 25) * 6
    
    return score.clip(0, 100)


def calculate_risk_score_v4_simple(df):
    """
    V4: 단순화 위험도점수 (4요소)
    
    핵심 요소만 사용:
    - 유동성: 거래대금 + 회전율
    - 수급: 체결강도
    - 규모: 시가총액
    - 변동성: 변동폭비율
    """
    score = pd.Series(0.0, index=df.index)
    
    # 유동성 (max 30)
    if '매수당일거래대금' in df.columns:
        trade_eok = pd.to_numeric(df['매수당일거래대금'], errors='coerce') / 100
        score += (trade_eok < 100) * 12
        score += (trade_eok < 200) * 6
    
    if '매수회전율' in df.columns:
        turn = pd.to_numeric(df['매수회전율'], errors='coerce')
        score += (turn < 20) * 8
        score += (turn < 35) * 4
    
    # 수급 (max 30)
    if '매수체결강도' in df.columns:
        power = pd.to_numeric(df['매수체결강도'], errors='coerce')
        score += (power < 70) * 15
        score += (power >= 170) * 15
    
    # 규모 (max 20)
    if '시가총액' in df.columns:
        mcap = pd.to_numeric(df['시가총액'], errors='coerce')
        score += (mcap < 1500) * 10
        score += (mcap < 3500) * 10
    
    # 변동성 (max 20)
    if '매수변동폭비율' in df.columns:
        vol = pd.to_numeric(df['매수변동폭비율'], errors='coerce')
        score += (vol >= 12) * 10
        score += (vol >= 20) * 10
    
    return score.clip(0, 100)


# === 버전 선택 함수 ===
def calculate_risk_score(df, version='v2_optimized'):
    """
    버전별 위험도점수 계산
    
    Args:
        df: DataFrame
        version: 'v1_original', 'v2_optimized', 'v3_tiered', 'v4_simple'
    
    Returns:
        Series: 위험도점수 (0-100)
    """
    if version == 'v1_original':
        return calculate_risk_score_v1(df)  # 기존 로직
    elif version == 'v2_optimized':
        return calculate_risk_score_v2(df)
    elif version == 'v3_tiered':
        return calculate_tiered_risk_score(df)[0]
    elif version == 'v4_simple':
        return calculate_risk_score_v4_simple(df)
    else:
        raise ValueError(f"Unknown version: {version}")
```

### 7.2 variable_registry.py 업데이트

```python
# backtester/variable_registry.py에 추가

_register(VariableDefinition(
    name='위험도점수_V2',
    display_name='위험도점수(최적화)',
    scope=VariableScope.BUY,
    timeframe=VariableTimeframe.ALL,
    unit='점수(0~100)',
    category='위험신호',
    formula=[
        '가중치 최적화 버전 (2026-01-07)',
        '매수등락율 가중치 감소 (40→20)',
        '매수회전율 가중치 증가 (15→25)',
        '임계값 데이터 기반 조정',
    ],
    source_columns=['매수등락율', '매수체결강도', '매수당일거래대금', '시가총액',
                   '매수호가잔량비', '매수스프레드', '매수회전율', '매수변동폭비율'],
    description='필터 효과 기반 가중치 최적화 위험도점수',
))

_register(VariableDefinition(
    name='위험도점수_Simple',
    display_name='위험도점수(단순화)',
    scope=VariableScope.BUY,
    timeframe=VariableTimeframe.ALL,
    unit='점수(0~100)',
    category='위험신호',
    formula=[
        '4요소 단순화 버전',
        '유동성(거래대금+회전율) + 수급(체결강도) + 규모(시가총액) + 변동성(변동폭비율)',
    ],
    source_columns=['매수당일거래대금', '매수회전율', '매수체결강도', '시가총액', '매수변동폭비율'],
    description='핵심 4요소만 사용하는 단순화 위험도점수',
))
```

---

## 8. 기대 효과 및 검증 방법

### 8.1 기대 효과

| 개선 방안 | 기대 효과 | 측정 지표 |
|----------|----------|----------|
| 가중치 최적화 (V2) | 필터 수익개선 10-20% 향상 | A/B 테스트 |
| 단순화 (V4) | 해석 용이성, 연산 속도 향상 | 사용자 피드백, 벤치마크 |
| 3-Tier 체계 | 위험 요소별 독립 분석 가능 | 서브스코어 상관분석 |
| 동적 임계값 | 시장 상황 적응력 향상 | OOS 안정성 |
| ML 기반 | 최적 가중치 자동 학습 | Cross-Validation AUC |

### 8.2 검증 방법

#### 8.2.1 A/B 테스트

```python
# 동일 데이터셋에서 V1 vs V2 비교
def compare_risk_versions(df_tsg):
    """위험도점수 버전별 필터 효과 비교"""
    
    results = {}
    
    for version in ['v1_original', 'v2_optimized', 'v4_simple']:
        df = df_tsg.copy()
        df['위험도점수'] = calculate_risk_score(df, version)
        
        # 동일 임계값(65점)으로 필터 효과 비교
        mask = df['위험도점수'] >= 65
        
        results[version] = {
            '제외비율': (~mask).mean() * 100,
            '잔여수익금': df.loc[mask, '수익금'].sum(),
            '잔여평균수익률': df.loc[mask, '수익률'].mean(),
            '잔여승률': (df.loc[mask, '수익금'] > 0).mean() * 100,
        }
    
    return pd.DataFrame(results).T
```

#### 8.2.2 Walk-Forward 검증

```python
def walk_forward_validate(df_tsg, risk_version, n_splits=5):
    """Walk-Forward 검증으로 오버피팅 확인"""
    
    from sklearn.model_selection import TimeSeriesSplit
    
    tscv = TimeSeriesSplit(n_splits=n_splits)
    oos_improvements = []
    
    for train_idx, test_idx in tscv.split(df_tsg):
        df_train = df_tsg.iloc[train_idx]
        df_test = df_tsg.iloc[test_idx]
        
        # Train에서 최적 임계값 찾기
        # ...
        
        # Test에서 효과 확인
        # ...
    
    return {
        '평균_OOS_개선': np.mean(oos_improvements),
        '표준편차': np.std(oos_improvements),
        '안정성': np.mean(oos_improvements) / (np.std(oos_improvements) + 0.01),
    }
```

---

## 9. 결론 및 권장사항

### 9.1 핵심 결론

1. **현재 위험도점수는 효과적이나 최적화 여지 존재**
   - 필터 효과: +696M원 (65점 미만 제외)
   - 개별 변수 필터가 더 높은 효과를 보이는 경우 다수

2. **가중치 불균형 확인**
   - 매수등락율: 과대평가 (40점 → 20점 권장)
   - 매수회전율: 과소평가 (15점 → 25점 권장)

3. **거래품질점수와 역할 중복**
   - 공통 사용 변수 5개
   - 두 점수의 역할 재정의 필요

### 9.2 권장 구현 순서

| 순서 | 작업 | 우선순위 | 기간 |
|:---:|------|:--------:|:----:|
| 1 | V2 가중치 최적화 적용 | 🔴 긴급 | 3일 |
| 2 | V4 단순화 버전 병행 제공 | 🔴 긴급 | 3일 |
| 3 | A/B 테스트 검증 | 🟠 높음 | 1주 |
| 4 | 3-Tier 체계 구현 | 🟠 높음 | 2주 |
| 5 | 동적 임계값 옵션 | 🟡 중간 | 2주 |
| 6 | ML 기반 프로토타입 | 🟢 낮음 | 4주 |

### 9.3 즉시 적용 가능한 최소 변경

```python
# metrics_enhanced.py Line 179-231 수정

# 변경 전
df.loc[buy_ret >= 20, '위험도점수'] += 20
df.loc[buy_ret >= 25, '위험도점수'] += 10
df.loc[buy_ret >= 30, '위험도점수'] += 10

# 변경 후 (등락율 가중치 감소)
df.loc[buy_ret >= 18, '위험도점수'] += 10
df.loc[buy_ret >= 25, '위험도점수'] += 5
df.loc[buy_ret >= 30, '위험도점수'] += 5

# 변경 전
df.loc[turn < 10, '위험도점수'] += 5
df.loc[turn < 5, '위험도점수'] += 10

# 변경 후 (회전율 가중치 증가)
df.loc[turn < 20, '위험도점수'] += 15
df.loc[turn < 35, '위험도점수'] += 10
```

---

## 참고자료

### 관련 문서

- [Variable_Management_Guide.md](../../Guideline/Variable_Management_Guide.md) - 변수 통합 관리 가이드
- [2025-12-28_Risk_Score_Calculation_and_Cross_Timeframe_Compatibility_Analysis.md](../SystemAnalysis/2025-12-28_Risk_Score_Calculation_and_Cross_Timeframe_Compatibility_Analysis.md) - 타임프레임 호환성 분석
- [2025-12-29_Overfitting_Risk_Assessment_Filter_Segment_Analysis.md](./2025-12-29_Overfitting_Risk_Assessment_Filter_Segment_Analysis.md) - 오버피팅 위험 평가

### 코드 파일

- `backtester/analysis_enhanced/metrics_enhanced.py` - 위험도점수 계산 로직
- `backtester/variable_registry.py` - 변수 레지스트리
- `backtester/analysis_enhanced/filters.py` - 필터 분석

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.0.0 | 2026-01-07 | 최초 작성 |

---

## 부록: 전체 필터 효과 데이터

### A. 위험도점수 관련 변수 필터 효과 (상세)

| 변수 | 필터 조건 | 수익개선금액 | 제외비율 | 잔여승률 |
|------|----------|:-----------:|:-------:|:-------:|
| 위험도점수 | < 65 | +696M원 | 78.8% | 29.4% |
| 위험도점수 | >= 80 | +123M원 | 6.2% | 28.9% |
| 매수체결강도 | >= 92.78 | +682M원 | 76.1% | 23.7% |
| 매수회전율 | < 26.93 | +646M원 | 76.0% | 21.5% |
| 매수변동폭비율 | < 18.39 | +614M원 | 76.1% | 22.2% |
| 매수당일거래대금 | < 316억 | +587M원 | 57.1% | 26.1% |
| 시가총액 | >= 1,309억 | +509M원 | 76.1% | 21.6% |
| 거래품질점수 | >= 70 | +328M원 | 43.2% | 27.8% |
| 매수스프레드 | >= 0.24 | +250M원 | 20.0% | 29.1% |
| 거래품질점수 | < 51.32 | +219M원 | 14.5% | 29.2% |
| 매수등락율 | >= 18.81 | +90M원 | 5.0% | 29.2% |
