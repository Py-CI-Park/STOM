# 세그먼트 필터 변수 정의 및 컨텍스트 분석

## 문서 정보
- **작성일**: 2026-01-06
- **목적**: 세그먼트 필터 조건식과 실제 백테스트 실행 환경의 변수 차이점 규명
- **관련 이슈**: 내부 검증 1,372건 vs 실제 적용 2,885건 불일치

---

## 1. 문제 배경

### 1.1 현상
| 항목 | 내부 검증 (segment_verification.csv) | 실제 백테스트 적용 |
|------|--------------------------------------|-------------------|
| 거래 수 | 1,372건 (27.07%) | 2,885건 (56.7%) |
| 수익금 | +96,258,908원 | -292,233,394원 |
| 통과율 | 예측값과 일치 | **약 2배 많음** |

### 1.2 근본 원인 가설
- **내부 검증** (`build_segment_mask_from_global_best`): DataFrame 컬럼 직접 조회
- **실제 실행** (`exec(self.buystg)`): Strategy() 함수 내 로컬 변수 컨텍스트에서 실행
- **런타임 매핑** (`code_generator.py`): 일부 변수가 `try/except`로 NameError 시 0으로 대체

---

## 2. 매수시점 변수 (backengine 런타임)

### 2.1 직접 정의 변수 (backengine_kiwoom_min.py Line 424-429)

Strategy() 함수 내에서 `self.arry_data[self.indexn, 1:48]`로 직접 언패킹되는 변수들:

| 인덱스 | 변수명 | 설명 | 데이터 타입 |
|--------|--------|------|-------------|
| 1 | `현재가` | 현재 체결가 | float |
| 2 | `시가` | 당일 시가 | float |
| 3 | `고가` | 당일 고가 | float |
| 4 | `저가` | 당일 저가 | float |
| 5 | `등락율` | 전일 대비 등락율 (%) | float |
| 6 | `당일거래대금` | 당일 누적 거래대금 (백만원) | float |
| 7 | `체결강도` | 매수체결강도 (%) | float |
| 8 | `거래대금증감` | 거래대금 변화량 | float |
| 9 | `전일비` | 전일 대비 비율 | float |
| 10 | `회전율` | 당일 회전율 (%) | float |
| 11 | `전일동시간비` | 전일 동시간 대비 거래량 비율 | float |
| 12 | `시가총액` | 시가총액 (억원) | float |
| 13 | `라운드피겨위5호가이내` | 라운드피겨 근접 여부 | int |
| 14 | `분당매수수량` | 분당 매수체결 수량 | float |
| 15 | `분당매도수량` | 분당 매도체결 수량 | float |
| 16 | `VI해제시간` | VI 해제 시간 (raw) | float |
| 17 | `VI가격` | VI 발동 가격 | float |
| 18 | `VI호가단위` | VI 호가 단위 | float |
| 19 | `분봉시가` | 현재 분봉 시가 | float |
| 20 | `분봉고가` | 현재 분봉 고가 | float |
| 21 | `분봉저가` | 현재 분봉 저가 | float |
| 22 | `분당거래대금` | 분당 거래대금 | float |
| 23 | `고저평균대비등락율` | 고저 평균 대비 등락율 | float |
| 24 | `매도총잔량` | 매도 호가 총잔량 | float |
| 25 | `매수총잔량` | 매수 호가 총잔량 | float |
| 26-30 | `매도호가5~1` | 매도 호가 1~5단계 | float |
| 31-35 | `매수호가1~5` | 매수 호가 1~5단계 | float |
| 36-40 | `매도잔량5~1` | 매도 잔량 1~5단계 | float |
| 41-45 | `매수잔량1~5` | 매수 잔량 1~5단계 | float |
| 46 | `매도수5호가잔량합` | 매도수 5호가 잔량 합계 | float |
| 47 | `관심종목` | 관심종목 여부 | int |

### 2.2 계산 파생 변수

| 변수명 | 계산식 | 정의 위치 |
|--------|--------|-----------|
| `종목명` | `self.name` | Line 424 |
| `종목코드` | `self.code` | Line 424 |
| `데이터길이` | `self.tick_count` | Line 424 |
| `시분초` | `int(str(self.index)[8:] + '00')` | Line 424 |
| `호가단위` | `매도호가2 - 매도호가1` | Line 430 |
| `VI해제시간` (변환) | `strp_time('%Y%m%d%H%M%S', str(int(VI해제시간)))` | Line 431 |
| `VI아래5호가` | `GetUvilower5(VI가격, VI호가단위, self.index)` | Line 431 |

### 2.3 헬퍼 함수 (Strategy() 내 정의)

| 함수명 | 인자 | 반환값 | 설명 |
|--------|------|--------|------|
| `now()` | - | datetime | 현재 시간 |
| `Parameter_Previous(aindex, pre)` | 배열인덱스, 이전틱수 | float | N틱 이전 데이터 조회 |
| `현재가N(pre)` | 이전틱수 | float | N틱 이전 현재가 |
| `시가N(pre)` | 이전틱수 | float | N틱 이전 시가 |
| `고가N(pre)` | 이전틱수 | float | N틱 이전 고가 |
| `저가N(pre)` | 이전틱수 | float | N틱 이전 저가 |
| `등락율N(pre)` | 이전틱수 | float | N틱 이전 등락율 |
| `당일거래대금N(pre)` | 이전틱수 | float | N틱 이전 당일거래대금 |
| `체결강도N(pre)` | 이전틱수 | float | N틱 이전 체결강도 |
| `이동평균(tick, pre)` | 기간, 이전틱수 | float | 이동평균 계산 |
| `최고현재가(tick, pre)` | 기간, 이전틱수 | float | 기간 내 최고 현재가 |
| `최저현재가(tick, pre)` | 기간, 이전틱수 | float | 기간 내 최저 현재가 |
| `체결강도평균(tick, pre)` | 기간, 이전틱수 | float | 기간 체결강도 평균 |
| `등락율각도(tick, pre)` | 기간, 이전틱수 | float | 등락율 변화 각도 |
| `경과틱수(조건명)` | 조건명 | int | 조건 충족 후 경과 틱수 |

---

## 3. 런타임 매핑 변수 (code_generator.py)

### 3.1 개요

`segment_code_final.txt` 생성 시 `_build_segment_runtime_preamble()` 함수가 49개의 런타임 매핑 블록을 삽입합니다.

**핵심 로직** (Line 273-297):
```python
def _build_segment_runtime_preamble(used_vars: Optional[List[str]] = None) -> List[str]:
    blocks = _get_segment_runtime_blocks()
    used_vars = used_vars or []
    needed = _resolve_runtime_dependencies(set(used_vars), blocks)
    # ... 필요한 블록만 선택하여 코드 생성
```

### 3.2 파생 계산 변수 (try/except 패턴)

| 변수명 | 의존 변수 | 계산식 | fallback |
|--------|-----------|--------|----------|
| `초당매수수량` | `분당매수수량` | `분당매수수량 / 60` | 0 |
| `초당매도수량` | `분당매도수량` | `분당매도수량 / 60` | 0 |
| `초당매도_매수_비율` | `초당매도수량`, `초당매수수량` | `초당매도수량 / (초당매수수량 + 1e-6)` | - |
| `초당매수_매도_비율` | `초당매수수량`, `초당매도수량` | `초당매수수량 / (초당매도수량 + 1e-6)` | - |
| `초당순매수수량` | `초당매수수량`, `초당매도수량` | `초당매수수량 - 초당매도수량` | - |
| `초당순매수금액` | `초당순매수수량`, `현재가` | `초당순매수수량 * 현재가 / 1_000_000` | - |
| `매수초당거래대금` | `분당거래대금` | `분당거래대금 / 60` | 0 |
| `매수스프레드` | `매도호가1`, `매수호가1` | `((매도호가1 - 매수호가1) / 매수호가1) * 100` | 0 |
| `매수호가잔량비` | `매수총잔량`, `매도총잔량` | `(매수총잔량 / (매도총잔량 + 1e-6)) * 100` | - |
| `매도호가잔량비` | `매도총잔량`, `매수총잔량` | `(매도총잔량 / (매수총잔량 + 1e-6)) * 100` | - |
| `매수변동폭` | `고가`, `저가` | `고가 - 저가` | - |
| `매수변동폭비율` | `고가`, `저가` | `((고가 - 저가) / 저가) * 100` | 0 |
| `현재가_고저범위_위치` | `현재가`, `고가`, `저가` | `(현재가 - 저가) / (고가 - 저가 + 1e-6) * 100` | - |
| `초당매수수량_매도총잔량_비율` | `초당매수수량`, `매도총잔량` | `(초당매수수량 / (매도총잔량 + 1e-6)) * 100` | - |
| `당일거래대금_전틱분봉_비율` | `당일거래대금` | `당일거래대금 / (_prev_trade + 1e-6)` | 0.0 |
| `당일거래대금_5틱분봉평균_비율` | `당일거래대금` | `당일거래대금 / (_trade_avg + 1e-6)` | 0.0 |

### 3.3 스냅샷 매핑 변수 (단순 별칭)

매수 시점의 값을 `매수*` 접두사로 저장:

| 런타임 변수명 | 원본 변수 | 그룹 |
|---------------|-----------|------|
| `매수매수호가1` | `매수호가1` | snapshot |
| `매수매도호가1` | `매도호가1` | snapshot |
| `매수매수총잔량` | `매수총잔량` | snapshot |
| `매수매도총잔량` | `매도총잔량` | snapshot |
| `매수전일비` | `전일비` | snapshot |
| `매수전일동시간비` | `전일동시간비` | snapshot |
| `매수체결강도` | `체결강도` | snapshot |
| `매수등락율` | `등락율` | snapshot |
| `매수시가등락율` | `시가등락율` | snapshot |
| `매수회전율` | `회전율` | snapshot |
| `매수당일거래대금` | `당일거래대금` | snapshot |
| `매수고가` | `고가` | snapshot |
| `매수저가` | `저가` | snapshot |
| `매수고저평균대비등락율` | `고저평균대비등락율` | snapshot |
| `매수시가` | `시가` | snapshot |
| `매수가` | `현재가` | snapshot |
| `매수초당매수수량` | `초당매수수량` | snapshot |
| `매수초당매도수량` | `초당매도수량` | snapshot |

### 3.4 시간 관련 변수

| 변수명 | 의존 변수 | 계산식 |
|--------|-----------|--------|
| `매수시` | `시분초` | `시분초 // 10000` |
| `매수분` | `시분초` | `(시분초 // 100) % 100` |
| `매수초` | `시분초` | `시분초 % 100` |
| `매수시간` | `시분초` | `시분초` (그대로) |
| `매수일자` | `self.index` | `int(str(self.index)[:8])` |

### 3.5 복합 점수 변수

| 변수명 | 의존 변수 | 범위 | 설명 |
|--------|-----------|------|------|
| `거래품질점수` | 매수체결강도, 매수호가잔량비, 시가총액, 매수등락율, 매수스프레드 | 0-100 | 거래 품질 종합 평가 |
| `위험도점수` | 매수등락율, 매수체결강도, 매수당일거래대금, 시가총액, 매수호가잔량비, 매수스프레드, 매수회전율, 매수변동폭비율 | 0-100 | 위험 신호 종합 점수 |
| `모멘텀점수` | 매수등락율, 매수체결강도 | -30~+30 | 모멘텀 강도 |

---

## 4. 파생 지표 (metrics_enhanced.py)

### 4.1 변화량 지표

detail.csv에 기록된 매수/매도 시점 데이터로 계산:

| 지표명 | 계산식 | 용도 |
|--------|--------|------|
| `등락율변화` | `매도등락율 - 매수등락율` | 보유 중 추세 변화 |
| `체결강도변화` | `매도체결강도 - 매수체결강도` | 수급 변화 감지 |
| `전일비변화` | `매도전일비 - 매수전일비` | 전일비 변화 |
| `회전율변화` | `매도회전율 - 매수회전율` | 회전율 변화 |
| `호가잔량비변화` | `매도호가잔량비 - 매수호가잔량비` | 호가 불균형 변화 |

### 4.2 변화율 지표

| 지표명 | 계산식 | 용도 |
|--------|--------|------|
| `거래대금변화율` | `매도당일거래대금 / 매수당일거래대금` | 거래량 추세 |
| `체결강도변화율` | `매도체결강도 / 매수체결강도` | 체결강도 비율 |
| `당일거래대금_전틱분봉_비율` | `현재 / 이전` | 거래대금 증감 트렌드 |
| `당일거래대금_5틱분봉평균_비율` | `현재 / 5틱평균` | 단기 트렌드 |

### 4.3 조합 비율 지표

| 지표명 | 계산식 | 용도 |
|--------|--------|------|
| `초당매수수량_매도총잔량_비율` | `매수초당매수수량 / 매수매도총잔량 * 100` | 매수세 강도 |
| `매도잔량_매수잔량_비율` | `매수매도총잔량 / 매수매수총잔량` | 호가 불균형 (매도 우위) |
| `매수잔량_매도잔량_비율` | `매수매수총잔량 / 매수매도총잔량` | 호가 불균형 (매수 우위) |
| `초당매도_매수_비율` | `매수초당매도수량 / 매수초당매수수량` | 매도 압력 |
| `초당매수_매도_비율` | `매수초당매수수량 / 매수초당매도수량` | 매수 압력 |
| `현재가_고저범위_위치` | `(매수가 - 매수저가) / (매수고가 - 매수저가) * 100` | 고저 범위 내 위치 |
| `초당거래대금_당일비중` | `매수초당거래대금 / 매수당일거래대금 * 10000` | 거래 강도 |
| `초당순매수비율` | `매수초당매수수량 / (매수초당매수수량 + 매수초당매도수량) * 100` | 순매수 비율 |

---

## 5. 변수 컨텍스트 비교

### 5.1 내부 검증 vs 실제 실행 비교

| 항목 | 내부 검증 (segment_apply.py) | 실제 실행 (exec in Strategy) |
|------|------------------------------|------------------------------|
| **데이터 소스** | DataFrame 컬럼 | Strategy() 로컬 변수 |
| **변수 접근** | `df['시분초']`, `df['시가총액']` | `시분초`, `시가총액` |
| **에러 처리** | `pd.to_numeric(..., errors='coerce')` | `try/except NameError → 0` |
| **누락 시 동작** | NaN → False (필터 미통과) | 0 (조건 평가에 영향) |
| **범위 검증** | SegmentBuilder로 정확한 세그먼트 분류 | 런타임 매핑 후 조건 평가 |

### 5.2 변수 가용성 체크리스트

#### backengine에서 직접 사용 가능한 변수

| 변수명 | backengine | code_generator | 일치 |
|--------|------------|----------------|------|
| `현재가` | ✅ Line 425 | ✅ snapshot (매수가) | ✅ |
| `시가` | ✅ Line 425 | ✅ snapshot (매수시가) | ✅ |
| `고가` | ✅ Line 425 | ✅ snapshot (매수고가) | ✅ |
| `저가` | ✅ Line 425 | ✅ snapshot (매수저가) | ✅ |
| `등락율` | ✅ Line 425 | ✅ snapshot (매수등락율) | ✅ |
| `당일거래대금` | ✅ Line 426 | ✅ snapshot (매수당일거래대금) | ✅ |
| `체결강도` | ✅ Line 426 | ✅ snapshot (매수체결강도) | ✅ |
| `시가총액` | ✅ Line 426 | ❌ (직접 매핑 없음) | ⚠️ |
| `시분초` | ✅ Line 424 | ✅ 매수시/분/초 계산에 사용 | ✅ |
| `분당매수수량` | ✅ Line 427 | ✅ 초당매수수량 계산에 사용 | ✅ |
| `분당매도수량` | ✅ Line 427 | ✅ 초당매도수량 계산에 사용 | ✅ |
| `매도총잔량` | ✅ Line 427 | ✅ snapshot (매수매도총잔량) | ✅ |
| `매수총잔량` | ✅ Line 427 | ✅ snapshot (매수매수총잔량) | ✅ |
| `매도호가1` | ✅ Line 427 | ✅ snapshot (매수매도호가1) | ✅ |
| `매수호가1` | ✅ Line 428 | ✅ snapshot (매수매수호가1) | ✅ |

#### 런타임 매핑이 필요한 변수

| 변수명 | backengine 직접 | 매핑 필요 | 매핑 상태 |
|--------|-----------------|-----------|-----------|
| `초당매수수량` | ❌ | ✅ | ✅ 분당매수수량/60 |
| `초당매도수량` | ❌ | ✅ | ✅ 분당매도수량/60 |
| `매수스프레드` | ❌ | ✅ | ✅ 계산식 존재 |
| `매수호가잔량비` | ❌ | ✅ | ✅ 계산식 존재 |
| `매수변동폭비율` | ❌ | ✅ | ✅ 계산식 존재 |
| `거래품질점수` | ❌ | ✅ | ✅ 복합 계산 |
| `위험도점수` | ❌ | ✅ | ✅ 복합 계산 |
| `모멘텀점수` | ❌ | ✅ | ✅ 복합 계산 |

---

## 6. 불일치 원인 분석

### 6.1 잠재적 문제점

#### 문제 1: `시가총액` 변수 직접 매핑 누락
- **내부 검증**: `df['시가총액']` → 정확한 값 사용
- **실제 실행**: `시가총액`은 backengine에서 직접 정의됨 (Line 426)
- **결론**: ✅ 문제 없음 (backengine에서 직접 사용 가능)

#### 문제 2: `시분초` 계산 방식 차이
- **backengine**: `int(str(self.index)[8:] + '00')` → HHMMSS 형식
- **내부 검증**: DataFrame의 `시분초` 컬럼 → 동일 형식 (detail.csv에서)
- **결론**: ✅ 문제 없음

#### 문제 3: 런타임 매핑 실패 가능성
- **상황**: 세그먼트 필터에서 사용하는 변수가 런타임 매핑 블록에 없는 경우
- **동작**: `try/except NameError → 0` 또는 조건이 무시됨
- **영향**: 필터 조건이 의도와 다르게 동작 → 더 많은 거래 통과

#### 문제 4: if/elif 체인 로직
- **코드** (code_generator.py Line 54-57):
```python
# 첫 번째는 "if", 나머지는 "elif" → 상호 배타적 처리
if_keyword = "if" if i == 0 else "elif"
```
- **문제**: 세그먼트 조건이 맞지 않으면 다음 세그먼트로 넘어감
- **영향**: 세그먼트 범위 경계에서 불일치 발생 가능

### 6.2 검증 권장 사항

1. **segment_code_final.txt 내용 확인**
   - 런타임 매핑 블록이 모든 필요 변수를 포함하는지 확인
   - 특히 세그먼트 필터에서 사용하는 변수 목록 추출

2. **세그먼트 경계값 일치 여부**
   - `ranges.csv`의 시가총액/시간 범위가 내부 검증과 동일한지 확인
   - `SegmentConfig`의 `dynamic_mode='fixed'` 적용 여부 확인

3. **런타임 로깅 추가**
   - 백테스트 실행 시 `필터통과` 변수 값과 세그먼트 분류 로깅
   - 내부 검증 결과와 비교

---

## 7. 참고 파일

| 파일 | 설명 | 핵심 라인 |
|------|------|-----------|
| `backtester/backengine_kiwoom_min.py` | 런타임 변수 정의 | 424-429 |
| `backtester/segment_analysis/code_generator.py` | 런타임 매핑 49개 블록 | 335-630 |
| `backtester/segment_analysis/segment_apply.py` | 내부 검증 마스크 생성 | 49-128 |
| `backtester/analysis_enhanced/metrics_enhanced.py` | 파생 지표 계산 | 61-444 |
| `backtester/analysis_enhanced/ml.py` | ML 예측 변수 | - |

---

## 8. 결론 및 다음 단계

### 8.1 현재 상태
- 변수 정의는 대부분 일치함
- 핵심 의문점: **왜 내부 검증과 실제 실행에서 2배 차이가 나는가?**

### 8.2 추가 조사 필요 항목
1. **Filter 백테스트의 세그먼트 재분석 로직** - 새 템플릿 선택 여부
2. **segment_code_final.txt 실제 내용 검토** - 생성된 조건식 확인
3. **런타임 매핑 실패 케이스 추적** - NameError 발생 빈도

### 8.3 권장 수정 방향
1. Filter 백테스트에서 세그먼트 재분석 비활성화 옵션 추가
2. 런타임 매핑 실패 시 경고 로깅 추가
3. 내부 검증 결과를 실제 실행 전에 저장하여 비교 가능하게 변경
