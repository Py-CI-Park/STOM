# 조건식 (Condition) - 위험 관리 매도 조건식

- STOM 주식 자동거래에 사용하기 위한 분봉 기반 조건식 문서
- Back_Testing_Guideline_Min.md의 조건식을 사용하여 만든 조건식
- 아이디어.md의 "위험 관리 매도 조건식"을 분봉 변수로 구현

## 소개

이 문서는 분봉 데이터를 활용한 포괄적인 위험 관리 매도 전략을 구현합니다.
다단계 손절, 추적 손절, 기술적 매도 신호 등을 포함합니다.

## 매수 조건식

```python
# 기본 매수 조건 (간단한 추세 추종)
if not (1000 < 현재가 <= 50000):
    매수 = False
elif not (0.5 < 등락율 <= 29.0):
    매수 = False
elif not (시가총액 >= 300):
    매수 = False
elif not (현재가 > 이동평균(20)):  # 20분봉 이평선 위
    매수 = False
elif not (RSI(14) >= 40 and RSI(14) <= 70):
    매수 = False
elif not (분당거래대금 >= 분당거래대금평균(20) * 1.2):
    매수 = False
else:
    매수 = True

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

## 매도 조건식

```python
# 위험 관리 매도 전략
매도 = False

# 1. 고정 손절 (Fixed Stop Loss)
if 수익률 <= -3.0:  # -3% 고정 손절
    매도 = True
    매도사유 = "고정손절"

# 2. 추적 손절 (Trailing Stop Loss)
elif 수익률 >= 2.0:  # 2% 이상 수익 시 추적 손절 시작
    최고수익률 = 수익률_최대값(10)  # 10분간 최고 수익률
    if 수익률 <= 최고수익률 - 1.5:  # 최고점 대비 1.5% 하락
        매도 = True
        매도사유 = "추적손절"

# 3. 시간 기반 손절 (Time-based Stop)
elif 보유시간 >= 180:  # 3시간 보유 시
    if 수익률 <= 1.0:  # 1% 이하 수익 시 시간 손절
        매도 = True
        매도사유 = "시간손절"

# 4. 기술적 매도 신호
elif RSI(14) >= 80:  # RSI 과매수
    매도 = True
    매도사유 = "RSI과매수"

elif MACD(12, 26, 9) < MACD신호(12, 26, 9):  # MACD 데드크로스
    if 수익률 >= 1.0:  # 수익 상태에서만
        매도 = True
        매도사유 = "MACD데드크로스"

# 5. 거래량 기반 매도
elif 분당매도량 > 분당매수량 * 1.5:  # 매도량 급증
    if 수익률 >= 2.0:  # 2% 이상 수익 시
        매도 = True
        매도사유 = "매도량급증"

# 6. 변동성 매도
elif 현재가 < 현재가_N(3):  # 3분 연속 하락
    if ATR(14) > ATR평균(14) * 1.5:  # 변동성 급증
        매도 = True
        매도사유 = "변동성급증"

# 7. 급락 보호
elif 등락율 <= -5.0:  # 당일 -5% 이하
    매도 = True
    매도사유 = "급락보호"

# 8. 체결강도 약화
elif 체결강도 <= 80:  # 체결강도 약화
    if 수익률 >= 3.0:  # 3% 이상 수익 시
        매도 = True
        매도사유 = "체결강도약화"

# 9. 지지선 붕괴
elif 현재가 < 이동평균(5):  # 5분봉 이평선 하향 돌파
    if 현재가 < 이동평균(20):  # 20분봉 이평선도 하향 돌파
        매도 = True
        매도사유 = "지지선붕괴"

# 10. 긴급 매도 (Circuit Breaker)
elif 현재가 < 매수가 * 0.9:  # 매수가 대비 -10%
    매도 = True
    매도사유 = "긴급매도"

if 매도:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

## 최적화 범위

```python
# 손절/익절 최적화
self.vars[0] = [[-4.0, -2.0, 0.5], -3.0]   # 고정_손절률
self.vars[1] = [[1.5, 3.0, 0.5], 2.0]      # 추적손절_시작수익률
self.vars[2] = [[1.0, 2.0, 0.5], 1.5]      # 추적손절_하락폭

# 시간 관리 최적화
self.vars[3] = [[120, 240, 30], 180]        # 시간손절_보유시간
self.vars[4] = [[0.5, 2.0, 0.5], 1.0]      # 시간손절_최소수익률

# 기술적 지표 최적화
self.vars[5] = [[75, 85, 2], 80]            # RSI_과매수기준
self.vars[6] = [[1.3, 2.0, 0.2], 1.5]      # 매도량비율_기준

# 변동성 관리 최적화
self.vars[7] = [[1.3, 2.0, 0.2], 1.5]      # ATR배수_기준
self.vars[8] = [[-6.0, -3.0, 1.0], -5.0]   # 급락보호_기준

# 체결강도 최적화
self.vars[9] = [[70, 90, 5], 80]            # 체결강도_약화기준
``` 