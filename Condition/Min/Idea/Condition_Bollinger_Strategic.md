# 조건식 (Condition) - 볼린저밴드 전략적 활용

- STOM 주식 자동거래에 사용하기 위한 분봉 기반 조건식 문서
- Back_Testing_Guideline_Min.md 에 있는 조건식을 사용하여 만든 조건식
- 아이디어.md의 "볼린저밴드 전략적 활용"을 분봉 변수로 구현

## 목차
- [조건식 (Condition) - 볼린저밴드 전략적 활용](#조건식-condition---볼린저밴드-전략적-활용)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - 볼린저밴드 전략적 활용](#condition---볼린저밴드-전략적-활용)
  - [조건식](#조건식)
    - [매수 조건식](#매수-조건식)
    - [매도 조건식](#매도-조건식)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식](#매수-최적화-조건식)
    - [매수 최적화 범위](#매수-최적화-범위)
    - [매도 최적화 조건식](#매도-최적화-조건식)
    - [매도 최적화 범위](#매도-최적화-범위)
    - [매수 매도 최적화 범위](#매수-매도-최적화-범위)
    - [GA 최적화 범위](#ga-최적화-범위)

## 소개

이 문서는 분봉 데이터를 활용한 볼린저밴드 전략적 활용을 구현합니다. 상/하단 밴드 터치, 밴드 수축/확장, 중심선 돌파 등 다양한 볼린저밴드 패턴을 종합적으로 활용합니다.

## 가이드라인

- 모든 조건식은 Python으로 작성되어 있으며, 분봉 데이터 기반 주식 거래의 자동화를 목표로 합니다.
- 볼린저밴드의 다양한 구성 요소(상단밴드, 하단밴드, 중심선, 밴드폭)를 종합적으로 활용합니다.
- 최적화 조건식은 변수의 범위를 설정하여 최적의 매수/매도 시점을 찾습니다.

### 저장 이름 규칙

- `C_MIN_BB_STRATEGIC_B`: 볼린저밴드 전략적 매수 조건식
- `C_MIN_BB_STRATEGIC_S`: 볼린저밴드 전략적 매도 조건식
- `C_MIN_BB_STRATEGIC_BO`: 볼린저밴드 전략적 매수 최적화 조건식
- `C_MIN_BB_STRATEGIC_SO`: 볼린저밴드 전략적 매도 최적화 조건식

---

# Condition - 볼린저밴드 전략적 활용

## 조건식

### 매수 조건식

```python
# 볼린저밴드 변수 계산
BB_상단 = BBU
BB_중심 = BBM  
BB_하단 = BBL
BB_폭 = BB_상단 - BB_하단
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)  # 0~1 사이 값

# 이전 값들
BB_상단_이전 = BBU_N(1)
BB_중심_이전 = BBM_N(1)
BB_하단_이전 = BBL_N(1)
BB_폭_이전 = BB_상단_이전 - BB_하단_이전
BB_위치_이전 = (현재가N(1) - BB_하단_이전) / (BB_상단_이전 - BB_하단_이전)

# 볼린저밴드 패턴 분석
BB_수축중 = BB_폭 < BB_폭_이전  # 밴드 수축
BB_확장중 = BB_폭 > BB_폭_이전  # 밴드 확장
BB_하단터치 = 현재가 <= BB_하단 * 1.005  # 하단 밴드 터치
BB_중심돌파 = (현재가 > BB_중심) and (현재가N(1) <= BB_중심_이전)  # 중심선 상향 돌파
BB_하단반등 = (현재가 > BB_하단 * 1.01) and (현재가N(1) <= BB_하단_이전 * 1.01)

# 볼린저밴드 위치 분석
BB_저가존 = BB_위치 < 0.2  # 하위 20% 구간
BB_매수존 = BB_위치 >= 0.2 and BB_위치 <= 0.4  # 매수 구간
BB_중립존 = BB_위치 > 0.4 and BB_위치 < 0.6  # 중립 구간

# 공통 선결 조건
if not (시분 >= 93000 and 시분 <= 150000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (0.5 < 등락율 <= 29.0):
    매수 = False
elif not (시가총액 >= 300):  # 300억원 이상
    매수 = False

# 볼린저밴드 기본 조건
elif not (현재가 > BB_하단):  # 하단 밴드 위
    매수 = False
elif not (현재가 < BB_상단 * 0.95):  # 상단 밴드 과매수 방지
    매수 = False

# 볼린저밴드 전략 패턴
# 1. 하단 밴드 반등 패턴
elif BB_하단반등 and BB_확장중:
    매수 = True
# 2. 중심선 돌파 패턴
elif BB_중심돌파 and BB_위치 > 0.5:
    매수 = True
# 3. 저가존 반등 패턴
elif BB_저가존 and (현재가 > 현재가N(1)):
    매수 = True

# 볼린저밴드 세부 조건
elif not (BB_위치 >= 0.1 and BB_위치 <= 0.7):  # 볼린저밴드 위치 제한
    매수 = False
elif not (BB_폭 > BB_폭_이전 * 0.95):  # 밴드 급축소 방지
    매수 = False

# 추가 기술적 지표 확인
elif not (RSI >= 25 and RSI <= 70):  # RSI 조건
    매수 = False
elif not (현재가 > 이동평균(20) * 0.98):  # 20분봉 이동평균 근처
    매수 = False

# 거래량 및 강도 조건
elif not (분당거래대금 >= 분당거래대금평균(20) * 1.2):
    매수 = False
elif not (체결강도 >= 100):
    매수 = False
elif not (분당매수수량 > 분당매도수량 * 0.8):  # 매수 우세 (여유있게)
    매수 = False

# 가격 모멘텀 확인
elif not (현재가 >= 최저분봉저가(10) * 1.005):  # 10분봉 저가 위
    매수 = False
elif not (현재가 > 시가 * 0.995):  # 시가 근처 또는 위
    매수 = False

# 위험 요소 체크
elif not (회전율 > 0.15):  # 유동성 확인
    매수 = False
elif 라운드피겨위5호가이내:  # 라운드피겨 근처 제외
    매수 = False

# 볼린저밴드 특별 패턴 재확인
if not 매수:
    # 볼린저밴드 스퀴즈 후 확장 패턴
    if (BB_폭 < BB_폭_이전 * 0.9) and BB_확장중 and BB_매수존:
        매수 = True
    # 볼린저밴드 워킹 더 밴드 시작 패턴
    elif (현재가 > BB_중심 * 1.01) and (BB_위치 > 0.5) and (BB_위치 < 0.75):
        매수 = True
    # 볼린저밴드 반등 확인 패턴
    elif BB_하단터치 and (체결강도 > 110) and (현재가 > 현재가N(2)):
        매수 = True

# 최종 매수 실행
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식

```python
# 볼린저밴드 변수 계산
BB_상단 = BBU
BB_중심 = BBM
BB_하단 = BBL
BB_폭 = BB_상단 - BB_하단
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 이전 값들
BB_상단_이전 = BBU_N(1)
BB_중심_이전 = BBM_N(1)
BB_하단_이전 = BBL_N(1)
BB_위치_이전 = (현재가N(1) - BB_하단_이전) / (BB_상단_이전 - BB_하단_이전)

# 볼린저밴드 패턴 분석
BB_상단터치 = 현재가 >= BB_상단 * 0.995  # 상단 밴드 터치
BB_중심하락돌파 = (현재가 < BB_중심) and (현재가N(1) >= BB_중심_이전)  # 중심선 하향 돌파
BB_고가존이탈 = BB_위치 > 0.8 and BB_위치_이전 <= 0.8  # 고가존 진입
BB_밴드축소중 = BB_폭 < BB_폭_이전 * 0.95  # 밴드 급격한 축소

# 상한가 근접 매도
if 등락율 > 28.0:
    매도 = True

# 볼린저밴드 매도 신호
elif BB_상단터치:  # 상단 밴드 터치
    매도 = True
elif BB_중심하락돌파:  # 중심선 하향 돌파
    매도 = True
elif BB_위치 > 0.85:  # 볼린저밴드 과매수 구간
    매도 = True
elif BB_고가존이탈 and 수익률 > 1.0:  # 고가존 진입 후 수익 실현
    매도 = True

# 볼린저밴드 기반 위험 신호
elif BB_밴드축소중 and BB_위치 > 0.7:  # 밴드 축소 중 고가존
    매도 = True
elif (현재가 < BB_상단 * 0.98) and (현재가N(1) >= BB_상단_이전 * 0.98):  # 상단 이탈
    매도 = True

# 수익률 기반 매도
elif 수익률 >= 5.0:  # 고수익 실현
    매도 = True
elif 수익률 <= -2.5:  # 손절매
    매도 = True

# 볼린저밴드 기반 추적 손절
elif 최고수익률 >= 2.5 and (최고수익률 - 수익률) >= 1.5 and BB_위치 < 0.5:
    매도 = True

# 시간 기반 매도
elif 보유시간 >= 300:  # 5시간 이상 보유
    매도 = True

# 추가 기술적 지표 매도 신호
elif RSI > 80:  # RSI 과매수
    매도 = True
elif 현재가 < 이동평균(20) * 0.98:  # 20분봉 이동평균 이탈
    매도 = True

# 거래량 기반 매도 신호
elif 분당거래대금 < 분당거래대금평균(10) * 0.6:
    매도 = True
elif 체결강도 < 80 and 분당매도수량 > 분당매수수량 * 1.5:
    매도 = True

# 볼린저밴드 워킹 더 밴드 종료 신호
elif (BB_위치 > 0.9) and (현재가 < 현재가N(1)) and (현재가 < 현재가N(2)):
    매도 = True

# 볼린저밴드 스퀴즈 시작 신호 (수익 있을 때)
elif BB_밴드축소중 and (BB_폭 < BB_폭_이전 * 0.85) and 수익률 > 0.5:
    매도 = True

# 최종 매도 실행
if 매도:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

## 최적화 조건식

### 매수 최적화 조건식

```python
# 최적화 변수들
BB_하단터치비율 = self.vars[0]    # 하단 터치 비율
BB_상단과매수비율 = self.vars[1]   # 상단 과매수 방지 비율
BB_위치하한 = self.vars[2]         # BB 위치 하한
BB_위치상한 = self.vars[3]         # BB 위치 상한
BB_폭최소비율 = self.vars[4]       # BB 폭 최소 비율
RSI_하한 = self.vars[5]            # RSI 하한
RSI_상한 = self.vars[6]            # RSI 상한
이동평균비율 = self.vars[7]        # 이동평균 비율
거래대금배수 = self.vars[8]        # 거래대금 배수
체결강도기준 = self.vars[9]        # 체결강도 기준

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_폭 = BB_상단 - BB_하단
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 이전 값들
BB_상단_이전 = 볼린저상단_N(20, 2, 1)
BB_중심_이전 = 볼린저중심_N(20, 1)
BB_하단_이전 = 볼린저하단_N(20, 2, 1)
BB_폭_이전 = BB_상단_이전 - BB_하단_이전
BB_위치_이전 = (현재가_N(1) - BB_하단_이전) / (BB_상단_이전 - BB_하단_이전)

# 볼린저밴드 패턴 분석
BB_확장중 = BB_폭 > BB_폭_이전
BB_하단터치 = 현재가 <= BB_하단 * BB_하단터치비율
BB_중심돌파 = (현재가 > BB_중심) and (현재가_N(1) <= BB_중심_이전)
BB_하단반등 = (현재가 > BB_하단 * 1.01) and (현재가N(1) <= BB_하단_이전 * 1.01)

# 공통 선결 조건
if not (시분 >= 93000 and 시분 <= 150000):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (0.5 < 등락율 <= 29.0):
    매수 = False
elif not (시가총액 >= 300):
    매수 = False

# 최적화된 볼린저밴드 조건
elif not (현재가 > BB_하단):
    매수 = False
elif not (현재가 < BB_상단 * BB_상단과매수비율):
    매수 = False
elif not (BB_위치 >= BB_위치하한 and BB_위치 <= BB_위치상한):
    매수 = False
elif not (BB_폭 > BB_폭_이전 * BB_폭최소비율):
    매수 = False

# 최적화된 기술적 지표
elif not (RSI(14) >= RSI_하한 and RSI(14) <= RSI_상한):
    매수 = False
elif not (현재가 > 이동평균(20) * 이동평균비율):
    매수 = False

# 최적화된 거래량 조건
elif not (분당거래대금 >= 분당거래대금평균(20) * 거래대금배수):
    매수 = False
elif not (체결강도 >= 체결강도기준):
    매수 = False
elif not (분당매수량 > 분당매도량 * 0.8):
    매수 = False

# 최적화된 가격 조건
elif not (현재가 >= 최저분봉저가(10) * 1.005):
    매수 = False
elif not (현재가 > 시가 * 0.995):
    매수 = False
elif not (회전율 > 0.15):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 볼린저밴드 패턴 확인
if BB_하단반등 and BB_확장중:
    매수 = True
elif BB_중심돌파 and BB_위치 > 0.5:
    매수 = True
elif (BB_위치 < 0.2) and (현재가 > 현재가_N(1)):
    매수 = True
elif not 매수:
    매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위

```python
self.vars[0] = [[1.002, 1.010, 0.002], 1.005]    # BB_하단터치비율
self.vars[1] = [[0.90, 0.98, 0.02], 0.95]        # BB_상단과매수비율
self.vars[2] = [[0.05, 0.20, 0.05], 0.1]         # BB_위치하한
self.vars[3] = [[0.60, 0.80, 0.05], 0.7]         # BB_위치상한
self.vars[4] = [[0.90, 1.00, 0.02], 0.95]        # BB_폭최소비율
self.vars[5] = [[20, 35, 5], 25]                  # RSI_하한
self.vars[6] = [[65, 80, 5], 70]                  # RSI_상한
self.vars[7] = [[0.95, 1.00, 0.01], 0.98]        # 이동평균비율
self.vars[8] = [[1.0, 1.5, 0.1], 1.2]            # 거래대금배수
self.vars[9] = [[95, 110, 5], 100]                # 체결강도기준
```

### 매도 최적화 조건식

```python
# 최적화 변수들
BB_상단터치비율 = self.vars[0]     # 상단 터치 비율
BB_과매수위치 = self.vars[1]       # 과매수 위치
BB_축소비율 = self.vars[2]         # 밴드 축소 비율
수익실현기준 = self.vars[3]        # 수익 실현 기준
손절기준 = self.vars[4]           # 손절 기준
추적손절기준 = self.vars[5]       # 추적 손절 기준
보유시간기준 = self.vars[6]       # 보유시간 기준
RSI_과매수기준 = self.vars[7]      # RSI 과매수 기준

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_폭 = BB_상단 - BB_하단
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 이전 값들
BB_상단_이전 = 볼린저상단_N(20, 2, 1)
BB_중심_이전 = 볼린저중심_N(20, 1)
BB_폭_이전 = BB_상단_이전 - 볼린저하단_N(20, 2, 1)
BB_위치_이전 = (현재가_N(1) - 볼린저하단_N(20, 2, 1)) / (BB_상단_이전 - 볼린저하단_N(20, 2, 1))

# 볼린저밴드 패턴 분석
BB_상단터치 = 현재가 >= BB_상단 * BB_상단터치비율
BB_중심하락돌파 = (현재가 < BB_중심) and (현재가_N(1) >= BB_중심_이전)
BB_밴드축소중 = BB_폭 < BB_폭_이전 * BB_축소비율

# 상한가 근접 매도
if 등락율 > 28.0:
    매도 = True

# 최적화된 볼린저밴드 매도 신호
elif BB_상단터치:
    매도 = True
elif BB_중심하락돌파:
    매도 = True
elif BB_위치 > BB_과매수위치:
    매도 = True
elif BB_밴드축소중 and BB_위치 > 0.7:
    매도 = True
elif (현재가 < BB_상단 * 0.98) and (현재가_N(1) >= BB_상단_이전 * 0.98):
    매도 = True

# 최적화된 수익률 매도
elif 수익률 >= 수익실현기준:
    매도 = True
elif 수익률 <= -손절기준:
    매도 = True
elif 최고수익률 >= 2.5 and (최고수익률 - 수익률) >= 추적손절기준 and BB_위치 < 0.5:
    매도 = True

# 최적화된 시간 매도
elif 보유시간 >= 보유시간기준:
    매도 = True

# 기타 최적화된 매도 신호
elif RSI(14) > RSI_과매수기준:
    매도 = True
elif 현재가 < 이동평균(20) * 0.98:
    매도 = True
elif 분당거래대금 < 분당거래대금평균(10) * 0.6:
    매도 = True
elif 체결강도 < 80 and 분당매도수량 > 분당매수수량 * 1.5:
    매도 = True
elif (BB_위치 > 0.9) and (현재가 < 현재가_N(1)) and (현재가 < 현재가_N(2)):
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 최적화 범위

```python
self.vars[0] = [[0.990, 1.000, 0.002], 0.995]    # BB_상단터치비율
self.vars[1] = [[0.80, 0.90, 0.02], 0.85]        # BB_과매수위치
self.vars[2] = [[0.90, 0.98, 0.02], 0.95]        # BB_축소비율
self.vars[3] = [[3.0, 7.0, 1.0], 5.0]            # 수익실현기준
self.vars[4] = [[2.0, 3.5, 0.5], 2.5]            # 손절기준
self.vars[5] = [[1.0, 2.0, 0.5], 1.5]            # 추적손절기준
self.vars[6] = [[240, 360, 30], 300]              # 보유시간기준
self.vars[7] = [[75, 85, 2], 80]                  # RSI_과매수기준
```

### 매수 매도 최적화 범위

```python
# 매수 최적화 범위
self.vars[0] = [[1.002, 1.010, 0.002], 1.005]    # BB_하단터치비율
self.vars[1] = [[0.90, 0.98, 0.02], 0.95]        # BB_상단과매수비율
self.vars[2] = [[0.05, 0.20, 0.05], 0.1]         # BB_위치하한
self.vars[3] = [[0.60, 0.80, 0.05], 0.7]         # BB_위치상한
self.vars[4] = [[0.90, 1.00, 0.02], 0.95]        # BB_폭최소비율
self.vars[5] = [[20, 35, 5], 25]                  # RSI_하한
self.vars[6] = [[65, 80, 5], 70]                  # RSI_상한
self.vars[7] = [[0.95, 1.00, 0.01], 0.98]        # 이동평균비율
self.vars[8] = [[1.0, 1.5, 0.1], 1.2]            # 거래대금배수
self.vars[9] = [[95, 110, 5], 100]                # 체결강도기준

# 매도 최적화 범위
self.vars[10] = [[0.990, 1.000, 0.002], 0.995]   # BB_상단터치비율
self.vars[11] = [[0.80, 0.90, 0.02], 0.85]       # BB_과매수위치
self.vars[12] = [[0.90, 0.98, 0.02], 0.95]       # BB_축소비율
self.vars[13] = [[3.0, 7.0, 1.0], 5.0]           # 수익실현기준
self.vars[14] = [[2.0, 3.5, 0.5], 2.5]           # 손절기준
self.vars[15] = [[1.0, 2.0, 0.5], 1.5]           # 추적손절기준
self.vars[16] = [[240, 360, 30], 300]             # 보유시간기준
self.vars[17] = [[75, 85, 2], 80]                 # RSI_과매수기준
```

### GA 최적화 범위

```python
# 매수 GA 최적화 범위
self.vars[0] = [[1.002, 1.003, 1.005, 1.007, 1.010], 1.005]          # BB_하단터치비율
self.vars[1] = [[0.90, 0.92, 0.94, 0.95, 0.96, 0.98], 0.95]          # BB_상단과매수비율
self.vars[2] = [[0.05, 0.10, 0.15, 0.20], 0.1]                       # BB_위치하한
self.vars[3] = [[0.60, 0.65, 0.70, 0.75, 0.80], 0.7]                 # BB_위치상한
self.vars[4] = [[0.90, 0.92, 0.94, 0.95, 0.96, 0.98, 1.00], 0.95]    # BB_폭최소비율
self.vars[5] = [[20, 25, 30, 35], 25]                                 # RSI_하한
self.vars[6] = [[65, 70, 75, 80], 70]                                 # RSI_상한
self.vars[7] = [[0.95, 0.96, 0.97, 0.98, 0.99, 1.00], 0.98]          # 이동평균비율
self.vars[8] = [[1.0, 1.1, 1.2, 1.3, 1.4, 1.5], 1.2]                # 거래대금배수
self.vars[9] = [[95, 100, 105, 110], 100]                             # 체결강도기준

# 매도 GA 최적화 범위
self.vars[10] = [[0.990, 0.992, 0.994, 0.995, 0.997, 1.000], 0.995]  # BB_상단터치비율
self.vars[11] = [[0.80, 0.82, 0.85, 0.87, 0.90], 0.85]               # BB_과매수위치
self.vars[12] = [[0.90, 0.92, 0.94, 0.95, 0.96, 0.98], 0.95]         # BB_축소비율
self.vars[13] = [[3.0, 4.0, 5.0, 6.0, 7.0], 5.0]                     # 수익실현기준
self.vars[14] = [[2.0, 2.5, 3.0, 3.5], 2.5]                          # 손절기준
self.vars[15] = [[1.0, 1.5, 2.0], 1.5]                                # 추적손절기준
self.vars[16] = [[240, 270, 300, 330, 360], 300]                      # 보유시간기준
self.vars[17] = [[75, 77, 80, 82, 85], 80]                            # RSI_과매수기준
```