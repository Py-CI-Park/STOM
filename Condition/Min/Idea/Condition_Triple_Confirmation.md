# 조건식 (Condition) - 삼중 확인 매수 조건식

- STOM 주식 자동거래에 사용하기 위한 분봉 기반 조건식 문서
- Back_Testing_Guideline_Min.md 에 있는 조건식을 사용하여 만든 조건식
- 아이디어.md의 "삼중 확인 매수 조건식"을 분봉 변수로 구현

## 목차
- [조건식 (Condition) - 삼중 확인 매수 조건식](#조건식-condition---삼중-확인-매수-조건식)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
    - [저장 이름 규칙](#저장-이름-규칙)
- [Condition - 삼중 확인 매수 조건식](#condition---삼중-확인-매수-조건식)
  - [조건식](#조건식)
    - [매수 조건식](#매수-조건식)
    - [매도 조건식](#매도-조건식)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식](#매수-최적화-조건식)
    - [매수 최적화 범위](#매수-최적화-범위)
    - [매도 최적화 조건식](#매도-최적화-조건식)
    - [매도 최적화 범위](#매도-최적화-범위)
    - [매수 매도 최적화 범위](#매수-매도-최적화-범위)
    - [GA 최적화 범위](#ga-최적화-범위)

## 소개

이 문서는 분봉 데이터를 활용한 삼중 확인 매수 전략을 구현합니다. 세 가지 다른 기술적 지표가 모두 매수 신호를 보낼 때만 매수를 실행하여 신뢰성을 극대화합니다.

## 가이드라인

- 모든 조건식은 Python으로 작성되어 있으며, 분봉 데이터 기반 주식 거래의 자동화를 목표로 합니다.
- RSI, MACD, 볼린저밴드 세 지표가 모두 매수 신호를 확인해야 매수를 실행합니다.
- 최적화 조건식은 변수의 범위를 설정하여 최적의 매수/매도 시점을 찾습니다.

### 저장 이름 규칙

- `C_MIN_TRIPLE_CONFIRM_B`: 삼중 확인 매수 조건식
- `C_MIN_TRIPLE_CONFIRM_S`: 삼중 확인 매도 조건식
- `C_MIN_TRIPLE_CONFIRM_BO`: 삼중 확인 매수 최적화 조건식
- `C_MIN_TRIPLE_CONFIRM_SO`: 삼중 확인 매도 최적화 조건식

---

# Condition - 삼중 확인 매수 조건식

## 조건식

### 매수 조건식

```python
# 기술적 지표 계산
RSI_값 = RSI(14)
RSI_이전 = RSI_N(14, 1)
MACD_값 = MACD(12, 26, 9)
MACD_신호 = MACD신호(12, 26, 9)
MACD_히스토그램 = MACD_값 - MACD_신호
MACD_히스토그램_이전 = MACD히스토그램_N(12, 26, 9, 1)

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 이동평균선 계산
이동평균5 = 이동평균(5)
이동평균20 = 이동평균(20)
이동평균60 = 이동평균(60)

# 삼중 확인 조건 1: RSI 반등 신호
RSI_매수신호 = False
if RSI_값 >= 35 and RSI_값 <= 65:  # RSI 과매수/과매도 방지
    if RSI_값 > RSI_이전:  # RSI 상승 중
        if RSI_값 >= 40:  # 최소 기준 이상
            RSI_매수신호 = True

# 삼중 확인 조건 2: MACD 골든크로스 및 모멘텀
MACD_매수신호 = False
if MACD_값 > MACD_신호:  # MACD 라인이 신호선 위
    if MACD_히스토그램 > 0:  # 히스토그램 양수
        if MACD_히스토그램 > MACD_히스토그램_이전:  # 히스토그램 증가
            MACD_매수신호 = True

# 삼중 확인 조건 3: 볼린저밴드 위치 및 패턴
BB_매수신호 = False
if BB_위치 >= 0.2 and BB_위치 <= 0.6:  # 볼린저밴드 적정 위치
    if 현재가 > BB_중심:  # 중심선 위
        if 현재가 > 현재가_N(1):  # 상승 모멘텀
            BB_매수신호 = True

# 이동평균 정배열 확인
이동평균_정배열 = (이동평균5 > 이동평균20) and (현재가 > 이동평균5)

# 공통 선결 조건
if not (시분 >= 930 and 시분 <= 1500):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (0.5 < 등락율 <= 29.0):
    매수 = False
elif not (시가총액 >= 300):  # 300억원 이상
    매수 = False

# 삼중 확인 조건 종합
elif not (RSI_매수신호 and MACD_매수신호 and BB_매수신호):
    매수 = False
elif not 이동평균_정배열:  # 이동평균 정배열 필수
    매수 = False

# 추가 보조 지표 확인
elif not (Stoch_K(14, 3) > Stoch_D(14, 3)):  # 스토캐스틱 골든크로스
    매수 = False
elif not (현재가 > 최고분봉고가(5) * 0.98):  # 5분봉 고가 근처
    매수 = False

# 거래량 및 강도 조건
elif not (분당거래대금 >= 분당거래대금평균(20) * 1.3):  # 거래량 급증
    매수 = False
elif not (체결강도 >= 105):  # 매수 우세
    매수 = False
elif not (분당매수량 > 분당매도량 * 1.1):  # 매수량 우세
    매수 = False

# 가격 움직임 확인
elif not (등락폭 > 0):  # 상승 중
    매수 = False
elif not (현재가 > 시가 * 1.005):  # 시가 대비 상승
    매수 = False

# 시장 상황 확인
elif not (현재가 >= 최저분봉저가(10) * 1.01):  # 10분봉 저가 위
    매수 = False
elif not (회전율 > 0.2):  # 활발한 거래
    매수 = False
elif 라운드피겨위5호가이내:  # 라운드피겨 근처 제외
    매수 = False

# 고급 패턴 확인
elif not (현재가 > 이동평균(20) * 1.01):  # 20분봉 이평선 위
    매수 = False

# 삼중 확인 신호 강도 검증
삼중확인강도 = 0
if RSI_매수신호:
    삼중확인강도 += 1
if MACD_매수신호:
    삼중확인강도 += 1
if BB_매수신호:
    삼중확인강도 += 1

# 추가 확인 신호들
if 이동평균_정배열:
    삼중확인강도 += 1
if Stoch_K(14, 3) > Stoch_D(14, 3):
    삼중확인강도 += 1
if 분당거래대금 >= 분당거래대금평균(20) * 1.5:
    삼중확인강도 += 1

# 최종 매수 판단 (기본 3개 + 추가 확인)
if 삼중확인강도 >= 5:  # 6개 중 5개 이상 만족
    매수 = True
else:
    매수 = False

# 최종 매수 실행
if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 조건식

```python
# 기술적 지표 계산
RSI_값 = RSI(14)
RSI_이전 = RSI_N(14, 1)
MACD_값 = MACD(12, 26, 9)
MACD_신호 = MACD신호(12, 26, 9)
MACD_히스토그램 = MACD_값 - MACD_신호
MACD_히스토그램_이전 = MACD히스토그램_N(12, 26, 9, 1)

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 삼중 매도 신호 1: RSI 과매수
RSI_매도신호 = False
if RSI_값 >= 75:  # RSI 과매수
    RSI_매도신호 = True
elif RSI_값 < RSI_이전 and RSI_값 < 65:  # RSI 하락전환
    RSI_매도신호 = True

# 삼중 매도 신호 2: MACD 데드크로스
MACD_매도신호 = False
if MACD_값 < MACD_신호:  # MACD 데드크로스
    MACD_매도신호 = True
elif MACD_히스토그램 < MACD_히스토그램_이전 and MACD_히스토그램 < 0:
    MACD_매도신호 = True

# 삼중 매도 신호 3: 볼린저밴드 과매수
BB_매도신호 = False
if BB_위치 > 0.8:  # 볼린저밴드 과매수 구간
    BB_매도신호 = True
elif 현재가 < BB_중심:  # 중심선 이탈
    BB_매도신호 = True

# 상한가 근접 매도
if 등락율 > 28.0:
    매도 = True

# 삼중 매도 신호 중 2개 이상 발생
매도신호개수 = 0
if RSI_매도신호:
    매도신호개수 += 1
if MACD_매도신호:
    매도신호개수 += 1
if BB_매도신호:
    매도신호개수 += 1

if 매도신호개수 >= 2:
    매도 = True

# 수익률 기반 매도
elif 수익률 >= 6.0:  # 고수익 실현
    매도 = True
elif 수익률 <= -3.0:  # 손절매
    매도 = True

# 추적 손절 (삼중 확인 전략용)
elif 최고수익률 >= 3.0 and (최고수익률 - 수익률) >= 2.0:
    매도 = True

# 시간 기반 매도
elif 보유시간 >= 240:  # 4시간 이상 보유
    매도 = True

# 기술적 지표 복합 매도 신호
elif RSI_값 > 80 and BB_위치 > 0.85:  # 과매수 신호 중복
    매도 = True
elif MACD_값 < MACD_신호 and 현재가 < 이동평균(20):  # 추세 전환
    매도 = True

# 거래량 기반 매도 신호
elif 분당거래대금 < 분당거래대금평균(10) * 0.5:  # 거래량 급감
    매도 = True
elif 체결강도 < 85 and 분당매도수량 > 분당매수수량 * 1.3:
    매도 = True

# 가격 모멘텀 매도 신호
elif 현재가 < 현재가_N(2) and 현재가 < 현재가_N(3):  # 연속 하락
    매도 = True
elif 현재가 < 최고분봉고가(5) * 0.95:  # 5분봉 고가 대비 하락
    매도 = True

# 이동평균 이탈 매도
elif 현재가 < 이동평균(5) * 0.98:  # 5분봉 이평선 이탈
    매도 = True

# 최종 매도 실행
if 매도:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

## 최적화 조건식

### 매수 최적화 조건식

```python
# 최적화 변수들
RSI_하한 = self.vars[0]          # RSI 하한
RSI_상한 = self.vars[1]          # RSI 상한
RSI_최소기준 = self.vars[2]      # RSI 최소 기준
BB_위치하한 = self.vars[3]       # BB 위치 하한
BB_위치상한 = self.vars[4]       # BB 위치 상한
거래대금배수 = self.vars[5]      # 거래대금 배수
체결강도기준 = self.vars[6]      # 체결강도 기준
삼중확인최소개수 = self.vars[7]   # 삼중 확인 최소 개수
시가상승비율 = self.vars[8]      # 시가 상승 비율
이동평균비율 = self.vars[9]      # 이동평균 비율

# 기술적 지표 계산
RSI_값 = RSI(14)
RSI_이전 = RSI_N(14, 1)
MACD_값 = MACD(12, 26, 9)
MACD_신호 = MACD신호(12, 26, 9)
MACD_히스토그램 = MACD_값 - MACD_신호
MACD_히스토그램_이전 = MACD히스토그램_N(12, 26, 9, 1)

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 이동평균선 계산
이동평균5 = 이동평균(5)
이동평균20 = 이동평균(20)

# 최적화된 삼중 확인 조건 1: RSI
RSI_매수신호 = False
if RSI_값 >= RSI_하한 and RSI_값 <= RSI_상한:
    if RSI_값 > RSI_이전:
        if RSI_값 >= RSI_최소기준:
            RSI_매수신호 = True

# 최적화된 삼중 확인 조건 2: MACD
MACD_매수신호 = False
if MACD_값 > MACD_신호:
    if MACD_히스토그램 > 0:
        if MACD_히스토그램 > MACD_히스토그램_이전:
            MACD_매수신호 = True

# 최적화된 삼중 확인 조건 3: 볼린저밴드
BB_매수신호 = False
if BB_위치 >= BB_위치하한 and BB_위치 <= BB_위치상한:
    if 현재가 > BB_중심:
        if 현재가 > 현재가_N(1):
            BB_매수신호 = True

# 이동평균 정배열 확인
이동평균_정배열 = (이동평균5 > 이동평균20) and (현재가 > 이동평균5)

# 공통 선결 조건
if not (시분 >= 930 and 시분 <= 1500):
    매수 = False
elif not (1000 < 현재가 <= 50000):
    매수 = False
elif not (0.5 < 등락율 <= 29.0):
    매수 = False
elif not (시가총액 >= 300):
    매수 = False

# 최적화된 거래량 조건
elif not (분당거래대금 >= 분당거래대금평균(20) * 거래대금배수):
    매수 = False
elif not (체결강도 >= 체결강도기준):
    매수 = False
elif not (분당매수량 > 분당매도량 * 1.1):
    매수 = False

# 최적화된 가격 조건
elif not (현재가 > 시가 * 시가상승비율):
    매수 = False
elif not (현재가 > 이동평균(20) * 이동평균비율):
    매수 = False
elif not (등락폭 > 0):
    매수 = False
elif not (현재가 >= 최저분봉저가(10) * 1.01):
    매수 = False
elif not (회전율 > 0.2):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False

# 삼중 확인 강도 계산
삼중확인강도 = 0
if RSI_매수신호:
    삼중확인강도 += 1
if MACD_매수신호:
    삼중확인강도 += 1
if BB_매수신호:
    삼중확인강도 += 1
if 이동평균_정배열:
    삼중확인강도 += 1
if Stoch_K(14, 3) > Stoch_D(14, 3):
    삼중확인강도 += 1
if 분당거래대금 >= 분당거래대금평균(20) * (거래대금배수 + 0.2):
    삼중확인강도 += 1

# 최종 매수 판단
if 삼중확인강도 >= 삼중확인최소개수:
    매수 = True
else:
    매수 = False

if 매수:
    self.Buy(종목코드, 종목명, 매수수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매수 최적화 범위

```python
self.vars[0] = [[30, 40, 5], 35]              # RSI_하한
self.vars[1] = [[60, 70, 5], 65]              # RSI_상한
self.vars[2] = [[35, 45, 5], 40]              # RSI_최소기준
self.vars[3] = [[0.15, 0.25, 0.05], 0.2]     # BB_위치하한
self.vars[4] = [[0.55, 0.65, 0.05], 0.6]     # BB_위치상한
self.vars[5] = [[1.2, 1.5, 0.1], 1.3]        # 거래대금배수
self.vars[6] = [[100, 110, 5], 105]           # 체결강도기준
self.vars[7] = [[4, 6, 1], 5]                 # 삼중확인최소개수
self.vars[8] = [[1.003, 1.010, 0.002], 1.005] # 시가상승비율
self.vars[9] = [[1.005, 1.015, 0.005], 1.01]  # 이동평균비율
```

### 매도 최적화 조건식

```python
# 최적화 변수들
RSI_과매수기준 = self.vars[0]    # RSI 과매수 기준
RSI_하락기준 = self.vars[1]      # RSI 하락 기준
BB_과매수위치 = self.vars[2]     # BB 과매수 위치
수익실현기준 = self.vars[3]      # 수익 실현 기준
손절기준 = self.vars[4]         # 손절 기준
추적손절기준 = self.vars[5]     # 추적 손절 기준
보유시간기준 = self.vars[6]     # 보유시간 기준
매도신호최소개수 = self.vars[7]  # 매도 신호 최소 개수

# 기술적 지표 계산
RSI_값 = RSI(14)
RSI_이전 = RSI_N(14, 1)
MACD_값 = MACD(12, 26, 9)
MACD_신호 = MACD신호(12, 26, 9)
MACD_히스토그램 = MACD_값 - MACD_신호
MACD_히스토그램_이전 = MACD히스토그램_N(12, 26, 9, 1)

# 볼린저밴드 계산
BB_상단 = 볼린저상단(20, 2)
BB_중심 = 볼린저중심(20)
BB_하단 = 볼린저하단(20, 2)
BB_위치 = (현재가 - BB_하단) / (BB_상단 - BB_하단)

# 최적화된 삼중 매도 신호
RSI_매도신호 = False
if RSI_값 >= RSI_과매수기준:
    RSI_매도신호 = True
elif RSI_값 < RSI_이전 and RSI_값 < RSI_하락기준:
    RSI_매도신호 = True

MACD_매도신호 = False
if MACD_값 < MACD_신호:
    MACD_매도신호 = True
elif MACD_히스토그램 < MACD_히스토그램_이전 and MACD_히스토그램 < 0:
    MACD_매도신호 = True

BB_매도신호 = False
if BB_위치 > BB_과매수위치:
    BB_매도신호 = True
elif 현재가 < BB_중심:
    BB_매도신호 = True

# 상한가 근접 매도
if 등락율 > 28.0:
    매도 = True

# 매도 신호 개수 계산
매도신호개수 = 0
if RSI_매도신호:
    매도신호개수 += 1
if MACD_매도신호:
    매도신호개수 += 1
if BB_매도신호:
    매도신호개수 += 1

if 매도신호개수 >= 매도신호최소개수:
    매도 = True

# 최적화된 수익률 매도
elif 수익률 >= 수익실현기준:
    매도 = True
elif 수익률 <= -손절기준:
    매도 = True
elif 최고수익률 >= 3.0 and (최고수익률 - 수익률) >= 추적손절기준:
    매도 = True

# 최적화된 시간 매도
elif 보유시간 >= 보유시간기준:
    매도 = True

# 기타 매도 신호
elif RSI_값 > 80 and BB_위치 > 0.85:
    매도 = True
elif MACD_값 < MACD_신호 and 현재가 < 이동평균(20):
    매도 = True
elif 분당거래대금 < 분당거래대금평균(10) * 0.5:
    매도 = True
elif 현재가 < 현재가_N(2) and 현재가 < 현재가_N(3):
    매도 = True
elif 현재가 < 이동평균(5) * 0.98:
    매도 = True

if 매도:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, 데이터길이)
```

### 매도 최적화 범위

```python
self.vars[0] = [[70, 80, 5], 75]               # RSI_과매수기준
self.vars[1] = [[60, 70, 5], 65]               # RSI_하락기준
self.vars[2] = [[0.75, 0.85, 0.05], 0.8]      # BB_과매수위치
self.vars[3] = [[4.0, 8.0, 1.0], 6.0]         # 수익실현기준
self.vars[4] = [[2.5, 4.0, 0.5], 3.0]         # 손절기준
self.vars[5] = [[1.5, 2.5, 0.5], 2.0]         # 추적손절기준
self.vars[6] = [[180, 300, 30], 240]           # 보유시간기준
self.vars[7] = [[1, 3, 1], 2]                  # 매도신호최소개수
```

### 매수 매도 최적화 범위

```python
# 매수 최적화 범위
self.vars[0] = [[30, 40, 5], 35]              # RSI_하한
self.vars[1] = [[60, 70, 5], 65]              # RSI_상한
self.vars[2] = [[35, 45, 5], 40]              # RSI_최소기준
self.vars[3] = [[0.15, 0.25, 0.05], 0.2]     # BB_위치하한
self.vars[4] = [[0.55, 0.65, 0.05], 0.6]     # BB_위치상한
self.vars[5] = [[1.2, 1.5, 0.1], 1.3]        # 거래대금배수
self.vars[6] = [[100, 110, 5], 105]           # 체결강도기준
self.vars[7] = [[4, 6, 1], 5]                 # 삼중확인최소개수
self.vars[8] = [[1.003, 1.010, 0.002], 1.005] # 시가상승비율
self.vars[9] = [[1.005, 1.015, 0.005], 1.01]  # 이동평균비율

# 매도 최적화 범위
self.vars[10] = [[70, 80, 5], 75]             # RSI_과매수기준
self.vars[11] = [[60, 70, 5], 65]             # RSI_하락기준
self.vars[12] = [[0.75, 0.85, 0.05], 0.8]    # BB_과매수위치
self.vars[13] = [[4.0, 8.0, 1.0], 6.0]       # 수익실현기준
self.vars[14] = [[2.5, 4.0, 0.5], 3.0]       # 손절기준
self.vars[15] = [[1.5, 2.5, 0.5], 2.0]       # 추적손절기준
self.vars[16] = [[180, 300, 30], 240]         # 보유시간기준
self.vars[17] = [[1, 3, 1], 2]                # 매도신호최소개수
```

### GA 최적화 범위

```python
# 매수 GA 최적화 범위
self.vars[0] = [[30, 32, 35, 37, 40], 35]                    # RSI_하한
self.vars[1] = [[60, 62, 65, 67, 70], 65]                    # RSI_상한
self.vars[2] = [[35, 37, 40, 42, 45], 40]                    # RSI_최소기준
self.vars[3] = [[0.15, 0.17, 0.20, 0.22, 0.25], 0.2]        # BB_위치하한
self.vars[4] = [[0.55, 0.57, 0.60, 0.62, 0.65], 0.6]        # BB_위치상한
self.vars[5] = [[1.2, 1.25, 1.3, 1.35, 1.4, 1.5], 1.3]     # 거래대금배수
self.vars[6] = [[100, 102, 105, 107, 110], 105]              # 체결강도기준
self.vars[7] = [[4, 5, 6], 5]                                # 삼중확인최소개수
self.vars[8] = [[1.003, 1.005, 1.007, 1.010], 1.005]        # 시가상승비율
self.vars[9] = [[1.005, 1.007, 1.010, 1.012, 1.015], 1.01]  # 이동평균비율

# 매도 GA 최적화 범위
self.vars[10] = [[70, 72, 75, 77, 80], 75]                   # RSI_과매수기준
self.vars[11] = [[60, 62, 65, 67, 70], 65]                   # RSI_하락기준
self.vars[12] = [[0.75, 0.77, 0.80, 0.82, 0.85], 0.8]       # BB_과매수위치
self.vars[13] = [[4.0, 5.0, 6.0, 7.0, 8.0], 6.0]            # 수익실현기준
self.vars[14] = [[2.5, 3.0, 3.5, 4.0], 3.0]                 # 손절기준
self.vars[15] = [[1.5, 2.0, 2.5], 2.0]                       # 추적손절기준
self.vars[16] = [[180, 210, 240, 270, 300], 240]             # 보유시간기준
self.vars[17] = [[1, 2, 3], 2]                               # 매도신호최소개수