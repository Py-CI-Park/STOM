# 조건식 (Condition)

STOM 주식 자동거래에 사용하기 위한 조건식 문서

## 목차
- [조건식 (Condition)](#조건식-condition)
  - [목차](#목차)
  - [소개](#소개)
  - [가이드라인](#가이드라인)
- [Stomer](#stomer)
  - [조건식](#조건식)
    - [매수 조건식](#매수-조건식)
    - [매도 조건식](#매도-조건식)
  - [최적화 조건식](#최적화-조건식)
    - [매수 최적화 조건식](#매수-최적화-조건식)
    - [매수 최적화 범위](#매수-최적화-범위)
    - [예상 시간 계산](#예상-시간-계산)
    - [GA 최적화 범위](#ga-최적화-범위)

## 소개

이 문서는 STOM 주식 자동거래 시스템에서 사용되는 다양한 조건식을 설명합니다. 각 조건식은 매수 및 매도 전략을 포함하며, 최적화된 변수 설정을 통해 성능을 향상시킵니다.

## 가이드라인

- 모든 조건식은 Python으로 작성되어 있으며, 주식 거래의 자동화를 목표로 합니다.
- 각 조건식은 특정 조건을 만족할 때 매수 또는 매도를 실행합니다.
- 최적화 조건식은 변수의 범위를 설정하여 최적의 매수/매도 시점을 찾습니다.
- 최적화 범위는 self.vars[정수] = [[시작값, 종료값, 간격], 최적값] 형식으로 설정합니다.
- GA(유전 알고리즘) 최적화 범위 생성 방법:
  - 유전 알고리즘을 사용하여 최적의 매수/매도 시점을 찾기 위해, 각 변수의 범위를 설정합니다.
  - 각 변수는 self.vars[정수] = [범위리스트, 고정값] 형식으로 정의됩니다.
  - 범위리스트는 탐색할 값들을 단순 나열한 형태로 입력하며, 고정값은 하나의 수로 입력합니다.
  - 고정값은 2단계, 3단계에서 이전 탐색에서 검출되지 않아도 돌연변이로 추가됩니다. 이는 사용자가 이미 알고 있는 최적값을 강제로 탐색하기 위함입니다. 4단계부터는 돌연변이로 추가되지 않습니다.
  - 너무 많은 변수를 입력할 경우 시간이 오래 걸리므로, 각각의 변수 범위를 10개 이하로 설정하십시오. 변수 범위의 최대값은 20개입니다.
  - 최적값 중에 최적값을 찾는 방법은 일반 최적화에서 구한 최적값을 GA에 돌연변이값으로 넣고 GA를 돌린 다음, 다시 GA에서 구한 최적값으로 일반 최적화를 돌리면 됩니다.

---

# Stomer

## 조건식

### 매수 조건식

```python
초당순매수금액 = (초당매수수량 - 초당매도수량) * 현재가 / 1_000_000

if 데이터길이 > 60 and 체결강도평균 >= 체결강도평균N(30):
    매수 = False
elif not (초당거래대금 > 초당거래대금N(1)):
    매수 = False
elif not (현재가 < VI아래5호가):
    매수 = False
elif 라운드피겨위5호가이내:
    매수 = False
elif 시가총액 < 3000:
    if not ((현재가 / 시가 - 1) * 100 > 0):
        매수 = False
    elif not ((현재가 / 고가 - 1) * 100 > -2):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (등락율 <= 23):
        매수 = False
    elif not (회전율 > 1):
        매수 = False
    elif not (전일비 > 2):
        매수 = False
    elif not (전일동시간비 > 20):
        매수 = False
    elif not (당일거래대금 > 10 * 100):
        매수 = False
    elif not (400 > 초당거래대금 - 초당거래대금평균):
        매수 = False
    elif not (400 > 초당순매수금액 > 0):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 20 / 100):
        매수 = False
else:
    if not ((현재가 / 시가 - 1) * 100 > -1):
        매수 = False
    elif not ((현재가 / 고가 - 1) * 100 > -3):
        매수 = False
    elif not (고저평균대비등락율 > 0):
        매수 = False
    elif not (등락율 <= 20):
        매수 = False
    elif not (회전율 > 2):
        매수 = False
    elif not (전일비 > 2):
        매수 = False
    elif not (전일동시간비 > 40):
        매수 = False
    elif not (당일거래대금 > 70 * 100):
        매수 = False
    elif not (300 > 초당거래대금 - 초당거래대금평균):
        매수 = False
    elif not (400 > 초당순매수금액 > 0):
        매수 = False
    elif not (초당매수수량 > 매도총잔량 * 25 / 100):
        매수 = False

if 매수:
    if '지정가' in self.dict_set['주식매수주문구분']:
        기준가격 = 현재가
        if self.dict_set['주식매수지정가기준가격'] == '매도1호가': 기준가격 = 매도호가1
        if self.dict_set['주식매수지정가기준가격'] == '매수1호가': 기준가격 = 매수호가1
        self.list_buy.append(종목코드)
        self.straderQ.put(['매수', 종목코드, 종목명, 기준가격, 매수수량, now(), False])
        self.dict_buyinfo[종목코드] = 매수시점정보
    else:
        남은수량 = 매수수량
        직전남은수량 = 매수수량
        매수금액 = 0
        for 매도호가, 매도잔량 in self.bhogainfo.items():
            남은수량 -= 매도잔량
            if 남은수량 <= 0:
                매수금액 += 매도호가 * 직전남은수량
                break
            else:
                매수금액 += 매도호가 * 매도잔량
                직전남은수량 = 남은수량
        if 남은수량 <= 0:
            예상체결가 = int(round(매수금액 / 매수수량)) if 매수수량 != 0 else 0
            self.list_buy.append(종목코드)
            self.straderQ.put(['매수', 종목코드, 종목명, 예상체결가, 매수수량, now(), False])
            self.dict_buyinfo[종목코드] = 매수시점정보
```

### 매도 조건식

```python
if 등락율 > 29.5:
    매도 = True
    self.sellcond = 1
elif 시가총액 < 3000:
    if 수익률 < -2 and 체결강도N(1) >= 체결강도평균N(1) and 체결강도평균 > 체결강도:
        매도 = True
        self.sellcond = 2
    elif 수익률 < -2 and 누적초당매도수량(30) > 누적초당매수수량(30) * 5:
        매도 = True
        self.sellcond = 3
    elif -1 < 수익률 <= 7 and 초당매도수량 - 초당매수수량 >= 매수총잔량 * 45 / 100:
        매도 = True
        self.sellcond = 4
    elif 2 < 수익률 and 현재가N(1) >= 이평60N(1) and 이평60 > 현재가:
        매도 = True
        self.sellcond = 5
else:
    if 수익률 < -2 and 체결강도N(1) >= 체결강도평균N(1) and 체결강도평균 > 체결강도:
        매도 = True
        self.sellcond = 6
    elif -1 < 수익률 <= 15 and 초당매도수량 - 초당매수수량 >= 매수총잔량 * 50 / 100:
        매도 = True
        self.sellcond = 7
    elif 2 < 수익률 and 현재가N(1) >= 이평60N(1) and 이평60 > 현재가:
        매도 = True
        self.sellcond = 8

if 매도:
    if '지정가' in self.dict_set['주식매도주문구분'] and not E:
        기준가격 = 현재가
        if self.dict_set['주식매도지정가기준가격'] == '매도1호가': 기준가격 = 매도호가1
        if self.dict_set['주식매도지정가기준가격'] == '매수1호가': 기준가격 = 매수호가1
        self.list_sell.append(종목코드)
        self.straderQ.put(['매도', 종목코드, 종목명, 기준가격, 매도수량, now(), False])
    else:
        남은수량 = 매도수량
        직전남은수량 = 매도수량
        매도금액 = 0
        for 매수호가, 매수잔량 in self.shogainfo.items():
            남은수량 -= 매수잔량
            if 남은수량 <= 0:
                매도금액 += 매수호가 * 직전남은수량
                break
            else:
                매도금액 += 매수호가 * 매수잔량
                직전남은수량 = 남은수량
        if 남은수량 <= 0:
            예상체결가 = int(round(매도금액 / 매도수량)) if 매도수량 != 0 else 0 
            self.list_sell.append(종목코드)
            self.straderQ.put(['매도', 종목코드, 종목명, 예상체결가, 매도수량, now(), True if E else False])
```

## 최적화 조건식

### 매수 최적화 조건식

```python

```

### 매수 최적화 범위

```python
self.vars[0]  = [[30, 30, 0], 30]           # 범위갯수: 1

self.vars[1]  = [[40, 50, 60, 70, 80], 80]  # 범위갯수: 5
self.vars[2]  = [[-4, -9, -14], -14]        # 범위갯수: 3
self.vars[3]  = [[-3, -2, -1, 0], -1]       # 범위갯수: 4
self.vars[4]  = [[1, 2, 3, 4, 5], 3]        # 범위갯수: 5

self.vars[5]  = [[40, 50, 60, 70, 80], 80]  # 범위갯수: 5
self.vars[6]  = [[-4, -9, -14, -19, -24], -4]  # 범위갯수: 5
self.vars[7]  = [[-3, -2, -1, 0], -1]       # 범위갯수: 4
self.vars[8]  = [[1, 2, 3, 4, 5], 3]        # 범위갯수: 5

self.vars[9]  = [[-3, -2, -1, 0], -1]       # 범위갯수: 4
self.vars[10] = [[-3, -2, -1], -2]          # 범위갯수: 3
self.vars[11] = [[25, 24, 23, 22, 21, 20], 22]  # 범위갯수: 6
self.vars[12] = [[0, 1, 2], 1]              # 범위갯수: 3
self.vars[13] = [[10, 20, 30], 30]          # 범위갯수: 3
self.vars[14] = [[10, 9, 8, 7, 6, 5], 10]   # 범위갯수: 6
self.vars[15] = [[20, 30, 40, 50], 30]      # 범위갯수: 4
self.vars[16] = [[15, 20, 25, 30], 25]      # 범위갯수: 4
self.vars[17] = [[7, 6, 5, 4, 3], 4]        # 범위갯수: 5

self.vars[18] = [[-3, -2, -1, 0], 0]        # 범위갯수: 4
self.vars[19] = [[-3, -2, -1, 0, 1], -2]    # 범위갯수: 5
self.vars[20] = [[-3, -2, -1, 0], 0]        # 범위갯수: 4
self.vars[21] = [[25, 24, 23, 22, 21, 20], 21]  # 범위갯수: 6
self.vars[22] = [[1, 2, 3, 4, 5], 4]        # 범위갯수: 5
self.vars[23] = [[60, 70, 80, 90, 100], 60] # 범위갯수: 5
self.vars[24] = [[50, 60, 70, 80, 90, 100], 80]  # 범위갯수: 6
self.vars[25] = [[10, 9, 8], 14]            # 범위갯수: 3
self.vars[26] = [[50, 45, 40, 35], 35]      # 범위갯수: 4
self.vars[27] = [[10, 15, 20, 25, 30, 35, 40, 45, 50], 35]  # 범위갯수: 9
```

### 예상 시간 계산

모든 변수의 범위 갯수를 곱하여 모든 경우의 수를 계산합니다.

- **전체 변수 범위**: 
  - 1 × 5 × 3 × 4 × 5 × 5 × 5 × 4 × 3 × 5 × 5 × 5 × 4 × 3 × 5 × 5 × 4 × 5 × 4 × 6 × 3 × 6 × 4 × 5 × 5 × 6 × 3 × 4 × 9

- **총 경우의 수**: 
  - 1,889,568,000,000,000,000

각 경우에 1분이 걸린다고 가정하면:
- **분**: 1,152,921,504,606,846,976분
- **시간**: 1,152,921,504,606,846,976 / 60 = 19,215,358,410,114,116시간
- **일**: 19,215,358,410,114,116 / 24 = 800,639,933,754,754일
- **년**: 800,639,933,754,754 / 365 ≈ 2,193,534,062,611년

**가정**: 각 경우의 수를 처리하는 데 1분이 소요된다고 가정하였습니다. 이는 현실적으로 불가능한 시간이므로, 범위를 더 좁히거나 간격을 늘려야 할 수 있습니다.

---

### GA 최적화 범위

- GA 최적화 변환 방법 및 원리:
  - 기존의 최적화 범위는 `self.vars[정수] = [[시작값, 종료값, 간격], 최적값]` 형식으로 설정됩니다.
  - GA 최적화에서는 이 범위를 `self.vars[정수] = [전체 리스트, 최적값]` 형식으로 변환합니다.
  - 전체 리스트는 시작값부터 종료값까지 간격에 따라 생성된 값들의 집합입니다.
  - 예를 들어, `self.vars[1] = [[0, 10, 1], 3]`는 `self.vars[1] = [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 3]`로 변환됩니다.
  - GA 최적화는 이 전체 리스트를 사용하여 유전 알고리즘을 통해 최적의 값을 탐색합니다.
  - 유전 알고리즘은 자연 선택, 교차, 돌연변이 등의 과정을 통해 최적의 해를 찾습니다.
  - 최적값은 유전 알고리즘 실행 후 도출된 최적의 값으로 설정됩니다.
  - 이 방법은 탐색 공간을 명시적으로 정의하여 GA가 보다 효율적으로 탐색할 수 있도록 돕습니다.

```python

```