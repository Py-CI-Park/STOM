########################
# 매도 조건식 (전량 매도)
########################

매도 = False  # 초기값
# 아래 trade_info 접근은 예시. 실제 인덱스나 함수는 전략마다 다름
수익금, 수익률, 최고수익률, 최저수익률, 보유수량 = self.trade_info[0][0].values()[:5]

# (1) 호가창 무너짐: 매수총잔량이 매수시점 대비 절반 이하
if 매수총잔량 < 매수총잔량N(-1) * 0.5:
    매도 = True

# (2) 체결강도 급락 + 초당매수수량 < 초당매도수량
if 체결강도 < 80 and 초당매수수량 < 초당매도수량:
    매도 = True

# (3) 단순 손절: -2% 이하
if 수익률 <= -2:
    매도 = True

# (4) 트레일링 스톱: 최고수익률이 3% 초과 시, 현재수익률이 고점의 70% 미만
#     (고점 4%→ 현재 2.8% 이하 되면 매도)
if 최고수익률 > 3 and 수익률 <= 최고수익률 * 0.7:
    매도 = True

# 매도 조건 충족 → 전량 매도
if 매도 and 보유수량 > 0:
    self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, False)

########################
# 분할 매도(부분 매도) 조건식
########################

매도 = False
매도구분 = 0   # 매도 시나리오 식별을 위한 변수
수익금, 수익률, 최고수익률, 최저수익률, 보유수량 = self.trade_info[0][0].values()[:5]

# (A) 긴급 손절 / 호가창 급변
if 매수총잔량 < 매수총잔량N(-1) * 0.5:
    매도 = True
    매도구분 = 200  # 손절청산 (전량매도)

if 체결강도 < 80 and 초당매수수량 < 초당매도수량:
    매도 = True
    매도구분 = 200

if 수익률 <= -2:
    매도 = True
    매도구분 = 200

# (B) 1차 익절 조건 (부분 매도)
# 예: 수익률 3% 이상 도달 시, 절반 매도
if 수익률 >= 3 and 보유수량 > 0:
    매도 = True
    매도구분 = 100  # 분할매도 1차

# (C) 2차 익절 조건 (남은 물량 전량 매도)
# 예: 수익률 5% 이상 되면 나머지 모두 청산
if 수익률 >= 5 and 보유수량 > 0:
    매도 = True
    매도구분 = 101  # 분할매도 2차

# (D) 최종 매도 실행
if 매도 and 보유수량 > 0:
    if 매도구분 == 200:
        # 긴급 손절 or 호가창 무너짐: 전량 청산
        self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, False)

    elif 매도구분 == 100:
        # 1차 분할매도 (절반 정도만 매도 예시)
        부분매도수량 = int(보유수량 * 0.5)
        self.Sell(종목코드, 종목명, 부분매도수량, 현재가, 매도호가1, 매수호가1, False)

    elif 매도구분 == 101:
        # 2차 분할매도: 전량 매도
        self.Sell(종목코드, 종목명, 보유수량, 현재가, 매도호가1, 매수호가1, False)
